<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0">
    <title>Control de Ventas - Agua</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1E5AAA;
            --secondary: #4FC3F7;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2C3E50;
            --light: #ecf0f1;
            --agua-azul: #4FC3F7;
            --azul-oscuro: #0D3B66;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        /* === PANTALLA DE LOGIN === */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .login-box h2 {
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        .login-box input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .login-box button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
        }
        
        .login-error {
            color: var(--danger);
            margin-top: 10px;
            display: none;
        }
        
        #app-container {
            display: none;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo img {
            height: 50px;
            width: 50px;
            object-fit: contain;
            background: white;
            border-radius: 50%;
            padding: 3px;
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .logo h1 {
            font-size: 20px;
            line-height: 1.2;
            margin: 0;
        }
        
        .logo-subtitle {
            font-size: 11px;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .logo i {
            font-size: 28px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: 50px;
            padding: 5px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .tab {
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab.active {
            background-color: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .badge-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-title {
            font-size: 14px;
            color: #6c757d;
        }
        
        .dollar-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .dollar-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            flex: 1;
            min-width: 200px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .dollar-title {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dollar-value {
            font-size: 20px;
            font-weight: 700;
        }
        
        .price-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .price-input-group input {
            flex: 1;
        }
        
        .contact-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .contact-btn {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-radius: 10px;
            color: white;
            text-decoration: none;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }
        
        .whatsapp {
            background-color: #25D366;
        }
        
        .email {
            background-color: #EA4335;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #6c757d;
            font-size: 14px;
        }
        
        .price-history-table {
            font-size: 14px;
        }
        
        .price-history-table th,
        .price-history-table td {
            padding: 8px 10px;
        }
        
        .product-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .product-name {
            font-weight: 600;
            color: var(--dark);
        }
        
        .product-price {
            font-weight: 700;
            color: var(--secondary);
            text-align: right;
        }
        
        .price-detail {
            font-size: 12px;
            color: #6c757d;
        }
        
        .iva-badge {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 10px;
        }
        
        .sale-items-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .sale-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .sale-item:last-child {
            border-bottom: none;
        }
        
        .remove-item {
            color: var(--danger);
            cursor: pointer;
            padding: 5px;
        }
        
        .total-breakdown {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        
        .breakdown-total {
            font-weight: 700;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 5px;
        }
        
        .currency-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .currency-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .currency-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .config-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .config-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        /* Vista Ecuador */
        .ecuador-view {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .ecuador-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .ecuador-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .ecuador-stat {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .ecuador-stat-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .ecuador-stat-value {
            font-size: 24px;
            font-weight: 700;
        }
        
        /* Abonos de Cr√©ditos */
        .payment-summary {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .payment-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .abono-list {
            margin-top: 10px;
        }
        
        .abono-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scroll-snap-type: x mandatory;
                padding-bottom: 4px;
            }

            .nav-tabs .tab {
                scroll-snap-align: start;
                white-space: nowrap;
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .stats-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .dollar-card {
                min-width: 100%;
            }

            /* B10: inputs y botones t√°ctiles */
            input, select, textarea {
                min-height: 44px;
                font-size: 16px !important; /* evita zoom autom√°tico en iOS */
            }

            .btn {
                min-height: 48px;
                padding: 10px 16px;
            }

            .btn-small {
                min-height: 38px;
            }

            /* B10: modales a pantalla completa en m√≥vil */
            .modal-content {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0;
                border-radius: 16px 16px 0 0;
                max-height: 95vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
            }

            /* B10: tablas horizontales en m√≥vil */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 500px;
            }

            /* B10: ocultar columnas no cr√≠ticas en m√≥vil */
            .col-opcional {
                display: none;
            }

            /* B10: cards full-width */
            .card {
                border-radius: 8px;
                margin-bottom: 10px;
            }

            /* B10: bottom navigation - nav principal sticky en base */
            .nav-tabs-wrapper {
                position: sticky;
                top: 0;
                z-index: 100;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,.1);
            }
        }

        /* B10: Pull-to-refresh indicator */
        #ptr-indicator {
            display: none;
            text-align: center;
            padding: 12px;
            color: #667eea;
            font-size: 13px;
            font-weight: 600;
            background: #f0f4ff;
            border-bottom: 1px solid #d0d8ff;
        }

        /* B10: Conexi√≥n lenta banner */
        #slow-connection-banner {
            display: none;
            background: #fff3e0;
            border-bottom: 1px solid #ff9800;
            padding: 6px 16px;
            font-size: 12px;
            color: #e65100;
            text-align: center;
        }

        /* B10: Reportes - estado visual en tablas */
        .rep-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
        }
        .rep-ok    { background: #e8f5e9; color: #2e7d32; }
        .rep-warn  { background: #fff3e0; color: #e65100; }
        .rep-crit  { background: #ffebee; color: #c62828; }
        .rep-info  { background: #e3f2fd; color: #1565c0; }
    
        /* ===== COMPATIBILIDAD CROSS-BROWSER / ANDROID ===== */

        /* Scroll momentum en iOS/Safari para contenedores overflow */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        /* gap en flexbox - fallback para Android < Chrome 84 */
        .stats-container > * + * { margin-top: 0; } /* grid ya lo maneja */

        /* Touch targets m√≠nimos WCAG 2.5.5 (44√ó44px) en todos los browsers */
        button, .btn, [role="button"] {
            -webkit-appearance: none;
            touch-action: manipulation;   /* elimina 300ms tap delay en Android */
            cursor: pointer;
        }

        /* Scroll suave en todos los navegadores */
        html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }

        /* Evitar overflow horizontal en toda la app */
        body, #app-container { max-width: 100vw; overflow-x: hidden; }

        /* Tablas: wrapper scroll universal */
        .table-scroll-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            display: block;
        }
        .table-scroll-wrap table { min-width: 480px; }

        /* Modales: scroll en iOS sin posici√≥n fixed atrapada */
        .modal {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        .modal-content {
            -webkit-overflow-scrolling: touch;
        }

        /* Select en Android: quitar flecha nativa problem√°tica */
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; 
                 background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23666' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
                 background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }

        /* Firefox: quitar inner padding extra en inputs */
        input::-moz-focus-inner { border: 0; padding: 0; }

        /* Placeholder color consistente cross-browser */
        ::placeholder { color: #aaa; opacity: 1; }
        :-ms-input-placeholder { color: #aaa; }

        /* Focus visible para accesibilidad (sin outline en touch) */
        @media (hover: none) {
            *:focus { outline: none; }
        }
        @media (hover: hover) {
            *:focus-visible { outline: 2px solid #667eea; outline-offset: 2px; }
        }

        /* ===== FIN COMPATIBILIDAD ===== */
</style>
    
    <!-- SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- ===== B9: PWA ===== -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AQUANEV">
    <meta name="theme-color" content="#667eea">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='32' fill='%23667eea'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle' fill='white'%3E%F0%9F%92%A7%3C/text%3E%3C/svg%3E">
    <!-- ===== FIN B9 head ===== -->
    <meta name="description" content="AQUANEV - Sistema de control de ventas de agua">
</head>
<body>

    <!-- Detecci√≥n de compatibilidad m√≠nima -->
    <script>
    (function(){
        // Test optional chaining y nullish coalescing (Chrome 80+)
        try { eval('(null?.x ?? "ok")'); }
        catch(e) {
            document.body.innerHTML = '<div style="padding:40px;text-align:center;font-family:sans-serif;">' +
                '<h2>‚ö†Ô∏è Navegador no compatible</h2>' +
                '<p>AQUANEV requiere <strong>Chrome 80+</strong>, <strong>Firefox 75+</strong> o <strong>Samsung Internet 12+</strong>.</p>' +
                '<p>Por favor actualiza tu navegador:</p>' +
                '<a href="https://play.google.com/store/apps/details?id=com.android.chrome" ' +
                'style="display:inline-block;margin:10px;padding:12px 24px;background:#4285f4;color:white;border-radius:8px;text-decoration:none;">'+
                'üì≤ Actualizar Chrome</a>' +
                '<a href="https://play.google.com/store/apps/details?id=com.sec.android.app.sbrowser" ' +
                'style="display:inline-block;margin:10px;padding:12px 24px;background:#1428a0;color:white;border-radius:8px;text-decoration:none;">'+
                'üì≤ Samsung Internet</a>' +
                '</div>';
        }
    })();
    </script>

    <!-- B10: Pull-to-refresh indicator -->
    <div id="ptr-indicator">‚Üì Suelta para sincronizar</div>
    <!-- B10: Conexi√≥n lenta -->
    <div id="slow-connection-banner">üê¢ Conexi√≥n lenta detectada ‚Äî sincronizaci√≥n en segundo plano</div>

    <!-- Pantalla de Login Multiusuario B7 -->
    <div id="login-screen">
        <div class="login-box" style="max-width:440px;">
            <div style="margin-bottom:20px;">
                <i class="fas fa-tint" style="font-size:36px; color:#667eea;"></i>
                <h2 style="margin:8px 0 4px;">AQUANEV C.A.</h2>
                <p style="color:#888; font-size:13px; margin:0;">Sistema de Gesti√≥n Comercial</p>
            </div>

            <!-- Paso 1: Seleccionar usuario -->
            <div id="login-step-usuario">
                <p style="color:#555; margin-bottom:14px; font-weight:600;">Selecciona tu usuario:</p>
                <div id="login-usuarios-lista" style="display:flex; flex-direction:column; gap:8px; margin-bottom:14px;"></div>
            </div>

            <!-- Paso 2: Ingresar PIN -->
            <div id="login-step-pin" style="display:none;">
                <div id="login-usuario-selected" style="background:#f0f4ff; border-radius:8px; padding:10px; margin-bottom:14px; font-weight:600; color:#3949ab;"></div>
                <p style="color:#555; margin-bottom:8px;">Ingresa tu PIN:</p>
                <input type="password" id="login-pin" maxlength="8" placeholder="PIN" 
                    style="letter-spacing:4px; font-size:20px; text-align:center;"
                    onkeypress="if(event.key==='Enter') attemptLoginB7()" autocomplete="current-password" autocorrect="off" autocapitalize="off">
                <button class="btn btn-primary" onclick="attemptLoginB7()" style="width:100%; margin-top:10px;">
                    <i class="fas fa-sign-in-alt"></i> Ingresar
                </button>
                <button class="btn btn-secondary" onclick="volverSeleccionUsuario()" style="width:100%; margin-top:6px; background:transparent; color:#666;">
                    ‚Üê Cambiar usuario
                </button>
            </div>

            <!-- Paso 3: Verificar 2FA -->
            <div id="login-step-2fa" style="display:none;">
                <div id="login-2fa-usuario" style="background:#f0f4ff; border-radius:8px; padding:10px; margin-bottom:14px; font-weight:600; color:#3949ab;"></div>
                <div id="login-2fa-instruccion" style="color:#555; margin-bottom:12px; font-size:14px;"></div>
                <input type="text" id="login-2fa-codigo" maxlength="6" placeholder="000000"
                    style="letter-spacing:6px; font-size:24px; text-align:center; font-weight:700;"
                    onkeypress="if(event.key==='Enter') verificar2FA()" autocomplete="one-time-code" inputmode="numeric">
                <button class="btn btn-primary" onclick="verificar2FA()" style="width:100%; margin-top:10px;">
                    <i class="fas fa-shield-alt"></i> Verificar C√≥digo
                </button>
                <div id="login-2fa-reenviar" style="display:none; margin-top:8px; text-align:center;">
                    <button class="btn btn-secondary btn-small" onclick="reenviarCodigo2FA()" style="background:transparent; color:#667eea;">
                        üîÑ Reenviar c√≥digo por email
                    </button>
                </div>
                <button class="btn btn-secondary" onclick="volverSeleccionUsuario()" style="width:100%; margin-top:6px; background:transparent; color:#666;">
                    ‚Üê Cancelar
                </button>
                <!-- QR para TOTP -->
                <div id="login-2fa-qr-container" style="display:none; text-align:center; margin-top:14px; padding:14px; background:#f9f9f9; border-radius:10px;">
                    <p style="font-size:13px; color:#555; margin-bottom:8px;">Escanea con Google Authenticator:</p>
                    <canvas id="login-2fa-qr"></canvas>
                    <p style="font-size:11px; color:#888; margin-top:6px;">Luego ingresa el c√≥digo de 6 d√≠gitos</p>
                </div>
            </div>

            <div id="login-error" class="login-error" style="margin-top:10px;">PIN incorrecto. Intenta de nuevo.</div>
        </div>
    </div>

    <!-- Aplicaci√≥n Principal -->
    <div id="app-container">
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-tint" style="color: var(--secondary);"></i>
                    <div class="logo-text">
                        <h1>AQUANEV C.A.</h1>
                        <span class="logo-subtitle">Comercializadora y Distribuidora de Agua</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-warning" onclick="updateExchangeRates()">
                        <i class="fas fa-dollar-sign"></i> Actualizar USD
                    </button>
                    <button class="btn btn-secondary" onclick="showPriceManager()">
                        <i class="fas fa-tags"></i> Precios
                    </button>
                    <button class="btn btn-primary" onclick="downloadBackup()">
                        <i class="fas fa-download"></i> Respaldo
                    </button>
                    <button class="btn btn-danger" onclick="logoutB7()">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                </div>
                <div class="user-info">
                    <span id="current-date"></span>
                    <span id="header-user-badge" style="display:none; background:rgba(255,255,255,0.2); border-radius:20px; padding:4px 12px; font-size:13px; margin-left:10px;">
                        <i class="fas fa-user-circle"></i>
                        <span id="header-user-nombre"></span>
                        <span id="header-user-rol" style="opacity:0.75; font-size:11px; margin-left:4px;"></span>
                    </span>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="dollar-info">
            <div class="dollar-card">
                <div class="dollar-title">
                    D√≥lar BCV
                    <span class="badge badge-info" id="bcv-last-update"></span>
                </div>
                <div class="dollar-value" id="bcv-rate">38.50 BS</div>
                <small>Tasa para conversi√≥n de precios</small>
            </div>
            <div class="dollar-card">
                <div class="dollar-title">
                    D√≥lar Binance
                    <span class="badge badge-info" id="binance-last-update"></span>
                </div>
                <div class="dollar-value" id="binance-rate">39.20 BS</div>
                <small>Tasa de referencia mercado</small>
            </div>
        </div>
        
        <div class="nav-tabs">
            <div class="tab active" data-tab="dashboard">Dashboard</div>
            <div class="tab" data-tab="sales">Registro de Ventas</div>
            <div class="tab" data-tab="credits">Cr√©ditos</div>
            <div class="tab" data-tab="adelantos">üí∞ Adelantos</div>
            <div class="tab" data-tab="expenses">Gastos</div>
            <div class="tab" data-tab="compras">üõí Compras</div>
            <div class="tab" data-tab="proveedores">üè≠ Proveedores</div>
            <div class="tab" data-tab="consignaciones">üìã Consignaciones</div>
            <div class="tab" data-tab="prestamos">üè¶ Pr√©stamos</div>
            <div class="tab" data-tab="ecuador">Vista Ecuador</div>
            <div class="tab" data-tab="orders">Pedidos</div>
            <div class="tab" data-tab="inventory">üì¶ Inventario</div>
            <div class="tab" data-tab="clients">Clientes</div>
            <div class="tab" data-tab="prices">Precios</div>
            <div class="tab" data-tab="reports">Reportes</div>
            <div class="tab" data-tab="config">Configuraci√≥n</div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">Ventas de Hoy</div>
                    <div class="stat-value" id="today-sales">0</div>
                    <div class="stat-desc">productos vendidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Ingresos de Hoy</div>
                    <div class="stat-value" id="today-income" style="color:#2e7d32;">$0.00</div>
                    <div class="stat-desc">USD ¬∑ total cobrado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Gastos de Hoy</div>
                    <div class="stat-value" id="today-expenses" style="color:#f44336;">$0.00</div>
                    <div class="stat-desc">USD ¬∑ total gastado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Balance Diario</div>
                    <div class="stat-value" id="daily-balance">$0.00</div>
                    <div class="stat-desc">USD ¬∑ ingresos ‚àí gastos</div>
                </div>
            </div>

            <!-- META DE VENTA DIARIA -->
            <div id="meta-diaria-card" class="stat-card" style="margin-bottom:14px; border-left:4px solid #9e9e9e; transition:border-color .4s, background .4s;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:8px;">
                    <div>
                        <div class="stat-title">üéØ Meta de Venta Diaria</div>
                        <div style="display:flex; align-items:baseline; gap:8px; margin-top:4px;">
                            <span class="stat-value" id="meta-progreso-usd" style="font-size:22px; transition:color .4s;">$0.00</span>
                            <span style="color:#888; font-size:14px;">/ <strong id="meta-objetivo-label">$30.00</strong> USD</span>
                        </div>
                        <div class="stat-desc" id="meta-desc-texto">Sin ventas por el momento</div>
                    </div>
                    <div id="meta-badge" style="font-size:28px; line-height:1;">üí§</div>
                </div>
                <!-- Barra de progreso -->
                <div style="margin-top:12px; background:#e0e0e0; border-radius:6px; height:12px; overflow:hidden;">
                    <div id="meta-barra" style="height:100%; width:0%; border-radius:6px; transition:width .5s, background .4s; background:#9e9e9e;"></div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:11px; color:#aaa; margin-top:4px;">
                    <span>$0</span>
                    <span id="meta-pct-label" style="font-weight:700; color:#888;">0%</span>
                    <span id="meta-objetivo-label2">$30</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Precios Actuales</div>
                    <div class="currency-toggle">
                        <button class="currency-btn active" onclick="setCurrencyDisplay('bs')">BS</button>
                        <button class="currency-btn" onclick="setCurrencyDisplay('usd')">USD</button>
                    </div>
                </div>
                <div class="stats-container" id="current-prices">
                    <!-- Los precios actuales se cargar√°n aqu√≠ -->
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Ventas Recientes</div>
                    <button class="btn btn-primary" onclick="showTab('sales')">
                        <i class="fas fa-list"></i> Ver Todas
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Productos</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="recent-sales">
                            <!-- Las ventas recientes se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="contact-buttons">
                <button class="contact-btn whatsapp" onclick="openWhatsApp()">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="contact-btn email" onclick="openGmail()">
                    <i class="fas fa-envelope"></i> Gmail
                </button>
            </div>
        </div>
        
        <!-- Registro de Ventas Tab -->
        <div id="sales" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Registrar Venta Mixta</div>
                </div>
                
                <div class="form-group">
                    <label for="sale-date">Fecha</label>
                    <input type="date" id="sale-date" required>
                </div>
                
                <div class="form-group">
                    <label for="customer-name">Cliente</label>
                    <input type="text" id="customer-name" list="customer-datalist" required
                           placeholder="Escribe para buscar cliente..."
                           autocomplete="off"
                           style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;box-sizing:border-box;">
                    <datalist id="customer-datalist">
                        <!-- Los clientes se cargar√°n aqu√≠ -->
                    </datalist>
                </div>
                
                <div class="form-group">
                    <label>Agregar Productos a la Venta</label>
                    <div id="products-list">
                        <!-- Los productos se cargar√°n aqu√≠ -->
                    </div>
                </div>
                
                <div class="sale-items-container" id="sale-items">
                    <div style="text-align: center; color: #6c757d; padding: 20px;">
                        No hay productos agregados
                    </div>
                </div>
                
                <div class="total-breakdown" id="sale-total" style="display: none;">
                    <div class="breakdown-row">
                        <span>Subtotal:</span>
                        <span id="subtotal-amount">0.00 BS</span>
                    </div>
                    <div class="breakdown-row">
                        <span>IVA (<span id="iva-percentage-display">16</span>%):</span>
                        <span id="iva-amount">0.00 BS</span>
                    </div>
                    <div class="breakdown-row breakdown-total">
                        <span>TOTAL:</span>
                        <span id="total-amount">0.00 BS</span>
                    </div>
                    <div class="breakdown-row">
                        <small><span id="total-usd">0.00 USD</span> (al cambio BCV)</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="payment-method">M√©todo de Pago</label>
                    <select id="payment-method" required>
                        <option value="">Seleccionar</option>
                        <option value="Efectivo BS">Efectivo BS</option>
                        <option value="Efectivo USD">Efectivo USD</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Pago M√≥vil">Pago M√≥vil</option>
                        <option value="Cr√©dito">Cr√©dito</option>
                        <option value="Mixto">Mixto</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="document-type">Tipo de Documento</label>
                    <select id="document-type" required onchange="toggleFiscalBreakdown()">
                        <option value="">Seleccionar</option>
                        <option value="Factura">Factura (con IVA desglosado)</option>
                        <option value="Nota de Entrega">Nota de Entrega</option>
                    </select>
                </div>
                
                <!-- Panel de Adelantos del Cliente -->
                <div id="customer-adelanto-panel" style="display: none; background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #4caf50;">
                    <h4 style="margin-bottom: 10px; color: #2e7d32;">üí∞ Adelanto Disponible</h4>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span><strong>Saldo Disponible:</strong></span>
                            <strong style="color: #2e7d32; font-size: 18px;" id="adelanto-saldo-disponible">0.00 BS</strong>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="usar-adelanto" onchange="toggleUseAdelanto()" style="width: auto;">
                                <span>Usar adelanto para pagar esta venta</span>
                            </label>
                        </div>
                        <div id="adelanto-usage-detail" style="display: none; background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>Monto a descontar:</span>
                                <strong id="adelanto-monto-usado">0.00 BS</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Saldo restante:</span>
                                <strong style="color: #2e7d32;" id="adelanto-saldo-restante">0.00 BS</strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Desglose Fiscal (visible solo con Factura) -->
                <div id="fiscal-breakdown" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="margin-bottom: 10px; color: var(--primary);">üíº Desglose Fiscal</h4>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Subtotal (Base):</span>
                            <strong id="fiscal-subtotal">0.00 BS</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>IVA (16%):</span>
                            <strong id="fiscal-iva">0.00 BS</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; border-top: 1px solid #ddd; padding-top: 8px;">
                            <span>Total con IVA:</span>
                            <strong id="fiscal-total-iva">0.00 BS</strong>
                        </div>
                        <div id="fiscal-retenciones" style="display: none; border-top: 1px solid #ddd; padding-top: 8px;">
                            <div style="display: flex; justify-content: space-between; color: #e74c3c;">
                                <span id="retencion-iva-label"></span>
                                <strong id="retencion-iva-amount">0.00 BS</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: #e74c3c;">
                                <span id="retencion-isr-label"></span>
                                <strong id="retencion-isr-amount">0.00 BS</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; border-top: 2px solid #333; padding-top: 8px; margin-top: 8px;">
                                <span><strong>Total a Cobrar:</strong></span>
                                <strong style="font-size: 20px; color: var(--primary);" id="fiscal-neto">0.00 BS</strong>
                            </div>
                            
                            <!-- Deducci√≥n por Adelanto -->
                            <div id="fiscal-adelanto-section" style="display: none; border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px;">
                                <div style="display: flex; justify-content: space-between; color: #4caf50;">
                                    <span>- Adelanto del Cliente:</span>
                                    <strong id="fiscal-adelanto-usado">0.00 BS</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; border-top: 2px solid #4caf50; padding-top: 8px; margin-top: 8px;">
                                    <span><strong>Total Final a Pagar:</strong></span>
                                    <strong style="font-size: 22px; color: #4caf50;" id="fiscal-total-final">0.00 BS</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="sale-notes">Notas</label>
                    <textarea id="sale-notes" rows="2" placeholder="Notas adicionales..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="saveSale()">
                    <i class="fas fa-save"></i> Registrar Venta
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Historial de Ventas</div>
                </div>
                
                <!-- Filtro de clientes -->
                <div class="form-group" style="padding: 15px;">
                    <label for="filter-sales-client">Filtrar por Cliente</label>
                    <select id="filter-sales-client" onchange="filterSalesHistory()" style="width: 100%; max-width: 400px;">
                        <option value="">Todos los clientes</option>
                    </select>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Productos</th>
                                <th>Total BS</th>
                                <th>Total USD</th>
                                <th>M√©todo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="sales-history">
                            <!-- El historial de ventas se cargar√° aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Precios Tab -->
        <div id="prices" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Configuraci√≥n de Tasas e IVA</div>
                </div>
                
                <div class="form-group">
                    <label for="iva-percentage">Porcentaje de IVA (%)</label>
                    <input type="number" id="iva-percentage" step="0.01" min="0" max="100" value="16" inputmode="decimal">
                </div>
                
                <div class="form-group">
                    <label for="price-exchange-rate">Tasa de Cambio para Precios (BS por USD)</label>
                    <input type="number" id="price-exchange-rate" step="0.01" min="0" value="38.50" inputmode="decimal" readonly
                           style="background:#f0f4ff;color:#4A5FC4;font-weight:700;">
                    <small>‚úÖ Se actualiza autom√°ticamente desde el registro de Tasas BCV ‚Äî no editar aqu√≠</small>
                </div>
                
                <button class="btn btn-secondary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Guardar Configuraci√≥n
                </button>
            </div>
            
            <!-- Gesti√≥n de Tasas BCV Hist√≥ricas -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üìÖ Gesti√≥n de Tasas BCV Hist√≥ricas</div>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #1976d2; font-size: 14px;">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Registra tasas BCV de d√≠as anteriores</strong> para calcular correctamente los abonos con fecha hist√≥rica.
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="bcv-rate-date">Fecha de la Tasa</label>
                    <input type="date" id="bcv-rate-date" style="width: 100%; max-width: 300px;">
                </div>
                
                <div class="form-group">
                    <label for="bcv-rate-value">Tasa BCV (BS/USD)</label>
                    <input type="number" id="bcv-rate-value" step="0.01" min="0" placeholder="Ej: 39.50" style="width: 100%; max-width: 300px;" inputmode="decimal">
                </div>
                
                <button class="btn btn-primary" onclick="registrarTasaBCV()">
                    <i class="fas fa-plus"></i> Registrar Tasa BCV
                </button>
                
                <!-- Historial de Tasas -->
                <div style="margin-top: 25px;">
                    <h4 style="margin-bottom: 15px; font-size: 16px;">üìä Historial de Tasas Registradas</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tasa (BS/USD)</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="bcv-rates-history">
                                <tr>
                                    <td colspan="3" style="text-align: center; color: #999; padding: 20px;">
                                        No hay tasas registradas
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Formulario para crear nuevos productos -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚ûï Crear Nuevo Producto</div>
                </div>
                
                <div class="form-group">
                    <label for="new-product-key">Clave del Producto (sin espacios)</label>
                    <input type="text" id="new-product-key" placeholder="Ej: filtro_agua" pattern="[a-z_]+" required>
                    <small>Solo letras min√∫sculas y gui√≥n bajo (_). Ejemplo: filtro_agua, botellon_5lt</small>
                </div>
                
                <div class="form-group">
                    <label for="new-product-name">Nombre del Producto</label>
                    <input type="text" id="new-product-name" placeholder="Ej: Filtro de Agua" required>
                </div>
                
                <div class="form-group">
                    <label for="new-product-price">Precio en USD ($)</label>
                    <input type="number" id="new-product-price" step="0.01" min="0" placeholder="0.00" required inputmode="decimal">
                </div>
                
                <div class="form-group">
                    <label for="new-product-icon">√çcono (FontAwesome)</label>
                    <select id="new-product-icon">
                        <option value="fa-box">üì¶ Caja (fa-box)</option>
                        <option value="fa-tint">üíß Gota (fa-tint)</option>
                        <option value="fa-truck">üöö Cami√≥n (fa-truck)</option>
                        <option value="fa-building">üè¢ Edificio (fa-building)</option>
                        <option value="fa-snowflake">‚ùÑÔ∏è Copo nieve (fa-snowflake)</option>
                        <option value="fa-refresh">üîÑ Recarga (fa-refresh)</option>
                        <option value="fa-faucet">üö∞ Grifo (fa-faucet)</option>
                        <option value="fa-filter">üîç Filtro (fa-filter)</option>
                        <option value="fa-bottle-water">üç∂ Botella (fa-bottle-water)</option>
                        <option value="fa-star">‚≠ê Estrella (fa-star)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="new-product-iva" checked> Este producto incluye IVA
                    </label>
                </div>
                
                <button class="btn btn-primary" onclick="createNewProduct()">
                    <i class="fas fa-plus"></i> Crear Producto
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Gesti√≥n de Precios en D√≥lares</div>
                </div>
                
                <div class="form-group">
                    <label for="price-product">Producto</label>
                    <select id="price-product" required>
                        <option value="recarga_local">Recarga en Local</option>
                        <option value="recarga_domicilio">Recarga a Domicilio</option>
                        <option value="recarga_lejana">Recarga a Domicilio Lejana</option>
                        <option value="empresas_mayor">Empresas Mayor de 12 unidades</option>
                        <option value="botellon_nuevo">Botell√≥n Nuevo</option>
                        <option value="hielo">Hielo</option>
                        <option value="recarga_local_empresa">Recarga Local Empresa</option>
                        <option value="dispensador">Dispensador de Agua</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="new-price-usd">Nuevo Precio (USD $)</label>
                    <input type="number" id="new-price-usd" step="0.01" min="0" placeholder="Ej: 0.12" required inputmode="decimal">
                </div>
                
                <div class="form-group">
                    <label>Precio Calculado en BS:</label>
                    <div id="calculated-price-bs" style="padding: 10px; background: #f8f9fa; border-radius: 5px; font-weight: 600;">
                        $0.00 USD = 0.00 BS
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="price-notes">Notas del Cambio</label>
                    <textarea id="price-notes" rows="2" placeholder="Raz√≥n del cambio..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="updateWaterPrice()">
                    <i class="fas fa-save"></i> Actualizar Precio
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Precios Actuales</div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Precio (USD)</th>
                                <th>Precio (BS)</th>
                                <th>IVA</th>
                                <th>√öltima Actualizaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="current-prices-table">
                            <!-- Los precios actuales se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Historial de Cambios de Precios</div>
                </div>
                <div class="table-container">
                    <table class="price-history-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Producto</th>
                                <th>Precio Anterior (USD)</th>
                                <th>Precio Nuevo (USD)</th>
                                <th>Tasa Cambio</th>
                                <th>Notas</th>
                            </tr>
                        </thead>
                        <tbody id="price-history">
                            <!-- El historial de precios se cargar√° aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ===== B5: SECCI√ìN KITS / PRODUCTOS COMPUESTOS ===== -->
            <div class="card" style="margin-top:15px;">
                <div class="card-header">
                    <div class="card-title">üß© Kits (Productos Compuestos)</div>
                    <button class="btn btn-primary btn-small" onclick="abrirKitModal()">
                        <i class="fas fa-plus"></i> Nuevo Kit
                    </button>
                </div>
                <div style="padding:12px;">
                    <p style="color:#666; font-size:13px; margin:0 0 12px;">
                        Los kits combinan m√∫ltiples productos del inventario en un solo √≠tem de venta. 
                        El stock disponible se calcula autom√°ticamente.
                    </p>
                    <div id="kits-list-container">
                        <div style="text-align:center; color:#999; padding:20px;">
                            <i class="fas fa-cubes" style="font-size:32px; margin-bottom:8px; display:block;"></i>
                            No hay kits configurados. Crea uno para comenzar.
                        </div>
                    </div>
                </div>
            </div>
            <!-- ===== FIN B5 ===== -->
        </div>

        <!-- Configuraci√≥n Tab -->
        <div id="config" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Configuraci√≥n de Contactos</div>
                </div>
                
                <div class="config-section">
                    <div class="config-title">Configuraci√≥n WhatsApp</div>
                    <div class="form-group">
                        <label for="whatsapp-number">N√∫mero de WhatsApp</label>
                        <input type="text" id="whatsapp-number" placeholder="584241234567" value="584241234567">
                        <small>Formato: 584241234567 (sin +)</small>
                    </div>
                    <div class="form-group">
                        <label for="whatsapp-message">Mensaje Predeterminado</label>
                        <textarea id="whatsapp-message" rows="3" placeholder="Mensaje que se enviar√° por WhatsApp">Hola, quiero hacer un pedido de agua</textarea>
                    </div>
                    <button class="btn btn-secondary" onclick="saveWhatsAppConfig()">
                        <i class="fas fa-save"></i> Guardar WhatsApp
                    </button>
                </div>
                
                <div class="config-section">
                    <div class="config-title">Configuraci√≥n Gmail</div>
                    <div class="form-group">
                        <label for="gmail-address">Email de Contacto</label>
                        <input type="email" id="gmail-address" placeholder="ventas@miempresa.com" value="ventas@aguapura.com" autocomplete="email" autocorrect="off" autocapitalize="off">
                    </div>
                    <div class="form-group">
                        <label for="gmail-subject">Asunto Predeterminado</label>
                        <input type="text" id="gmail-subject" placeholder="Asunto del email" value="Pedido de Agua">
                    </div>
                    <div class="form-group">
                        <label for="gmail-body">Cuerpo del Email</label>
                        <textarea id="gmail-body" rows="4" placeholder="Cuerpo del mensaje de email">Hola, me gustar√≠a hacer un pedido de agua con los siguientes detalles:</textarea>
                    </div>
                    <button class="btn btn-secondary" onclick="saveGmailConfig()">
                        <i class="fas fa-save"></i> Guardar Gmail
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Configuraci√≥n de Tasas de Cambio</div>
                </div>
                
                <div class="form-group">
                    <label for="manual-bcv-rate">D√≥lar BCV (BS)</label>
                    <input type="number" id="manual-bcv-rate" step="0.01" value="38.50" inputmode="decimal" readonly
                           style="background:#f0f4ff;color:#4A5FC4;font-weight:700;">
                    <small>‚úÖ Se actualiza autom√°ticamente desde el registro de Tasas BCV</small>
                </div>
                
                <div class="form-group">
                    <label for="manual-binance-rate">D√≥lar Binance (BS)</label>
                    <input type="number" id="manual-binance-rate" step="0.01" value="39.20" inputmode="decimal">
                </div>
                
                <button class="btn btn-primary" onclick="saveManualRates()">
                    <i class="fas fa-save"></i> Guardar Tasas Manuales
                </button>
            </div>

            <!-- ===== B7: GESTI√ìN DE USUARIOS ===== -->
            <div class="card" id="users-management-card" style="margin-top:15px;">
                <div class="card-header">
                    <div class="card-title">üë• Gesti√≥n de Usuarios</div>
                    <button class="btn btn-primary btn-small" onclick="abrirUserModal()">
                        <i class="fas fa-plus"></i> Nuevo Usuario
                    </button>
                </div>
                <div style="padding:12px;">
                    <p style="color:#666; font-size:13px; margin:0 0 12px;">
                        Administra los usuarios del sistema. Cada usuario tiene un PIN y permisos seg√∫n su rol.
                    </p>
                    <div id="users-list-container"></div>
                </div>
            </div>
            <!-- ===== FIN B7 ===== -->

            <!-- ===== B8: SINCRONIZACI√ìN GOOGLE SHEETS ===== -->
            <div class="card" id="sync-config-card" style="margin-top:15px;">
                <div class="card-header">
                    <div class="card-title">üîÑ Sincronizaci√≥n con Google Sheets</div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <span id="sync-status-badge" style="font-size:12px; padding:4px 12px; border-radius:20px; background:#e0e0e0; color:#666;">‚ö´ No configurado</span>
                        <button class="btn btn-primary btn-small" onclick="ejecutarSyncManual()" id="btn-sync-manual" disabled>
                            <i class="fas fa-sync"></i> Sincronizar
                        </button>
                    </div>
                </div>
                <div style="padding:15px;">

                    <!-- URL del Apps Script -->
                    <div class="form-group">
                        <label>URL del Google Apps Script WebApp *</label>
                        <input type="url" id="sync-apps-script-url"
                            placeholder="https://script.google.com/macros/s/AKfy.../exec"
                            style="font-size:12px; font-family:monospace;">
                        <small style="color:#888;">Despliega el script como WebApp y pega la URL aqu√≠. Ver instrucciones adjuntas.</small>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div class="form-group">
                            <label>Frecuencia Autom√°tica</label>
                            <select id="sync-frecuencia">
                                <option value="0">Manual solamente</option>
                                <option value="5" selected>Cada 5 minutos</option>
                                <option value="15">Cada 15 minutos</option>
                                <option value="30">Cada 30 minutos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Modo</label>
                            <select id="sync-modo">
                                <option value="bidireccional" selected>‚Üî Bidireccional</option>
                                <option value="solo_subir">‚Üë Solo subir (push)</option>
                                <option value="solo_bajar">‚Üì Solo bajar (pull)</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="guardarConfigSync()">
                        <i class="fas fa-save"></i> Guardar Configuraci√≥n Sync
                    </button>

                    <!-- Estado y estad√≠sticas -->
                    <div id="sync-stats-panel" style="display:none; background:#f8f9fa; border-radius:8px; padding:14px; margin-top:14px;">
                        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:10px; text-align:center; font-size:13px; margin-bottom:12px;">
                            <div style="background:white; border-radius:6px; padding:8px;">
                                <div style="color:#888; font-size:11px;">PENDIENTES</div>
                                <div id="sync-pendientes-count" style="font-weight:700; font-size:20px; color:#ff9800;">0</div>
                            </div>
                            <div style="background:white; border-radius:6px; padding:8px;">
                                <div style="color:#888; font-size:11px;">√öLTIMA SYNC</div>
                                <div id="sync-ultima-fecha" style="font-weight:600; font-size:12px; color:#4caf50;">‚Äî</div>
                            </div>
                            <div style="background:white; border-radius:6px; padding:8px;">
                                <div style="color:#888; font-size:11px;">ENVIADOS HOY</div>
                                <div id="sync-enviados-hoy" style="font-weight:700; font-size:20px; color:#1565c0;">0</div>
                            </div>
                            <div style="background:white; border-radius:6px; padding:8px;">
                                <div style="color:#888; font-size:11px;">ERRORES</div>
                                <div id="sync-errores-count" style="font-weight:700; font-size:20px; color:#f44336;">0</div>
                            </div>
                        </div>
                        <div style="font-size:12px; color:#666;" id="sync-progress-msg"></div>
                    </div>

                    <!-- Cola de pendientes -->
                    <div style="margin-top:14px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span style="font-weight:600; font-size:14px;">üìã Cola de Sincronizaci√≥n</span>
                            <div style="display:flex; gap:6px;">
                                <button class="btn btn-small btn-warning" onclick="limpiarColaSync()" title="Limpiar cola">
                                    <i class="fas fa-trash"></i> Limpiar Cola
                                </button>
                                <button class="btn btn-small" style="background:#e3f2fd; color:#1565c0;" onclick="loadSyncQueueDisplay()">
                                    <i class="fas fa-refresh"></i>
                                </button>
                            </div>
                        </div>
                        <div id="sync-cola-container" style="max-height:200px; overflow-y:auto;">
                            <div style="color:#999; text-align:center; padding:16px; font-size:13px;">Cola vac√≠a ‚Äî todo sincronizado ‚úÖ</div>
                        </div>
                    </div>

                    <!-- SyncLog -->
                    <div style="margin-top:14px;">
                        <div style="font-weight:600; font-size:14px; margin-bottom:8px;">üìú Historial de Sincronizaci√≥n</div>
                        <div id="sync-log-container" style="max-height:180px; overflow-y:auto; font-size:12px; font-family:monospace;"></div>
                    </div>
                </div>
            </div>
            <!-- ===== FIN B8 ===== -->

            <!-- ===== B9: NOTIFICACIONES Y PWA ===== -->
            <div class="card" id="pwa-config-card" style="margin-top:15px;">
                <div class="card-header">
                    <div class="card-title">üîî Notificaciones y PWA</div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <span id="notif-status-badge" style="font-size:12px; padding:4px 12px; border-radius:20px; background:#e0e0e0; color:#666;">‚ö´ No activadas</span>
                        <button class="btn btn-primary btn-small" onclick="solicitarPermisoNotificaciones()" id="btn-activar-notif">
                            <i class="fas fa-bell"></i> Activar
                        </button>
                    </div>
                </div>
                <div style="padding:15px;">

                    <!-- Instalar PWA -->
                    <div id="pwa-install-banner" style="display:none; background:linear-gradient(135deg,#667eea,#764ba2); color:white; border-radius:10px; padding:14px 18px; margin-bottom:16px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
                        <div>
                            <div style="font-weight:700; font-size:15px;">üì≤ Instalar AQUANEV como App</div>
                            <div style="font-size:12px; opacity:.85; margin-top:3px;">Accede desde la pantalla de inicio sin abrir el navegador</div>
                        </div>
                        <button class="btn btn-small" onclick="instalarPWA()" style="background:white; color:#667eea; font-weight:700; white-space:nowrap;">
                            Instalar App
                        </button>
                    </div>

                    <!-- Estado del SW -->
                    <div style="background:#f8f9fa; border-radius:8px; padding:12px; margin-bottom:14px; font-size:13px;">
                        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:10px; text-align:center;">
                            <div style="background:white; border-radius:6px; padding:8px;">
                                <div style="color:#888; font-size:11px;">SERVICE WORKER</div>
                                <div id="sw-status-val" style="font-weight:700; color:#9e9e9e;">‚ö´ ‚Äî</div>
                            </div>
                            <div style="background:white; border-radius:6px; padding:8px;">
                                <div style="color:#888; font-size:11px;">NOTIFICACIONES</div>
                                <div id="notif-perm-val" style="font-weight:700; color:#9e9e9e;">‚ö´ ‚Äî</div>
                            </div>
                            <div style="background:white; border-radius:6px; padding:8px;">
                                <div style="color:#888; font-size:11px;">CACH√â APP</div>
                                <div id="cache-status-val" style="font-weight:700; color:#9e9e9e;">‚ö´ ‚Äî</div>
                            </div>
                            <div style="background:white; border-radius:6px; padding:8px;">
                                <div style="color:#888; font-size:11px;">MODO OFFLINE</div>
                                <div id="online-status-val" style="font-weight:700; color:#4caf50;">üü¢ Online</div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuraci√≥n de alertas -->
                    <div style="font-weight:600; margin-bottom:10px; font-size:14px;">‚öôÔ∏è Tipos de Alerta</div>
                    <div id="notif-config-list" style="display:grid; gap:6px;">

                        <label style="display:flex; align-items:center; gap:10px; padding:8px 10px; background:#f8f9fa; border-radius:6px; cursor:pointer; font-size:13px;">
                            <input type="checkbox" id="notif-sync" checked onchange="guardarNotifConfig()">
                            <span>‚úÖ Sincronizaci√≥n completada</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 10px; background:#f8f9fa; border-radius:6px; cursor:pointer; font-size:13px;">
                            <input type="checkbox" id="notif-conflicto" checked onchange="guardarNotifConfig()">
                            <span>‚ö†Ô∏è Conflictos de sincronizaci√≥n resueltos</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 10px; background:#f8f9fa; border-radius:6px; cursor:pointer; font-size:13px;">
                            <input type="checkbox" id="notif-offline" checked onchange="guardarNotifConfig()">
                            <span>üì¥ Sin conexi√≥n (con pendientes en cola)</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 10px; background:#f8f9fa; border-radius:6px; cursor:pointer; font-size:13px;">
                            <input type="checkbox" id="notif-credito-prox" checked onchange="guardarNotifConfig()">
                            <span>üí∞ Cr√©dito pr√≥ximo a vencer</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 10px; background:#f8f9fa; border-radius:6px; cursor:pointer; font-size:13px;">
                            <input type="checkbox" id="notif-credito-venc" checked onchange="guardarNotifConfig()">
                            <span>üö® Cr√©dito vencido</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 10px; background:#f8f9fa; border-radius:6px; cursor:pointer; font-size:13px;">
                            <input type="checkbox" id="notif-stock-bajo" checked onchange="guardarNotifConfig()">
                            <span>üì¶ Stock bajo en inventario</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 10px; background:#f8f9fa; border-radius:6px; cursor:pointer; font-size:13px;">
                            <input type="checkbox" id="notif-agotado" checked onchange="guardarNotifConfig()">
                            <span>üö´ Producto agotado</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 10px; background:#f8f9fa; border-radius:6px; cursor:pointer; font-size:13px;">
                            <input type="checkbox" id="notif-cuota" checked onchange="guardarNotifConfig()">
                            <span>‚è∞ Cuota de pr√©stamo pr√≥xima a vencer</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 10px; background:#f8f9fa; border-radius:6px; cursor:pointer; font-size:13px;">
                            <input type="checkbox" id="notif-backup" checked onchange="guardarNotifConfig()">
                            <span>üìÖ Backup / sincronizaci√≥n necesaria</span>
                        </label>

                    </div>

                    <div style="display:flex; gap:8px; margin-top:14px; flex-wrap:wrap;">
                        <button class="btn btn-small" style="background:#e3f2fd; color:#1565c0;" onclick="enviarNotifPrueba()">
                            <i class="fas fa-paper-plane"></i> Enviar Notificaci√≥n de Prueba
                        </button>
                        <button class="btn btn-small btn-warning" onclick="limpiarCacheSW()">
                            <i class="fas fa-trash"></i> Limpiar Cach√©
                        </button>
                    </div>

                    <!-- Log de notificaciones recientes -->
                    <div style="margin-top:14px;">
                        <div style="font-weight:600; font-size:13px; margin-bottom:6px;">üìã √öltimas Notificaciones</div>
                        <div id="notif-log-container" style="max-height:140px; overflow-y:auto; font-size:12px; font-family:monospace; background:#f8f9fa; border-radius:6px; padding:8px;">
                            <span style="color:#aaa;">Sin notificaciones recientes</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ===== FIN B9 ===== -->
        </div>
        
        <!-- Gastos Tab -->
        <div id="expenses" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Registrar Gasto</div>
                </div>
                <form id="expense-form">
                    <!-- PASO 1: Fecha -->
                    <div class="form-group">
                        <label for="expense-date">Fecha *</label>
                        <input type="date" id="expense-date" required>
                    </div>

                    <!-- PASO 2: Categor√≠a (controla qu√© campos se muestran) -->
                    <div class="form-group">
                        <label for="expense-category">Categor√≠a *</label>
                        <select id="expense-category" required onchange="onExpenseCategoryChange()">
                            <option value="">Seleccione una categor√≠a</option>
                            <option value="Transporte">üöö Transporte</option>
                            <option value="Suministros">üß¥ Suministros</option>
                            <option value="Mantenimiento">üîß Mantenimiento</option>
                            <option value="Personal">üë§ Personal (Salarios/Sueldos)</option>
                            <option value="Cr√©dito">üè¶ Cr√©dito (Pago de Cuota)</option>
                            <option value="Otros">üìå Otros</option>
                        </select>
                    </div>

                    <!-- ===== PANEL CR√âDITO: Pago de cuota de pr√©stamo ===== -->
                    <div id="credito-pago-panel" style="display:none; background:#e8eaf6; border:2px solid #3f51b5; border-radius:10px; padding:16px; margin:10px 0;">
                        <div style="font-weight:700; color:#283593; margin-bottom:12px; font-size:15px;">üè¶ Pago de Cuota de Pr√©stamo</div>

                        <div class="form-group">
                            <label>Pr√©stamo *</label>
                            <select id="credito-prestamo-sel" onchange="onCreditoPrestSelChange()">
                                <option value="">‚Äî Seleccionar pr√©stamo activo ‚Äî</option>
                            </select>
                        </div>

                        <div id="credito-cuotas-panel" style="display:none;">
                            <div class="form-group">
                                <label>Cuota a pagar *</label>
                                <select id="credito-cuota-sel" onchange="onCreditoCuotaSelChange()">
                                    <option value="">‚Äî Seleccionar cuota ‚Äî</option>
                                </select>
                            </div>

                            <!-- Info de la cuota seleccionada -->
                            <div id="credito-cuota-info" style="display:none; background:white; border-radius:8px; padding:12px; margin:10px 0; border-left:4px solid #3f51b5;">
                            </div>

                            <!-- Tipo de pago -->
                            <div class="form-group">
                                <label>Tipo de Pago *</label>
                                <div style="display:flex; gap:12px; margin-top:6px; flex-wrap:wrap;">
                                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:10px 16px; border:2px solid #3f51b5; border-radius:8px; background:white;">
                                        <input type="radio" name="credito-tipo-pago" value="completo" onchange="onCreditoTipoPagoChange()" style="width:auto;">
                                        <span>‚úÖ Pago Completo</span>
                                    </label>
                                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:10px 16px; border:2px solid #ff9800; border-radius:8px; background:white;">
                                        <input type="radio" name="credito-tipo-pago" value="parcial" onchange="onCreditoTipoPagoChange()" style="width:auto;">
                                        <span>‚ö†Ô∏è Pago Parcial</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Monto parcial (solo si parcial) -->
                            <div id="credito-monto-parcial-panel" style="display:none;" class="form-group">
                                <label for="credito-monto-parcial">Monto Pagado (USD) *</label>
                                <input type="number" id="credito-monto-parcial" step="0.01" min="0.01" placeholder="0.00" inputmode="decimal" oninput="onCreditoMontoParcialInput()">
                                <small id="credito-parcial-hint" style="color:#e65100;"></small>
                            </div>

                            <!-- Resumen del pago cr√©dito -->
                            <div id="credito-resumen" style="display:none; background:#e8f5e9; border-radius:8px; padding:12px; margin-top:10px; border-left:4px solid #4caf50;">
                            </div>
                        </div>
                    </div>

                    <!-- ===== CAMPOS NORMALES (ocultos en Cr√©dito) ===== -->
                    <div id="expense-campos-normales">
                        <div class="form-group">
                            <label for="expense-supplier">Proveedor</label>
                            <input type="text" id="expense-supplier" placeholder="Nombre del proveedor" list="gastos-proveedores-list" oninput="onGastosProveedorChange()">
                            <datalist id="gastos-proveedores-list"></datalist>
                        </div>
                        <div class="form-group">
                            <label for="expense-description">Descripci√≥n *</label>
                            <input type="text" id="expense-description" placeholder="Descripci√≥n del gasto">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="expense-invoice-number">N¬∫ Factura</label>
                                <input type="text" id="expense-invoice-number" placeholder="Ej: 00001234">
                            </div>
                            <div class="form-group">
                                <label for="expense-document-type">Tipo Documento *</label>
                                <select id="expense-document-type" onchange="onExpenseDocTypeChange()">
                                    <option value="">Seleccionar</option>
                                    <option value="Factura">Factura</option>
                                    <option value="Nota de Entrega">Nota de Entrega</option>
                                    <option value="Recibo">Recibo</option>
                                    <option value="Sin Documento">Sin Documento</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="expense-amount">Monto (USD) *</label>
                                <input type="number" id="expense-amount" step="0.01" min="0" oninput="calculateExpenseAmounts(); updateHieloAdelantoUsage()" inputmode="decimal">
                            </div>
                            <!-- IVA: oculto para Personal y Cr√©dito -->
                            <div class="form-group" id="expense-iva-group">
                                <label for="expense-iva">IVA (%)</label>
                                <input type="number" id="expense-iva" step="0.01" min="0" max="16" value="16" oninput="calculateExpenseAmounts()" inputmode="decimal">
                                <small id="expense-iva-hint">Rango: 12% - 16%</small>
                            </div>
                        </div>

                        <!-- Mostrar montos calculados -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <strong>Total USD:</strong>
                                    <div id="expense-total-usd" style="font-size: 18px; color: var(--primary);">$0.00 USD</div>
                                </div>
                                <div id="expense-iva-display-group">
                                    <strong>IVA incluido:</strong>
                                    <div id="expense-total-bs" style="font-size: 14px; color: #666;">‚Äî</div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;" id="expense-base-row">
                                <small>Base: <span id="expense-base-bs">0.00</span> USD | IVA: <span id="expense-iva-bs">0.00</span> USD</small>
                            </div>
                        </div>
                    </div>

                    <!-- ===== PANEL DE COMPRAS (actualiza inventario) ===== -->
                    <div id="compras-inventario-panel" style="display:none; background:#e8f5e9; border:2px solid #4caf50; border-radius:10px; padding:16px; margin:10px 0;">
                        <div style="font-weight:700; color:#2e7d32; margin-bottom:12px; font-size:15px;">üì¶ √çtems de Compra ‚Üí Inventario</div>

                        <!-- Agregar √≠tem -->
                        <div style="background:white; border-radius:8px; padding:12px; margin-bottom:12px;">
                            <div style="display:grid; grid-template-columns:1fr 80px 100px; gap:10px; align-items:end;">
                                <div class="form-group" style="margin:0;">
                                    <label style="font-size:12px;">Producto de Inventario</label>
                                    <select id="compra-producto-sel" onchange="onCompraProductoChange()">
                                        <option value="">Seleccionar‚Ä¶</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin:0;">
                                    <label style="font-size:12px;">Cantidad</label>
                                    <input type="number" id="compra-cantidad" value="1" min="1" step="1" oninput="updateCompraSubtotal()" inputmode="numeric">
                                </div>
                                <div class="form-group" style="margin:0;">
                                    <label style="font-size:12px;">Costo Unit. USD</label>
                                    <input type="number" id="compra-costo-unit" value="0" min="0" step="0.01" oninput="updateCompraSubtotal()" inputmode="decimal">
                                </div>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                                <small id="compra-subtotal-preview" style="color:#2e7d32; font-weight:600;">Subtotal: $0.00 USD</small>
                                <button type="button" class="btn btn-success btn-small" onclick="agregarItemCompra()">
                                    <i class="fas fa-plus"></i> Agregar √≠tem
                                </button>
                            </div>
                        </div>

                        <!-- Lista de √≠tems agregados -->
                        <div id="compras-items-list" style="display:none; margin-bottom:10px;">
                            <div style="font-size:12px; color:#555; font-weight:600; margin-bottom:6px;">√çTEMS AGREGADOS:</div>
                            <div id="compras-items-container"></div>
                        </div>

                        <!-- Total compra en USD -->
                        <div style="background:white; border-radius:8px; padding:10px; display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:600; color:#333;">Total Compra:</span>
                            <span id="compras-total-usd" style="font-size:18px; font-weight:700; color:#2e7d32;">$0.00 USD</span>
                        </div>
                        <small style="color:#666; margin-top:6px; display:block;">‚ÑπÔ∏è Al guardar, el inventario se actualizar√° autom√°ticamente con el stock y costo promedio de cada √≠tem.</small>
                    </div>
                    
                    <!-- Panel de Adelantos para Hielo -->
                    <div id="hielo-adelanto-panel" style="display: none; background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196f3;">
                        <h4 style="margin-bottom: 10px; color: #1565c0;">‚ùÑÔ∏è Adelanto de Hielo Disponible</h4>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span><strong>Saldo Disponible:</strong></span>
                                <strong style="color: #1565c0; font-size: 18px;" id="hielo-saldo-disponible">0.00 BS</strong>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="usar-adelanto-hielo" onchange="toggleUseAdelantoHielo()" style="width: auto;">
                                    <span>Usar adelanto para pagar este gasto</span>
                                </label>
                            </div>
                            <div id="hielo-usage-detail" style="display: none; background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Monto a descontar del adelanto:</span>
                                    <strong id="hielo-monto-usado">$0.00 USD</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Saldo restante del adelanto:</span>
                                    <strong style="color: #1565c0;" id="hielo-saldo-restante">$0.00 USD</strong>
                                </div>
                                <div id="hielo-diferencia-row" style="display: none; justify-content: space-between; margin-top: 8px; padding-top: 8px; border-top: 2px solid #f44336;">
                                    <span style="font-weight: 700; color: #c62828;">üíµ Valor a pagar en efectivo:</span>
                                    <strong style="color: #c62828; font-size: 16px;" id="hielo-diferencia">$0.00 USD</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- M√©todo de pago (visible siempre excepto Cr√©dito que usa el del modal de pr√©stamos) -->
                    <div class="form-group" id="expense-metodo-pago-group">
                        <label for="expense-payment-method">Forma de Pago</label>
                        <select id="expense-payment-method">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Zelle">Zelle</option>
                            <option value="Divisas">Divisas</option>
                            <option value="Pago M√≥vil">Pago M√≥vil</option>
                            <option value="Punto de Venta">Punto de Venta</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Gasto
                    </button>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Historial de Gastos</div>
                    <div class="search-box">
                        <input type="text" id="expense-search" placeholder="Buscar en gastos...">
                    </div>
                </div>
                
                <!-- Filtro por fechas -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px;">
                    <div class="form-group">
                        <label for="expense-filter-from">Desde</label>
                        <input type="date" id="expense-filter-from" onchange="filterExpensesByDate()">
                    </div>
                    <div class="form-group">
                        <label for="expense-filter-to">Hasta</label>
                        <input type="date" id="expense-filter-to" onchange="filterExpensesByDate()">
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Descripci√≥n / √çtems</th>
                                <th>Categor√≠a</th>
                                <th>Monto</th>
                                <th>Documento</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-history">
                            <!-- El historial de gastos se cargar√° aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        

        <!-- Proveedores Tab -->
        <div id="proveedores" class="tab-content">

            <!-- Dashboard resumen -->
            <div id="prov-dashboard" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:10px; margin-bottom:14px;"></div>

            <!-- Bot√≥n nuevo proveedor -->
            <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                <button class="btn btn-primary" onclick="abrirProvModal()">
                    <i class="fas fa-plus"></i> Nuevo Proveedor
                </button>
            </div>

            <!-- Buscador -->
            <div class="card" style="margin-bottom:10px;">
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <input type="text" id="prov-search" placeholder="üîç Buscar proveedor..." oninput="filtrarProveedores()"
                        style="flex:1; min-width:180px; padding:9px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
                    <select id="prov-filtro-tipo" onchange="filtrarProveedores()" style="padding:9px; border:1px solid #ddd; border-radius:8px;">
                        <option value="todos">Todos</option>
                        <option value="gastos">Gastos</option>
                        <option value="compras">Compras</option>
                        <option value="ambos">Ambos</option>
                    </select>
                </div>
            </div>

            <!-- Lista de proveedores -->
            <div id="prov-lista-container"></div>

        </div>

        <!-- Modal Proveedor -->
        <div id="prov-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1500; justify-content:center; align-items:flex-start; overflow-y:auto; padding:16px 0;">
            <div style="background:white; border-radius:12px; width:92%; max-width:500px; margin:auto; display:flex; flex-direction:column; max-height:calc(100vh - 32px);">
                <div style="background:linear-gradient(135deg,#1565c0,#0d47a1); color:white; padding:14px 18px; display:flex; justify-content:space-between; align-items:center; border-radius:12px 12px 0 0; flex-shrink:0;">
                    <h3 id="prov-modal-title" style="margin:0; font-size:16px;">üè≠ Nuevo Proveedor</h3>
                    <span onclick="cerrarProvModal()" style="cursor:pointer; font-size:26px; line-height:1;">&times;</span>
                </div>
                <div style="padding:16px; overflow-y:auto; flex:1;">

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div class="form-group" style="grid-column:1/-1;">
                            <label>Nombre / Raz√≥n Social *</label>
                            <input type="text" id="prov-nombre" placeholder="Empresa o persona natural">
                        </div>
                        <div class="form-group">
                            <label>RIF / C√©dula</label>
                            <input type="text" id="prov-rif" placeholder="J-12345678-9">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" id="prov-telefono" placeholder="0414-1234567" inputmode="tel">
                        </div>
                        <div class="form-group" style="grid-column:1/-1;">
                            <label>Email</label>
                            <input type="email" id="prov-email" placeholder="proveedor@empresa.com">
                        </div>
                        <div class="form-group" style="grid-column:1/-1;">
                            <label>Direcci√≥n</label>
                            <input type="text" id="prov-direccion" placeholder="Direcci√≥n f√≠sica">
                        </div>
                        <div class="form-group" style="grid-column:1/-1;">
                            <label>Persona de Contacto</label>
                            <input type="text" id="prov-contacto" placeholder="Nombre del representante">
                        </div>
                    </div>

                    <!-- Uso -->
                    <div style="background:#f0f4ff; border-radius:10px; padding:12px; margin:10px 0; border:1px solid #c5cae9;">
                        <div style="font-weight:700; color:#3949ab; margin-bottom:10px; font-size:13px;">üìã Tipo de Proveedor</div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:8px 14px; border:2px solid #3f51b5; border-radius:8px; background:white; font-size:13px;">
                                <input type="checkbox" id="prov-tipo-gastos" style="width:auto;"> üí∏ Gastos
                            </label>
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:8px 14px; border:2px solid #4caf50; border-radius:8px; background:white; font-size:13px;">
                                <input type="checkbox" id="prov-tipo-compras" style="width:auto;"> üõí Compras
                            </label>
                        </div>
                    </div>

                    <!-- Tipos de documento que maneja -->
                    <div style="background:#f9f9f9; border-radius:10px; padding:12px; margin:10px 0; border:1px solid #e0e0e0;">
                        <div style="font-weight:700; color:#333; margin-bottom:10px; font-size:13px;">üìÑ Documentos que Emite</div>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:6px 12px; border:1px solid #ddd; border-radius:20px; background:white; font-size:13px;">
                                <input type="checkbox" id="prov-doc-factura" style="width:auto;"> üßæ Factura Fiscal
                            </label>
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:6px 12px; border:1px solid #ddd; border-radius:20px; background:white; font-size:13px;">
                                <input type="checkbox" id="prov-doc-nota-entrega" style="width:auto;"> üì¶ Nota de Entrega
                            </label>
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:6px 12px; border:1px solid #ddd; border-radius:20px; background:white; font-size:13px;">
                                <input type="checkbox" id="prov-doc-recibo" style="width:auto;"> üñäÔ∏è Recibo
                            </label>
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:6px 12px; border:1px solid #ddd; border-radius:20px; background:white; font-size:13px;">
                                <input type="checkbox" id="prov-doc-orden" style="width:auto;"> üìã Orden de Compra
                            </label>
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:6px 12px; border:1px solid #ddd; border-radius:20px; background:white; font-size:13px;">
                                <input type="checkbox" id="prov-doc-sin-doc" style="width:auto;"> ‚ùå Sin Documento
                            </label>
                        </div>
                    </div>

                    <!-- Condiciones comerciales -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px;">
                        <div class="form-group">
                            <label>D√≠as de Cr√©dito</label>
                            <input type="number" id="prov-dias-credito" min="0" value="0" placeholder="0 = Contado" inputmode="numeric">
                        </div>
                        <div class="form-group">
                            <label>Moneda Preferida</label>
                            <select id="prov-moneda">
                                <option value="USD">USD</option>
                                <option value="BS">Bol√≠vares</option>
                                <option value="Ambas">Ambas</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notas / Observaciones</label>
                        <textarea id="prov-notas" rows="2" placeholder="Condiciones especiales, horarios, etc." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; font-size:14px; resize:vertical; box-sizing:border-box;"></textarea>
                    </div>

                </div>
                <div style="padding:12px 16px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid #e0e0e0; flex-shrink:0; background:white; border-radius:0 0 12px 12px;">
                    <button class="btn btn-secondary" onclick="cerrarProvModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="guardarProveedor()" style="background:#1565c0;">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </div>
        </div>

        <!-- Cr√©ditos Tab -->
        <div id="credits" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Cr√©ditos Pendientes</div>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <select id="credit-filter-estado" onchange="loadPendingCredits()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
                            <option value="todos">Todos</option>
                            <option value="vencido">üî¥ Vencidos</option>
                            <option value="por_vencer">üü° Por Vencer</option>
                            <option value="vigente">üü¢ Vigentes</option>
                            <option value="Pendiente">Sin Vencimiento</option>
                        </select>
                    </div>
                </div>
                <!-- Alertas de cr√©ditos vencidos/por vencer -->
                <div id="credits-alerts-bar" style="display:none; padding: 10px 15px; border-radius: 8px; margin: 10px; font-size: 13px;"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Vencimiento</th>
                                <th>Monto Total USD</th>
                                <th>Abonado USD</th>
                                <th>Saldo USD</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="pending-credits">
                            <!-- Los cr√©ditos pendientes se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Adelantos Tab -->
        <div id="adelantos" class="tab-content">
            <!-- Adelantos de Clientes -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üíµ Registrar Adelanto de Cliente</div>
                </div>
                
                <form id="adelanto-cliente-form">
                    <div class="form-group">
                        <label for="adelanto-cliente">Cliente *</label>
                        <select id="adelanto-cliente" required>
                            <option value="">Seleccionar cliente</option>
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="adelanto-monto">Monto (USD) *</label>
                            <input type="number" id="adelanto-monto" step="0.01" min="0" placeholder="0.00" required inputmode="decimal">
                        </div>
                        
                        <div class="form-group">
                            <label for="adelanto-fecha">Fecha *</label>
                            <input type="date" id="adelanto-fecha" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="adelanto-forma-pago">Forma de Pago *</label>
                        <select id="adelanto-forma-pago" required>
                            <option value="">Seleccionar</option>
                            <option value="Efectivo BS">Efectivo BS</option>
                            <option value="Efectivo USD">Efectivo USD</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Pago M√≥vil">Pago M√≥vil</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="adelanto-concepto">Concepto</label>
                        <textarea id="adelanto-concepto" rows="2" placeholder="Adelanto para compras del mes..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Registrar Adelanto
                    </button>
                </form>
            </div>
            
            <!-- Lista de Adelantos de Clientes -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìã Adelantos de Clientes Activos</div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Monto Total USD</th>
                                <th>Usado USD</th>
                                <th>Saldo USD</th>
                                <th>Forma Pago</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="adelantos-clientes-list">
                            <!-- Se cargar√° din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Adelantos para Hielo -->
            <div class="card" style="display:none;">
                <div class="card-header">
                    <div class="card-title">‚ùÑÔ∏è Registrar Adelanto para Hielo</div>
                </div>
                
                <form id="adelanto-hielo-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="adelanto-hielo-monto">Monto (USD) *</label>
                            <input type="number" id="adelanto-hielo-monto" step="0.01" min="0" placeholder="0.00" required inputmode="decimal">
                        </div>
                        
                        <div class="form-group">
                            <label for="adelanto-hielo-fecha">Fecha *</label>
                            <input type="date" id="adelanto-hielo-fecha" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="adelanto-hielo-proveedor">Proveedor</label>
                        <input type="text" id="adelanto-hielo-proveedor" placeholder="Nombre del proveedor">
                    </div>
                    
                    <div class="form-group">
                        <label for="adelanto-hielo-concepto">Concepto</label>
                        <textarea id="adelanto-hielo-concepto" rows="2" placeholder="Adelanto para hielo del mes..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Registrar Adelanto
                    </button>
                </form>
            </div>
            
            <!-- Lista de Adelantos de Hielo -->
            <div class="card" style="display:none;">
                <div class="card-header">
                    <div class="card-title">üìã Adelantos de Hielo Activos</div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Proveedor</th>
                                <th>Monto Total USD</th>
                                <th>Gastado USD</th>
                                <th>Saldo USD</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="adelantos-hielo-list">
                            <!-- Se cargar√° din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Vista Ecuador Tab -->
        <div id="ecuador" class="tab-content">
            <div class="ecuador-view">
                <div class="ecuador-title">
                    <i class="fas fa-chart-line"></i> Vista Ecuador - Solo Lectura
                </div>
                <div class="ecuador-stats">
                    <div class="ecuador-stat">
                        <div class="ecuador-stat-title">Ventas del Mes</div>
                        <div class="ecuador-stat-value" id="ecuador-monthly-sales">$0.00 USD</div>
                    </div>
                    <div class="ecuador-stat">
                        <div class="ecuador-stat-title">Gastos del Mes</div>
                        <div class="ecuador-stat-value" id="ecuador-monthly-expenses">$0.00 USD</div>
                    </div>
                    <div class="ecuador-stat">
                        <div class="ecuador-stat-title">Balance Neto</div>
                        <div class="ecuador-stat-value" id="ecuador-net-balance">$0.00 USD</div>
                    </div>
                    <div class="ecuador-stat">
                        <div class="ecuador-stat-title">Cr√©ditos Pendientes</div>
                        <div class="ecuador-stat-value" id="ecuador-pending-credits">$0.00 USD</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Resumen Mensual</div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Concepto</th>
                                <th>Cantidad</th>
                                <th>Monto (USD)</th>
                            </tr>
                        </thead>
                        <tbody id="ecuador-summary">
                            <!-- El resumen se cargar√° aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Top 10 Clientes del Mes</div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Cliente</th>
                                <th>Compras</th>
                                <th>Total (USD)</th>
                            </tr>
                        </thead>
                        <tbody id="top-clients">
                            <!-- Los top clientes se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Pedidos Tab -->
        <div id="orders" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Registrar Pedido</div>
                </div>
                <form id="order-form">
                    <div class="form-group">
                        <label for="order-date">Fecha *</label>
                        <input type="date" id="order-date" required>
                    </div>
                    <div class="form-group">
                        <label for="order-customer">Cliente *</label>
                        <select id="order-customer" required>
                            <option value="">Seleccionar cliente</option>
                        </select>
                    </div>
                    
                    <!-- Selector de productos -->
                    <div class="card" style="background: #f8f9fa; padding: 15px; margin: 15px 0;">
                        <h4 style="margin-bottom: 10px;">üì¶ Productos del Pedido</h4>
                        <div id="order-products-list">
                            <!-- Productos se cargar√°n aqu√≠ -->
                        </div>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addProductToOrder()">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="order-notes">Notas</label>
                        <textarea id="order-notes" rows="3" placeholder="Detalles del pedido, direcci√≥n de entrega..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="order-status">Estado *</label>
                        <select id="order-status" required>
                            <option value="Pendiente">Pendiente</option>
                            <option value="En Ruta">En Ruta</option>
                            <option value="Entregado">Entregado</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Pedido
                    </button>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Historial de Pedidos</div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Productos</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="orders-history">
                            <!-- El historial de pedidos se cargar√° aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Reportes Tab -->
        <div id="reports" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Generar Reporte</div>
                </div>
                <form id="report-form">
                    <div class="form-group">
                        <label for="report-type">Tipo de Reporte</label>
                        <select id="report-type" required>
                            <option value="daily">Diario</option>
                            <option value="weekly">Semanal</option>
                            <option value="monthly">Mensual</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    <div class="form-group" id="custom-date-range" style="display: none;">
                        <label for="start-date">Fecha de Inicio</label>
                        <input type="date" id="start-date">
                        <label for="end-date">Fecha de Fin</label>
                        <input type="date" id="end-date">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-chart-bar"></i> Generar Reporte
                    </button>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Resumen del Reporte</div>
                </div>
                <div id="report-summary">
                    <!-- El resumen del reporte se cargar√° aqu√≠ -->
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìà Reporte de Ventas por Cliente</div>
                </div>
                
                <div class="form-group">
                    <label for="sales-report-client">Seleccionar Cliente</label>
                    <select id="sales-report-client">
                        <option value="">-- Todos los clientes --</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="sales-date-from">Desde</label>
                        <input type="date" id="sales-date-from">
                    </div>
                    <div class="form-group">
                        <label for="sales-date-to">Hasta</label>
                        <input type="date" id="sales-date-to">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="generateSalesReport()">
                    <i class="fas fa-chart-line"></i> Generar Reporte de Ventas
                </button>
                
                <button class="btn btn-secondary" onclick="downloadSalesReportTXT()" style="margin-left: 10px;">
                    <i class="fas fa-file-download"></i> Descargar TXT
                </button>
                
                <div id="sales-report-summary" style="margin-top: 20px;">
                    <!-- El reporte de ventas se cargar√° aqu√≠ -->
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìä Reporte de Cr√©ditos por Cliente</div>
                </div>
                
                <div class="form-group">
                    <label for="credit-report-client">Seleccionar Cliente</label>
                    <select id="credit-report-client">
                        <option value="">-- Todos los clientes --</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="credit-date-from">Desde</label>
                        <input type="date" id="credit-date-from">
                    </div>
                    <div class="form-group">
                        <label for="credit-date-to">Hasta</label>
                        <input type="date" id="credit-date-to">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="generateCreditReport()">
                    <i class="fas fa-file-invoice-dollar"></i> Generar Reporte de Cr√©ditos
                </button>
                
                <button class="btn btn-secondary" onclick="downloadCreditReportPDF()" style="margin-left: 10px;">
                    <i class="fas fa-file-pdf"></i> Descargar PDF
                </button>
                
                <div id="credit-report-summary" style="margin-top: 20px;">
                    <!-- El reporte de cr√©ditos se cargar√° aqu√≠ -->
                </div>
            </div>
            
            <!-- Secci√≥n de Exportaci√≥n -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üì• Exportar Datos Contables</div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">Filtros de Exportaci√≥n</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="export-date-from">Desde *</label>
                            <input type="date" id="export-date-from" required>
                        </div>
                        <div class="form-group">
                            <label for="export-date-to">Hasta *</label>
                            <input type="date" id="export-date-to" required>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <button class="btn btn-success" onclick="exportSalesToXLSX()">
                        <i class="fas fa-file-excel"></i> Exportar Ventas XLSX
                    </button>
                    <button class="btn btn-success" onclick="exportExpensesToXLSX()">
                        <i class="fas fa-file-excel"></i> Exportar Gastos XLSX
                    </button>
                    <button class="btn btn-success" onclick="exportCreditsToXLSX()">
                        <i class="fas fa-file-excel"></i> Exportar Cr√©ditos XLSX
                    </button>
                    <button class="btn btn-primary" onclick="exportAllToXLSX()">
                        <i class="fas fa-download"></i> Exportar Todo XLSX
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                    <h5 style="margin-bottom: 10px;">üìã Informaci√≥n de Exportaci√≥n</h5>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><strong>Ventas XLSX:</strong> Formato Excel con cliente, RIF, productos, IVA desglosado, retenciones, adelantos</li>
                        <li><strong>Gastos XLSX:</strong> Formato Excel con descripci√≥n, factura, tipo documento, IVA editable, adelantos</li>
                        <li><strong>Cr√©ditos XLSX:</strong> Formato Excel con cliente, monto, abonos detallados, saldo, forma de pago</li>
                        <li><strong>Todo:</strong> Archivo Excel con 3 hojas (Ventas, Gastos, Cr√©ditos) del per√≠odo seleccionado</li>
                    </ul>
                </div>
            </div>

            <!-- ===== B10: REPORTES AMPLIADOS ===== -->

            <!-- Reporte 1: Estado de Inventario -->
            <div class="card" style="margin-top:12px;">
                <div class="card-header">
                    <div class="card-title">üì¶ Reporte ‚Äî Estado de Inventario</div>
                    <button class="btn btn-small" style="background:#e8f5e9;color:#2e7d32;" onclick="exportReporteInventarioXLSX()">
                        <i class="fas fa-file-excel"></i> XLSX
                    </button>
                </div>
                <div style="padding:12px;">
                    <button class="btn btn-primary" onclick="generarReporteInventario()">
                        <i class="fas fa-boxes"></i> Generar
                    </button>
                </div>
                <div id="rep-inventario-result" style="padding:0 12px 12px;"></div>
            </div>

            <!-- Reporte 2: Cr√©ditos por Vencimiento -->
            <div class="card" style="margin-top:12px;">
                <div class="card-header">
                    <div class="card-title">üí∞ Reporte ‚Äî Cr√©ditos por Vencimiento</div>
                    <button class="btn btn-small" style="background:#e8f5e9;color:#2e7d32;" onclick="exportRepCreditosXLSX()">
                        <i class="fas fa-file-excel"></i> XLSX
                    </button>
                </div>
                <div style="padding:12px;">
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                        <select id="rep-creditos-estado" style="min-width:160px;">
                            <option value="todos">Todos los estados</option>
                            <option value="Pendiente">Pendientes</option>
                            <option value="vencido">Vencidos</option>
                            <option value="por_vencer">Por vencer</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="generarRepCreditosVencimiento()">
                        <i class="fas fa-calendar-times"></i> Generar
                    </button>
                </div>
                <div id="rep-creditos-result" style="padding:0 12px 12px;"></div>
            </div>

            <!-- Reporte 3: An√°lisis de Ventas -->
            <div class="card" style="margin-top:12px;">
                <div class="card-header">
                    <div class="card-title">üìà Reporte ‚Äî An√°lisis de Ventas por Producto</div>
                    <button class="btn btn-small" style="background:#e8f5e9;color:#2e7d32;" onclick="exportRepVentasXLSX()">
                        <i class="fas fa-file-excel"></i> XLSX
                    </button>
                </div>
                <div style="padding:12px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div>
                            <label style="font-size:12px; color:#666;">Desde</label>
                            <input type="date" id="rep-ventas-desde">
                        </div>
                        <div>
                            <label style="font-size:12px; color:#666;">Hasta</label>
                            <input type="date" id="rep-ventas-hasta">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generarRepAnalisisVentas()">
                        <i class="fas fa-chart-bar"></i> Generar
                    </button>
                </div>
                <div id="rep-ventas-result" style="padding:0 12px 12px;"></div>
            </div>

            <!-- Reporte 4: Estado de Pr√©stamos -->
            <div class="card" style="margin-top:12px;">
                <div class="card-header">
                    <div class="card-title">üè¶ Reporte ‚Äî Estado de Pr√©stamos</div>
                    <button class="btn btn-small" style="background:#e8f5e9;color:#2e7d32;" onclick="exportRepPrestamosXLSX()">
                        <i class="fas fa-file-excel"></i> XLSX
                    </button>
                </div>
                <div style="padding:12px;">
                    <button class="btn btn-primary" onclick="generarRepPrestamos()">
                        <i class="fas fa-landmark"></i> Generar
                    </button>
                </div>
                <div id="rep-prestamos-result" style="padding:0 12px 12px;"></div>
            </div>

            <!-- Reporte 5: Movimientos de Inventario -->
            <div class="card" style="margin-top:12px;">
                <div class="card-header">
                    <div class="card-title">üîÑ Reporte ‚Äî Movimientos de Inventario</div>
                    <button class="btn btn-small" style="background:#e8f5e9;color:#2e7d32;" onclick="exportRepMovimientosXLSX()">
                        <i class="fas fa-file-excel"></i> XLSX
                    </button>
                </div>
                <div style="padding:12px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
                        <div>
                            <label style="font-size:12px; color:#666;">Desde</label>
                            <input type="date" id="rep-mov-desde">
                        </div>
                        <div>
                            <label style="font-size:12px; color:#666;">Hasta</label>
                            <input type="date" id="rep-mov-hasta">
                        </div>
                        <div>
                            <label style="font-size:12px; color:#666;">Tipo</label>
                            <select id="rep-mov-tipo">
                                <option value="todos">Todos</option>
                                <option value="venta">Ventas</option>
                                <option value="compra">Compras</option>
                                <option value="ajuste">Ajustes</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generarRepMovimientos()">
                        <i class="fas fa-exchange-alt"></i> Generar
                    </button>
                </div>
                <div id="rep-movimientos-result" style="padding:0 12px 12px;"></div>
            </div>

            <!-- Reporte 6: Consignaciones Pendientes -->
            <div class="card" style="margin-top:12px;">
                <div class="card-header">
                    <div class="card-title">üì§ Reporte ‚Äî Consignaciones Pendientes</div>
                    <button class="btn btn-small" style="background:#e8f5e9;color:#2e7d32;" onclick="exportRepConsignacionesXLSX()">
                        <i class="fas fa-file-excel"></i> XLSX
                    </button>
                </div>
                <div style="padding:12px;">
                    <button class="btn btn-primary" onclick="generarRepConsignaciones()">
                        <i class="fas fa-box-open"></i> Generar
                    </button>
                </div>
                <div id="rep-consignaciones-result" style="padding:0 12px 12px;"></div>
            </div>
            <!-- ===== FIN B10 REPORTES ===== -->

        </div>
        
        <!-- Clientes Tab -->
        <!-- ===================== PR√âSTAMOS TAB B6 ===================== -->
        <div id="prestamos" class="tab-content">

            <!-- Dashboard -->
            <div class="stats-container">
                <div class="stat-card" style="border-left:4px solid #1565c0;">
                    <div class="stat-title">Pr√©stamos Activos</div>
                    <div class="stat-value" id="prest-activos-count" style="color:#1565c0;">0</div>
                    <div class="stat-desc">en curso</div>
                </div>
                <div class="stat-card" style="border-left:4px solid #f44336;">
                    <div class="stat-title">Deuda Total</div>
                    <div class="stat-value" id="prest-deuda-total" style="color:#f44336;">$0.00</div>
                    <div class="stat-desc">USD pendiente</div>
                </div>
                <div class="stat-card" style="border-left:4px solid #ff9800;">
                    <div class="stat-title">Cuota Mensual Total</div>
                    <div class="stat-value" id="prest-cuota-mes" style="color:#ff9800;">$0.00</div>
                    <div class="stat-desc">USD/mes comprometido</div>
                </div>
                <div class="stat-card" style="border-left:4px solid #4caf50;">
                    <div class="stat-title">Total Pagado</div>
                    <div class="stat-value" id="prest-pagado-total" style="color:#4caf50;">$0.00</div>
                    <div class="stat-desc">USD amortizado</div>
                </div>
            </div>

            <!-- Alerta cuotas pr√≥ximas -->
            <div id="prest-alertas-bar" style="display:none; background:#fff3e0; border:1px solid #ff9800; border-radius:8px; padding:12px 16px; margin-bottom:12px; font-size:13px;"></div>

            <!-- Nuevo pr√©stamo -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üè¶ Gesti√≥n de Pr√©stamos</div>
                    <button class="btn btn-primary" onclick="abrirPrestModal()">
                        <i class="fas fa-plus"></i> Nuevo Pr√©stamo
                    </button>
                </div>

                <!-- Filtro -->
                <div style="padding:12px 15px; border-bottom:1px solid #eee; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <select id="prest-filtro-estado" onchange="loadPrestamosList()" style="padding:6px 10px; border-radius:6px; border:1px solid #ddd; font-size:13px;">
                        <option value="todos">Todos</option>
                        <option value="activo">Activos</option>
                        <option value="finalizado">Finalizados</option>
                        <option value="cancelado">Cancelados</option>
                    </select>
                    <select id="prest-filtro-tipo" onchange="loadPrestamosList()" style="padding:6px 10px; border-radius:6px; border:1px solid #ddd; font-size:13px;">
                        <option value="todos">Todos los tipos</option>
                        <option value="banco">Banco</option>
                        <option value="persona">Persona</option>
                        <option value="empresa">Empresa</option>
                    </select>
                </div>

                <div id="prestamos-list-container" style="padding:12px;">
                    <div style="text-align:center; color:#999; padding:30px;">
                        <div style="font-size:48px; margin-bottom:12px;">üè¶</div>
                        <p>No hay pr√©stamos registrados.</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- ===================== FIN PR√âSTAMOS TAB B6 ===================== -->

        <!-- ===================== CONSIGNACIONES TAB B4 ===================== -->
        <div id="consignaciones" class="tab-content">

            <!-- Resumen -->
            <div class="stats-container">
                <div class="stat-card" style="border-left:4px solid #9c27b0;">
                    <div class="stat-title">En Poder Clientes</div>
                    <div class="stat-value" id="cons-activas-count" style="color:#9c27b0;">0</div>
                    <div class="stat-desc">consignaciones abiertas</div>
                </div>
                <div class="stat-card" style="border-left:4px solid #f44336;">
                    <div class="stat-title">Botellones Afuera</div>
                    <div class="stat-value" id="cons-botellones-out" style="color:#f44336;">0</div>
                    <div class="stat-desc">unidades pendientes</div>
                </div>
                <div class="stat-card" style="border-left:4px solid #ff9800;">
                    <div class="stat-title">Valor Expuesto</div>
                    <div class="stat-value" id="cons-valor-usd" style="color:#ff9800;">$0.00</div>
                    <div class="stat-desc">USD en calle</div>
                </div>
                <div class="stat-card" style="border-left:4px solid #4caf50;">
                    <div class="stat-title">Cobrado (mes)</div>
                    <div class="stat-value" id="cons-cobrado-mes" style="color:#4caf50;">$0.00</div>
                    <div class="stat-desc">USD este mes</div>
                </div>
            </div>

            <!-- Acciones -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìã Control de Consignaciones</div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="abrirNuevaConsignacion()">
                            <i class="fas fa-plus"></i> Nueva Entrega
                        </button>
                        <select id="cons-filtro" onchange="loadConsignacionesList()" style="padding:6px 10px; border-radius:6px; border:1px solid #ddd; font-size:13px;">
                            <option value="todos">Todas</option>
                            <option value="entregado">üì¶ Entregadas</option>
                            <option value="cobrado">‚úÖ Cobradas</option>
                            <option value="devuelto">‚Ü©Ô∏è Devueltas</option>
                            <option value="mixto">üîÄ Mixtas</option>
                        </select>
                    </div>
                </div>
                <div id="consignaciones-list" style="padding:10px;">
                    <div style="text-align:center; color:#999; padding:30px;">
                        <div style="font-size:48px; margin-bottom:12px;">üìã</div>
                        <p>No hay consignaciones registradas.</p>
                        <button class="btn btn-primary" onclick="abrirNuevaConsignacion()"><i class="fas fa-plus"></i> Crear primera entrega</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ===================== FIN CONSIGNACIONES TAB B4 ===================== -->

        <!-- ===================== COMPRAS TAB B3 ===================== -->
        <div id="compras" class="tab-content">

            <!-- Resumen de Compras -->
            <div class="stats-container" id="compras-stats-row">
                <div class="stat-card" style="border-left:4px solid #667eea;">
                    <div class="stat-title">Total Comprado (mes)</div>
                    <div class="stat-value" id="compras-mes-usd" style="color:#667eea;">$0.00</div>
                    <div class="stat-desc">USD este mes</div>
                </div>
                <div class="stat-card" style="border-left:4px solid #4caf50;">
                    <div class="stat-title">√ìrdenes este mes</div>
                    <div class="stat-value" id="compras-mes-count" style="color:#4caf50;">0</div>
                    <div class="stat-desc">registros</div>
                </div>
                <div class="stat-card" style="border-left:4px solid #ff9800;">
                    <div class="stat-title">Pendientes de Pago</div>
                    <div class="stat-value" id="compras-pendientes-count" style="color:#ff9800;">0</div>
                    <div class="stat-desc">√≥rdenes</div>
                </div>
                <div class="stat-card" style="border-left:4px solid #f44336;">
                    <div class="stat-title">Deuda Proveedores</div>
                    <div class="stat-value" id="compras-deuda-usd" style="color:#f44336;">$0.00</div>
                    <div class="stat-desc">USD pendiente</div>
                </div>
            </div>

            <!-- Formulario nueva compra -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üõí Registrar Compra</div>
                    <button class="btn btn-secondary btn-small" onclick="toggleComprasForm()">
                        <i class="fas fa-chevron-down" id="compras-form-icon"></i> Formulario
                    </button>
                </div>
                <div id="compras-form-container">
                    <!-- Datos generales -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div class="form-group">
                            <label>Fecha *</label>
                            <input type="date" id="c-fecha">
                        </div>
                        <div class="form-group">
                            <label>Proveedor *</label>
                            <input type="text" id="c-proveedor" placeholder="Nombre del proveedor" list="compras-proveedores-list" oninput="onComprasProveedorSelChange()">
                            <datalist id="compras-proveedores-list"></datalist>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div class="form-group">
                            <label>N¬∞ Factura</label>
                            <input type="text" id="c-factura" placeholder="F-001-0001">
                        </div>
                        <div class="form-group">
                            <label>M√©todo de Pago</label>
                            <select id="c-metodo-pago">
                                <option value="Efectivo USD">Efectivo USD</option>
                                <option value="Efectivo BS">Efectivo BS</option>
                                <option value="Transferencia">Transferencia</option>
                                <option value="Zelle">Zelle</option>
                                <option value="Pago M√≥vil">Pago M√≥vil</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Estado de Pago</label>
                            <select id="c-estado-pago">
                                <option value="pagado">Pagado</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="parcial">Parcial</option>
                            </select>
                        </div>
                    </div>

                    <!-- Agregar productos -->
                    <div style="background:#f8f9fa; border-radius:8px; padding:14px; margin-bottom:14px;">
                        <div style="font-weight:600; margin-bottom:10px; color:#555;">üì¶ Agregar Productos</div>
                        <div style="display:grid; grid-template-columns:1fr 90px 110px auto; gap:10px; align-items:end;">
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:12px;">Producto de Inventario</label>
                                <select id="c-item-producto" onchange="onCItemProductoChange()">
                                    <option value="">Seleccionar‚Ä¶</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:12px;">Cantidad</label>
                                <input type="number" id="c-item-cantidad" value="1" min="1" step="1" oninput="updateCItemPreview()" inputmode="numeric">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:12px;">Costo Unit. USD</label>
                                <input type="number" id="c-item-costo" value="0" min="0" step="0.01" oninput="updateCItemPreview()" inputmode="decimal">
                            </div>
                            <button type="button" class="btn btn-success btn-small" onclick="agregarCItem()" style="white-space:nowrap;">
                                <i class="fas fa-plus"></i> Agregar
                            </button>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                            <small id="c-item-preview" style="color:#2e7d32; font-weight:600;">Subtotal: $0.00</small>
                            <small style="color:#888;">üí° Puede agregar m√∫ltiples productos en una misma compra</small>
                        </div>
                    </div>

                    <!-- Lista de √≠tems de la compra -->
                    <div id="c-items-list" style="display:none; margin-bottom:14px;">
                        <div style="font-weight:600; color:#333; margin-bottom:8px; font-size:13px;">PRODUCTOS EN ESTA COMPRA:</div>
                        <div id="c-items-container"></div>
                    </div>

                    <!-- Totales y observaciones -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div class="form-group">
                            <label>Observaciones</label>
                            <textarea id="c-observaciones" rows="2" placeholder="Notas adicionales‚Ä¶" style="resize:vertical;"></textarea>
                        </div>
                        <div style="background:#e8f5e9; border-radius:8px; padding:14px; display:flex; flex-direction:column; justify-content:center; gap:8px;">
                            <div style="display:flex; justify-content:space-between; font-size:14px;">
                                <span>Subtotal:</span>
                                <strong id="c-total-preview">$0.00 USD</strong>
                            </div>
                            <div style="display:flex; justify-content:space-between; font-size:16px; border-top:2px solid #4caf50; padding-top:8px;">
                                <strong>Total Compra:</strong>
                                <strong id="c-total-final" style="color:#2e7d32; font-size:20px;">$0.00 USD</strong>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; justify-content:flex-end; gap:10px;">
                        <button class="btn btn-secondary" onclick="limpiarFormCompra()">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                        <button class="btn btn-primary" onclick="guardarCompra()">
                            <i class="fas fa-save"></i> Registrar Compra
                        </button>
                    </div>
                </div>
            </div>

            <!-- Historial de compras -->
            <div class="card" style="margin-top:15px;">
                <div class="card-header">
                    <div class="card-title">üìã Historial de Compras</div>
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <input type="text" id="compras-search" placeholder="Buscar proveedor, factura‚Ä¶"
                            oninput="filtrarCompras()" style="padding:6px 10px; border-radius:6px; border:1px solid #ddd; font-size:13px;">
                        <select id="compras-filtro-pago" onchange="filtrarCompras()" style="padding:6px 10px; border-radius:6px; border:1px solid #ddd; font-size:13px;">
                            <option value="todos">Todos</option>
                            <option value="pagado">Pagado</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="parcial">Parcial</option>
                        </select>
                        <div style="display:flex; gap:6px;">
                            <input type="date" id="compras-desde" onchange="filtrarCompras()" style="padding:6px; border-radius:6px; border:1px solid #ddd; font-size:13px;">
                            <input type="date" id="compras-hasta" onchange="filtrarCompras()" style="padding:6px; border-radius:6px; border:1px solid #ddd; font-size:13px;">
                        </div>
                    </div>
                </div>
                <div id="compras-historial-container" style="padding:10px;">
                    <div style="text-align:center; color:#999; padding:30px;">
                        <div style="font-size:40px; margin-bottom:8px;">üõí</div>
                        <p>No hay compras registradas a√∫n.</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- ===================== FIN COMPRAS TAB B3 ===================== -->

        <!-- ===================== INVENTARIO TAB B2 ===================== -->
        <div id="inventory" class="tab-content">

            <!-- Resumen de Inventario -->
            <div class="stats-container" id="inv-stats-container">
                <div class="stat-card" style="border-left: 4px solid #4caf50;">
                    <div class="stat-title">Normal</div>
                    <div class="stat-value" id="inv-normal-count" style="color:#4caf50;">0</div>
                    <div class="stat-desc">productos</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #ff9800;">
                    <div class="stat-title">Stock Bajo</div>
                    <div class="stat-value" id="inv-bajo-count" style="color:#ff9800;">0</div>
                    <div class="stat-desc">productos</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #f44336;">
                    <div class="stat-title">Agotados</div>
                    <div class="stat-value" id="inv-agotado-count" style="color:#f44336;">0</div>
                    <div class="stat-desc">productos</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #667eea;">
                    <div class="stat-title">Valor Total</div>
                    <div class="stat-value" id="inv-valor-total" style="color:#667eea;">$0.00</div>
                    <div class="stat-desc">USD en stock</div>
                </div>
            </div>

            <!-- Acciones y Alertas -->
            <div id="inv-alerts-bar" style="display:none; margin: 0 0 12px 0; padding: 10px 15px; border-radius: 8px; font-size: 13px;"></div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">üì¶ Control de Inventario</div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="showInvProductModal()">
                            <i class="fas fa-plus"></i> Nuevo Producto
                        </button>
                        <button class="btn btn-success" onclick="showAjusteStockModal()">
                            <i class="fas fa-sliders-h"></i> Ajustar Stock
                        </button>
                        <select id="inv-filter" onchange="loadInventoryList()" style="padding:6px 10px; border-radius:6px; border:1px solid #ddd; font-size:13px;">
                            <option value="todos">Todos</option>
                            <option value="normal">üü¢ Normal</option>
                            <option value="bajo">üü° Stock Bajo</option>
                            <option value="agotado">üî¥ Agotados</option>
                        </select>
                    </div>
                </div>

                <!-- Tarjetas de inventario -->
                <div id="inventory-cards" style="padding: 10px;">
                    <!-- Se carga din√°micamente -->
                </div>
            </div>

            <!-- Historial de Movimientos -->
            <div class="card" style="margin-top: 15px;">
                <div class="card-header">
                    <div class="card-title">üìã Historial de Movimientos</div>
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <select id="inv-mov-producto" onchange="loadMovimientosHistorial()" style="padding:6px 10px; border-radius:6px; border:1px solid #ddd; font-size:13px;">
                            <option value="todos">Todos los productos</option>
                        </select>
                        <select id="inv-mov-tipo" onchange="loadMovimientosHistorial()" style="padding:6px 10px; border-radius:6px; border:1px solid #ddd; font-size:13px;">
                            <option value="todos">Todos los tipos</option>
                            <option value="compra">Compras</option>
                            <option value="venta">Ventas</option>
                            <option value="ajuste">Ajustes</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Stock Anterior</th>
                                <th>Stock Nuevo</th>
                                <th>Referencia</th>
                            </tr>
                        </thead>
                        <tbody id="inv-movimientos-list">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- ===================== FIN INVENTARIO TAB ===================== -->

        <div id="clients" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Gesti√≥n de Clientes</div>
                    <button class="btn btn-primary" onclick="showAddClientModal()">
                        <i class="fas fa-plus"></i> Agregar Cliente
                    </button>
                </div>
                <div class="search-box">
                    <input type="text" id="client-search" placeholder="Buscar cliente...">
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente / RIF</th>
                                <th>Contacto</th>
                                <th>Cr√©dito</th>
                                <th>Retenciones</th>
                                <th>√öltima Compra</th>
                                <th>Total Compras USD</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clients-list">
                            <!-- La lista de clientes se cargar√° aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
    </div>
    </div>
    
    <footer>
        <div class="container">
            <p>&copy; 2023 Control de Ventas - Agua. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- Modal para agregar cliente -->
    <!-- Modal para seleccionar tipo de cliente -->
    <div id="client-type-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 450px; text-align: center;">
            <h3 style="margin-bottom: 20px; color: var(--primary);">¬øQu√© tipo de cliente deseas agregar?</h3>
            <p style="color: #666; margin-bottom: 30px;">Selecciona el tipo de cliente para continuar</p>
            
            <div style="display: grid; gap: 15px;">
                <button class="btn btn-primary" onclick="selectClientType('natural')" style="padding: 20px; font-size: 16px;">
                    <i class="fas fa-user"></i> Persona Natural
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.9;">RIF opcional</div>
                </button>
                <button class="btn btn-success" onclick="selectClientType('juridica')" style="padding: 20px; font-size: 16px;">
                    <i class="fas fa-building"></i> Persona Jur√≠dica
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.9;">RIF obligatorio</div>
                </button>
                <button class="btn btn-secondary" onclick="closeClientTypeModal()" style="margin-top: 10px;">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal para agregar cliente -->
    <div id="client-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="client-modal-title">Agregar Cliente</h3>
                <span onclick="closeClientModal()" style="cursor: pointer; font-size: 20px;">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-client-name">Nombre del Cliente *</label>
                    <input type="text" id="new-client-name" placeholder="Nombre del cliente" required>
                </div>
                <div class="form-group" id="rif-field-group">
                    <label for="new-client-rif" id="rif-label">RIF *</label>
                    <input type="text" id="new-client-rif" placeholder="J-12345678-9">
                    <small id="rif-hint">Formato: J-12345678-9 o V-12345678-9</small>
                </div>
                <div class="form-group">
                    <label for="new-client-contact">Contacto</label>
                    <input type="text" id="new-client-contact" placeholder="Tel√©fono o email">
                </div>
                <div class="form-group">
                    <label for="new-client-address">Direcci√≥n</label>
                    <textarea id="new-client-address" rows="2" placeholder="Direcci√≥n del cliente"></textarea>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="checkbox" id="new-client-retiene-iva" style="width: auto;">
                        <span>Retiene IVA (75%)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="new-client-retiene-isr" style="width: auto;">
                        <span>Retiene ISLR (2%)</span>
                    </label>
                </div>
                <!-- B1: Condiciones de Cr√©dito -->
                <div style="border-top: 2px solid #e0e0e0; margin-top: 15px; padding-top: 15px;">
                    <div style="font-weight: 600; color: #667eea; margin-bottom: 12px;">üí≥ Condiciones de Cr√©dito</div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <input type="checkbox" id="new-client-permite-credito" style="width: auto;" onchange="toggleCreditFields()">
                            <span>Permitir Cr√©dito a este Cliente</span>
                        </label>
                    </div>
                    <div id="credit-fields-group" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label for="new-client-dias-credito">D√≠as de Cr√©dito</label>
                                <input type="number" id="new-client-dias-credito" value="30" min="1" max="365" placeholder="30" inputmode="numeric">
                            </div>
                            <div class="form-group">
                                <label for="new-client-dias-alerta">Alertar N d√≠as antes</label>
                                <input type="number" id="new-client-dias-alerta" value="3" min="1" max="30" placeholder="3" inputmode="numeric">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="closeClientModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveNewClient()">Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- ========== MODAL USUARIO B7 ========== -->
    <div id="user-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1500; justify-content:center; align-items:flex-start; overflow-y:auto; padding:16px 0;">
        <div style="background:white; border-radius:12px; width:90%; max-width:460px; margin:auto; display:flex; flex-direction:column; max-height:calc(100vh - 32px);">
            <div style="background:linear-gradient(135deg,#455a64,#263238); color:white; padding:14px 18px; display:flex; justify-content:space-between; align-items:center; border-radius:12px 12px 0 0; flex-shrink:0;">
                <h3 id="user-modal-title" style="margin:0; font-size:16px;">üë§ Nuevo Usuario</h3>
                <span onclick="cerrarUserModal()" style="cursor:pointer; font-size:26px; line-height:1;">&times;</span>
            </div>
            <div style="padding:16px; overflow-y:auto; flex:1;">
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="user-nombre" placeholder="Nombre completo">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group">
                        <label>Rol *</label>
                        <select id="user-rol" onchange="onUserRolChange()">
                            <option value="admin">üëë Administrador</option>
                            <option value="vendedor">üõí Vendedor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Dispositivo</label>
                        <select id="user-dispositivo">
                            <option value="pc">üíª PC</option>
                            <option value="mobile">üì± M√≥vil</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Email <small style="color:#888;">(para notificaciones y 2FA)</small></label>
                    <input type="email" id="user-email" placeholder="usuario@email.com">
                </div>
                <div class="form-group">
                    <label>C√©dula / RIF</label>
                    <input type="text" id="user-cedula" placeholder="V-12345678">
                </div>
                <div class="form-group">
                    <label>Cargo</label>
                    <input type="text" id="user-cargo" placeholder="Vendedor, Despachador...">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group">
                        <label>PIN * <small style="color:#888;">(min. 4)</small></label>
                        <input type="password" id="user-pin" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="letter-spacing:3px; font-size:16px;" autocomplete="current-password" autocorrect="off" autocapitalize="off">
                    </div>
                    <div class="form-group">
                        <label>Confirmar PIN *</label>
                        <input type="password" id="user-pin2" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="letter-spacing:3px; font-size:16px;" autocomplete="current-password" autocorrect="off" autocapitalize="off">
                    </div>
                </div>
                <!-- 2FA -->
                <div style="background:#f0f4ff; border-radius:10px; padding:14px; margin-top:8px; border:1px solid #c5cae9;">
                    <div style="font-weight:700; color:#3949ab; margin-bottom:10px; font-size:13px;">üîê Doble Factor de Autenticaci√≥n (2FA)</div>
                    <div class="form-group" style="margin-bottom:8px;">
                        <label>M√©todo 2FA</label>
                        <select id="user-2fa-metodo" onchange="onUser2FAChange()">
                            <option value="ninguno">Sin 2FA (solo PIN)</option>
                            <option value="email">üìß C√≥digo por Email</option>
                            <option value="totp">üì± Google Authenticator</option>
                        </select>
                    </div>
                    <div id="user-2fa-email-info" style="display:none; font-size:12px; color:#555; background:#e8eaf6; border-radius:6px; padding:8px;">
                        Se enviar√° un c√≥digo de 6 d√≠gitos al email del usuario cada vez que inicie sesi√≥n.
                    </div>
                    <div id="user-2fa-totp-info" style="display:none; font-size:12px; color:#555; background:#e8eaf6; border-radius:6px; padding:8px;">
                        El usuario deber√° escanear un c√≥digo QR con Google Authenticator. El QR se genera al guardar.
                    </div>
                    <div id="user-2fa-activo-info" style="display:none; margin-top:8px; padding:8px; background:#e8f5e9; border-radius:6px; font-size:12px; color:#2e7d32;">
                        ‚úÖ 2FA activo ‚Äî Solo el administrador puede resetearlo.
                        <br><button class="btn btn-danger btn-small" style="margin-top:6px;" onclick="resetear2FA()">üîÑ Resetear 2FA</button>
                    </div>
                </div>
                <div id="user-permisos-info" style="background:#f8f9fa; border-radius:8px; padding:10px; font-size:12px; color:#555; margin-top:8px;"></div>
            </div>
            <div style="padding:12px 16px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid #e0e0e0; flex-shrink:0; background:white; border-radius:0 0 12px 12px;">
                <button class="btn btn-secondary" onclick="cerrarUserModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarUsuario()" style="background:#263238;">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
    <!-- ========== FIN MODAL USUARIO B7 ========== -->

    <!-- ========== MODALES PR√âSTAMOS B6 ========== -->

    <!-- Modal: Nuevo/Editar Pr√©stamo -->
    <div id="prest-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.65); z-index:1500; overflow-y:auto; -webkit-overflow-scrolling:touch;">
        <div style="background:white; border-radius:12px; width:92%; max-width:620px; margin:20px auto; overflow:hidden;">
            <div style="background:linear-gradient(135deg,#1565c0,#0d47a1); color:white; padding:20px 25px; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="prest-modal-title" style="margin:0;">üè¶ Nuevo Pr√©stamo</h3>
                <span onclick="cerrarPrestModal('prest-modal')" style="cursor:pointer; font-size:26px;">&times;</span>
            </div>
            <div style="padding:20px;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group" style="grid-column:1/-1;">
                        <label>Prestamista / Acreedor *</label>
                        <input type="text" id="prest-prestamista" placeholder="Banco Nacional, Juan P√©rez‚Ä¶">
                    </div>
                    <div class="form-group">
                        <label>Tipo *</label>
                        <select id="prest-tipo">
                            <option value="banco">üèõ Banco</option>
                            <option value="persona">üë§ Persona</option>
                            <option value="empresa">üè¢ Empresa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>N¬∞ Contrato</label>
                        <input type="text" id="prest-contrato" placeholder="CT-2024-001">
                    </div>
                    <div class="form-group">
                        <label>Monto Original USD *</label>
                        <input type="number" id="prest-monto" min="1" step="0.01" value="" placeholder="10000.00" oninput="calcularAmortizacionPreview()" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label>Tasa de Inter√©s % Anual *</label>
                        <input type="number" id="prest-tasa" min="0" step="0.01" value="" placeholder="12.5" oninput="calcularAmortizacionPreview()" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label>Plazo (meses) *</label>
                        <input type="number" id="prest-plazo" min="1" step="1" value="" placeholder="24" oninput="calcularAmortizacionPreview()" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Fecha Desembolso *</label>
                        <input type="date" id="prest-fecha-desembolso" oninput="calcularAmortizacionPreview()">
                    </div>
                    <div class="form-group">
                        <label>Fecha Primera Cuota *</label>
                        <input type="date" id="prest-fecha-primera">
                    </div>
                </div>

                <!-- Preview cuota -->
                <div id="prest-cuota-preview" style="display:none; background:#e3f2fd; border-radius:8px; padding:12px; margin:10px 0;">
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; text-align:center; font-size:13px;">
                        <div><div style="color:#666; font-size:11px;">CUOTA MENSUAL</div><div id="prev-cuota" style="font-weight:700; font-size:18px; color:#1565c0;">$0.00</div></div>
                        <div><div style="color:#666; font-size:11px;">TOTAL INTERESES</div><div id="prev-intereses" style="font-weight:700; color:#f44336;">$0.00</div></div>
                        <div><div style="color:#666; font-size:11px;">TOTAL A PAGAR</div><div id="prev-total" style="font-weight:700;">$0.00</div></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="prest-obs" rows="2" placeholder="Condiciones especiales, garant√≠as‚Ä¶" style="resize:vertical;"></textarea>
                </div>
            </div>
            <div style="padding:0 20px 20px; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-secondary" onclick="cerrarPrestModal('prest-modal')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarPrestamo()" style="background:#1565c0;">
                    <i class="fas fa-save"></i> Guardar Pr√©stamo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Tabla de Amortizaci√≥n -->
    <div id="prest-amort-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.65); z-index:1600; overflow-y:auto; -webkit-overflow-scrolling:touch;">
        <div style="background:white; border-radius:12px; width:95%; max-width:780px; margin:20px auto; overflow:hidden;">
            <div style="background:linear-gradient(135deg,#0277bd,#01579b); color:white; padding:18px 22px; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="prest-amort-title" style="margin:0; font-size:16px;">üìã Tabla de Amortizaci√≥n</h3>
                <span onclick="cerrarPrestModal('prest-amort-modal')" style="cursor:pointer; font-size:26px;">&times;</span>
            </div>
            <div id="prest-amort-body" style="padding:16px; overflow-x:auto;"></div>
        </div>
    </div>

    <!-- Modal: Pagar Cuota -->
    <div id="prest-pago-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.65); z-index:1700; justify-content:center; align-items:center;">
        <div style="background:white; border-radius:12px; width:90%; max-width:420px; overflow:hidden;">
            <div style="background:linear-gradient(135deg,#2e7d32,#1b5e20); color:white; padding:18px 22px; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">üí≥ Registrar Pago de Cuota</h3>
                <span onclick="cerrarPrestModal('prest-pago-modal')" style="cursor:pointer; font-size:26px;">&times;</span>
            </div>
            <div style="padding:20px;">
                <div id="prest-pago-info" style="background:#e8f5e9; border-radius:8px; padding:12px; margin-bottom:14px; font-size:14px;"></div>
                <div class="form-group">
                    <label>Fecha de Pago *</label>
                    <input type="date" id="prest-pago-fecha">
                </div>
                <div class="form-group">
                    <label>M√©todo de Pago</label>
                    <select id="prest-pago-metodo">
                        <option value="Transferencia">Transferencia</option>
                        <option value="Efectivo USD">Efectivo USD</option>
                        <option value="Efectivo BS">Efectivo BS</option>
                        <option value="Zelle">Zelle</option>
                        <option value="D√©bito Autom√°tico">D√©bito Autom√°tico</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notas</label>
                    <input type="text" id="prest-pago-notas" placeholder="Referencia, comprobante‚Ä¶">
                </div>
            </div>
            <div style="padding:0 20px 20px; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-secondary" onclick="cerrarPrestModal('prest-pago-modal')">Cancelar</button>
                <button class="btn btn-success" onclick="ejecutarPagoCuota()">
                    <i class="fas fa-check"></i> Confirmar Pago
                </button>
            </div>
        </div>
    </div>

    <!-- ========== FIN MODALES PR√âSTAMOS B6 ========== -->

    <!-- ========== MODAL KIT B5 ========== -->
    <div id="kit-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1500; overflow-y:auto; -webkit-overflow-scrolling:touch;">
        <div style="background:white; border-radius:12px; width:90%; max-width:560px; margin:20px auto; overflow:hidden;">
            <div style="background:linear-gradient(135deg,#5c6bc0,#3949ab); color:white; padding:20px 25px; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="kit-modal-title" style="margin:0;">üß© Nuevo Kit</h3>
                <span onclick="cerrarKitModal()" style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div style="padding:20px;">

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                    <div class="form-group" style="grid-column:1/-1;">
                        <label>Nombre del Kit *</label>
                        <input type="text" id="kit-nombre" placeholder="Ej: Kit Agua + Hielo">
                    </div>
                    <div class="form-group">
                        <label>Precio de Venta USD *</label>
                        <input type="number" id="kit-precio" min="0" step="0.01" value="0" oninput="actualizarKitResumen()" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label>¬øAplica IVA?</label>
                        <select id="kit-iva">
                            <option value="true">S√≠ (+IVA)</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>

                <!-- Componentes -->
                <div style="font-weight:600; margin-bottom:10px; color:#333;">Componentes del Kit:</div>
                <div style="background:#f8f9fa; border-radius:8px; padding:12px; margin-bottom:12px;">
                    <div style="display:grid; grid-template-columns:1fr 80px auto; gap:8px; align-items:end; margin-bottom:10px;">
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:12px;">Producto de Inventario</label>
                            <select id="kit-comp-producto">
                                <option value="">Seleccionar‚Ä¶</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:12px;">Cantidad</label>
                            <input type="number" id="kit-comp-cantidad" value="1" min="1" step="1" inputmode="numeric">
                        </div>
                        <button type="button" class="btn btn-success btn-small" onclick="agregarComponenteKit()" style="white-space:nowrap;">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                    </div>
                    <div id="kit-componentes-lista" style="display:none;">
                        <div id="kit-componentes-container"></div>
                    </div>
                </div>

                <!-- Resumen: costo, stock disponible, margen -->
                <div id="kit-resumen" style="display:none; background:#e8eaf6; border-radius:8px; padding:12px; font-size:13px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; text-align:center;">
                        <div><div style="color:#666; font-size:11px;">COSTO COMPONENTES</div><div id="kit-costo-total" style="font-weight:700;">$0.00</div></div>
                        <div><div style="color:#666; font-size:11px;">PRECIO VENTA</div><div id="kit-precio-display" style="font-weight:700; color:#3949ab;">$0.00</div></div>
                        <div><div style="color:#666; font-size:11px;">STOCK DISPONIBLE</div><div id="kit-stock-display" style="font-weight:700; color:#4caf50;">0 kits</div></div>
                    </div>
                </div>

                <div class="form-group" style="margin-top:14px;">
                    <label>Estado</label>
                    <select id="kit-activo">
                        <option value="true">‚úÖ Activo (aparece en ventas)</option>
                        <option value="false">‚è∏ Inactivo (oculto en ventas)</option>
                    </select>
                </div>
            </div>
            <div style="padding:0 20px 20px; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-secondary" onclick="cerrarKitModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarKit()" style="background:#3949ab;">
                    <i class="fas fa-save"></i> Guardar Kit
                </button>
            </div>
        </div>
    </div>
    <!-- ========== FIN MODAL KIT B5 ========== -->

    <!-- ========== MODALES CONSIGNACIONES B4 ========== -->

    <!-- Modal: Nueva Consignaci√≥n (entrega) -->
    <div id="cons-nueva-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1500; justify-content:center; align-items:center;">
        <div style="background:white; border-radius:12px; width:90%; max-width:480px; overflow:hidden;">
            <div style="background:linear-gradient(135deg,#9c27b0,#6a1b9a); color:white; padding:20px 25px; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">üì¶ Nueva Entrega en Consignaci√≥n</h3>
                <span onclick="cerrarConsModal('cons-nueva-modal')" style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div style="padding:20px;">
                <div class="form-group">
                    <label>Cliente *</label>
                    <select id="cons-cliente">
                        <option value="">Seleccionar cliente‚Ä¶</option>
                    </select>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group">
                        <label>Fecha de Entrega *</label>
                        <input type="date" id="cons-fecha-entrega">
                    </div>
                    <div class="form-group">
                        <label>Producto de Consignaci√≥n *</label>
                        <select id="cons-producto-inv">
                            <option value="">Seleccionar‚Ä¶</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group">
                        <label>Cantidad *</label>
                        <input type="number" id="cons-cantidad" value="1" min="1" step="1" oninput="calcularTotalConsignacion()" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Precio Unit. USD *</label>
                        <input type="number" id="cons-precio-unit" value="15.00" min="0" step="0.01" oninput="calcularTotalConsignacion()" inputmode="decimal">
                    </div>
                </div>
                <div style="background:#f3e5f5; border-radius:8px; padding:12px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:600;">Total Consignaci√≥n:</span>
                    <span id="cons-total-preview" style="font-size:20px; font-weight:700; color:#9c27b0;">$0.00 USD</span>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <input type="text" id="cons-obs-entrega" placeholder="Notas opcionales‚Ä¶">
                </div>
            </div>
            <div style="padding:0 20px 20px; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-secondary" onclick="cerrarConsModal('cons-nueva-modal')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarConsignacion()" style="background:#9c27b0;">
                    <i class="fas fa-paper-plane"></i> Entregar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Procesar Consignaci√≥n (devoluci√≥n/cobro) -->
    <div id="cons-procesar-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1500; justify-content:center; align-items:center; overflow-y:auto; -webkit-overflow-scrolling:touch;">
        <div style="background:white; border-radius:12px; width:90%; max-width:500px; margin:20px auto; overflow:hidden;">
            <div style="background:linear-gradient(135deg,#ff9800,#e65100); color:white; padding:20px 25px; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">üì• Procesar Consignaci√≥n</h3>
                <span onclick="cerrarConsModal('cons-procesar-modal')" style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div style="padding:20px;">
                <!-- Info de la consignaci√≥n -->
                <div id="cons-proc-info" style="background:#fff3e0; border-radius:8px; padding:12px; margin-bottom:16px; font-size:14px;"></div>

                <!-- Campos de proceso -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                    <div class="form-group">
                        <label>Cantidad Devuelta</label>
                        <input type="number" id="cons-proc-devueltos" value="0" min="0" step="1" oninput="calcularProcesoConsignacion()" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Cantidad a Cobrar</label>
                        <input type="number" id="cons-proc-cobrados" value="0" min="0" step="1" oninput="calcularProcesoConsignacion()" inputmode="numeric">
                    </div>
                </div>

                <!-- Resumen calculado -->
                <div id="cons-proc-resumen" style="background:#f8f9fa; border-radius:8px; padding:12px; margin-bottom:14px; font-size:13px; display:none;"></div>

                <!-- M√©todo de pago (solo si hay cobro) -->
                <div id="cons-proc-pago-row" style="display:none;">
                    <div class="form-group">
                        <label>M√©todo de Pago *</label>
                        <select id="cons-proc-metodo-pago">
                            <option value="Efectivo USD">Efectivo USD</option>
                            <option value="Efectivo BS">Efectivo BS</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Zelle">Zelle</option>
                            <option value="Pago M√≥vil">Pago M√≥vil</option>
                            <option value="Cr√©dito">üìã Cr√©dito (cobro diferido)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Observaciones</label>
                    <input type="text" id="cons-proc-obs" placeholder="Notas del proceso‚Ä¶">
                </div>
            </div>
            <div style="padding:0 20px 20px; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-secondary" onclick="cerrarConsModal('cons-procesar-modal')">Cancelar</button>
                <button class="btn btn-warning" onclick="ejecutarProcesoConsignacion()">
                    <i class="fas fa-check"></i> Procesar
                </button>
            </div>
        </div>
    </div>

    <!-- ========== FIN MODALES CONSIGNACIONES B4 ========== -->

    <!-- ========== MODALES COMPRAS B3 ========== -->

    <!-- Modal: Detalle de una Compra -->
    <div id="compra-detalle-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1500; overflow-y:auto; -webkit-overflow-scrolling:touch;">
        <div style="background:white; border-radius:12px; width:90%; max-width:640px; margin:20px auto; overflow:hidden;">
            <div style="background:linear-gradient(135deg,#4caf50,#388e3c); color:white; padding:20px 25px; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="compra-detalle-title" style="margin:0;">üõí Detalle de Compra</h3>
                <span onclick="document.getElementById('compra-detalle-modal').style.display='none'" style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div id="compra-detalle-body" style="padding:20px;"></div>
        </div>
    </div>

    <!-- Modal: Marcar Pago de Compra -->
    <div id="compra-pago-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1600; justify-content:center; align-items:center;">
        <div style="background:white; border-radius:12px; width:90%; max-width:420px; overflow:hidden;">
            <div style="background:linear-gradient(135deg,#ff9800,#f57c00); color:white; padding:18px 22px; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">üí≥ Registrar Pago</h3>
                <span onclick="document.getElementById('compra-pago-modal').style.display='none'" style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div style="padding:20px;">
                <div id="compra-pago-info" style="background:#fff3e0; border-radius:8px; padding:12px; margin-bottom:14px; font-size:14px;"></div>
                <div class="form-group">
                    <label>Estado de Pago</label>
                    <select id="pago-nuevo-estado">
                        <option value="pagado">‚úÖ Pagado</option>
                        <option value="parcial">‚ö° Parcial</option>
                        <option value="pendiente">‚è≥ Pendiente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>M√©todo de Pago</label>
                    <select id="pago-nuevo-metodo">
                        <option value="Efectivo USD">Efectivo USD</option>
                        <option value="Efectivo BS">Efectivo BS</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Zelle">Zelle</option>
                        <option value="Pago M√≥vil">Pago M√≥vil</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notas</label>
                    <input type="text" id="pago-notas" placeholder="Referencia, observaci√≥n‚Ä¶">
                </div>
            </div>
            <div style="padding:0 20px 20px; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-secondary" onclick="document.getElementById('compra-pago-modal').style.display='none'">Cancelar</button>
                <button class="btn btn-warning" onclick="guardarPagoCompra()">Registrar Pago</button>
            </div>
        </div>
    </div>

    <!-- ========== FIN MODALES COMPRAS B3 ========== -->

    <!-- ========== MODALES DE INVENTARIO B2 ========== -->

    <!-- Modal: Nuevo/Editar Producto de Inventario -->
    <div id="inv-product-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1500; justify-content:center; align-items:center; overflow-y:auto; -webkit-overflow-scrolling:touch;">
        <div style="background:white; border-radius:12px; width:90%; max-width:520px; margin:20px auto; overflow:hidden;">
            <div style="background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:20px 25px; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="inv-product-modal-title" style="margin:0;">üì¶ Nuevo Producto de Inventario</h3>
                <span onclick="closeInvProductModal()" style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div style="padding:20px;">
                <div class="form-group">
                    <label>Nombre del Producto *</label>
                    <input type="text" id="inv-prod-nombre" placeholder="Ej: Botell√≥n Recarga">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <input type="text" id="inv-prod-categoria" placeholder="agua, hielo, insumos‚Ä¶">
                    </div>
                    <div class="form-group">
                        <label>Unidad de Medida</label>
                        <select id="inv-prod-unidad">
                            <option value="unidad">Unidad</option>
                            <option value="kg">Kg</option>
                            <option value="litro">Litro</option>
                            <option value="caja">Caja</option>
                            <option value="bolsa">Bolsa</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                    <div class="form-group">
                        <label>Stock Actual</label>
                        <input type="number" id="inv-prod-stock" value="0" min="0" step="1" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Stock M√≠nimo</label>
                        <input type="number" id="inv-prod-stock-min" value="5" min="0" step="1" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Stock M√°ximo</label>
                        <input type="number" id="inv-prod-stock-max" value="100" min="0" step="1" inputmode="numeric">
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group">
                        <label>Costo Promedio (USD)</label>
                        <input type="number" id="inv-prod-costo" value="0" min="0" step="0.01" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label>Vincular a Producto de Venta</label>
                        <select id="inv-prod-vincular">
                            <option value="">‚Äî Sin vincular ‚Äî</option>
                        </select>
                    </div>
                </div>
                <small style="color:#888; display:block; margin-top:-8px; margin-bottom:12px;">Vincular permite descontar stock autom√°ticamente al registrar ventas</small>
            </div>
            <div style="padding:0 20px 20px; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-secondary" onclick="closeInvProductModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveInvProduct()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Ajuste de Stock -->
    <div id="inv-ajuste-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1500; justify-content:center; align-items:center;">
        <div style="background:white; border-radius:12px; width:90%; max-width:440px; overflow:hidden;">
            <div style="background:linear-gradient(135deg,#f59e0b,#d97706); color:white; padding:20px 25px; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">‚öñÔ∏è Ajustar Stock</h3>
                <span onclick="closeAjusteStockModal()" style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div style="padding:20px;">
                <div class="form-group">
                    <label>Producto *</label>
                    <select id="ajuste-producto">
                        <option value="">Seleccionar producto‚Ä¶</option>
                    </select>
                </div>
                <div id="ajuste-stock-actual-display" style="background:#f8f9fa; padding:10px 14px; border-radius:8px; margin-bottom:14px; font-size:14px; display:none;">
                    Stock actual: <strong id="ajuste-stock-val">0</strong>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group">
                        <label>Tipo de Ajuste</label>
                        <select id="ajuste-tipo" onchange="updateAjustePreview()">
                            <option value="entrada">+ Entrada</option>
                            <option value="salida">‚àí Salida</option>
                            <option value="absoluto">= Establecer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cantidad</label>
                        <input type="number" id="ajuste-cantidad" value="0" min="0" step="1" oninput="updateAjustePreview()" inputmode="numeric">
                    </div>
                </div>
                <div id="ajuste-preview" style="background:#e8f5e9; padding:10px 14px; border-radius:8px; margin-bottom:14px; font-size:14px; display:none;">
                    Nuevo stock: <strong id="ajuste-preview-val" style="color:#2e7d32;">‚Äî</strong>
                </div>
                <div class="form-group">
                    <label>Motivo</label>
                    <input type="text" id="ajuste-motivo" placeholder="Ej: Inventario f√≠sico, merma, correcci√≥n‚Ä¶">
                </div>
            </div>
            <div style="padding:0 20px 20px; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-secondary" onclick="closeAjusteStockModal()">Cancelar</button>
                <button class="btn btn-warning" onclick="saveAjusteStock()">Aplicar Ajuste</button>
            </div>
        </div>
    </div>

    <!-- Modal: Historial de un Producto -->
    <div id="inv-historial-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1500; overflow-y:auto; -webkit-overflow-scrolling:touch;">
        <div style="background:white; border-radius:12px; width:90%; max-width:680px; margin:20px auto; overflow:hidden;">
            <div style="background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:20px 25px; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="inv-historial-title" style="margin:0;">üìã Historial de Producto</h3>
                <span onclick="document.getElementById('inv-historial-modal').style.display='none'" style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div style="padding:20px;">
                <div id="inv-historial-resumen" style="background:#f8f9fa; padding:12px 16px; border-radius:8px; margin-bottom:16px; font-size:13px;"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Cantidad</th>
                                <th>Stock Ant.</th>
                                <th>Stock Nuevo</th>
                                <th>Referencia</th>
                            </tr>
                        </thead>
                        <tbody id="inv-historial-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== FIN MODALES INVENTARIO ========== -->

    <!-- Modal para Registrar Abonos a Cr√©ditos -->
    <!-- Modal para Registrar Abonos a Cr√©ditos - Pantalla Completa -->
    <div id="payment-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto; -webkit-overflow-scrolling: touch;">
        <div class="modal-content" style="background: white; margin: 20px auto; max-width: 800px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px 15px 0 0;">
                <h2 style="margin: 0; font-size: 24px;">üí∞ Registrar Abono a Cr√©dito</h2>
                <span class="close-modal" onclick="closePaymentModal()" style="cursor: pointer; font-size: 30px; position: absolute; right: 25px; top: 20px;">&times;</span>
            </div>
            
            <div style="padding: 30px;">
                <!-- Fecha del Abono -->
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 8px; display: block;">
                        üìÖ Fecha del Abono *
                    </label>
                    <input type="date" id="payment-date" required style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px;" onchange="updatePaymentBCVRate()">
                    <small id="payment-bcv-rate-display" style="color: #666; margin-top: 5px; display: block;"></small>
                </div>
                
                <!-- Cliente -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <div style="font-weight: 600; font-size: 14px; color: #666; margin-bottom: 8px;">üë§ CLIENTE</div>
                    <div id="payment-customer-name" style="font-size: 20px; font-weight: 700; color: #333;"></div>
                </div>
                
                <!-- Deuda -->
                <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <div style="font-weight: 600; font-size: 14px; color: #856404; margin-bottom: 15px;">üíµ DEUDA PENDIENTE</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 12px; color: #856404; margin-bottom: 5px;">En D√≥lares</div>
                            <div id="payment-debt-usd" style="font-size: 24px; font-weight: 700; color: #dc3545;"></div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #856404; margin-bottom: 5px;">En Bol√≠vares</div>
                            <div id="payment-debt-bs" style="font-size: 24px; font-weight: 700; color: #dc3545;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Total Abonado -->
                <div style="background: #d1ecf1; border: 2px solid #17a2b8; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <div style="font-weight: 600; font-size: 14px; color: #0c5460; margin-bottom: 10px;">üí∞ TOTAL ABONADO</div>
                    <div id="payment-total-paid" style="font-size: 24px; font-weight: 700; color: #17a2b8;"></div>
                </div>
                
                <!-- Detalle de la Venta -->
                <div style="background: #e7f3ff; border: 2px solid #007bff; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <div style="font-weight: 600; font-size: 14px; color: #004085; margin-bottom: 15px;">üì¶ DETALLE DE LA VENTA</div>
                    <div id="payment-sale-details"></div>
                </div>
                
                <!-- Monto del Abono -->
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 8px; display: block;">
                        üíµ Monto del Abono (USD) *
                    </label>
                    <input type="number" id="payment-amount" step="0.01" min="0" placeholder="0.00" required style="width: 100%; padding: 12px; font-size: 18px; border: 2px solid #28a745; border-radius: 8px; font-weight: 600;" inputmode="decimal">
                </div>
                
                <!-- Forma de Pago -->
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 8px; display: block;">
                        üí≥ Forma de Pago *
                    </label>
                    <select id="payment-method-abono" required style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">Seleccionar</option>
                        <option value="Efectivo BS">Efectivo BS</option>
                        <option value="Efectivo USD">Efectivo USD</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Pago M√≥vil">Pago M√≥vil</option>
                        <option value="Zelle">Zelle</option>
                        <option value="Mixto">Mixto</option>
                    </select>
                </div>
                
                <!-- Notas -->
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 8px; display: block;">
                        üìù Notas
                    </label>
                    <textarea id="payment-notes" rows="3" placeholder="Notas adicionales..." style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid #e0e0e0; border-radius: 8px;"></textarea>
                </div>
                
                <!-- Botones -->
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closePaymentModal()" style="flex: 1; padding: 15px; font-size: 16px; font-weight: 600;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="savePayment()" style="flex: 1; padding: 15px; font-size: 16px; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                        <i class="fas fa-save"></i> Registrar Abono
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== DATOS Y CONFIGURACI√ìN ==========
        let salesData = JSON.parse(localStorage.getItem('salesData')) || [];
        let expensesData = JSON.parse(localStorage.getItem('expensesData')) || [];
        let ordersData = JSON.parse(localStorage.getItem('ordersData')) || [];
        let currentOrderProducts = [];
        let creditsData = JSON.parse(localStorage.getItem('creditsData')) || [];
        let clientsData = JSON.parse(localStorage.getItem('clientsData')) || [];
        let adelantosClientes = JSON.parse(localStorage.getItem('adelantosClientes')) || [];
        let adelantosHielo = JSON.parse(localStorage.getItem('adelantosHielo')) || [];
        
        // Configuraci√≥n de contactos
        let appConfig = JSON.parse(localStorage.getItem('appConfig')) || {
            whatsapp: {
                number: '584241234567',
                message: 'Hola, quiero hacer un pedido de agua'
            },
            gmail: {
                address: 'ventas@aguapura.com',
                subject: 'Pedido de Agua',
                body: 'Hola, me gustar√≠a hacer un pedido de agua con los siguientes detalles:'
            },
            exchangeRates: {
                bcv: 38.50,
                binance: 39.20,
                priceRate: 38.50
            }
        };

        // Configuraci√≥n de productos y precios EN D√ìLARES (actualizada)
        let waterPrices = JSON.parse(localStorage.getItem('waterPrices')) || {
            recarga_local: { 
                priceUSD: 0.5, 
                lastUpdate: new Date().toISOString(),
                hasIva: true 
            },
            recarga_domicilio: { 
                priceUSD: 1.0, 
                lastUpdate: new Date().toISOString(),
                hasIva: true 
            },
            recarga_lejana: { 
                priceUSD: 1.5, 
                lastUpdate: new Date().toISOString(),
                hasIva: true 
            },
            empresas_mayor: { 
                priceUSD: 0.7, 
                lastUpdate: new Date().toISOString(),
                hasIva: true 
            },
            botellon_nuevo: { 
                priceUSD: 10.0, 
                lastUpdate: new Date().toISOString(),
                hasIva: true 
            },
            hielo: { 
                priceUSD: 2.0, 
                lastUpdate: new Date().toISOString(),
                hasIva: true 
            },
            recarga_local_empresa: { 
                priceUSD: 0.45, 
                lastUpdate: new Date().toISOString(),
                hasIva: true 
            },
            dispensador: { 
                priceUSD: 15.0, 
                lastUpdate: new Date().toISOString(),
                hasIva: true 
            }
        };
        
        let priceHistory = JSON.parse(localStorage.getItem('priceHistory')) || [];
        let currentSaleItems = [];
        let ivaPercentage = parseFloat(localStorage.getItem('ivaPercentage')) || 16;
        let priceExchangeRate = appConfig.exchangeRates.priceRate;
        let currentCurrencyDisplay = 'bs';
        
        // Sistema de historial de tasas BCV
        let bcvRateHistory = JSON.parse(localStorage.getItem('bcvRateHistory')) || [];

        // ========== B2: DATOS DE INVENTARIO ==========
        let inventoryData   = JSON.parse(localStorage.getItem('inventoryData'))   || [];
        let movimientosData = JSON.parse(localStorage.getItem('movimientosData')) || [];
        let currentInvEditId = null;

        // ========== B3: DATOS DE COMPRAS ==========
        let comprasData = JSON.parse(localStorage.getItem('comprasData')) || [];
        let cItems      = [];
        let currentPagoCompraId = null;

        // ========== B4: DATOS DE CONSIGNACIONES ==========
        let consignacionesData  = JSON.parse(localStorage.getItem('consignacionesData')) || [];
        let currentConsId       = null;

        // ========== B5: DATOS DE PRODUCTOS COMPUESTOS (KITS) ==========
        let productosCompuestos = JSON.parse(localStorage.getItem('productosCompuestos')) || [];
        let currentKitId        = null;
        let kitComponentes      = [];

        // ========== B6: DATOS DE PR√âSTAMOS ==========
        let prestamosData      = JSON.parse(localStorage.getItem('prestamosData')) || [];
        let currentPrestId     = null;
        let currentPagoNroCuota = null;

        // ========== B7: DATOS DE USUARIOS ==========
        // Usuarios predefinidos del spec si no existen
        const PERMISOS_ADMIN    = ['all'];
        const PERMISOS_VENDEDOR = ['ventas.crear','ventas.ver','clientes.ver','creditos.ver','creditos.abonar','inventario.ver'];

        function getDefaultUsers() {
            return [
                { id:'admin-pc-001',      nombre:'Administrador', email:'aquanev.bna@gmail.com', rol:'admin',    dispositivo:'pc',     pin:'1234', permisos:PERMISOS_ADMIN,    activo:true, creadoEn:new Date().toISOString() },
                { id:'mobile-vendor-001', nombre:'Vendedor 1',    email:'',                      rol:'vendedor', dispositivo:'mobile', pin:'1111', permisos:PERMISOS_VENDEDOR, activo:true, creadoEn:new Date().toISOString() },
                { id:'mobile-vendor-002', nombre:'Vendedor 2',    email:'',                      rol:'vendedor', dispositivo:'mobile', pin:'2222', permisos:PERMISOS_VENDEDOR, activo:true, creadoEn:new Date().toISOString() },
                { id:'mobile-vendor-003', nombre:'Vendedor 3',    email:'',                      rol:'vendedor', dispositivo:'mobile', pin:'3333', permisos:PERMISOS_VENDEDOR, activo:true, creadoEn:new Date().toISOString() }
            ];
        }
        let usersData   = JSON.parse(localStorage.getItem('usersData')) || getDefaultUsers();
        let currentUser = null;
        let editUserId  = null;

        // ========== B8: DATOS DE SINCRONIZACI√ìN ==========
        // URL del Apps Script - preconfigurada para todos los dispositivos
        const APPS_SCRIPT_URL_DEFAULT = 'https://script.google.com/macros/s/AKfycbyX7FjArSkiGabghylTRsRaNtIrReILMFzJOSVwN4hRlDTFU2rtscifoKlWJw2sdTk4hA/exec';

        let syncConfig = JSON.parse(localStorage.getItem('syncConfig')) || {
            appsScriptUrl: APPS_SCRIPT_URL_DEFAULT,
            frecuenciaMin: 15,
            modo: 'bidireccional',
            activa: true
        };
        // Si ya existe en localStorage pero sin URL, inyectar la URL por defecto
        if (!syncConfig.appsScriptUrl) {
            syncConfig.appsScriptUrl = APPS_SCRIPT_URL_DEFAULT;
            syncConfig.activa = true;
            localStorage.setItem('syncConfig', JSON.stringify(syncConfig));
        }
        // ========== PROVEEDORES ==========
        let proveedoresData = JSON.parse(localStorage.getItem('proveedoresData')) || [];
        function saveProveedores() { localStorage.setItem('proveedoresData', JSON.stringify(proveedoresData)); }

        let syncQueue    = JSON.parse(localStorage.getItem('syncQueue'))    || [];   // [{id,tabla,accion,datos,timestamp,intentos}]
        let syncLog      = JSON.parse(localStorage.getItem('syncLog'))      || [];   // [{timestamp,usuario,accion,tabla,enviados,recibidos,errores,msg}]
        let syncTimer    = null;   // setInterval handle
        let syncEnCurso  = false;
        
        // Funci√≥n para obtener tasa BCV de una fecha espec√≠fica
        function getBCVRateForDate(date) {
            const dateStr = typeof date === 'string' ? date : date.toISOString().split('T')[0];
            
            // Buscar tasa exacta de esa fecha
            const rateEntry = bcvRateHistory.find(r => r.date === dateStr);
            if (rateEntry) {
                return rateEntry.rate;
            }
            
            // Si no existe, buscar la m√°s cercana anterior
            const previousRates = bcvRateHistory
                .filter(r => r.date <= dateStr)
                .sort((a, b) => b.date.localeCompare(a.date));
            
            if (previousRates.length > 0) {
                return previousRates[0].rate;
            }
            
            // Si no hay historial, usar tasa actual
            return priceExchangeRate;
        }
        
        // Funci√≥n para actualizar tasa BCV
        function updateBCVRate(newRate) {
            const today = new Date().toISOString().split('T')[0];
            
            // Verificar si ya existe entrada para hoy
            const existingIndex = bcvRateHistory.findIndex(r => r.date === today);
            
            if (existingIndex > -1) {
                bcvRateHistory[existingIndex].rate = newRate;
            } else {
                bcvRateHistory.push({
                    date: today,
                    rate: newRate
                });
            }
            
            // Guardar historial
            localStorage.setItem('bcvRateHistory', JSON.stringify(bcvRateHistory));
            
            // Actualizar tasa actual
            priceExchangeRate = newRate;
            
            alert(`‚úÖ Tasa BCV actualizada\n\nFecha: ${formatDate(today)}\nNueva tasa: ${newRate.toFixed(2)} BS/USD\n\nLos cr√©ditos pendientes se recalcular√°n con la nueva tasa.`);
            
            // Recargar vistas
            loadPendingCredits();
            loadDashboard();
        }
        
        // Alerta diaria para actualizar tasa BCV (4:00 PM)
        let lastBCVAlertDate = localStorage.getItem('lastBCVAlertDate');
        
        function checkBCVAlert() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const hour = now.getHours();
            const minute = now.getMinutes();
            
            // Verificar si es 4:00 PM (16:00) y no se ha mostrado hoy
            if (hour === 16 && minute === 0 && lastBCVAlertDate !== today) {
                alert('‚è∞ RECORDATORIO\n\n¬°Es hora de actualizar la tasa BCV del d√≠a!\n\nVe a Configuraci√≥n para actualizar la tasa del d√≥lar.');
                localStorage.setItem('lastBCVAlertDate', today);
                lastBCVAlertDate = today;
            }
        }
        
        // Verificar alerta cada minuto
        setInterval(checkBCVAlert, 60000);

        // ========== INICIALIZACI√ìN COMPLETA ==========
        document.addEventListener('DOMContentLoaded', function() {
            renderLoginUsuarios();   // B7: mostrar usuarios en pantalla de login
            registrarServiceWorker(); // B9: PWA
            initializeApp();
        });

        function initializeApp() {
            // Sanar adelantos de hielo con saldoDisponibleUSD inv√°lido (negativo/NaN por bug anterior)
            let changed = false;
            adelantosHielo = adelantosHielo.map(a => {
                const usd = a.saldoDisponibleUSD;
                if (typeof usd !== 'number' || isNaN(usd) || usd < 0) {
                    a.saldoDisponibleUSD = Math.max(0, convertBStoUSD(a.saldoDisponible || 0));
                    changed = true;
                }
                return a;
            });
            if (changed) localStorage.setItem('adelantosHielo', JSON.stringify(adelantosHielo));

            // Configurar fecha actual
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Cargar configuraci√≥n
            loadContactConfig();
            loadManualRates(); // syncRateFromBCV se llama dentro de loadManualRates
            loadManualExchangeRates();
            
            // Establecer fechas por defecto
            const today = now.toISOString().split('T')[0];
            document.getElementById('sale-date').value = today;
            document.getElementById('expense-date').value = today;
            document.getElementById('order-date').value = today;
            
            // Adelantos
            const adelantoFecha = document.getElementById('adelanto-fecha');
            if (adelantoFecha) adelantoFecha.value = today;
            const adelantoHieloFecha = document.getElementById('adelanto-hielo-fecha');
            if (adelantoHieloFecha) adelantoHieloFecha.value = today;
            
            // Fechas de exportaci√≥n (primer d√≠a del mes hasta hoy)
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const exportFrom = document.getElementById('export-date-from');
            const exportTo = document.getElementById('export-date-to');
            if (exportFrom) exportFrom.value = firstDayOfMonth;
            if (exportTo) exportTo.value = today;
            
            // Configurar eventos
            document.getElementById('new-price-usd').addEventListener('input', updateCalculatedPrice);
            document.getElementById('price-exchange-rate').addEventListener('input', updateCalculatedPrice);
            document.getElementById('report-type').addEventListener('change', toggleCustomDateRange);
            document.getElementById('expense-search').addEventListener('input', filterExpenses);
            document.getElementById('client-search').addEventListener('input', filterClients);
            
            // Cargar datos iniciales
            loadDashboard();
            loadEcuadorView();
            loadCurrentPrices();
            loadProductsList();
            loadSalesHistory();
            loadExpensesHistory();
            loadOrdersHistory();
            loadPendingCredits();
            loadPriceHistory();
            loadCurrentPricesTable();
            loadRecentSales();
            loadClientsList();
            loadEcuadorView();
            loadCreditReportClients();
            loadSalesReportClients();
            loadAdelantosClientes();
            loadAdelantosClientesList();
            loadAdelantosHieloList();
            loadOrderCustomerSelect();
            cargarHistorialTasasBCV();
            
            // B2: Inventario
            loadInventoryList();
            loadMovimientosHistorial();

            // B3: Compras
            const fechaHoy = new Date().toISOString().split('T')[0];
            const cFecha = document.getElementById('c-fecha');
            if (cFecha) cFecha.value = fechaHoy;
            poblarCItemProductoSelect();
            poblarProveedoresDatalist();
            loadComprasDashboard();
            loadComprasHistorial();

            // B4: Consignaciones
            loadConsignacionesDashboard();
            loadConsignacionesList();

            // B5: Kits
            loadKitsList();

            // B6: Pr√©stamos
            loadPrestamosDashboard();
            loadPrestamosList();

            // B7: Usuarios (solo carga lista si admin)
            if (esAdmin()) {
                loadUsersList();
            }

            // B8: Sincronizaci√≥n
            loadSyncConfigForm();
            loadSyncQueueDisplay();
            loadSyncLogDisplay();
            iniciarTimerSync();

            // B9: PWA + Notificaciones
            actualizarEstadoPWA();
            // Escanear alertas 3s despu√©s del login para no bloquear UI
            setTimeout(escanearAlertas, 3000);
            // Re-escanear cada 30 minutos
            setInterval(escanearAlertas, 30 * 60 * 1000);

            // B10: Reportes ampliados - inicializar fechas
            initReportDates();
            
            // Configurar navegaci√≥n y formularios
            setupTabs();
            actualizarDatalistProveedores();
            setupForms();
            setupClientSearch();
            
            // Cargar clientes predefinidos si no existen
            if (clientsData.length === 0) {
                loadPredefinedClients();
            }
            
            // Cargar gastos predefinidos si no existen
            if (expensesData.length === 0) {
                loadPredefinedExpenses();
            }
            
            // B1: Migrar datos existentes
            migrarDatosB1();
        }

        // ========== B1: MIGRACI√ìN DE DATOS ==========
        function migrarDatosB1() {
            let cambios = false;
            
            // Recalcular fechaVencimiento en TODOS los cr√©ditos activos
            // seg√∫n los d√≠as actuales del cliente (as√≠ siempre est√° sincronizado)
            creditsData.forEach(credit => {
                if (credit.status === 'Pagado') return;
                
                const cliente = clientsData.find(c => c.name === credit.customer);
                if (cliente && cliente.permiteCredito && cliente.diasCredito && credit.date) {
                    const fechaBase = new Date(credit.date + 'T00:00:00');
                    fechaBase.setDate(fechaBase.getDate() + cliente.diasCredito);
                    const nuevaFecha = fechaBase.toISOString().split('T')[0];
                    
                    // Solo actualizar si cambi√≥ o no exist√≠a
                    if (credit.fechaVencimiento !== nuevaFecha || credit.diasCredito !== cliente.diasCredito) {
                        credit.fechaVencimiento = nuevaFecha;
                        credit.diasCredito = cliente.diasCredito;
                        credit.diasAlertaAntes = cliente.diasAlertaAntes || 3;
                        cambios = true;
                    }
                }
                // Asegurar diasAlertaAntes m√≠nimo
                if (!credit.diasAlertaAntes) { credit.diasAlertaAntes = 3; cambios = true; }
            });
            
            if (cambios) {
                localStorage.setItem('creditsData', JSON.stringify(creditsData));
            }
        }

        // ========== B2: M√ìDULO DE INVENTARIO ==========

        // ---- Helpers ----
        function calcularEstadoInventario(item) {
            if (item.stockActual <= 0) return { estado: 'agotado', color: '#f44336', icono: 'üî¥', label: 'AGOTADO' };
            if (item.stockActual < item.stockMinimo) return { estado: 'bajo', color: '#ff9800', icono: 'üü°', label: 'STOCK BAJO' };
            return { estado: 'normal', color: '#4caf50', icono: 'üü¢', label: 'Normal' };
        }

        function saveInventory() {
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
        }
        function saveMovimientos() {
            localStorage.setItem('movimientosData', JSON.stringify(movimientosData));
        }

        // ---- Registrar movimiento ----
        function registrarMovimiento(productoKey, tipo, cantidad, stockAnterior, stockNuevo, referencia) {
            movimientosData.unshift({
                id: Date.now().toString(),
                fecha: new Date().toISOString().split('T')[0],
                tipo: tipo, // 'compra' | 'venta' | 'ajuste'
                productoKey: productoKey,
                cantidad: cantidad,
                stockAnterior: stockAnterior,
                stockNuevo: stockNuevo,
                referencia: referencia || '',
                creadoEn: new Date().toISOString()
            });
            // Conservar √∫ltimos 2000 movimientos
            if (movimientosData.length > 2000) movimientosData = movimientosData.slice(0, 2000);
            saveMovimientos();
        }

        // ---- Descontar stock al registrar venta ----
        function descontarStockPorVenta(saleItems, saleId) {
            let alertas = [];
            saleItems.forEach(item => {
                const inv = inventoryData.find(i => i.vinculadoA === item.productKey || i.productoKey === item.productKey);
                if (!inv) return;
                const stockAnt = inv.stockActual;
                const cant = item.quantity || 1;
                if (inv.stockActual < cant) {
                    alertas.push(`‚ö†Ô∏è Stock insuficiente de "${inv.nombre}". Disponible: ${inv.stockActual}`);
                    return;
                }
                inv.stockActual = Math.max(0, inv.stockActual - cant);
                inv.totalVentas = (inv.totalVentas || 0) + cant;
                inv.ultimaVenta = new Date().toISOString().split('T')[0];
                inv.diasSinMovimiento = 0;
                const est = calcularEstadoInventario(inv);
                inv.estado = est.estado;
                inv.requiereAlerta = est.estado !== 'normal';
                inv.modificadoEn = new Date().toISOString();
                registrarMovimiento(inv.productoKey, 'venta', cant, stockAnt, inv.stockActual, `Venta #${saleId}`);
            });
            saveInventory();
            if (alertas.length > 0) alert(alertas.join('\n'));
        }

        // ---- Dashboard de Inventario ----
        function loadInventoryDashboard() {
            let normal = 0, bajo = 0, agotado = 0, valorTotal = 0;
            inventoryData.forEach(item => {
                const est = calcularEstadoInventario(item);
                if (est.estado === 'normal') normal++;
                else if (est.estado === 'bajo') bajo++;
                else agotado++;
                valorTotal += (item.stockActual || 0) * (item.costoPromedioUSD || 0);
            });
            document.getElementById('inv-normal-count').textContent = normal;
            document.getElementById('inv-bajo-count').textContent = bajo;
            document.getElementById('inv-agotado-count').textContent = agotado;
            document.getElementById('inv-valor-total').textContent = '$' + valorTotal.toFixed(2);

            // Barra de alertas
            const alertBar = document.getElementById('inv-alerts-bar');
            const msgs = [];
            if (agotado > 0) msgs.push(`üî¥ <strong>${agotado}</strong> producto${agotado > 1 ? 's' : ''} AGOTADO${agotado > 1 ? 'S' : ''}`);
            if (bajo > 0) msgs.push(`üü° <strong>${bajo}</strong> producto${bajo > 1 ? 's' : ''} con stock bajo`);
            if (msgs.length > 0) {
                alertBar.style.display = 'block';
                alertBar.style.background = agotado > 0 ? 'rgba(244,67,54,0.1)' : 'rgba(255,152,0,0.1)';
                alertBar.style.border = `1px solid ${agotado > 0 ? '#f44336' : '#ff9800'}`;
                alertBar.innerHTML = '‚ö†Ô∏è ' + msgs.join(' &nbsp;|&nbsp; ');
            } else {
                alertBar.style.display = 'none';
            }
        }

        // ---- Lista de productos de inventario (tarjetas) ----
        function loadInventoryList() {
            loadInventoryDashboard();
            const container = document.getElementById('inventory-cards');
            const filtro = document.getElementById('inv-filter')?.value || 'todos';

            if (inventoryData.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#999; padding:40px;">
                    <div style="font-size:48px; margin-bottom:12px;">üì¶</div>
                    <p>No hay productos en el inventario.</p>
                    <button class="btn btn-primary" onclick="showInvProductModal()"><i class="fas fa-plus"></i> Agregar primer producto</button>
                </div>`;
                return;
            }

            let items = [...inventoryData];
            if (filtro !== 'todos') items = items.filter(i => calcularEstadoInventario(i).estado === filtro);
            // Ordenar: agotados ‚Üí bajo ‚Üí normal
            items.sort((a, b) => {
                const order = { agotado: 0, bajo: 1, normal: 2 };
                return (order[calcularEstadoInventario(a).estado] ?? 3) - (order[calcularEstadoInventario(b).estado] ?? 3);
            });

            if (items.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#999; padding:30px;">No hay productos con ese filtro.</div>`;
                return;
            }

            container.innerHTML = items.map(item => {
                const est = calcularEstadoInventario(item);
                const pct = item.stockMaximo > 0 ? Math.min(100, Math.round((item.stockActual / item.stockMaximo) * 100)) : 0;
                const valorItem = (item.stockActual || 0) * (item.costoPromedioUSD || 0);
                const margen = item.precioVentaUSD > 0 && item.costoPromedioUSD > 0
                    ? Math.round(((item.precioVentaUSD - item.costoPromedioUSD) / item.precioVentaUSD) * 100) : null;
                const barColor = est.estado === 'agotado' ? '#f44336' : est.estado === 'bajo' ? '#ff9800' : '#4caf50';
                return `
                <div style="border:1px solid #e0e0e0; border-left: 4px solid ${est.color}; border-radius:10px; padding:16px; margin-bottom:12px; background:${est.estado === 'agotado' ? 'rgba(244,67,54,0.03)' : est.estado === 'bajo' ? 'rgba(255,152,0,0.03)' : 'white'};">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:8px;">
                        <div>
                            <div style="font-weight:700; font-size:16px;">${est.icono} ${item.nombre}</div>
                            <small style="color:#888;">${item.categoria || '-'} ¬∑ ${item.unidadMedida || 'unidad'}</small>
                        </div>
                        <span style="background:${est.color}20; color:${est.color}; padding:3px 10px; border-radius:20px; font-size:12px; font-weight:600;">${est.label}</span>
                    </div>

                    <!-- Barra de stock -->
                    <div style="margin:12px 0 4px;">
                        <div style="display:flex; justify-content:space-between; font-size:12px; color:#666; margin-bottom:4px;">
                            <span>Stock: <strong style="color:${est.color}">${item.stockActual}</strong> / ${item.stockMaximo} ${item.unidadMedida || 'u'}</span>
                            <span>${pct}%</span>
                        </div>
                        <div style="height:8px; background:#e0e0e0; border-radius:4px; overflow:hidden;">
                            <div style="height:100%; width:${pct}%; background:${barColor}; border-radius:4px; transition:width 0.3s;"></div>
                        </div>
                        ${item.stockActual < item.stockMinimo ? `<small style="color:${est.color};">‚ö†Ô∏è M√≠nimo: ${item.stockMinimo}</small>` : ''}
                    </div>

                    <!-- Costos y precios -->
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(110px, 1fr)); gap:8px; margin:10px 0; font-size:13px;">
                        <div style="background:#f8f9fa; padding:6px 10px; border-radius:6px;">
                            <div style="color:#888; font-size:11px;">COSTO PROM.</div>
                            <div style="font-weight:600;">$${(item.costoPromedioUSD||0).toFixed(2)}</div>
                        </div>
                        <div style="background:#f8f9fa; padding:6px 10px; border-radius:6px;">
                            <div style="color:#888; font-size:11px;">VALOR STOCK</div>
                            <div style="font-weight:600; color:#667eea;">$${valorItem.toFixed(2)}</div>
                        </div>
                        ${margen !== null ? `
                        <div style="background:#f8f9fa; padding:6px 10px; border-radius:6px;">
                            <div style="color:#888; font-size:11px;">MARGEN</div>
                            <div style="font-weight:600; color:#4caf50;">${margen}%</div>
                        </div>` : ''}
                        <div style="background:#f8f9fa; padding:6px 10px; border-radius:6px;">
                            <div style="color:#888; font-size:11px;">√öLITMA VENTA</div>
                            <div style="font-weight:600;">${item.ultimaVenta ? formatDate(item.ultimaVenta) : '-'}</div>
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                        <button class="btn btn-small btn-primary" onclick="showAjusteStockModal('${item.productoKey}')">
                            <i class="fas fa-sliders-h"></i> Ajustar
                        </button>
                        <button class="btn btn-small" style="background:#667eea; color:white;" onclick="showInvHistorialProducto('${item.productoKey}')">
                            <i class="fas fa-history"></i> Historial
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="editInvProduct('${item.productoKey}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteInvProduct('${item.productoKey}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');

            // Actualizar selector de movimientos
            loadMovProductoSelect();
        }

        // ---- Historial de movimientos general ----
        function loadMovimientosHistorial() {
            const tbody = document.getElementById('inv-movimientos-list');
            const filtroProd = document.getElementById('inv-mov-producto')?.value || 'todos';
            const filtroTipo = document.getElementById('inv-mov-tipo')?.value || 'todos';
            let movs = [...movimientosData];
            if (filtroProd !== 'todos') movs = movs.filter(m => m.productoKey === filtroProd);
            if (filtroTipo !== 'todos') movs = movs.filter(m => m.tipo === filtroTipo);
            movs = movs.slice(0, 100); // Mostrar √∫ltimos 100

            if (movs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:#999; padding:20px;">No hay movimientos registrados</td></tr>`;
                return;
            }
            const tipoLabel = { compra: 'üõí Compra', venta: 'üõçÔ∏è Venta', ajuste: '‚öñÔ∏è Ajuste' };
            const tipoColor = { compra: '#4caf50', venta: '#2196f3', ajuste: '#ff9800' };
            tbody.innerHTML = movs.map(m => {
                const inv = inventoryData.find(i => i.productoKey === m.productoKey);
                const nombreProd = inv ? inv.nombre : m.productoKey;
                const delta = m.stockNuevo - m.stockAnterior;
                const signo = delta >= 0 ? '+' : '';
                return `<tr>
                    <td>${formatDate(m.fecha)}</td>
                    <td><span style="color:${tipoColor[m.tipo] || '#666'}; font-weight:600;">${tipoLabel[m.tipo] || m.tipo}</span></td>
                    <td>${nombreProd}</td>
                    <td style="font-weight:600; color:${delta >= 0 ? '#4caf50' : '#f44336'}">${signo}${m.cantidad}</td>
                    <td>${m.stockAnterior}</td>
                    <td><strong>${m.stockNuevo}</strong></td>
                    <td><small style="color:#888;">${m.referencia || '-'}</small></td>
                </tr>`;
            }).join('');
        }

        function loadMovProductoSelect() {
            const sel = document.getElementById('inv-mov-producto');
            if (!sel) return;
            const val = sel.value;
            sel.innerHTML = '<option value="todos">Todos los productos</option>' +
                inventoryData.map(i => `<option value="${i.productoKey}">${i.nombre}</option>`).join('');
            sel.value = val;
        }

        // ---- Modal Nuevo/Editar Producto ----
        function showInvProductModal(productoKey) {
            currentInvEditId = null;
            document.getElementById('inv-product-modal-title').textContent = 'üì¶ Nuevo Producto de Inventario';
            document.getElementById('inv-prod-nombre').value = '';
            document.getElementById('inv-prod-categoria').value = '';
            document.getElementById('inv-prod-unidad').value = 'unidad';
            document.getElementById('inv-prod-stock').value = '0';
            document.getElementById('inv-prod-stock-min').value = '5';
            document.getElementById('inv-prod-stock-max').value = '100';
            document.getElementById('inv-prod-costo').value = '0';
            // Poblar select de vinculaci√≥n
            const vinSel = document.getElementById('inv-prod-vincular');
            vinSel.innerHTML = '<option value="">- Sin vincular -</option>' +
                Object.keys(waterPrices).map(k => {
                    const info = getProductInfo(k);
                    return `<option value="${k}">${info.name}</option>`;
                }).join('');
            document.getElementById('inv-product-modal').style.display = 'flex';
        }

        function editInvProduct(productoKey) {
            const item = inventoryData.find(i => i.productoKey === productoKey);
            if (!item) return;
            currentInvEditId = productoKey;
            document.getElementById('inv-product-modal-title').textContent = '‚úèÔ∏è Editar Producto de Inventario';
            document.getElementById('inv-prod-nombre').value = item.nombre;
            document.getElementById('inv-prod-categoria').value = item.categoria || '';
            document.getElementById('inv-prod-unidad').value = item.unidadMedida || 'unidad';
            document.getElementById('inv-prod-stock').value = item.stockActual;
            document.getElementById('inv-prod-stock-min').value = item.stockMinimo;
            document.getElementById('inv-prod-stock-max').value = item.stockMaximo;
            document.getElementById('inv-prod-costo').value = item.costoPromedioUSD || 0;
            const vinSel = document.getElementById('inv-prod-vincular');
            vinSel.innerHTML = '<option value="">- Sin vincular -</option>' +
                Object.keys(waterPrices).map(k => {
                    const info = getProductInfo(k);
                    return `<option value="${k}" ${item.vinculadoA === k ? 'selected' : ''}>${info.name}</option>`;
                }).join('');
            document.getElementById('inv-product-modal').style.display = 'flex';
        }

        function closeInvProductModal() {
            document.getElementById('inv-product-modal').style.display = 'none';
            currentInvEditId = null;
        }

        function saveInvProduct() {
            const nombre = document.getElementById('inv-prod-nombre').value.trim();
            if (!nombre) { alert('El nombre es obligatorio'); return; }

            const stock = parseInt(document.getElementById('inv-prod-stock').value) || 0;
            const stockMin = parseInt(document.getElementById('inv-prod-stock-min').value) || 0;
            const stockMax = parseInt(document.getElementById('inv-prod-stock-max').value) || 100;
            const costo = parseFloat(document.getElementById('inv-prod-costo').value) || 0;
            const unidad = document.getElementById('inv-prod-unidad').value;
            const categoria = document.getElementById('inv-prod-categoria').value.trim();
            const vinculadoA = document.getElementById('inv-prod-vincular').value || null;

            if (currentInvEditId) {
                // Editar existente
                const idx = inventoryData.findIndex(i => i.productoKey === currentInvEditId);
                if (idx === -1) return;
                const stockAnterior = inventoryData[idx].stockActual;
                inventoryData[idx] = {
                    ...inventoryData[idx],
                    nombre, categoria, unidadMedida: unidad,
                    stockActual: stock, stockMinimo: stockMin, stockMaximo: stockMax,
                    costoPromedioUSD: costo, vinculadoA,
                    modificadoEn: new Date().toISOString()
                };
                if (stockAnterior !== stock) {
                    registrarMovimiento(currentInvEditId, 'ajuste', Math.abs(stock - stockAnterior), stockAnterior, stock, 'Edici√≥n directa');
                }
                const est = calcularEstadoInventario(inventoryData[idx]);
                inventoryData[idx].estado = est.estado;
            } else {
                // Nuevo producto
                const key = 'inv_' + Date.now();
                // Verificar que no haya otro vinculado al mismo producto de venta
                if (vinculadoA && inventoryData.some(i => i.vinculadoA === vinculadoA)) {
                    if (!confirm(`Ya existe un producto vinculado a "${vinculadoA}". ¬øDeseas continuar de todas formas?`)) return;
                }
                const newItem = {
                    productoKey: key,
                    nombre, categoria, unidadMedida: unidad,
                    tipo: 'simple',
                    stockActual: stock, stockMinimo: stockMin, stockMaximo: stockMax,
                    totalCompras: 0, totalVentas: 0, totalAjustes: 0,
                    costoPromedioUSD: costo, precioVentaUSD: 0, margenPorcentaje: 0,
                    estado: calcularEstadoInventario({ stockActual: stock, stockMinimo: stockMin }).estado,
                    ultimaCompra: null, ultimaVenta: null, ultimoAjuste: null,
                    requiereAlerta: false, diasSinMovimiento: 0,
                    vinculadoA: vinculadoA,
                    creadoEn: new Date().toISOString(),
                    modificadoEn: new Date().toISOString()
                };
                inventoryData.push(newItem);
                if (stock > 0) {
                    registrarMovimiento(key, 'ajuste', stock, 0, stock, 'Stock inicial');
                }
            }

            saveInventory();
            closeInvProductModal();
            loadInventoryList();
            poblarCItemProductoSelect();   // B3: refrescar selector de compras
            poblarCompraProductoSelect();  // Compras en gastos
            poblarConsProductoSelect();    // Consignaciones
            refreshOrderProductSelects();  // Pedidos
            alert('‚úÖ Producto de inventario guardado exitosamente.');
        }

        function deleteInvProduct(productoKey) {
            if (!confirm('¬øEliminar este producto del inventario? Se eliminar√° tambi√©n su historial.')) return;
            inventoryData = inventoryData.filter(i => i.productoKey !== productoKey);
            movimientosData = movimientosData.filter(m => m.productoKey !== productoKey);
            saveInventory();
            saveMovimientos();
            loadInventoryList();
            loadMovimientosHistorial();
        }

        // ---- Modal Ajuste de Stock ----
        function showAjusteStockModal(productoKey) {
            // Poblar select
            const sel = document.getElementById('ajuste-producto');
            sel.innerHTML = '<option value="">Seleccionar producto‚Ä¶</option>' +
                inventoryData.map(i => `<option value="${i.productoKey}" ${i.productoKey === productoKey ? 'selected' : ''}>${i.nombre}</option>`).join('');
            document.getElementById('ajuste-cantidad').value = '0';
            document.getElementById('ajuste-tipo').value = 'entrada';
            document.getElementById('ajuste-motivo').value = '';
            document.getElementById('ajuste-preview').style.display = 'none';
            // Mostrar stock actual si viene con clave
            if (productoKey) {
                const item = inventoryData.find(i => i.productoKey === productoKey);
                if (item) {
                    document.getElementById('ajuste-stock-actual-display').style.display = 'block';
                    document.getElementById('ajuste-stock-val').textContent = item.stockActual + ' ' + (item.unidadMedida || '');
                }
            } else {
                document.getElementById('ajuste-stock-actual-display').style.display = 'none';
            }
            sel.onchange = function() {
                const it = inventoryData.find(i => i.productoKey === this.value);
                if (it) {
                    document.getElementById('ajuste-stock-actual-display').style.display = 'block';
                    document.getElementById('ajuste-stock-val').textContent = it.stockActual + ' ' + (it.unidadMedida || '');
                } else {
                    document.getElementById('ajuste-stock-actual-display').style.display = 'none';
                }
                updateAjustePreview();
            };
            document.getElementById('inv-ajuste-modal').style.display = 'flex';
        }

        function closeAjusteStockModal() {
            document.getElementById('inv-ajuste-modal').style.display = 'none';
        }

        function updateAjustePreview() {
            const key = document.getElementById('ajuste-producto').value;
            const tipo = document.getElementById('ajuste-tipo').value;
            const cant = parseInt(document.getElementById('ajuste-cantidad').value) || 0;
            const item = inventoryData.find(i => i.productoKey === key);
            if (!item || cant === 0) { document.getElementById('ajuste-preview').style.display = 'none'; return; }
            let nuevo;
            if (tipo === 'entrada') nuevo = item.stockActual + cant;
            else if (tipo === 'salida') nuevo = Math.max(0, item.stockActual - cant);
            else nuevo = cant; // absoluto
            const est = calcularEstadoInventario({ stockActual: nuevo, stockMinimo: item.stockMinimo });
            document.getElementById('ajuste-preview').style.display = 'block';
            document.getElementById('ajuste-preview').style.background = est.estado === 'agotado' ? '#fce4ec' : est.estado === 'bajo' ? '#fff3e0' : '#e8f5e9';
            document.getElementById('ajuste-preview-val').textContent = nuevo + ' ' + (item.unidadMedida || '') + ' ' + est.icono;
            document.getElementById('ajuste-preview-val').style.color = est.color;
        }

        function saveAjusteStock() {
            const key = document.getElementById('ajuste-producto').value;
            const tipo = document.getElementById('ajuste-tipo').value;
            const cant = parseInt(document.getElementById('ajuste-cantidad').value) || 0;
            const motivo = document.getElementById('ajuste-motivo').value.trim() || 'Ajuste manual';
            if (!key) { alert('Selecciona un producto'); return; }
            if (cant === 0 && tipo !== 'absoluto') { alert('La cantidad debe ser mayor a 0'); return; }
            const idx = inventoryData.findIndex(i => i.productoKey === key);
            if (idx === -1) return;
            const stockAnt = inventoryData[idx].stockActual;
            let stockNuevo;
            if (tipo === 'entrada') stockNuevo = stockAnt + cant;
            else if (tipo === 'salida') { stockNuevo = Math.max(0, stockAnt - cant); }
            else stockNuevo = cant;
            inventoryData[idx].stockActual = stockNuevo;
            inventoryData[idx].totalAjustes = (inventoryData[idx].totalAjustes || 0) + Math.abs(stockNuevo - stockAnt);
            inventoryData[idx].ultimoAjuste = new Date().toISOString().split('T')[0];
            inventoryData[idx].diasSinMovimiento = 0;
            const est = calcularEstadoInventario(inventoryData[idx]);
            inventoryData[idx].estado = est.estado;
            inventoryData[idx].requiereAlerta = est.estado !== 'normal';
            inventoryData[idx].modificadoEn = new Date().toISOString();
            registrarMovimiento(key, 'ajuste', Math.abs(stockNuevo - stockAnt), stockAnt, stockNuevo, motivo);
            saveInventory();
            closeAjusteStockModal();
            loadInventoryList();
            loadMovimientosHistorial();
            alert(`‚úÖ Stock de "${inventoryData[idx].nombre}" ajustado a ${stockNuevo}.`);
        }

        // ---- Modal Historial de un Producto ----
        function showInvHistorialProducto(productoKey) {
            const item = inventoryData.find(i => i.productoKey === productoKey);
            if (!item) return;
            document.getElementById('inv-historial-title').textContent = `üìã Historial: ${item.nombre}`;
            const valorStock = (item.stockActual || 0) * (item.costoPromedioUSD || 0);
            const est = calcularEstadoInventario(item);
            document.getElementById('inv-historial-resumen').innerHTML = `
                <div style="display:flex; flex-wrap:wrap; gap:16px;">
                    <span>${est.icono} <strong>Estado:</strong> <span style="color:${est.color}">${est.label}</span></span>
                    <span>üì¶ <strong>Stock:</strong> ${item.stockActual} / ${item.stockMaximo}</span>
                    <span>üí∞ <strong>Costo prom.:</strong> $${(item.costoPromedioUSD||0).toFixed(2)}</span>
                    <span>üíµ <strong>Valor stock:</strong> $${valorStock.toFixed(2)}</span>
                    <span>üõí <strong>Total compras:</strong> ${item.totalCompras || 0}</span>
                    <span>üõçÔ∏è <strong>Total ventas:</strong> ${item.totalVentas || 0}</span>
                </div>`;
            const movs = movimientosData.filter(m => m.productoKey === productoKey).slice(0, 50);
            const tipoLabel = { compra: 'üõí Compra', venta: 'üõçÔ∏è Venta', ajuste: '‚öñÔ∏è Ajuste' };
            const tipoColor = { compra: '#4caf50', venta: '#2196f3', ajuste: '#ff9800' };
            const tbody = document.getElementById('inv-historial-list');
            if (movs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#999; padding:20px;">Sin movimientos registrados</td></tr>`;
            } else {
                const delta = m => m.stockNuevo - m.stockAnterior;
                tbody.innerHTML = movs.map(m => `<tr>
                    <td>${formatDate(m.fecha)}</td>
                    <td style="color:${tipoColor[m.tipo]||'#666'}; font-weight:600;">${tipoLabel[m.tipo]||m.tipo}</td>
                    <td style="font-weight:600; color:${delta(m)>=0?'#4caf50':'#f44336'}">${delta(m)>=0?'+':''}${m.cantidad}</td>
                    <td>${m.stockAnterior}</td>
                    <td><strong>${m.stockNuevo}</strong></td>
                    <td><small style="color:#888;">${m.referencia||'-'}</small></td>
                </tr>`).join('');
            }
            document.getElementById('inv-historial-modal').style.display = 'flex';
        }

        // ---- Integraci√≥n con ventas: descontar stock ----
        // Esta funci√≥n es llamada desde saveSale() despu√©s de guardar la venta
        function integrarInventarioConVenta(saleItems, saleId, saleDate) {
            // Productos simples vinculados al inventario
            const itemsSimples = saleItems.filter(item =>
                !item.esKit &&
                inventoryData.some(i => i.vinculadoA === item.productKey || i.productoKey === item.productKey)
            );
            if (itemsSimples.length > 0) descontarStockPorVenta(saleItems, saleId);

            // B5: Kits - descontar componentes
            const itemsKit = saleItems.filter(item => item.esKit && item.componentes);
            itemsKit.forEach(kitItem => {
                kitItem.componentes.forEach(comp => {
                    const idx = inventoryData.findIndex(i => i.productoKey === comp.productoKey);
                    if (idx === -1) return;
                    const inv       = inventoryData[idx];
                    const stockAnt  = inv.stockActual;
                    const descontar = comp.cantidad * kitItem.quantity;
                    inv.stockActual   = Math.max(0, stockAnt - descontar);
                    inv.totalVentas   = (inv.totalVentas || 0) + descontar;
                    inv.ultimaVenta   = saleDate;
                    inv.diasSinMovimiento = 0;
                    const est = calcularEstadoInventario(inv);
                    inv.estado         = est.estado;
                    inv.requiereAlerta = est.estado !== 'normal';
                    inv.modificadoEn   = new Date().toISOString();
                    registrarMovimiento(
                        comp.productoKey, 'venta', descontar,
                        stockAnt, inv.stockActual,
                        `Kit "${kitItem.name}" √ó ${kitItem.quantity} - Venta #${saleId}`
                    );
                });
            });
            if (itemsKit.length > 0) {
                saveInventory();
                loadInventoryList();
                loadMovimientosHistorial();
            }
        }

        // ---- Alertas de inventario en dashboard ----
        function getInventarioAlertas() {
            const alertas = [];
            inventoryData.forEach(item => {
                const est = calcularEstadoInventario(item);
                if (est.estado === 'agotado') {
                    alertas.push({ tipo: 'agotado', producto: item.nombre, prioridad: 'alta' });
                } else if (est.estado === 'bajo') {
                    alertas.push({ tipo: 'stock_bajo', producto: item.nombre, actual: item.stockActual, minimo: item.stockMinimo, prioridad: 'media' });
                }
            });
            return alertas;
        }

        // ========== FIN B2: M√ìDULO DE INVENTARIO ==========

        // ========== B3: M√ìDULO DE COMPRAS ==========

        function saveCompras() {
            localStorage.setItem('comprasData', JSON.stringify(comprasData));
        }

        // ---- Poblar selects de productos ----
        function poblarCItemProductoSelect() {
            const sel = document.getElementById('c-item-producto');
            if (!sel) return;
            sel.innerHTML = '<option value="">Seleccionar producto de inventario‚Ä¶</option>' +
                inventoryData.map(i =>
                    `<option value="${i.productoKey}" data-costo="${i.costoPromedioUSD||0}">${i.nombre} (stock: ${i.stockActual})</option>`
                ).join('') +
                '<option value="__nuevo__">‚ûï Crear nuevo producto de inventario</option>';
        }

        function poblarProveedoresDatalist() {
            const dl = document.getElementById('compras-proveedores-list');
            if (!dl) return;
            const proveedores = [...new Set(comprasData.map(c => c.proveedor).filter(Boolean))];
            dl.innerHTML = proveedores.map(p => `<option value="${p}">`).join('');
        }

        function onCItemProductoChange() {
            const sel = document.getElementById('c-item-producto');
            if (sel.value === '__nuevo__') {
                showInvProductModal();
                const observer = new MutationObserver(() => {
                    if (document.getElementById('inv-product-modal').style.display === 'none') {
                        poblarCItemProductoSelect();
                        observer.disconnect();
                    }
                });
                observer.observe(document.getElementById('inv-product-modal'), { attributes: true, attributeFilter: ['style'] });
                sel.value = '';
                return;
            }
            const item = inventoryData.find(i => i.productoKey === sel.value);
            if (item && item.costoPromedioUSD > 0) {
                document.getElementById('c-item-costo').value = item.costoPromedioUSD.toFixed(2);
            }
            updateCItemPreview();
        }

        function updateCItemPreview() {
            const cant  = parseFloat(document.getElementById('c-item-cantidad').value) || 0;
            const costo = parseFloat(document.getElementById('c-item-costo').value) || 0;
            document.getElementById('c-item-preview').textContent = 'Subtotal: $' + (cant * costo).toFixed(2);
        }

        function agregarCItem() {
            const sel   = document.getElementById('c-item-producto');
            const key   = sel.value;
            const cant  = parseInt(document.getElementById('c-item-cantidad').value) || 0;
            const costo = parseFloat(document.getElementById('c-item-costo').value) || 0;

            if (!key || key === '__nuevo__') { alert('Selecciona un producto'); return; }
            if (cant <= 0)  { alert('La cantidad debe ser mayor a 0'); return; }
            if (costo <= 0) { alert('El costo unitario debe ser mayor a 0'); return; }

            const inv = inventoryData.find(i => i.productoKey === key);
            if (!inv) { alert('Producto no encontrado'); return; }

            const existing = cItems.find(i => i.productoKey === key);
            if (existing) {
                // Costo promedio ponderado si se agrega el mismo producto con distinto precio
                const costoPromedio = ((existing.cantidad * existing.costoUnitarioUSD) + (cant * costo)) / (existing.cantidad + cant);
                existing.cantidad        += cant;
                existing.costoUnitarioUSD = parseFloat(costoPromedio.toFixed(4));
                existing.subtotalUSD      = existing.cantidad * existing.costoUnitarioUSD;
            } else {
                cItems.push({ productoKey: key, nombre: inv.nombre, cantidad: cant, costoUnitarioUSD: costo, subtotalUSD: cant * costo });
            }

            renderCItems();
            sel.value = '';
            document.getElementById('c-item-cantidad').value = '1';
            document.getElementById('c-item-costo').value = '0';
            document.getElementById('c-item-preview').textContent = 'Subtotal: $0.00';
        }

        function eliminarCItem(idx) {
            cItems.splice(idx, 1);
            renderCItems();
        }

        function renderCItems() {
            const container = document.getElementById('c-items-container');
            const listDiv   = document.getElementById('c-items-list');
            const total     = cItems.reduce((s, i) => s + i.subtotalUSD, 0);
            document.getElementById('c-total-preview').textContent = '$' + total.toFixed(2) + ' USD';
            document.getElementById('c-total-final').textContent   = '$' + total.toFixed(2) + ' USD';

            if (cItems.length === 0) { listDiv.style.display = 'none'; return; }
            listDiv.style.display = 'block';
            container.innerHTML = cItems.map((item, idx) => `
                <div style="display:flex; justify-content:space-between; align-items:center; background:#f8f9fa; border-radius:7px; padding:9px 13px; margin-bottom:6px; font-size:13px;">
                    <div>
                        <strong>${item.nombre}</strong>
                        <span style="color:#666;"> - ${item.cantidad} u √ó $${item.costoUnitarioUSD.toFixed(2)}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <strong style="color:#2e7d32;">$${item.subtotalUSD.toFixed(2)}</strong>
                        <span onclick="eliminarCItem(${idx})" style="cursor:pointer; color:#f44336; font-size:16px; font-weight:700;">‚úï</span>
                    </div>
                </div>`).join('');
        }

        // ---- Toggle formulario ----
        function toggleComprasForm() {
            const form = document.getElementById('compras-form-container');
            const icon = document.getElementById('compras-form-icon');
            const visible = form.style.display !== 'none';
            form.style.display = visible ? 'none' : 'block';
            icon.className = visible ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
        }

        // ---- Limpiar formulario ----
        function limpiarFormCompra() {
            document.getElementById('c-proveedor').value = '';
            document.getElementById('c-factura').value = '';
            document.getElementById('c-observaciones').value = '';
            document.getElementById('c-estado-pago').value = 'pagado';
            document.getElementById('c-metodo-pago').value = 'Efectivo USD';
            document.getElementById('c-item-producto').value = '';
            document.getElementById('c-item-cantidad').value = '1';
            document.getElementById('c-item-costo').value = '0';
            document.getElementById('c-item-preview').textContent = 'Subtotal: $0.00';
            cItems = [];
            renderCItems();
        }

        // ---- Guardar Compra ----
        function guardarCompra() {
            const fecha    = document.getElementById('c-fecha').value;
            const proveedor = document.getElementById('c-proveedor').value.trim();
            if (!fecha)     { alert('Selecciona la fecha'); return; }
            if (!proveedor) { alert('Ingresa el nombre del proveedor'); return; }
            if (cItems.length === 0) { alert('Agrega al menos un producto a la compra'); return; }

            const totalUSD = cItems.reduce((s, i) => s + i.subtotalUSD, 0);
            const compra = {
                id: Date.now().toString(),
                fecha,
                proveedor,
                factura:       document.getElementById('c-factura').value.trim(),
                items:         JSON.parse(JSON.stringify(cItems)),
                subtotalUSD:   totalUSD,
                totalUSD,
                metodoPago:    document.getElementById('c-metodo-pago').value,
                estadoPago:    document.getElementById('c-estado-pago').value,
                observaciones: document.getElementById('c-observaciones').value.trim(),
                creadoEn:      new Date().toISOString()
            };

            // Actualizar inventario con PEPS
            let errores = [];
            compra.items.forEach(item => {
                const idx = inventoryData.findIndex(i => i.productoKey === item.productoKey);
                if (idx === -1) { errores.push(item.nombre); return; }
                const inv      = inventoryData[idx];
                const stockAnt = inv.stockActual;
                const costoTotalAnt   = (inv.costoPromedioUSD || 0) * stockAnt;
                const costoTotalNuevo = item.costoUnitarioUSD * item.cantidad;
                const nuevoStock      = stockAnt + item.cantidad;
                inv.costoPromedioUSD  = nuevoStock > 0 ? (costoTotalAnt + costoTotalNuevo) / nuevoStock : item.costoUnitarioUSD;
                inv.stockActual       = nuevoStock;
                inv.totalCompras      = (inv.totalCompras || 0) + item.cantidad;
                inv.ultimaCompra      = fecha;
                inv.diasSinMovimiento = 0;
                const est = calcularEstadoInventario(inv);
                inv.estado         = est.estado;
                inv.requiereAlerta = est.estado !== 'normal';
                inv.modificadoEn   = new Date().toISOString();
                registrarMovimiento(item.productoKey, 'compra', item.cantidad, stockAnt, nuevoStock,
                    `Compra #${compra.id} - ${proveedor}`);
            });
            saveInventory();

            comprasData.unshift(compra);
            saveCompras();

            limpiarFormCompra();
            loadComprasDashboard();
            loadComprasHistorial();
            loadInventoryList();
            loadMovimientosHistorial();
            poblarProveedoresDatalist();

            const msg = errores.length > 0
                ? `‚úÖ Compra registrada.\n‚ö†Ô∏è No se encontr√≥ en inventario: ${errores.join(', ')}`
                : `‚úÖ Compra registrada. Inventario actualizado (${compra.items.length} producto${compra.items.length > 1 ? 's' : ''}).`;
            alert(msg);
        }

        // ---- Dashboard de Compras ----
        function loadComprasDashboard() {
            const hoy   = new Date();
            const mes   = hoy.getMonth();
            const anio  = hoy.getFullYear();
            const deMes = comprasData.filter(c => {
                const d = new Date(c.fecha + 'T00:00:00');
                return d.getMonth() === mes && d.getFullYear() === anio;
            });
            const pendientes = comprasData.filter(c => c.estadoPago !== 'pagado');
            const deudaUSD   = pendientes.reduce((s, c) => s + (c.totalUSD || 0), 0);

            document.getElementById('compras-mes-usd').textContent   = '$' + deMes.reduce((s, c) => s + (c.totalUSD || 0), 0).toFixed(2);
            document.getElementById('compras-mes-count').textContent  = deMes.length;
            document.getElementById('compras-pendientes-count').textContent = pendientes.length;
            document.getElementById('compras-deuda-usd').textContent  = '$' + deudaUSD.toFixed(2);
        }

        // ---- Historial de Compras ----
        function loadComprasHistorial() {
            filtrarCompras();
        }

        function filtrarCompras() {
            const busqueda = (document.getElementById('compras-search')?.value || '').toLowerCase();
            const filtPago = document.getElementById('compras-filtro-pago')?.value || 'todos';
            const desde    = document.getElementById('compras-desde')?.value || '';
            const hasta    = document.getElementById('compras-hasta')?.value || '';

            let lista = [...comprasData];
            if (busqueda)          lista = lista.filter(c => (c.proveedor + ' ' + c.factura).toLowerCase().includes(busqueda));
            if (filtPago !== 'todos') lista = lista.filter(c => c.estadoPago === filtPago);
            if (desde)             lista = lista.filter(c => c.fecha >= desde);
            if (hasta)             lista = lista.filter(c => c.fecha <= hasta);

            renderComprasHistorial(lista);
        }

        function renderComprasHistorial(lista) {
            const container = document.getElementById('compras-historial-container');
            if (lista.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#999; padding:30px;">
                    <div style="font-size:40px; margin-bottom:8px;">üõí</div>
                    <p>No hay compras que coincidan con el filtro.</p></div>`;
                return;
            }

            const mostrarTodasComp = container.dataset.showAll === '1';
            const listaVis = mostrarTodasComp ? lista : lista.slice(0, 10);

            const pagoColor  = { pagado: '#4caf50', pendiente: '#f44336', parcial: '#ff9800' };
            const pagoLabel  = { pagado: '‚úÖ Pagado', pendiente: '‚è≥ Pendiente', parcial: '‚ö° Parcial' };

            container.innerHTML = listaVis.map(compra => {
                const itemsSummary = compra.items.map(i =>
                    `<span style="background:#f0f4ff; border-radius:4px; padding:2px 7px; font-size:11px; margin:2px;">${i.cantidad}√ó ${i.nombre}</span>`
                ).join('');
                const color = pagoColor[compra.estadoPago] || '#999';
                const label = pagoLabel[compra.estadoPago] || compra.estadoPago;
                return `
                <div style="border:1px solid #e0e0e0; border-left:4px solid ${color}; border-radius:9px; padding:14px 16px; margin-bottom:10px; background:white;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:8px;">
                        <div>
                            <div style="font-weight:700; font-size:15px;">üè≠ ${compra.proveedor}</div>
                            <small style="color:#888;">${formatDate(compra.fecha)}${compra.factura ? ' ¬∑ Fact. ' + compra.factura : ''} ¬∑ ${compra.metodoPago}</small>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:18px; font-weight:700; color:#2e7d32;">$${(compra.totalUSD||0).toFixed(2)}</div>
                            <span style="background:${color}20; color:${color}; border-radius:20px; padding:2px 10px; font-size:12px; font-weight:600;">${label}</span>
                        </div>
                    </div>
                    <div style="margin:10px 0 8px; flex-wrap:wrap; display:flex; gap:3px;">${itemsSummary}</div>
                    ${compra.observaciones ? `<div style="font-size:12px; color:#666; margin-bottom:8px;">üìù ${compra.observaciones}</div>` : ''}
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-small" style="background:#667eea; color:white;" onclick="verDetalleCompra('${compra.id}')">
                            <i class="fas fa-eye"></i> Detalle
                        </button>
                        ${compra.estadoPago !== 'pagado' ? `
                        <button class="btn btn-small btn-warning" onclick="abrirPagoCompra('${compra.id}')">
                            <i class="fas fa-credit-card"></i> Registrar Pago
                        </button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="eliminarCompra('${compra.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');
            // Bot√≥n Ver todos compras
            if (lista.length > 10) {
                container.innerHTML += `<div style="text-align:center; padding:10px;">
                    <button class="btn btn-secondary btn-small" style="width:100%"
                        onclick="this.closest('#compras-historial-container, [id=compras-historial-container]') && (document.getElementById('compras-historial-container').dataset.showAll = document.getElementById('compras-historial-container').dataset.showAll === '1' ? '0' : '1') || (document.getElementById('compras-historial-container').dataset.showAll = document.getElementById('compras-historial-container').dataset.showAll === '1' ? '0' : '1'); filtrarCompras();">
                        ${mostrarTodasComp ? '‚ñ≤ Ver menos (√∫ltimas 10)' : '‚ñº Ver todas (' + lista.length + ' compras)'}
                    </button></div>`;
            }
        }

        // ---- Ver detalle ----
        function verDetalleCompra(id) {
            const compra = comprasData.find(c => c.id === id);
            if (!compra) return;
            document.getElementById('compra-detalle-title').textContent = `üõí Compra - ${compra.proveedor}`;
            const pagoColor = { pagado: '#4caf50', pendiente: '#f44336', parcial: '#ff9800' };
            const pagoLabel = { pagado: '‚úÖ Pagado', pendiente: '‚è≥ Pendiente', parcial: '‚ö° Parcial' };
            const color = pagoColor[compra.estadoPago] || '#999';
            document.getElementById('compra-detalle-body').innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; font-size:13px;">
                    <div><strong>Proveedor:</strong> ${compra.proveedor}</div>
                    <div><strong>Fecha:</strong> ${formatDate(compra.fecha)}</div>
                    <div><strong>Factura:</strong> ${compra.factura || '-'}</div>
                    <div><strong>M√©todo:</strong> ${compra.metodoPago}</div>
                    <div><strong>Estado:</strong> <span style="color:${color}; font-weight:600;">${pagoLabel[compra.estadoPago]||compra.estadoPago}</span></div>
                    <div><strong>Total:</strong> <span style="color:#2e7d32; font-weight:700; font-size:16px;">$${(compra.totalUSD||0).toFixed(2)} USD</span></div>
                </div>
                <div style="font-weight:600; margin-bottom:8px;">Productos comprados:</div>
                <div class="table-scroll-wrap"><table style="width:100%; border-collapse:collapse; font-size:13px;">
                    <thead><tr style="background:#f5f5f5;">
                        <th style="padding:8px; text-align:left;">Producto</th>
                        <th style="padding:8px; text-align:right;">Cant.</th>
                        <th style="padding:8px; text-align:right;">Costo Unit.</th>
                        <th style="padding:8px; text-align:right;">Subtotal</th>
                    </tr></thead>
                    <tbody>${compra.items.map(i => `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:8px;">${i.nombre}</td>
                            <td style="padding:8px; text-align:right;">${i.cantidad}</td>
                            <td style="padding:8px; text-align:right;">$${i.costoUnitarioUSD.toFixed(2)}</td>
                            <td style="padding:8px; text-align:right; font-weight:600; color:#2e7d32;">$${i.subtotalUSD.toFixed(2)}</td>
                        </tr>`).join('')}
                        <tr style="background:#e8f5e9; font-weight:700;">
                            <td colspan="3" style="padding:10px;">TOTAL</td>
                            <td style="padding:10px; text-align:right; font-size:16px; color:#2e7d32;">$${(compra.totalUSD||0).toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table></div>
                ${compra.observaciones ? `<div style="margin-top:12px; padding:10px; background:#f8f9fa; border-radius:6px; font-size:13px;">üìù ${compra.observaciones}</div>` : ''}`;
            document.getElementById('compra-detalle-modal').style.display = 'flex';
        }

        // ---- Registrar pago ----
        function abrirPagoCompra(id) {
            const compra = comprasData.find(c => c.id === id);
            if (!compra) return;
            currentPagoCompraId = id;
            document.getElementById('compra-pago-info').innerHTML =
                `<strong>${compra.proveedor}</strong> ¬∑ $${(compra.totalUSD||0).toFixed(2)} USD<br>
                Estado actual: <em>${compra.estadoPago}</em>`;
            document.getElementById('pago-nuevo-estado').value  = 'pagado';
            document.getElementById('pago-nuevo-metodo').value  = compra.metodoPago || 'Efectivo USD';
            document.getElementById('pago-notas').value         = '';
            document.getElementById('compra-pago-modal').style.display = 'flex';
        }

        function guardarPagoCompra() {
            const compra = comprasData.find(c => c.id === currentPagoCompraId);
            if (!compra) return;
            compra.estadoPago  = document.getElementById('pago-nuevo-estado').value;
            compra.metodoPago  = document.getElementById('pago-nuevo-metodo').value;
            const notas        = document.getElementById('pago-notas').value.trim();
            if (notas) compra.observaciones = (compra.observaciones ? compra.observaciones + ' | ' : '') + notas;
            compra.fechaPago   = new Date().toISOString().split('T')[0];
            saveCompras();
            document.getElementById('compra-pago-modal').style.display = 'none';
            loadComprasDashboard();
            loadComprasHistorial();
            alert(`‚úÖ Pago registrado como "${compra.estadoPago}" para ${compra.proveedor}.`);
        }

        // ---- Eliminar compra (con reversi√≥n de inventario) ----
        function eliminarCompra(id) {
            const compra = comprasData.find(c => c.id === id);
            if (!compra) return;
            if (!confirm(`‚ö†Ô∏è ¬øEliminar la compra de "${compra.proveedor}" por $${(compra.totalUSD||0).toFixed(2)}?\n\nSe REVERTIR√Å el stock actualizado en el inventario.`)) return;

            // Revertir inventario
            compra.items.forEach(item => {
                const idx = inventoryData.findIndex(i => i.productoKey === item.productoKey);
                if (idx === -1) return;
                const inv      = inventoryData[idx];
                const stockAnt = inv.stockActual;
                const nuevoStock = Math.max(0, stockAnt - item.cantidad);
                inv.stockActual   = nuevoStock;
                inv.totalCompras  = Math.max(0, (inv.totalCompras || 0) - item.cantidad);
                inv.modificadoEn  = new Date().toISOString();
                const est = calcularEstadoInventario(inv);
                inv.estado         = est.estado;
                inv.requiereAlerta = est.estado !== 'normal';
                registrarMovimiento(item.productoKey, 'ajuste', item.cantidad, stockAnt, nuevoStock,
                    `Eliminaci√≥n Compra #${id}`);
            });
            saveInventory();

            comprasData = comprasData.filter(c => c.id !== id);
            saveCompras();
            loadComprasDashboard();
            loadComprasHistorial();
            loadInventoryList();
            loadMovimientosHistorial();
            alert('‚úÖ Compra eliminada y stock revertido.');
        }

        // ========== FIN B3: M√ìDULO DE COMPRAS ==========

        // ========== B4: M√ìDULO DE CONSIGNACIONES ==========

        function saveConsignaciones() {
            localStorage.setItem('consignacionesData', JSON.stringify(consignacionesData));
        }

        // ---- Helpers ----
        function cerrarConsModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function calcularTotalConsignacion() {
            const cant  = parseFloat(document.getElementById('cons-cantidad').value)    || 0;
            const precio = parseFloat(document.getElementById('cons-precio-unit').value) || 0;
            document.getElementById('cons-total-preview').textContent = '$' + (cant * precio).toFixed(2) + ' USD';
        }

        // ---- Poblar selects ----
        function poblarConsClienteSelect() {
            const sel = document.getElementById('cons-cliente');
            if (!sel) return;
            const sorted = [...clientsData].sort((a, b) => a.name.localeCompare(b.name, 'es'));
            sel.innerHTML = '<option value="">Seleccionar cliente‚Ä¶</option>' +
                sorted.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }

        function poblarConsProductoSelect() {
            const sel = document.getElementById('cons-producto-inv');
            if (!sel) return;

            // Construir opciones: productos de inventario + kits + manual
            const optsInv = inventoryData.map(i => {
                // Precio de venta: waterPrices[vinculadoA] tiene prioridad ‚Üí luego precioVentaUSD ‚Üí fallback
                const precioVenta = getPrecioVentaInventario(i);
                return `<option value="${i.productoKey}" data-precio="${precioVenta}">${i.nombre} (stock: ${i.stockActual})</option>`;
            }).join('');

            const optsKits = productosCompuestos
                .filter(k => k.activo !== false)
                .map(k => {
                    const stock = calcularStockKit(k);
                    return `<option value="${k.key}" data-precio="${k.precioVentaUSD || 0}">üß© ${k.nombre} (stock kit: ${stock})</option>`;
                }).join('');

            sel.innerHTML = '<option value="">Seleccionar producto‚Ä¶</option>' +
                optsInv + optsKits +
                '<option value="__manual__">‚úèÔ∏è Producto manual (sin inventario)</option>';

            sel.onchange = function() {
                const key = this.value;
                // Buscar en inventario
                const invItem = inventoryData.find(i => i.productoKey === key);
                if (invItem) {
                    const precio = getPrecioVentaInventario(invItem);
                    document.getElementById('cons-precio-unit').value = precio.toFixed(2);
                    calcularTotalConsignacion();
                    return;
                }
                // Buscar en kits
                const kit = productosCompuestos.find(k => k.key === key);
                if (kit) {
                    document.getElementById('cons-precio-unit').value = (kit.precioVentaUSD || 0).toFixed(2);
                    calcularTotalConsignacion();
                }
            };
        }

        // Resolver precio de VENTA de un item de inventario
        // Prioridad: waterPrices[vinculadoA].priceUSD ‚Üí precioVentaUSD ‚Üí costoPromedioUSD
        function getPrecioVentaInventario(invItem) {
            if (invItem.vinculadoA && waterPrices[invItem.vinculadoA]) {
                const wp = waterPrices[invItem.vinculadoA];
                if (wp.priceUSD > 0) return wp.priceUSD;
            }
            if (invItem.precioVentaUSD > 0) return invItem.precioVentaUSD;
            // Fallback: costo (no ideal, pero evita $0)
            return invItem.costoPromedioUSD || 0;
        }

        // ---- Abrir modal nueva consignaci√≥n ----
        function abrirNuevaConsignacion() {
            poblarConsClienteSelect();
            poblarConsProductoSelect();
            document.getElementById('cons-fecha-entrega').value = new Date().toISOString().split('T')[0];
            document.getElementById('cons-cantidad').value      = '1';
            document.getElementById('cons-precio-unit').value   = '15.00';
            document.getElementById('cons-obs-entrega').value   = '';
            document.getElementById('cons-total-preview').textContent = '$15.00 USD';
            document.getElementById('cons-nueva-modal').style.display = 'flex';
        }

        // ---- Guardar nueva consignaci√≥n (entrega) ----
        function guardarConsignacion() {
            const clienteNombre = document.getElementById('cons-cliente').value;
            const fechaEntrega  = document.getElementById('cons-fecha-entrega').value;
            const productoKey   = document.getElementById('cons-producto-inv').value;
            const cantidad      = parseInt(document.getElementById('cons-cantidad').value) || 0;
            const precioUnit    = parseFloat(document.getElementById('cons-precio-unit').value) || 0;

            if (!clienteNombre) { alert('Selecciona un cliente'); return; }
            if (!fechaEntrega)  { alert('Ingresa la fecha de entrega'); return; }
            if (cantidad <= 0)  { alert('La cantidad debe ser mayor a 0'); return; }
            if (precioUnit <= 0){ alert('El precio unitario debe ser mayor a 0'); return; }

            // Verificar stock si tiene producto de inventario vinculado
            if (productoKey && productoKey !== '__manual__') {
                const inv = inventoryData.find(i => i.productoKey === productoKey);
                if (inv && inv.stockActual < cantidad) {
                    if (!confirm(`‚ö†Ô∏è Stock insuficiente de "${inv.nombre}".\nDisponible: ${inv.stockActual} | Solicitado: ${cantidad}\n\n¬øContinuar de todas formas?`)) return;
                }
                // Descontar del inventario
                if (inv) {
                    const stockAnt   = inv.stockActual;
                    inv.stockActual  = Math.max(0, stockAnt - cantidad);
                    inv.totalVentas  = (inv.totalVentas || 0) + cantidad;
                    inv.ultimaVenta  = fechaEntrega;
                    inv.diasSinMovimiento = 0;
                    const est = calcularEstadoInventario(inv);
                    inv.estado         = est.estado;
                    inv.requiereAlerta = est.estado !== 'normal';
                    inv.modificadoEn   = new Date().toISOString();
                    registrarMovimiento(productoKey, 'venta', cantidad, stockAnt, inv.stockActual,
                        `Consignaci√≥n entrega ‚Üí ${clienteNombre}`);
                    saveInventory();
                    loadInventoryList();
                }
            }

            const consignacion = {
                id:               Date.now().toString(),
                cliente:          clienteNombre,
                fechaEntrega,
                productoKey:      productoKey && productoKey !== '__manual__' ? productoKey : null,
                productoNombre:   productoKey && productoKey !== '__manual__'
                    ? (inventoryData.find(i => i.productoKey === productoKey)?.nombre || productoKey)
                    : 'Botell√≥n (manual)',
                cantidadEntregada: cantidad,
                precioUnitarioUSD: precioUnit,
                totalUSD:         cantidad * precioUnit,
                estado:           'entregado',
                fechaProceso:     null,
                cantidadDevuelta: 0,
                cantidadCobrada:  0,
                montoCobradoUSD:  0,
                observaciones:    document.getElementById('cons-obs-entrega').value.trim(),
                ventaGeneradaId:  null,
                creadoEn:         new Date().toISOString()
            };

            consignacionesData.unshift(consignacion);
            saveConsignaciones();
            cerrarConsModal('cons-nueva-modal');
            loadConsignacionesDashboard();
            loadConsignacionesList();
            alert(`‚úÖ Consignaci√≥n registrada.\n${cantidad} unidad(es) entregadas a ${clienteNombre}.`);
        }

        // ---- Abrir modal proceso ----
        function abrirProcesoConsignacion(id) {
            const cons = consignacionesData.find(c => c.id === id);
            if (!cons) return;
            currentConsId = id;

            const pendiente = cons.cantidadEntregada - cons.cantidadDevuelta - cons.cantidadCobrada;
            document.getElementById('cons-proc-info').innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                    <span>üë§ <strong>${cons.cliente}</strong></span>
                    <span>üìÖ ${formatDate(cons.fechaEntrega)}</span>
                    <span>üì¶ Entregados: <strong>${cons.cantidadEntregada}</strong></span>
                    <span>üí∞ $${cons.precioUnitarioUSD.toFixed(2)}/u</span>
                    <span>‚Ü©Ô∏è Ya devueltos: <strong>${cons.cantidadDevuelta}</strong></span>
                    <span>‚úÖ Ya cobrados: <strong>${cons.cantidadCobrada}</strong></span>
                    <span style="grid-column:1/-1; font-weight:700; color:#e65100;">‚ö° Pendientes: ${pendiente} unidades</span>
                </div>`;

            document.getElementById('cons-proc-devueltos').value = '0';
            document.getElementById('cons-proc-cobrados').value  = String(pendiente);
            document.getElementById('cons-proc-obs').value       = '';
            document.getElementById('cons-proc-resumen').style.display = 'none';
            document.getElementById('cons-proc-pago-row').style.display = 'none';
            calcularProcesoConsignacion();
            document.getElementById('cons-procesar-modal').style.display = 'flex';
        }

        // ---- Obtener precio de venta VIGENTE para una consignaci√≥n al momento del cobro ----
        // Prioridad: waterPrices[invItem.vinculadoA] ‚Üí kit.precioVentaUSD ‚Üí cons.precioUnitarioUSD (hist√≥rico)
        function getPrecioVigenteConsignacion(cons) {
            // Buscar en inventario
            if (cons.productoKey) {
                const invItem = inventoryData.find(i => i.productoKey === cons.productoKey);
                if (invItem) return getPrecioVentaInventario(invItem);
                // Puede ser un kit
                const kit = productosCompuestos.find(k => k.key === cons.productoKey);
                if (kit && kit.precioVentaUSD > 0) return kit.precioVentaUSD;
            }
            // Fallback: precio guardado al crear la consignaci√≥n
            return cons.precioUnitarioUSD;
        }

        function calcularProcesoConsignacion() {
            if (!currentConsId) return;
            const cons      = consignacionesData.find(c => c.id === currentConsId);
            if (!cons) return;
            const pendiente  = cons.cantidadEntregada - cons.cantidadDevuelta - cons.cantidadCobrada;
            const devueltos  = parseInt(document.getElementById('cons-proc-devueltos').value) || 0;
            const cobrados   = parseInt(document.getElementById('cons-proc-cobrados').value)  || 0;
            const total      = devueltos + cobrados;

            // Precio vigente al momento del cobro
            const precioVigente = getPrecioVigenteConsignacion(cons);
            const precioOriginal = cons.precioUnitarioUSD;
            const cambioPrecio   = Math.abs(precioVigente - precioOriginal) > 0.001;
            const montoCobro     = cobrados * precioVigente;

            const resumen = document.getElementById('cons-proc-resumen');
            const pagoRow = document.getElementById('cons-proc-pago-row');

            if (total > pendiente) {
                resumen.style.display = 'block';
                resumen.style.background = '#ffebee';
                resumen.innerHTML = `<span style="color:#f44336;">‚ö†Ô∏è La suma (${total}) supera las unidades pendientes (${pendiente}).</span>`;
                pagoRow.style.display = 'none';
                return;
            }

            resumen.style.display = 'block';
            resumen.style.background = cobrados > 0 ? '#e8f5e9' : '#f3e5f5';
            resumen.innerHTML = `
                <div style="display:grid; gap:6px;">
                    ${devueltos > 0 ? `<div>‚Ü©Ô∏è Devueltos al inventario: <strong>${devueltos} unidades</strong></div>` : ''}
                    ${cobrados  > 0 ? `
                        <div>üíµ Cobro a precio vigente: <strong>${cobrados} u √ó $${precioVigente.toFixed(2)} = <span style="color:#2e7d32;">$${montoCobro.toFixed(2)}</span></strong></div>
                        ${cambioPrecio ? `<div style="font-size:12px; color:#ff9800;">‚ÑπÔ∏è Precio actualizado (entrega: $${precioOriginal.toFixed(2)} ‚Üí vigente: $${precioVigente.toFixed(2)})</div>` : ''}
                    ` : ''}
                    ${total < pendiente ? `<div style="color:#ff9800;">‚ö° Quedan ${pendiente - total} unidades a√∫n pendientes (estado: Mixto)</div>` : ''}
                    ${total === 0 ? `<div style="color:#999;">Sin cambios seleccionados.</div>` : ''}
                </div>`;

            pagoRow.style.display = cobrados > 0 ? 'block' : 'none';
        }

        // ---- Ejecutar proceso ----
        function ejecutarProcesoConsignacion() {
            const cons     = consignacionesData.find(c => c.id === currentConsId);
            if (!cons) return;
            const pendiente = cons.cantidadEntregada - cons.cantidadDevuelta - cons.cantidadCobrada;
            const devueltos = parseInt(document.getElementById('cons-proc-devueltos').value) || 0;
            const cobrados  = parseInt(document.getElementById('cons-proc-cobrados').value)  || 0;
            const total     = devueltos + cobrados;

            if (total === 0)          { alert('Ingresa al menos una cantidad a devolver o cobrar'); return; }
            if (total > pendiente)    { alert(`La suma (${total}) supera las unidades pendientes (${pendiente})`); return; }

            const metodoPago = document.getElementById('cons-proc-metodo-pago').value;
            if (cobrados > 0 && !metodoPago) { alert('Selecciona el m√©todo de pago para el cobro'); return; }

            const hoy = new Date().toISOString().split('T')[0];

            // Precio VIGENTE al momento del cobro (no el precio de la entrega)
            const precioVigente = getPrecioVigenteConsignacion(cons);

            // ---- 1. Devolver al inventario ----
            if (devueltos > 0 && cons.productoKey) {
                const inv = inventoryData.find(i => i.productoKey === cons.productoKey);
                if (inv) {
                    const stockAnt   = inv.stockActual;
                    inv.stockActual += devueltos;
                    inv.totalCompras = (inv.totalCompras || 0) + devueltos;
                    inv.ultimaCompra = hoy;
                    inv.modificadoEn = new Date().toISOString();
                    const est = calcularEstadoInventario(inv);
                    inv.estado         = est.estado;
                    inv.requiereAlerta = est.estado !== 'normal';
                    registrarMovimiento(cons.productoKey, 'ajuste', devueltos, stockAnt, inv.stockActual,
                        `Devoluci√≥n consignaci√≥n #${cons.id} - ${cons.cliente}`);
                    saveInventory();
                    loadInventoryList();
                }
            }

            // ---- 2. Generar venta al precio VIGENTE ----
            let ventaId = null;
            if (cobrados > 0) {
                const montoCobro   = cobrados * precioVigente;
                const montoCobroBS = convertUSDtoBS(montoCobro);
                ventaId = Date.now();
                const ventaCons = {
                    id:           ventaId,
                    date:         hoy,
                    customer:     cons.cliente,
                    customerRif:  (clientsData.find(c => c.name === cons.cliente)?.rif) || '',
                    items: [{
                        productKey:  cons.productoKey || 'consignacion',
                        name:        cons.productoNombre,
                        quantity:    cobrados,
                        priceUSD:    precioVigente,
                        priceBS:     convertUSDtoBS(precioVigente),
                        hasIva:      false
                    }],
                    subtotal:      montoCobroBS,
                    iva:           0,
                    total:         montoCobroBS,
                    totalUSD:      montoCobro,
                    paymentMethod: metodoPago,
                    documentType:  'Nota de Entrega',
                    retencionIva:  0, retencionIslr: 0,
                    totalNeto:     montoCobroBS,
                    notes:         `Cobro consignaci√≥n #${cons.id} - precio vigente $${precioVigente.toFixed(2)}`,
                    esConsignacion: true
                };
                salesData.unshift(ventaCons);
                localStorage.setItem('salesData', JSON.stringify(salesData));

                // ---- Si m√©todo es Cr√©dito: crear registro en creditsData ----
                if (metodoPago === 'Cr√©dito') {
                    const clienteData  = clientsData.find(c => c.name === cons.cliente);
                    const diasCredito  = clienteData?.diasCredito    || 30;
                    const diasAlerta   = clienteData?.diasAlertaAntes || 3;
                    const fechaBase    = new Date(hoy + 'T00:00:00');
                    fechaBase.setDate(fechaBase.getDate() + diasCredito);
                    const fechaVencimiento = fechaBase.toISOString().split('T')[0];
                    const creditoCons = {
                        id:              ventaId,
                        customer:        cons.cliente,
                        date:            hoy,
                        amount:          parseFloat(montoCobro.toFixed(2)),
                        paid:            0,
                        balance:         parseFloat(montoCobro.toFixed(2)),
                        status:          'Pendiente',
                        payments:        [],
                        fechaVencimiento,
                        diasCredito,
                        diasAlertaAntes: diasAlerta,
                        notas:           `Cr√©dito por consignaci√≥n #${cons.id} - ${cons.productoNombre} √ó ${cobrados} @ $${precioVigente.toFixed(2)}`
                    };
                    creditsData.unshift(creditoCons);
                    localStorage.setItem('creditsData', JSON.stringify(creditsData));
                    if (typeof loadPendingCredits === 'function') loadPendingCredits();
                }

                loadDashboard();
                loadSalesHistory();
                loadRecentSales();
            }

            // ---- 3. Actualizar consignaci√≥n ----
            cons.cantidadDevuelta += devueltos;
            cons.cantidadCobrada  += cobrados;
            // Registrar monto cobrado al precio vigente
            cons.montoCobradoUSD  += cobrados > 0 ? cobrados * precioVigente : 0;
            cons.fechaProceso      = hoy;
            cons.ventaGeneradaId   = ventaId || cons.ventaGeneradaId;
            const obs = document.getElementById('cons-proc-obs').value.trim();
            if (obs) cons.observaciones = (cons.observaciones ? cons.observaciones + ' | ' : '') + obs;

            const pendienteRestante = cons.cantidadEntregada - cons.cantidadDevuelta - cons.cantidadCobrada;
            if (pendienteRestante <= 0) {
                // Cerrada: determinar estado final
                if (cons.cantidadCobrada > 0 && cons.cantidadDevuelta > 0) cons.estado = 'mixto';
                else if (cons.cantidadCobrada > 0) cons.estado = 'cobrado';
                else cons.estado = 'devuelto';
            } else {
                cons.estado = 'mixto'; // Proceso parcial
            }

            saveConsignaciones();
            cerrarConsModal('cons-procesar-modal');
            loadConsignacionesDashboard();
            loadConsignacionesList();

            const msgs = [];
            if (devueltos > 0) msgs.push(`‚Ü©Ô∏è ${devueltos} devueltos al inventario`);
            if (cobrados  > 0) msgs.push(`üíµ Venta generada: ${cobrados} u √ó $${precioVigente.toFixed(2)} = $${(cobrados * precioVigente).toFixed(2)}`);
            alert('‚úÖ Consignaci√≥n procesada.\n' + msgs.join('\n'));
        }

        // ---- Dashboard ----
        function loadConsignacionesDashboard() {
            const abiertas = consignacionesData.filter(c => c.estado === 'entregado' || c.estado === 'mixto');
            const hoy   = new Date();
            const mes   = hoy.getMonth();
            const anio  = hoy.getFullYear();

            const botonesOut  = abiertas.reduce((s, c) =>
                s + (c.cantidadEntregada - c.cantidadDevuelta - c.cantidadCobrada), 0);
            const valorOut    = abiertas.reduce((s, c) =>
                s + (c.cantidadEntregada - c.cantidadDevuelta - c.cantidadCobrada) * c.precioUnitarioUSD, 0);
            const cobradoMes  = consignacionesData
                .filter(c => {
                    if (!c.fechaProceso) return false;
                    const d = new Date(c.fechaProceso + 'T00:00:00');
                    return d.getMonth() === mes && d.getFullYear() === anio;
                })
                .reduce((s, c) => s + (c.montoCobradoUSD || 0), 0);

            document.getElementById('cons-activas-count').textContent  = abiertas.length;
            document.getElementById('cons-botellones-out').textContent = botonesOut;
            document.getElementById('cons-valor-usd').textContent      = '$' + valorOut.toFixed(2);
            document.getElementById('cons-cobrado-mes').textContent    = '$' + cobradoMes.toFixed(2);
        }

        // ---- Lista de consignaciones ----
        function loadConsignacionesList() {
            const filtro    = document.getElementById('cons-filtro')?.value || 'todos';
            let lista       = [...consignacionesData];
            if (filtro !== 'todos') lista = lista.filter(c => c.estado === filtro);

            const container = document.getElementById('consignaciones-list');
            if (lista.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#999; padding:30px;">
                    <div style="font-size:48px; margin-bottom:12px;">üìã</div>
                    <p>No hay consignaciones con este filtro.</p>
                    <button class="btn btn-primary" onclick="abrirNuevaConsignacion()"><i class="fas fa-plus"></i> Nueva entrega</button>
                </div>`;
                return;
            }

            const estadoColor = { entregado:'#9c27b0', cobrado:'#4caf50', devuelto:'#2196f3', mixto:'#ff9800' };
            const estadoLabel = { entregado:'üì¶ Entregado', cobrado:'‚úÖ Cobrado', devuelto:'‚Ü©Ô∏è Devuelto', mixto:'üîÄ Mixto' };

            container.innerHTML = lista.map(cons => {
                const pendiente   = cons.cantidadEntregada - cons.cantidadDevuelta - cons.cantidadCobrada;
                const color       = estadoColor[cons.estado] || '#999';
                const label       = estadoLabel[cons.estado] || cons.estado;
                const estaAbierta = cons.estado === 'entregado' || (cons.estado === 'mixto' && pendiente > 0);
                return `
                <div style="border:1px solid #e0e0e0; border-left:4px solid ${color}; border-radius:10px; padding:14px 16px; margin-bottom:10px; background:white;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:8px;">
                        <div>
                            <div style="font-weight:700; font-size:15px;">üë§ ${cons.cliente}</div>
                            <small style="color:#888;">üì¶ ${cons.productoNombre} ¬∑ üóì ${formatDate(cons.fechaEntrega)}</small>
                        </div>
                        <span style="background:${color}20; color:${color}; padding:3px 12px; border-radius:20px; font-size:12px; font-weight:600;">${label}</span>
                    </div>

                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(110px,1fr)); gap:8px; margin:10px 0; font-size:13px;">
                        <div style="background:#f8f9fa; padding:6px 10px; border-radius:6px;">
                            <div style="color:#888; font-size:11px;">ENTREGADOS</div>
                            <div style="font-weight:600;">${cons.cantidadEntregada} u</div>
                        </div>
                        <div style="background:#f8f9fa; padding:6px 10px; border-radius:6px;">
                            <div style="color:#888; font-size:11px;">PRECIO/U</div>
                            <div style="font-weight:600;">$${cons.precioUnitarioUSD.toFixed(2)}</div>
                        </div>
                        ${cons.cantidadDevuelta > 0 ? `
                        <div style="background:#e3f2fd; padding:6px 10px; border-radius:6px;">
                            <div style="color:#1565c0; font-size:11px;">DEVUELTOS</div>
                            <div style="font-weight:600; color:#1565c0;">${cons.cantidadDevuelta} u</div>
                        </div>` : ''}
                        ${cons.cantidadCobrada > 0 ? `
                        <div style="background:#e8f5e9; padding:6px 10px; border-radius:6px;">
                            <div style="color:#2e7d32; font-size:11px;">COBRADOS</div>
                            <div style="font-weight:600; color:#2e7d32;">${cons.cantidadCobrada} u ¬∑ $${cons.montoCobradoUSD.toFixed(2)}</div>
                        </div>` : ''}
                        ${pendiente > 0 ? `
                        <div style="background:#fff3e0; padding:6px 10px; border-radius:6px;">
                            <div style="color:#e65100; font-size:11px;">PENDIENTE</div>
                            <div style="font-weight:600; color:#e65100;">${pendiente} u ¬∑ $${(pendiente * cons.precioUnitarioUSD).toFixed(2)}</div>
                        </div>` : ''}
                    </div>

                    ${cons.observaciones ? `<div style="font-size:12px; color:#666; margin-bottom:8px;">üìù ${cons.observaciones}</div>` : ''}

                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:4px;">
                        ${estaAbierta ? `
                        <button class="btn btn-small btn-warning" onclick="abrirProcesoConsignacion('${cons.id}')">
                            <i class="fas fa-exchange-alt"></i> Procesar
                        </button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="eliminarConsignacion('${cons.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        // ---- Eliminar ----
        function eliminarConsignacion(id) {
            const cons = consignacionesData.find(c => c.id === id);
            if (!cons) return;
            const pendiente = cons.cantidadEntregada - cons.cantidadDevuelta - cons.cantidadCobrada;
            let msg = `¬øEliminar la consignaci√≥n de ${cons.cliente} (${cons.cantidadEntregada} unidades)?`;
            if (pendiente > 0) msg += `\n\n‚ö†Ô∏è Hay ${pendiente} unidades pendientes. NO se revertir√° el inventario autom√°ticamente.`;
            if (!confirm(msg)) return;
            consignacionesData = consignacionesData.filter(c => c.id !== id);
            saveConsignaciones();
            loadConsignacionesDashboard();
            loadConsignacionesList();
        }

        // ========== FIN B4: M√ìDULO DE CONSIGNACIONES ==========

        // ========== B5: M√ìDULO DE PRODUCTOS COMPUESTOS (KITS) ==========

        function saveKits() {
            localStorage.setItem('productosCompuestos', JSON.stringify(productosCompuestos));
        }

        // ---- Calcular stock disponible de un kit ----
        function calcularStockKit(kit) {
            if (!kit.componentes || kit.componentes.length === 0) return 0;
            let minStock = Infinity;
            kit.componentes.forEach(comp => {
                const inv = inventoryData.find(i => i.productoKey === comp.productoKey);
                const stockComp = inv ? Math.floor(inv.stockActual / comp.cantidad) : 0;
                if (stockComp < minStock) minStock = stockComp;
            });
            return minStock === Infinity ? 0 : minStock;
        }

        // ---- Calcular costo total de componentes de un kit ----
        function calcularCostoKit(kit) {
            return kit.componentes.reduce((total, comp) => {
                const inv = inventoryData.find(i => i.productoKey === comp.productoKey);
                return total + (inv ? (inv.costoPromedioUSD || 0) * comp.cantidad : 0);
            }, 0);
        }

        // ---- Modal: Abrir crear/editar ----
        function abrirKitModal(kitId = null) {
            currentKitId     = kitId;
            kitComponentes   = [];

            // Poblar selector de productos de inventario
            const sel = document.getElementById('kit-comp-producto');
            sel.innerHTML = '<option value="">Seleccionar producto‚Ä¶</option>' +
                inventoryData.map(i =>
                    `<option value="${i.productoKey}">${i.nombre} (stock: ${i.stockActual})</option>`
                ).join('');

            if (kitId) {
                // Modo edici√≥n
                const kit = productosCompuestos.find(k => k.key === kitId);
                if (!kit) return;
                document.getElementById('kit-modal-title').textContent = 'üß© Editar Kit';
                document.getElementById('kit-nombre').value  = kit.nombre;
                document.getElementById('kit-precio').value  = kit.precioVentaUSD;
                document.getElementById('kit-iva').value     = String(kit.hasIva);
                document.getElementById('kit-activo').value  = String(kit.activo !== false);
                kitComponentes = JSON.parse(JSON.stringify(kit.componentes || []));
            } else {
                // Modo creaci√≥n
                document.getElementById('kit-modal-title').textContent = 'üß© Nuevo Kit';
                document.getElementById('kit-nombre').value  = '';
                document.getElementById('kit-precio').value  = '0';
                document.getElementById('kit-iva').value     = 'true';
                document.getElementById('kit-activo').value  = 'true';
            }

            renderKitComponentes();
            actualizarKitResumen();
            document.getElementById('kit-modal').style.display = 'block';
        }

        function cerrarKitModal() {
            document.getElementById('kit-modal').style.display = 'none';
            kitComponentes = [];
            currentKitId   = null;
        }

        // ---- Agregar componente al formulario ----
        function agregarComponenteKit() {
            const sel  = document.getElementById('kit-comp-producto');
            const key  = sel.value;
            const cant = parseInt(document.getElementById('kit-comp-cantidad').value) || 0;
            if (!key)     { alert('Selecciona un producto'); return; }
            if (cant <= 0){ alert('La cantidad debe ser mayor a 0'); return; }

            const inv = inventoryData.find(i => i.productoKey === key);
            if (!inv) { alert('Producto no encontrado en inventario'); return; }

            const existing = kitComponentes.find(c => c.productoKey === key);
            if (existing) {
                existing.cantidad += cant;
            } else {
                kitComponentes.push({ productoKey: key, nombre: inv.nombre, cantidad: cant });
            }

            sel.value = '';
            document.getElementById('kit-comp-cantidad').value = '1';
            renderKitComponentes();
            actualizarKitResumen();
        }

        function eliminarComponenteKit(idx) {
            kitComponentes.splice(idx, 1);
            renderKitComponentes();
            actualizarKitResumen();
        }

        function renderKitComponentes() {
            const container = document.getElementById('kit-componentes-container');
            const listDiv   = document.getElementById('kit-componentes-lista');
            if (kitComponentes.length === 0) {
                listDiv.style.display = 'none';
                return;
            }
            listDiv.style.display = 'block';
            container.innerHTML = kitComponentes.map((c, idx) => {
                const inv = inventoryData.find(i => i.productoKey === c.productoKey);
                const costo = inv ? (inv.costoPromedioUSD || 0) * c.cantidad : 0;
                return `<div style="display:flex; justify-content:space-between; align-items:center; background:white; border-radius:6px; padding:8px 12px; margin-bottom:6px; font-size:13px; border:1px solid #e0e0e0;">
                    <div>
                        <strong>${c.nombre}</strong>
                        <span style="color:#666;"> √ó ${c.cantidad}</span>
                        <span style="color:#888; font-size:11px; margin-left:6px;">($${costo.toFixed(2)} costo)</span>
                    </div>
                    <span onclick="eliminarComponenteKit(${idx})" style="cursor:pointer; color:#f44336; font-size:16px; font-weight:700;">‚úï</span>
                </div>`;
            }).join('');
        }

        function actualizarKitResumen() {
            const resumen = document.getElementById('kit-resumen');
            if (kitComponentes.length === 0) {
                resumen.style.display = 'none';
                return;
            }
            resumen.style.display = 'block';

            // Stock disponible (m√≠nimo entre componentes)
            let minStock = Infinity;
            let costoTotal = 0;
            kitComponentes.forEach(c => {
                const inv = inventoryData.find(i => i.productoKey === c.productoKey);
                costoTotal += inv ? (inv.costoPromedioUSD || 0) * c.cantidad : 0;
                const disponible = inv ? Math.floor(inv.stockActual / c.cantidad) : 0;
                if (disponible < minStock) minStock = disponible;
            });
            if (minStock === Infinity) minStock = 0;

            const precioVenta = parseFloat(document.getElementById('kit-precio').value) || 0;
            document.getElementById('kit-costo-total').textContent   = '$' + costoTotal.toFixed(2);
            document.getElementById('kit-precio-display').textContent = '$' + precioVenta.toFixed(2);
            document.getElementById('kit-stock-display').textContent  = minStock + ' kits';
        }

        // ---- Guardar kit ----
        function guardarKit() {
            const nombre     = document.getElementById('kit-nombre').value.trim();
            const precioVenta = parseFloat(document.getElementById('kit-precio').value) || 0;
            const hasIva     = document.getElementById('kit-iva').value === 'true';
            const activo     = document.getElementById('kit-activo').value === 'true';

            if (!nombre)              { alert('Ingresa el nombre del kit'); return; }
            if (precioVenta <= 0)     { alert('El precio de venta debe ser mayor a 0'); return; }
            if (kitComponentes.length === 0) { alert('Agrega al menos un componente al kit'); return; }

            if (currentKitId) {
                // Edici√≥n
                const kit = productosCompuestos.find(k => k.key === currentKitId);
                if (!kit) return;
                kit.nombre       = nombre;
                kit.precioVentaUSD = precioVenta;
                kit.hasIva       = hasIva;
                kit.activo       = activo;
                kit.componentes  = JSON.parse(JSON.stringify(kitComponentes));
                kit.modificadoEn = new Date().toISOString();
            } else {
                // Nuevo
                const key = 'kit-' + Date.now();
                productosCompuestos.push({
                    key,
                    nombre,
                    tipo:          'compuesto',
                    componentes:   JSON.parse(JSON.stringify(kitComponentes)),
                    precioVentaUSD: precioVenta,
                    hasIva,
                    activo,
                    creadoEn:      new Date().toISOString()
                });
            }

            saveKits();
            cerrarKitModal();
            loadKitsList();
            loadProductsList();            // Refrescar lista de ventas para mostrar nuevo kit
            loadKitsList();
            poblarConsProductoSelect();    // Consignaciones - kits aparecen como opci√≥n
            refreshOrderProductSelects();  // Pedidos - kits en lista
            alert('‚úÖ Kit guardado exitosamente.');
        }

        // ---- Eliminar kit ----
        function eliminarKit(kitId) {
            const kit = productosCompuestos.find(k => k.key === kitId);
            if (!kit) return;
            if (!confirm(`¬øEliminar el kit "${kit.nombre}"? No se eliminan los productos de inventario, solo la definici√≥n del kit.`)) return;
            productosCompuestos = productosCompuestos.filter(k => k.key !== kitId);
            saveKits();
            loadKitsList();
            loadProductsList();
            poblarConsProductoSelect();   // Consignaciones
            refreshOrderProductSelects(); // Pedidos
        }

        // ---- Renderizar lista de kits en tab Precios ----
        function loadKitsList() {
            const container = document.getElementById('kits-list-container');
            if (!container) return;

            if (productosCompuestos.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#999; padding:20px;">
                    <i class="fas fa-cubes" style="font-size:32px; margin-bottom:8px; display:block;"></i>
                    No hay kits configurados. Crea uno para comenzar.</div>`;
                return;
            }

            container.innerHTML = productosCompuestos.map(kit => {
                const stockDisp  = calcularStockKit(kit);
                const costoTotal = calcularCostoKit(kit);
                const margen     = kit.precioVentaUSD > 0 ? ((kit.precioVentaUSD - costoTotal) / kit.precioVentaUSD * 100).toFixed(0) : 0;
                const stockColor = stockDisp === 0 ? '#f44336' : stockDisp < 5 ? '#ff9800' : '#4caf50';
                return `
                <div style="border:1px solid #e0e0e0; border-left:4px solid ${kit.activo !== false ? '#3949ab' : '#bbb'}; border-radius:9px; padding:14px; margin-bottom:10px; background:${kit.activo !== false ? 'white' : '#fafafa'};">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:8px;">
                        <div>
                            <div style="font-weight:700; font-size:15px;">üß© ${kit.nombre}</div>
                            <small style="color:#888;">${kit.componentes.length} componente(s) ¬∑ ${kit.hasIva ? '+IVA' : 'Sin IVA'} ¬∑ ${kit.activo !== false ? '<span style="color:#4caf50;">Activo</span>' : '<span style="color:#bbb;">Inactivo</span>'}</small>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:18px; font-weight:700; color:#3949ab;">$${kit.precioVentaUSD.toFixed(2)}</div>
                            <div style="font-size:12px; color:${stockColor}; font-weight:600;">Stock: ${stockDisp} kits</div>
                            <div style="font-size:11px; color:#888;">Costo: $${costoTotal.toFixed(2)} ¬∑ Margen: ${margen}%</div>
                        </div>
                    </div>
                    <div style="margin:8px 0; font-size:12px; color:#666;">
                        ${kit.componentes.map(c => `<span style="background:#e8eaf6; border-radius:4px; padding:2px 7px; margin:2px; display:inline-block;">${c.cantidad}√ó ${c.nombre}</span>`).join('')}
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;">
                        <button class="btn btn-small" style="background:#3949ab; color:white;" onclick="abrirKitModal('${kit.key}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-small btn-danger" onclick="eliminarKit('${kit.key}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        // ---- Agregar kit a la venta ----
        function addKitToSale(kitKey) {
            const kit       = productosCompuestos.find(k => k.key === kitKey);
            if (!kit || kit.activo === false) return;
            const qtyInput  = document.getElementById(`qty-kit-${kitKey}`);
            let quantity    = parseInt(qtyInput?.value) || 1;

            // Validar stock de cada componente
            const errores = [];
            kit.componentes.forEach(comp => {
                const inv       = inventoryData.find(i => i.productoKey === comp.productoKey);
                const necesario = comp.cantidad * quantity;
                if (!inv || inv.stockActual < necesario) {
                    errores.push(`"${comp.nombre}": necesita ${necesario}, disponible ${inv?.stockActual || 0}`);
                }
            });

            if (errores.length > 0) {
                alert(`‚ö†Ô∏è Stock insuficiente para "${kit.nombre}" (√ó${quantity}):\n\n${errores.join('\n')}`);
                return;
            }

            const priceBS = convertUSDtoBS(kit.precioVentaUSD);
            const existing = currentSaleItems.find(item => item.productKey === kitKey);
            if (existing) {
                existing.quantity += quantity;
            } else {
                currentSaleItems.push({
                    productKey:  kitKey,
                    name:        kit.nombre,
                    priceUSD:    kit.precioVentaUSD,
                    priceBS:     priceBS,
                    quantity:    quantity,
                    hasIva:      kit.hasIva,
                    esKit:       true,
                    componentes: kit.componentes
                });
            }
            updateSaleDisplay();
            if (qtyInput) qtyInput.value = 1;
        }

        // ========== FIN B5: M√ìDULO DE KITS ==========

        // ========== B6: M√ìDULO DE PR√âSTAMOS EMPRESARIALES ==========

        function savePrestamos() {
            localStorage.setItem('prestamosData', JSON.stringify(prestamosData));
        }

        function cerrarPrestModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // ---- C√°lculo de cuota (sistema franc√©s) ----
        // F√≥rmula: C = P √ó [i(1+i)^n] / [(1+i)^n - 1]
        function calcularCuotaMensual(principal, tasaAnual, plazoMeses) {
            if (tasaAnual === 0) return principal / plazoMeses;
            const i = tasaAnual / 100 / 12;
            const n = plazoMeses;
            return principal * (i * Math.pow(1 + i, n)) / (Math.pow(1 + i, n) - 1);
        }

        // ---- Generar tabla de amortizaci√≥n completa ----
        function generarAmortizacion(prestamo) {
            const { montoOriginalUSD, tasaInteres, plazoMeses, fechaPrimeraCuota, cuotaMensualUSD } = prestamo;
            const i      = tasaInteres / 100 / 12;
            const cuota  = cuotaMensualUSD;
            const tabla  = [];
            let saldo    = montoOriginalUSD;

            for (let n = 1; n <= plazoMeses; n++) {
                const interesUSD  = saldo * i;
                const capitalUSD  = cuota - interesUSD;
                saldo            -= capitalUSD;
                if (saldo < 0.001) saldo = 0;  // correcci√≥n flotante

                // Calcular fecha de vencimiento
                const base = new Date(fechaPrimeraCuota + 'T12:00:00');
                base.setMonth(base.getMonth() + (n - 1));
                const vencimiento = base.toISOString().split('T')[0];

                // Recuperar estado del pago si ya existe
                const existing = prestamo.amortizacion?.[n - 1];
                tabla.push({
                    numero:     n,
                    vencimiento,
                    capitalUSD: Math.max(0, capitalUSD),
                    interesUSD: Math.max(0, interesUSD),
                    cuotaUSD:   cuota,
                    saldoUSD:   Math.max(0, saldo),
                    estado:     existing?.estado     || 'pendiente',
                    fechaPago:  existing?.fechaPago  || null,
                    metodoPago: existing?.metodoPago || null,
                    notas:      existing?.notas      || null
                });
            }
            return tabla;
        }

        // ---- Preview en formulario ----
        function calcularAmortizacionPreview() {
            const monto  = parseFloat(document.getElementById('prest-monto').value)  || 0;
            const tasa   = parseFloat(document.getElementById('prest-tasa').value)   || 0;
            const plazo  = parseInt(document.getElementById('prest-plazo').value)    || 0;
            const prev   = document.getElementById('prest-cuota-preview');

            if (monto <= 0 || plazo <= 0) { prev.style.display = 'none'; return; }

            const cuota     = calcularCuotaMensual(monto, tasa, plazo);
            const totalPago = cuota * plazo;
            const totalInt  = totalPago - monto;

            prev.style.display = 'block';
            document.getElementById('prev-cuota').textContent     = '$' + cuota.toFixed(2);
            document.getElementById('prev-intereses').textContent  = '$' + Math.max(0, totalInt).toFixed(2);
            document.getElementById('prev-total').textContent      = '$' + totalPago.toFixed(2);

            // Auto-llenar fecha primera cuota si hay desembolso
            const desembolso = document.getElementById('prest-fecha-desembolso').value;
            if (desembolso && !document.getElementById('prest-fecha-primera').value) {
                const d = new Date(desembolso + 'T12:00:00');
                d.setMonth(d.getMonth() + 1);
                document.getElementById('prest-fecha-primera').value = d.toISOString().split('T')[0];
            }
        }

        // ---- Abrir modal nuevo/editar pr√©stamo ----
        function abrirPrestModal(prestId = null) {
            currentPrestId = prestId;
            const hoy      = new Date().toISOString().split('T')[0];

            if (prestId) {
                const p = prestamosData.find(x => x.id === prestId);
                if (!p) return;
                document.getElementById('prest-modal-title').textContent = 'üè¶ Editar Pr√©stamo';
                document.getElementById('prest-prestamista').value      = p.prestamista;
                document.getElementById('prest-tipo').value             = p.tipo;
                document.getElementById('prest-contrato').value         = p.contrato || '';
                document.getElementById('prest-monto').value            = p.montoOriginalUSD;
                document.getElementById('prest-tasa').value             = p.tasaInteres;
                document.getElementById('prest-plazo').value            = p.plazoMeses;
                document.getElementById('prest-fecha-desembolso').value = p.fechaDesembolso;
                document.getElementById('prest-fecha-primera').value    = p.fechaPrimeraCuota;
                document.getElementById('prest-obs').value              = p.observaciones || '';
            } else {
                document.getElementById('prest-modal-title').textContent = 'üè¶ Nuevo Pr√©stamo';
                document.getElementById('prest-prestamista').value      = '';
                document.getElementById('prest-tipo').value             = 'banco';
                document.getElementById('prest-contrato').value         = '';
                document.getElementById('prest-monto').value            = '';
                document.getElementById('prest-tasa').value             = '';
                document.getElementById('prest-plazo').value            = '';
                document.getElementById('prest-fecha-desembolso').value = hoy;
                document.getElementById('prest-fecha-primera').value    = '';
                document.getElementById('prest-obs').value              = '';
                document.getElementById('prest-cuota-preview').style.display = 'none';
            }
            calcularAmortizacionPreview();
            document.getElementById('prest-modal').style.display = 'block';
        }

        // ---- Guardar pr√©stamo ----
        function guardarPrestamo() {
            const prestamista   = document.getElementById('prest-prestamista').value.trim();
            const tipo          = document.getElementById('prest-tipo').value;
            const contrato      = document.getElementById('prest-contrato').value.trim();
            const monto         = parseFloat(document.getElementById('prest-monto').value)  || 0;
            const tasa          = parseFloat(document.getElementById('prest-tasa').value)   || 0;
            const plazo         = parseInt(document.getElementById('prest-plazo').value)    || 0;
            const fechaDesem    = document.getElementById('prest-fecha-desembolso').value;
            const fechaPrimera  = document.getElementById('prest-fecha-primera').value;
            const obs           = document.getElementById('prest-obs').value.trim();

            if (!prestamista)  { alert('Ingresa el nombre del prestamista'); return; }
            if (monto <= 0)    { alert('El monto debe ser mayor a 0'); return; }
            if (tasa < 0)      { alert('La tasa de inter√©s no puede ser negativa'); return; }
            if (plazo < 1)     { alert('El plazo debe ser al menos 1 mes'); return; }
            if (!fechaDesem)   { alert('Ingresa la fecha de desembolso'); return; }
            if (!fechaPrimera) { alert('Ingresa la fecha de la primera cuota'); return; }

            const cuotaMensual = calcularCuotaMensual(monto, tasa, plazo);

            if (currentPrestId) {
                // Edici√≥n - recalcular amortizaci√≥n preservando pagos existentes
                const p          = prestamosData.find(x => x.id === currentPrestId);
                if (!p) return;
                const oldAmort   = p.amortizacion || [];
                p.prestamista    = prestamista;
                p.tipo           = tipo;
                p.contrato       = contrato;
                p.montoOriginalUSD = monto;
                p.tasaInteres    = tasa;
                p.plazoMeses     = plazo;
                p.cuotaMensualUSD = cuotaMensual;
                p.fechaDesembolso = fechaDesem;
                p.fechaPrimeraCuota = fechaPrimera;
                p.observaciones  = obs;
                p.modificadoEn   = new Date().toISOString();
                // Regenerar tabla preservando estados de pago
                p.amortizacion   = generarAmortizacion(p);
                // Restaurar pagos previos
                oldAmort.forEach((oa, idx) => {
                    if (p.amortizacion[idx] && oa.estado === 'pagado') {
                        p.amortizacion[idx].estado     = 'pagado';
                        p.amortizacion[idx].fechaPago  = oa.fechaPago;
                        p.amortizacion[idx].metodoPago = oa.metodoPago;
                        p.amortizacion[idx].notas      = oa.notas;
                    }
                });
                recalcularEstadoPrestamo(p);
            } else {
                // Nuevo
                const nuevoPrest = {
                    id: Date.now().toString(),
                    prestamista, tipo, contrato,
                    montoOriginalUSD: monto,
                    tasaInteres: tasa,
                    plazoMeses: plazo,
                    cuotaMensualUSD: cuotaMensual,
                    fechaDesembolso: fechaDesem,
                    fechaPrimeraCuota: fechaPrimera,
                    estado: 'activo',
                    cuotasPagadas: 0,
                    totalPagadoUSD: 0,
                    saldoPendienteUSD: monto,
                    observaciones: obs,
                    amortizacion: [],
                    creadoEn: new Date().toISOString()
                };
                nuevoPrest.amortizacion = generarAmortizacion(nuevoPrest);
                prestamosData.unshift(nuevoPrest);
            }

            savePrestamos();
            cerrarPrestModal('prest-modal');
            loadPrestamosDashboard();
            loadPrestamosList();
            alert('‚úÖ Pr√©stamo guardado exitosamente.');
        }

        // ---- Recalcular saldos y estado tras pago ----
        function recalcularEstadoPrestamo(p) {
            // Normalizar primero: si saldoPendienteUSD <= 0 en una parcial, marcarla pagada
            p.amortizacion.forEach(c => {
                if (c.estado === 'parcial' && c.saldoPendienteUSD != null && c.saldoPendienteUSD <= 0.005) {
                    c.estado            = 'pagado';
                    c.saldoPendienteUSD = 0;
                    c.montoPagadoUSD    = c.cuotaUSD;
                }
            });

            const pagadas   = p.amortizacion.filter(c => c.estado === 'pagado');
            const parciales = p.amortizacion.filter(c => c.estado === 'parcial');
            const pendientes = p.amortizacion.filter(c => c.estado === 'pendiente');

            p.cuotasPagadas = pagadas.length;

            // Total pagado = suma cuotas completas + abonos en parciales
            const totalParcialAbonado = parciales.reduce((s, c) => s + (c.montoPagadoUSD || 0), 0);
            p.totalPagadoUSD = parseFloat((
                pagadas.reduce((s, c) => s + c.cuotaUSD, 0) + totalParcialAbonado
            ).toFixed(2));

            // Saldo pendiente = cuotas sin tocar + saldo restante de parciales
            const saldoParciales = parciales.reduce((s, c) => s + (c.saldoPendienteUSD ?? c.cuotaUSD), 0);
            p.saldoPendienteUSD = parseFloat((
                pendientes.reduce((s, c) => s + c.cuotaUSD, 0) + saldoParciales
            ).toFixed(2));

            // Finalizar pr√©stamo solo cuando todas las cuotas est√©n pagadas
            const todasPagadas = p.amortizacion.every(c => c.estado === 'pagado');
            if (todasPagadas) p.estado = 'finalizado';
        }

        // ---- Ver tabla de amortizaci√≥n ----
        function verAmortizacion(prestId) {
            const p = prestamosData.find(x => x.id === prestId);
            if (!p) return;
            currentPrestId = prestId;

            document.getElementById('prest-amort-title').textContent =
                `üìã ${p.prestamista} - ${p.plazoMeses} cuotas de $${p.cuotaMensualUSD.toFixed(2)}`;

            const hoy        = new Date().toISOString().split('T')[0];
            const pagadas    = p.amortizacion.filter(c => c.estado === 'pagado').length;
            const totalInt   = p.amortizacion.reduce((s, c) => s + c.interesUSD, 0);
            const totalCap   = p.amortizacion.reduce((s, c) => s + c.capitalUSD, 0);

            // Resumen
            let resumen = `
                <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:10px; margin-bottom:14px;">
                    <div style="background:#e3f2fd; border-radius:8px; padding:10px; text-align:center;">
                        <div style="font-size:11px; color:#666;">CUOTAS PAGADAS</div>
                        <div style="font-size:20px; font-weight:700; color:#1565c0;">${pagadas} / ${p.plazoMeses}</div>
                    </div>
                    <div style="background:#e8f5e9; border-radius:8px; padding:10px; text-align:center;">
                        <div style="font-size:11px; color:#666;">TOTAL PAGADO</div>
                        <div style="font-size:18px; font-weight:700; color:#2e7d32;">$${p.totalPagadoUSD.toFixed(2)}</div>
                    </div>
                    <div style="background:#ffebee; border-radius:8px; padding:10px; text-align:center;">
                        <div style="font-size:11px; color:#666;">SALDO PENDIENTE</div>
                        <div style="font-size:18px; font-weight:700; color:#f44336;">$${p.saldoPendienteUSD.toFixed(2)}</div>
                    </div>
                    <div style="background:#fff3e0; border-radius:8px; padding:10px; text-align:center;">
                        <div style="font-size:11px; color:#666;">TOTAL INTERESES</div>
                        <div style="font-size:18px; font-weight:700; color:#e65100;">$${totalInt.toFixed(2)}</div>
                    </div>
                </div>`;

            // Tabla
            const filas = p.amortizacion.map(c => {
                const esParcial = c.estado === 'parcial';
                const vencida   = (c.estado === 'pendiente' || esParcial) && c.vencimiento < hoy;
                const proxima   = c.estado === 'pendiente' && !vencida && c.vencimiento <= getFechaEnDias(7);
                const rowStyle  = c.estado === 'pagado' ? 'background:#f1f8e9;'
                                : esParcial             ? 'background:#fff8e1;'
                                : vencida               ? 'background:#ffebee;'
                                : proxima               ? 'background:#fff8e1;'
                                : '';
                const montoPagado  = (c.montoPagadoUSD  || 0).toFixed(2);
                const saldoCuota   = (c.saldoPendienteUSD != null ? c.saldoPendienteUSD : c.cuotaUSD).toFixed(2);
                const estadoBadge  = c.estado === 'pagado'
                    ? `<span style="color:#2e7d32; font-weight:600;">‚úÖ Pagado<br><small>${c.fechaPago || ''}</small></span>`
                    : esParcial
                    ? `<span style="color:#f57c00; font-weight:600;">‚ö° Parcial<br>
                       <small style="color:#388e3c;">Abonado: $${montoPagado}</small><br>
                       <small style="color:#c62828;">Pendiente: $${saldoCuota}</small></span>`
                    : vencida
                    ? `<span style="color:#f44336; font-weight:600;">üî¥ Vencida</span>`
                    : proxima
                    ? `<span style="color:#ff9800; font-weight:600;">‚ö†Ô∏è Pr√≥xima</span>`
                    : `<span style="color:#666;">‚è≥ Pendiente</span>`;

                const botonPago = (c.estado !== 'pagado')
                    ? `<button class="btn btn-small btn-success" onclick="abrirPagoCuota('${prestId}', ${c.numero})" style="font-size:11px; padding:3px 8px;">
                           <i class="fas fa-check"></i> ${esParcial ? 'Completar' : 'Pagar'}
                       </button>`
                    : '';

                return `<tr style="${rowStyle}">
                    <td style="text-align:center; font-weight:600;">${c.numero}</td>
                    <td style="text-align:center;">${c.vencimiento}</td>
                    <td style="text-align:right;">$${c.capitalUSD.toFixed(2)}</td>
                    <td style="text-align:right; color:#e65100;">$${c.interesUSD.toFixed(2)}</td>
                    <td style="text-align:right; font-weight:700;">$${c.cuotaUSD.toFixed(2)}</td>
                    <td style="text-align:right; color:#666;">$${c.saldoUSD.toFixed(2)}</td>
                    <td style="text-align:center;">${estadoBadge}</td>
                    <td style="text-align:center;">${botonPago}</td>
                </tr>`;
            }).join('');

            // Totales
            const totalRow = `<tr style="background:#e8eaf6; font-weight:700;">
                <td colspan="2" style="text-align:center;">TOTALES</td>
                <td style="text-align:right;">$${totalCap.toFixed(2)}</td>
                <td style="text-align:right; color:#e65100;">$${totalInt.toFixed(2)}</td>
                <td style="text-align:right;">$${(totalCap + totalInt).toFixed(2)}</td>
                <td colspan="3"></td>
            </tr>`;

            document.getElementById('prest-amort-body').innerHTML = resumen + `
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:12px;">
                        <thead>
                            <tr style="background:#1565c0; color:white;">
                                <th style="padding:8px; text-align:center;">#</th>
                                <th style="padding:8px; text-align:center;">Vencimiento</th>
                                <th style="padding:8px; text-align:right;">Capital</th>
                                <th style="padding:8px; text-align:right;">Inter√©s</th>
                                <th style="padding:8px; text-align:right;">Cuota</th>
                                <th style="padding:8px; text-align:right;">Saldo</th>
                                <th style="padding:8px; text-align:center;">Estado</th>
                                <th style="padding:8px; text-align:center;">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>${filas}${totalRow}</tbody>
                    </table>
                </div>`;

            document.getElementById('prest-amort-modal').style.display = 'block';
        }

        // ---- Abrir pago de cuota ----
        function abrirPagoCuota(prestId, nroCuota) {
            const p   = prestamosData.find(x => x.id === prestId);
            if (!p)   return;
            const cuota = p.amortizacion.find(c => c.numero === nroCuota);
            if (!cuota || cuota.estado === 'pagado') return;

            currentPrestId      = prestId;
            currentPagoNroCuota = nroCuota;

            const esParcial    = cuota.estado === 'parcial';
            const saldoCuota   = esParcial
                ? (cuota.saldoPendienteUSD != null ? cuota.saldoPendienteUSD : cuota.cuotaUSD)
                : cuota.cuotaUSD;
            const abonado      = cuota.montoPagadoUSD || 0;

            document.getElementById('prest-pago-info').innerHTML = `
                <strong>${p.prestamista}</strong> ¬∑ Cuota #${nroCuota} de ${p.plazoMeses}<br>
                Vencimiento: <strong>${cuota.vencimiento}</strong><br>
                Capital: $${cuota.capitalUSD.toFixed(2)} ¬∑ Inter√©s: $${cuota.interesUSD.toFixed(2)}<br>
                ${esParcial
                    ? `<span style="color:#f57c00;">‚ö° Pago parcial anterior: <strong>$${abonado.toFixed(2)}</strong> USD</span><br>
                       <strong style="font-size:16px; color:#c62828;">Saldo pendiente: $${saldoCuota.toFixed(2)} USD</strong>`
                    : `<strong style="font-size:16px; color:#1565c0;">Total a pagar: $${cuota.cuotaUSD.toFixed(2)} USD</strong>`
                }`;

            document.getElementById('prest-pago-fecha').value  = new Date().toISOString().split('T')[0];
            document.getElementById('prest-pago-notas').value  = '';
            document.getElementById('prest-pago-modal').style.display = 'flex';
        }

        function ejecutarPagoCuota() {
            const p = prestamosData.find(x => x.id === currentPrestId);
            if (!p) return;
            const cuota = p.amortizacion.find(c => c.numero === currentPagoNroCuota);
            if (!cuota) return;

            const fecha    = document.getElementById('prest-pago-fecha').value;
            const metodo   = document.getElementById('prest-pago-metodo').value;
            const notas    = document.getElementById('prest-pago-notas').value.trim();
            if (!fecha) { alert('Ingresa la fecha de pago'); return; }

            // Calcular saldo real antes de marcar pagado
            const saldoAntes = (cuota.estado === 'parcial' && cuota.saldoPendienteUSD != null)
                ? cuota.saldoPendienteUSD : cuota.cuotaUSD;

            cuota.estado            = 'pagado';
            cuota.fechaPago         = fecha;
            cuota.metodoPago        = metodo;
            cuota.notas             = notas || null;
            cuota.montoPagadoUSD    = cuota.cuotaUSD;
            cuota.saldoPendienteUSD = 0;
            if (!cuota.pagos) cuota.pagos = [];
            cuota.pagos.push({ fecha, monto: saldoAntes, tipo: 'completo_desde_tabla' });

            recalcularEstadoPrestamo(p);
            savePrestamos();

            cerrarPrestModal('prest-pago-modal');
            loadPrestamosDashboard();
            loadPrestamosList();
            verificarAlertasPrestamos();

            // Refrescar tabla de amortizaci√≥n si est√° abierta
            if (document.getElementById('prest-amort-modal').style.display !== 'none') {
                verAmortizacion(currentPrestId);
            }
            alert(`‚úÖ Cuota #${currentPagoNroCuota} pagada. Saldo pendiente: $${p.saldoPendienteUSD.toFixed(2)} USD`);
        }

        // ---- Cambiar estado del pr√©stamo ----
        function cambiarEstadoPrestamo(prestId, nuevoEstado) {
            const p = prestamosData.find(x => x.id === prestId);
            if (!p) return;
            const labels = { finalizado: 'finalizado', cancelado: 'cancelado' };
            if (!confirm(`¬øMarcar este pr√©stamo como "${labels[nuevoEstado]}"?`)) return;
            p.estado = nuevoEstado;
            p.modificadoEn = new Date().toISOString();
            savePrestamos();
            loadPrestamosDashboard();
            loadPrestamosList();
        }

        // ---- Eliminar pr√©stamo ----
        function eliminarPrestamo(prestId) {
            const p = prestamosData.find(x => x.id === prestId);
            if (!p) return;
            if (!confirm(`¬øEliminar el pr√©stamo de "${p.prestamista}"? Esta acci√≥n no se puede deshacer.`)) return;
            prestamosData = prestamosData.filter(x => x.id !== prestId);
            savePrestamos();
            loadPrestamosDashboard();
            loadPrestamosList();
        }

        // ---- Dashboard pr√©stamos ----
        function loadPrestamosDashboard() {
            const activos    = prestamosData.filter(p => p.estado === 'activo');
            const deudaTotal = activos.reduce((s, p) => s + (p.saldoPendienteUSD || 0), 0);
            const cuotaMes   = activos.reduce((s, p) => s + (p.cuotaMensualUSD   || 0), 0);
            const pagadoTotal= prestamosData.reduce((s, p) => s + (p.totalPagadoUSD || 0), 0);

            document.getElementById('prest-activos-count').textContent = activos.length;
            document.getElementById('prest-deuda-total').textContent   = '$' + deudaTotal.toFixed(2);
            document.getElementById('prest-cuota-mes').textContent     = '$' + cuotaMes.toFixed(2);
            document.getElementById('prest-pagado-total').textContent  = '$' + pagadoTotal.toFixed(2);

            verificarAlertasPrestamos();
        }

        // ---- Alertas de cuotas pr√≥ximas y vencidas ----
        function getFechaEnDias(dias) {
            const d = new Date();
            d.setDate(d.getDate() + dias);
            return d.toISOString().split('T')[0];
        }

        function verificarAlertasPrestamos() {
            const hoy   = new Date().toISOString().split('T')[0];
            const en7   = getFechaEnDias(7);
            const alertas = [];

            prestamosData.filter(p => p.estado === 'activo').forEach(p => {
                p.amortizacion.filter(c => c.estado === 'pendiente').forEach(c => {
                    if (c.vencimiento < hoy) {
                        alertas.push({ tipo: 'vencida',  prestamista: p.prestamista, nro: c.numero, monto: c.cuotaUSD, fecha: c.vencimiento, prestId: p.id });
                    } else if (c.vencimiento <= en7) {
                        alertas.push({ tipo: 'proxima',  prestamista: p.prestamista, nro: c.numero, monto: c.cuotaUSD, fecha: c.vencimiento, prestId: p.id });
                    }
                });
            });

            const bar = document.getElementById('prest-alertas-bar');
            if (!bar) return;
            if (alertas.length === 0) { bar.style.display = 'none'; return; }

            bar.style.display = 'block';
            bar.innerHTML = alertas.map(a =>
                `<div style="margin-bottom:4px;">
                    ${a.tipo === 'vencida' ? 'üî¥' : 'üü°'}
                    <strong>${a.prestamista}</strong> - Cuota #${a.nro}
                    ($${a.monto.toFixed(2)}) ¬∑ Vence: ${a.fecha}
                    <button class="btn btn-small btn-success" onclick="abrirPagoCuota('${a.prestId}', ${a.nro})" style="margin-left:8px; font-size:11px;">
                        <i class="fas fa-check"></i> Pagar
                    </button>
                </div>`
            ).join('');
        }

        // ---- Lista de pr√©stamos ----
        function loadPrestamosList() {
            const filtroEstado = document.getElementById('prest-filtro-estado')?.value || 'todos';
            const filtroTipo   = document.getElementById('prest-filtro-tipo')?.value   || 'todos';
            const hoy          = new Date().toISOString().split('T')[0];

            let lista = [...prestamosData];
            if (filtroEstado !== 'todos') lista = lista.filter(p => p.estado === filtroEstado);
            if (filtroTipo   !== 'todos') lista = lista.filter(p => p.tipo   === filtroTipo);

            const container = document.getElementById('prestamos-list-container');
            if (lista.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#999; padding:30px;">
                    <div style="font-size:48px; margin-bottom:12px;">üè¶</div>
                    <p>No hay pr√©stamos que coincidan con el filtro.</p>
                    <button class="btn btn-primary" onclick="abrirPrestModal()"><i class="fas fa-plus"></i> Registrar Pr√©stamo</button>
                </div>`;
                return;
            }

            const tipoIcon  = { banco: 'üèõ', persona: 'üë§', empresa: 'üè¢' };
            const estadoColor = { activo: '#1565c0', finalizado: '#4caf50', cancelado: '#9e9e9e' };
            const estadoLabel = { activo: '‚úÖ Activo', finalizado: 'üèÅ Finalizado', cancelado: '‚ùå Cancelado' };

            container.innerHTML = lista.map(p => {
                const progreso  = p.plazoMeses > 0 ? Math.round((p.cuotasPagadas / p.plazoMeses) * 100) : 0;
                const color     = estadoColor[p.estado] || '#666';
                const label     = estadoLabel[p.estado] || p.estado;

                // Pr√≥xima cuota pendiente
                const proximaCuota = p.amortizacion.find(c => c.estado === 'pendiente');
                const vencidaCuota = proximaCuota && proximaCuota.vencimiento < hoy;
                const proximaInfo  = proximaCuota
                    ? `<div style="font-size:12px; color:${vencidaCuota ? '#f44336' : '#e65100'}; margin-top:4px;">
                           ${vencidaCuota ? 'üî¥ Cuota vencida' : '‚è∞ Pr√≥xima cuota'}: #${proximaCuota.numero} - $${proximaCuota.cuotaUSD.toFixed(2)} ¬∑ ${proximaCuota.vencimiento}
                       </div>`
                    : p.estado === 'activo' ? '<div style="font-size:12px; color:#4caf50; margin-top:4px;">‚úÖ Todas las cuotas al d√≠a</div>' : '';

                return `
                <div style="border:1px solid #e0e0e0; border-left:4px solid ${color}; border-radius:10px; padding:14px 16px; margin-bottom:12px; background:white;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:8px;">
                        <div>
                            <div style="font-weight:700; font-size:16px;">${tipoIcon[p.tipo] || 'üè¶'} ${p.prestamista}</div>
                            <small style="color:#888;">${p.tipo.charAt(0).toUpperCase()+p.tipo.slice(1)}${p.contrato ? ' ¬∑ ' + p.contrato : ''} ¬∑ ${p.tasaInteres}% anual ¬∑ ${p.plazoMeses} meses</small>
                            ${proximaInfo}
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:11px; font-weight:600; color:${color}; background:${color}18; padding:2px 10px; border-radius:20px;">${label}</div>
                            <div style="font-size:18px; font-weight:700; color:#f44336; margin-top:4px;">$${(p.saldoPendienteUSD||0).toFixed(2)}</div>
                            <div style="font-size:11px; color:#888;">pendiente de $${p.montoOriginalUSD.toFixed(2)}</div>
                        </div>
                    </div>

                    <!-- Barra de progreso -->
                    <div style="margin:10px 0;">
                        <div style="display:flex; justify-content:space-between; font-size:12px; color:#666; margin-bottom:4px;">
                            <span>${p.cuotasPagadas} cuotas pagadas</span>
                            <span>${progreso}% - $${(p.totalPagadoUSD||0).toFixed(2)} pagado</span>
                        </div>
                        <div style="background:#e0e0e0; border-radius:4px; height:8px; overflow:hidden;">
                            <div style="background:${color}; height:100%; width:${progreso}%; transition:width .3s;"></div>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(100px,1fr)); gap:8px; font-size:12px; margin-bottom:10px;">
                        <div style="background:#f8f9fa; padding:6px 8px; border-radius:6px;">
                            <div style="color:#888;">CUOTA/MES</div>
                            <div style="font-weight:600;">$${p.cuotaMensualUSD.toFixed(2)}</div>
                        </div>
                        <div style="background:#f8f9fa; padding:6px 8px; border-radius:6px;">
                            <div style="color:#888;">DESEMBOLSO</div>
                            <div style="font-weight:600;">${formatDate(p.fechaDesembolso)}</div>
                        </div>
                        <div style="background:#f8f9fa; padding:6px 8px; border-radius:6px;">
                            <div style="color:#888;">PENDIENTES</div>
                            <div style="font-weight:600;">${p.plazoMeses - p.cuotasPagadas} cuotas</div>
                        </div>
                    </div>

                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-small" style="background:#1565c0; color:white;" onclick="verAmortizacion('${p.id}')">
                            <i class="fas fa-table"></i> Amortizaci√≥n
                        </button>
                        <button class="btn btn-small btn-warning" onclick="abrirPrestModal('${p.id}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        ${p.estado === 'activo' ? `
                        <button class="btn btn-small" style="background:#4caf50; color:white;" onclick="cambiarEstadoPrestamo('${p.id}', 'finalizado')">
                            <i class="fas fa-flag-checkered"></i> Finalizar
                        </button>
                        <button class="btn btn-small" style="background:#9e9e9e; color:white;" onclick="cambiarEstadoPrestamo('${p.id}', 'cancelado')">
                            <i class="fas fa-ban"></i> Cancelar
                        </button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="eliminarPrestamo('${p.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        // ========== FIN B6: M√ìDULO DE PR√âSTAMOS ==========

        // ========== B7: M√ìDULO MULTIUSUARIO ==========

        function saveUsers() {
            localStorage.setItem('usersData', JSON.stringify(usersData));
        }

        // ---- Permisos helpers ----
        function tienePermiso(permiso) {
            if (!currentUser) return false;
            return currentUser.permisos.includes('all') || currentUser.permisos.includes(permiso);
        }

        function esAdmin() {
            return currentUser && currentUser.rol === 'admin';
        }

        function getTabsPermitidas() {
            if (esAdmin()) return null; // null = todas visibles
            // Vendedor: solo estas tabs
            return ['dashboard', 'sales', 'credits', 'adelantos', 'orders', 'inventory', 'clients'];
        }

        // ---- Aplicar restricciones de UI por rol ----
        function aplicarRestriccionesRol() {
            if (!currentUser) return;
            const permitidas = getTabsPermitidas();

            // Mostrar/ocultar tabs
            document.querySelectorAll('.tab[data-tab]').forEach(tab => {
                const tabId = tab.getAttribute('data-tab');
                if (permitidas && !permitidas.includes(tabId)) {
                    tab.style.display = 'none';
                } else {
                    tab.style.display = '';
                }
            });

            // Secci√≥n usuarios en config: solo admin
            const usersCard = document.getElementById('users-management-card');
            if (usersCard) usersCard.style.display = esAdmin() ? 'block' : 'none';

            // Bot√≥n "Precios" en header: solo admin
            document.querySelectorAll('button[onclick*="showPriceManager"]').forEach(b => {
                b.style.display = esAdmin() ? '' : 'none';
            });
        }

        // ---- Renderizar usuarios en pantalla de login ----
        function renderLoginUsuarios() {
            const activos = usersData.filter(u => u.activo);
            const lista   = document.getElementById('login-usuarios-lista');
            if (!lista) return;

            const rolIcon  = { admin:'üëë', vendedor:'üõí' };
            const dispIcon = { pc:'üíª', mobile:'üì±' };

            lista.innerHTML = activos.map(u => `
                <button onclick="seleccionarUsuarioLogin('${u.id}')"
                    style="display:flex; align-items:center; gap:12px; padding:12px 16px; border:2px solid #e0e0e0; border-radius:10px; background:white; cursor:pointer; font-size:14px; text-align:left; transition:all .15s;"
                    onmouseover="this.style.borderColor='#667eea'; this.style.background='#f0f4ff';"
                    onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white';">
                    <div style="width:40px; height:40px; border-radius:50%; background:${u.rol==='admin' ? '#667eea' : '#4caf50'}; display:flex; align-items:center; justify-content:center; color:white; font-size:18px; flex-shrink:0;">
                        ${rolIcon[u.rol] || 'üë§'}
                    </div>
                    <div>
                        <div style="font-weight:700; color:#333;">${u.nombre}</div>
                        <div style="font-size:12px; color:#888;">${u.rol.charAt(0).toUpperCase()+u.rol.slice(1)} ¬∑ ${dispIcon[u.dispositivo]||''} ${u.dispositivo}</div>
                    </div>
                </button>`).join('');
        }

        let loginUserId = null;

        function seleccionarUsuarioLogin(userId) {
            loginUserId = userId;
            const user = usersData.find(u => u.id === userId);
            if (!user) return;
            document.getElementById('login-step-usuario').style.display = 'none';
            document.getElementById('login-step-pin').style.display     = 'block';
            document.getElementById('login-usuario-selected').innerHTML =
                `${user.rol === 'admin' ? 'üëë' : 'üõí'} ${user.nombre}`;
            document.getElementById('login-pin').value = '';
            document.getElementById('login-error').style.display = 'none';
            setTimeout(() => document.getElementById('login-pin').focus(), 100);
        }

        function volverSeleccionUsuario() {
            loginUserId = null;
            document.getElementById('login-step-pin').style.display     = 'none';
            document.getElementById('login-step-usuario').style.display = 'block';
            document.getElementById('login-pin').value = '';
            document.getElementById('login-error').style.display = 'none';
        }

        // Variables 2FA
        let codigo2FAActual   = null;
        let codigo2FAExpira   = null;
        let totp2FAUserPendiente = null;

        function attemptLoginB7() {
            const pin    = document.getElementById('login-pin').value;
            const errDiv = document.getElementById('login-error');
            if (!loginUserId) { volverSeleccionUsuario(); return; }

            const user = usersData.find(u => u.id === loginUserId);
            if (!user) { volverSeleccionUsuario(); return; }

            if (pin === user.pin) {
                // PIN correcto - verificar si requiere 2FA
                const metodo = user.twoFA?.metodo || 'ninguno';
                if (metodo === 'ninguno') {
                    // Sin 2FA - acceso directo
                    currentUser = user;
                    user.ultimaLogin = new Date().toISOString();
                    saveUsers();
                    loginB7();
                } else if (metodo === 'email') {
                    // 2FA por email
                    totp2FAUserPendiente = user;
                    mostrarPaso2FA(user, 'email');
                    enviarCodigo2FAEmail(user);
                } else if (metodo === 'totp') {
                    // Google Authenticator
                    totp2FAUserPendiente = user;
                    mostrarPaso2FA(user, 'totp');
                }
            } else {
                errDiv.style.display = 'block';
                errDiv.textContent   = 'PIN incorrecto. Intenta de nuevo.';
                document.getElementById('login-pin').value = '';
                document.getElementById('login-pin').focus();
                setTimeout(() => errDiv.style.display = 'none', 3000);
            }
        }

        function mostrarPaso2FA(user, metodo) {
            document.getElementById('login-step-pin').style.display  = 'none';
            document.getElementById('login-step-2fa').style.display  = 'block';
            document.getElementById('login-2fa-usuario').textContent = (user.rol === 'admin' ? 'üëë ' : 'üõí ') + user.nombre;
            document.getElementById('login-2fa-codigo').value        = '';

            if (metodo === 'email') {
                document.getElementById('login-2fa-instruccion').innerHTML =
                    'üìß Se envi√≥ un c√≥digo de 6 d√≠gitos a <strong>' + (user.email || 'tu email') + '</strong><br><small style="color:#888;">V√°lido por 5 minutos</small>';
                document.getElementById('login-2fa-reenviar').style.display = 'block';
                document.getElementById('login-2fa-qr-container').style.display = 'none';
            } else if (metodo === 'totp') {
                if (!user.twoFA?.activo) {
                    // Primera vez: mostrar QR para configurar
                    document.getElementById('login-2fa-instruccion').innerHTML =
                        'üì± <strong>Primera vez:</strong> Escanea el QR con Google Authenticator, luego ingresa el c√≥digo.';
                    document.getElementById('login-2fa-qr-container').style.display = 'block';
                    document.getElementById('login-2fa-reenviar').style.display = 'none';
                    generarQRTotp(user);
                } else {
                    document.getElementById('login-2fa-instruccion').innerHTML =
                        'üì± Ingresa el c√≥digo de <strong>Google Authenticator</strong>';
                    document.getElementById('login-2fa-qr-container').style.display = 'none';
                    document.getElementById('login-2fa-reenviar').style.display = 'none';
                }
            }
            setTimeout(() => document.getElementById('login-2fa-codigo').focus(), 200);
        }

        function enviarCodigo2FAEmail(user) {
            // Generar c√≥digo 6 d√≠gitos
            codigo2FAActual = String(Math.floor(100000 + Math.random() * 900000));
            codigo2FAExpira = Date.now() + 5 * 60 * 1000; // 5 minutos
            
            // Enviar via Apps Script si est√° configurado
            if (syncConfig?.appsScriptUrl) {
                fetch(syncConfig.appsScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accion: 'enviar2FA',
                        email:   user.email,
                        nombre:  user.nombre,
                        codigo:  codigo2FAActual
                    })
                }).catch(() => {});
            }
            // En desarrollo/sin email: mostrar en consola como respaldo
            console.log('[AQUANEV 2FA] C√≥digo para ' + user.nombre + ': ' + codigo2FAActual);
        }

        function reenviarCodigo2FA() {
            if (totp2FAUserPendiente) {
                enviarCodigo2FAEmail(totp2FAUserPendiente);
                alert('üìß C√≥digo reenviado a ' + totp2FAUserPendiente.email);
            }
        }

        async function verificar2FA() {
            const codigo  = document.getElementById('login-2fa-codigo').value.trim();
            const errDiv  = document.getElementById('login-error');
            const user    = totp2FAUserPendiente;
            if (!user || !codigo) return;

            const metodo = user.twoFA?.metodo;
            let valido = false;

            if (metodo === 'email') {
                if (Date.now() >= codigo2FAExpira) {
                    errDiv.style.display = 'block';
                    errDiv.textContent   = 'C√≥digo expirado. Reenv√≠a el c√≥digo.';
                    setTimeout(() => errDiv.style.display = 'none', 4000);
                    return;
                }
                valido = codigo === codigo2FAActual;
            } else if (metodo === 'totp') {
                valido = await verificarTOTP(user.twoFA.secret, codigo);
            }

            if (valido) {
                if (!user.twoFA.activo) {
                    user.twoFA.activo = true;
                    user.twoFA.configuradoEn = new Date().toISOString();
                }
                currentUser = user;
                user.ultimaLogin = new Date().toISOString();
                totp2FAUserPendiente = null;
                codigo2FAActual = null;
                saveUsers();
                document.getElementById('login-step-2fa').style.display = 'none';
                loginB7();
            } else {
                errDiv.style.display = 'block';
                errDiv.textContent   = 'C√≥digo incorrecto. Intenta de nuevo.';
                document.getElementById('login-2fa-codigo').value = '';
                document.getElementById('login-2fa-codigo').focus();
                setTimeout(() => errDiv.style.display = 'none', 3000);
            }
        }

        // ‚îÄ‚îÄ TOTP (Google Authenticator) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function generarTOTPSecret() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let secret = '';
            for (let i = 0; i < 32; i++) secret += chars[Math.floor(Math.random() * chars.length)];
            return secret;
        }

        function generarQRTotp(user) {
            if (!user.twoFA?.secret) {
                user.twoFA.secret = generarTOTPSecret();
                saveUsers();
            }
            const issuer  = 'AQUANEV';
            const account = encodeURIComponent(user.email || user.nombre);
            const secret  = user.twoFA.secret;
            const otpauth = `otpauth://totp/${issuer}:${account}?secret=${secret}&issuer=${issuer}&algorithm=SHA1&digits=6&period=30`;
            
            // Generar QR usando API publica
            const qrImg = document.createElement('img');
            qrImg.src   = 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=' + encodeURIComponent(otpauth);
            qrImg.style.cssText = 'width:180px; height:180px; border-radius:8px;';
            qrImg.alt = 'QR Google Authenticator';
            const container = document.getElementById('login-2fa-qr-container');
            // Remove canvas, add img
            const canvas = document.getElementById('login-2fa-qr');
            if (canvas) canvas.replaceWith(qrImg);
        }

        function verificarTOTP(secret, token) {
            if (!secret || !token) return false;
            // Implementacion TOTP RFC 6238
            function base32Decode(s) {
                const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
                let bits = 0, value = 0;
                const output = [];
                for (const c of s.toUpperCase().replace(/=+$/, '')) {
                    const idx = alphabet.indexOf(c);
                    if (idx < 0) continue;
                    value = (value << 5) | idx;
                    bits += 5;
                    if (bits >= 8) { bits -= 8; output.push((value >> bits) & 0xFF); }
                }
                return new Uint8Array(output);
            }
            async function hmacSHA1(key, data) {
                const k = await crypto.subtle.importKey('raw', key, { name:'HMAC', hash:'SHA-1' }, false, ['sign']);
                return new Uint8Array(await crypto.subtle.sign('HMAC', k, data));
            }
            // Sincrono aproximado: verificar ventanas -1, 0, +1
            const now   = Math.floor(Date.now() / 1000);
            const steps = [Math.floor(now/30)-1, Math.floor(now/30), Math.floor(now/30)+1];
            // Usamos verificaci√≥n async en segundo plano y retornamos promise
            return new Promise(async resolve => {
                const keyBytes = base32Decode(secret);
                for (const step of steps) {
                    const msg = new ArrayBuffer(8);
                    const view = new DataView(msg);
                    view.setUint32(4, step);
                    const mac  = await hmacSHA1(keyBytes, msg);
                    const off  = mac[19] & 0x0F;
                    const code = ((mac[off]&0x7F)<<24 | mac[off+1]<<16 | mac[off+2]<<8 | mac[off+3]) % 1000000;
                    if (String(code).padStart(6,'0') === String(token).padStart(6,'0')) { resolve(true); return; }
                }
                resolve(false);
            });
        }

        function loginB7() {
            isAuthenticated = true;
            document.getElementById('login-screen').style.display     = 'none';
            document.getElementById('app-container').style.display    = 'block';

            // Mostrar badge de usuario en header
            document.getElementById('header-user-badge').style.display = 'inline-flex';
            document.getElementById('header-user-nombre').textContent  = currentUser.nombre;
            document.getElementById('header-user-rol').textContent     = '(' + currentUser.rol + ')';

            aplicarRestriccionesRol();

            // Si la tab activa no est√° permitida, ir a dashboard
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const permitidas = getTabsPermitidas();
                if (permitidas && !permitidas.includes(activeTab.getAttribute('data-tab'))) {
                    switchTab('dashboard');
                }
            }
        }

        function logoutB7() {
            if (confirm('¬øEst√°s seguro que deseas salir?')) {
                currentUser     = null;
                loginUserId     = null;
                isAuthenticated = false;
                document.getElementById('login-screen').style.display     = 'flex';
                document.getElementById('app-container').style.display    = 'none';
                document.getElementById('header-user-badge').style.display = 'none';
                // Reset login form
                volverSeleccionUsuario();
                renderLoginUsuarios();
            }
        }

        // switchTab helper (para redirigir si tab no permitida)
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tab = document.querySelector(`.tab[data-tab="${tabId}"]`);
            const content = document.getElementById(tabId);
            if (tab)     tab.classList.add('active');
            if (content) content.classList.add('active');
        }

        // ---- Gesti√≥n de usuarios (solo admin) ----
        function loadUsersList() {
            const container = document.getElementById('users-list-container');
            if (!container) return;

            const rolIcon  = { admin:'üëë', vendedor:'üõí' };
            const dispIcon = { pc:'üíª', mobile:'üì±' };
            const rolColor = { admin:'#667eea', vendedor:'#4caf50' };

            container.innerHTML = usersData.map(u => `
                <div style="border:1px solid #e0e0e0; border-left:4px solid ${rolColor[u.rol]||'#999'}; border-radius:9px; padding:12px 14px; margin-bottom:8px; background:${u.activo ? 'white' : '#fafafa'}; opacity:${u.activo ? '1' : '0.6'};">
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="width:38px; height:38px; border-radius:50%; background:${rolColor[u.rol]||'#999'}; display:flex; align-items:center; justify-content:center; color:white; font-size:18px; flex-shrink:0;">
                                ${rolIcon[u.rol]||'üë§'}
                            </div>
                            <div>
                                <div style="font-weight:700;">${u.nombre}</div>
                                <div style="font-size:12px; color:#888;">${u.rol} ¬∑ ${dispIcon[u.dispositivo]||''} ${u.dispositivo}${u.cargo ? ' ¬∑ '+u.cargo : ''}${u.cedula ? ' ¬∑ '+u.cedula : ''}</div>
                                <div style="font-size:11px; color:#888;">${u.email ? 'üìß '+u.email : ''}
                                  ${u.twoFA?.metodo && u.twoFA.metodo !== 'ninguno' ? '<span style="background:'+(u.twoFA.activo?'#e8f5e9':'#fff3e0')+';color:'+(u.twoFA.activo?'#2e7d32':'#e65100')+';border-radius:10px;padding:1px 7px;font-size:10px;margin-left:4px;">'+(u.twoFA.activo?'üîê 2FA activo':'‚è≥ 2FA pendiente')+'</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                            <span style="background:${u.activo ? '#e8f5e9' : '#fce4ec'}; color:${u.activo ? '#2e7d32' : '#c62828'}; border-radius:20px; padding:2px 10px; font-size:12px;">${u.activo ? '‚úÖ Activo' : '‚è∏ Inactivo'}</span>
                            ${u.id !== 'admin-pc-001' ? `
                            <button class="btn btn-small btn-warning" onclick="abrirUserModal('${u.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-small" style="background:${u.activo ? '#ff9800' : '#4caf50'}; color:white;" onclick="toggleUserActivo('${u.id}')">${u.activo ? '‚è∏' : '‚ñ∂'}</button>
                            <button class="btn btn-small btn-danger" onclick="eliminarUsuario('${u.id}')"><i class="fas fa-trash"></i></button>
                            ` : `<button class="btn btn-small btn-warning" onclick="abrirUserModal('${u.id}')"><i class="fas fa-edit"></i> PIN</button>`}
                        </div>
                    </div>
                </div>`).join('');
        }

        // ---- Modal usuario ----
        function abrirUserModal(userId = null) {
            editUserId = userId;
            if (userId) {
                const u = usersData.find(x => x.id === userId);
                if (!u) return;
                document.getElementById('user-modal-title').textContent = 'Editar Usuario';
                document.getElementById('user-nombre').value      = u.nombre;
                document.getElementById('user-rol').value         = u.rol;
                document.getElementById('user-dispositivo').value = u.dispositivo;
                document.getElementById('user-email').value       = u.email       || '';
                document.getElementById('user-cedula').value      = u.cedula      || '';
                document.getElementById('user-cargo').value       = u.cargo       || '';
                document.getElementById('user-2fa-metodo').value  = u.twoFA?.metodo || 'ninguno';
                document.getElementById('user-pin').value         = '';
                document.getElementById('user-pin2').value        = '';
                // Mostrar estado 2FA si ya esta activo
                const info2fa = document.getElementById('user-2fa-activo-info');
                if (u.twoFA?.activo && currentUser?.rol === 'admin') {
                    info2fa.style.display = 'block';
                    info2fa.dataset.userId = userId;
                } else {
                    info2fa.style.display = 'none';
                }
            } else {
                document.getElementById('user-modal-title').textContent = 'Nuevo Usuario';
                document.getElementById('user-nombre').value      = '';
                document.getElementById('user-rol').value         = 'vendedor';
                document.getElementById('user-dispositivo').value = 'mobile';
                document.getElementById('user-email').value       = '';
                document.getElementById('user-cedula').value      = '';
                document.getElementById('user-cargo').value       = '';
                document.getElementById('user-2fa-metodo').value  = 'ninguno';
                document.getElementById('user-2fa-activo-info').style.display = 'none';
                document.getElementById('user-pin').value         = '';
                document.getElementById('user-pin2').value        = '';
            }
            onUser2FAChange();
            onUserRolChange();
            document.getElementById('user-modal').style.display = 'flex';
        }

        function onUser2FAChange() {
            const metodo = document.getElementById('user-2fa-metodo')?.value;
            document.getElementById('user-2fa-email-info').style.display = metodo === 'email' ? 'block' : 'none';
            document.getElementById('user-2fa-totp-info').style.display  = metodo === 'totp'  ? 'block' : 'none';
        }

        function resetear2FA() {
            if (currentUser?.rol !== 'admin') {
                alert('Solo el administrador puede resetear el 2FA.');
                return;
            }
            const info2fa  = document.getElementById('user-2fa-activo-info');
            const targetId = info2fa.dataset.userId || editUserId;
            const u = usersData.find(x => x.id === targetId);
            if (!u) return;
            if (!confirm('¬øResetear el 2FA de ' + u.nombre + '?\n\nEl usuario deber√° configurarlo nuevamente en su pr√≥ximo login.')) return;
            u.twoFA = { metodo: document.getElementById('user-2fa-metodo').value, activo: false, secret: null, resetadoPor: currentUser.id, resetadoEn: new Date().toISOString() };
            saveUsers();
            info2fa.style.display = 'none';
            alert('‚úÖ 2FA reseteado. El usuario deber√° reconfigurarlo en su pr√≥ximo inicio de sesi√≥n.');
        }

        function cerrarUserModal() {
            document.getElementById('user-modal').style.display = 'none';
            editUserId = null;
        }

        function onUserRolChange() {
            const rol  = document.getElementById('user-rol')?.value;
            const info = document.getElementById('user-permisos-info');
            if (!info) return;
            if (rol === 'admin') {
                info.innerHTML = 'üëë <strong>Admin:</strong> Acceso completo - ventas, cr√©ditos, inventario, gastos, compras, pr√©stamos, configuraci√≥n, reportes.';
            } else {
                info.innerHTML = 'üõí <strong>Vendedor:</strong> Crear ventas, ver cr√©ditos/abonar, ver clientes, ver inventario. <br>‚ùå Sin acceso a: gastos, compras, pr√©stamos, consignaciones, precios, configuraci√≥n.';
            }
        }

        function guardarUsuario() {
            const nombre  = document.getElementById('user-nombre').value.trim();
            const rol     = document.getElementById('user-rol').value;
            const disp    = document.getElementById('user-dispositivo').value;
            const email   = document.getElementById('user-email').value.trim();
            const cedula  = document.getElementById('user-cedula').value.trim();
            const cargo   = document.getElementById('user-cargo').value.trim();
            const pin     = document.getElementById('user-pin').value;
            const pin2    = document.getElementById('user-pin2').value;
            const metodo2fa = document.getElementById('user-2fa-metodo').value;

            if (!nombre) { alert('Ingresa el nombre del usuario'); return; }
            if (metodo2fa === 'email' && !email) { alert('El 2FA por email requiere ingresar un email v√°lido'); return; }

            // PIN: obligatorio para nuevos, opcional para editar
            if (!editUserId && pin.length < 4) { alert('El PIN debe tener al menos 4 d√≠gitos'); return; }
            if (pin && pin !== pin2) { alert('Los PINs no coinciden'); return; }
            if (pin && pin.length < 4) { alert('El PIN debe tener al menos 4 d√≠gitos'); return; }

            if (editUserId) {
                const u = usersData.find(x => x.id === editUserId);
                if (!u) return;
                u.nombre      = nombre;
                u.rol         = rol;
                u.dispositivo = disp;
                u.email       = email;
                u.cedula      = cedula;
                u.cargo       = cargo;
                u.permisos    = rol === 'admin' ? PERMISOS_ADMIN : PERMISOS_VENDEDOR;
                if (pin) u.pin = pin;
                // Actualizar 2FA solo si cambi√≥ el m√©todo o no estaba activo
                if (!u.twoFA || u.twoFA.metodo !== metodo2fa) {
                    u.twoFA = { metodo: metodo2fa, activo: false, secret: null, configuradoEn: null };
                }
                u.modificadoEn = new Date().toISOString();
            } else {
                // Generar secret TOTP si aplica
                const secret = metodo2fa === 'totp' ? generarTOTPSecret() : null;
                usersData.push({
                    id: 'user-' + Date.now(),
                    nombre, rol, email, cedula, cargo,
                    dispositivo: disp,
                    pin,
                    permisos: rol === 'admin' ? PERMISOS_ADMIN : PERMISOS_VENDEDOR,
                    twoFA: { metodo: metodo2fa, activo: false, secret, configuradoEn: null },
                    activo: true,
                    creadoEn: new Date().toISOString()
                });
            }
            saveUsers();
            cerrarUserModal();
            loadUsersList();
            alert('‚úÖ Usuario guardado.' + (metodo2fa !== 'ninguno' ? '\n\nüîê El 2FA se activar√° en el pr√≥ximo inicio de sesi√≥n del usuario.' : ''));
        }

        function toggleUserActivo(userId) {
            const u = usersData.find(x => x.id === userId);
            if (!u) return;
            u.activo = !u.activo;
            saveUsers();
            loadUsersList();
        }

        function eliminarUsuario(userId) {
            if (userId === 'admin-pc-001') { alert('No puedes eliminar al administrador principal.'); return; }
            if (!confirm('¬øEliminar este usuario?')) return;
            usersData = usersData.filter(x => x.id !== userId);
            saveUsers();
            loadUsersList();
        }

        // ---- Auditor√≠a: obtener userId actual ----
        function getCurrentUserId() {
            return currentUser ? currentUser.id : 'unknown';
        }

        // ---- Compatibilidad: legacy attemptLogin y logout ----
        // Las llamadas antiguas de logout() ahora delegan a logoutB7()
        function logout() { logoutB7(); }

        // ========== FIN B7: M√ìDULO MULTIUSUARIO ==========

        // ========== B8: M√ìDULO SINCRONIZACI√ìN GOOGLE SHEETS ==========

        // ---- Persistencia ----
        function saveSyncConfig()  { localStorage.setItem('syncConfig', JSON.stringify(syncConfig)); }
        function saveSyncQueue()   { localStorage.setItem('syncQueue',  JSON.stringify(syncQueue));  }
        function saveSyncLog()     { localStorage.setItem('syncLog',    JSON.stringify(syncLog));    }

        // ---- Encolar operaci√≥n para sync ----
        // Llamar desde cualquier m√≥dulo que guarde datos
        function encolarSync(tabla, accion, datos) {
            const entry = {
                id:        tabla + '-' + Date.now() + '-' + Math.random().toString(36).substr(2,5),
                tabla,
                accion,    // 'upsert' | 'delete'
                datos:     JSON.parse(JSON.stringify(datos)),
                timestamp: new Date().toISOString(),
                intentos:  0,
                error:     null
            };
            syncQueue.push(entry);
            saveSyncQueue();
            actualizarSyncBadge();
        }

        // ---- Badge de estado en header de sync panel ----
        function actualizarSyncBadge() {
            const badge   = document.getElementById('sync-status-badge');
            const pendEl  = document.getElementById('sync-pendientes-count');
            if (!badge) return;

            const pending = syncQueue.filter(e => e.intentos < 3).length;
            if (!syncConfig.activa || !syncConfig.appsScriptUrl) {
                badge.style.background = '#e0e0e0'; badge.style.color = '#666';
                badge.textContent = '‚ö´ No configurado';
            } else if (syncEnCurso) {
                badge.style.background = '#e3f2fd'; badge.style.color = '#1565c0';
                badge.textContent = 'üîÑ Sincronizando‚Ä¶';
            } else if (pending > 0) {
                badge.style.background = '#fff3e0'; badge.style.color = '#e65100';
                badge.textContent = `üü° ${pending} pendiente${pending>1?'s':''}`;
            } else {
                badge.style.background = '#e8f5e9'; badge.style.color = '#2e7d32';
                badge.textContent = 'üü¢ Al d√≠a';
            }
            if (pendEl) pendEl.textContent = pending;
        }

        // ---- Guardar config de sync ----
        function guardarConfigSync() {
            const url       = document.getElementById('sync-apps-script-url').value.trim();
            const frecuencia = parseInt(document.getElementById('sync-frecuencia').value) || 0;
            const modo      = document.getElementById('sync-modo').value;

            syncConfig.appsScriptUrl = url;
            syncConfig.frecuenciaMin = frecuencia;
            syncConfig.modo          = modo;
            syncConfig.activa        = url.length > 0;
            saveSyncConfig();

            // Arrancar/detener timer autom√°tico
            iniciarTimerSync();

            const btnSync = document.getElementById('btn-sync-manual');
            if (btnSync) btnSync.disabled = !syncConfig.activa;

            document.getElementById('sync-stats-panel').style.display = syncConfig.activa ? 'block' : 'none';
            actualizarSyncBadge();
            loadSyncQueueDisplay();
            alert(syncConfig.activa
                ? `‚úÖ Sync configurada.\nURL: ${url.substring(0,60)}‚Ä¶\nFrecuencia: ${frecuencia > 0 ? 'cada '+frecuencia+' min' : 'manual'}`
                : '‚ö†Ô∏è URL vac√≠a - sync desactivada.');
        }

        // ---- Timer autom√°tico ----
        function iniciarTimerSync() {
            if (syncTimer) clearInterval(syncTimer);
            syncTimer = null;
            if (syncConfig.activa && syncConfig.frecuenciaMin > 0) {
                syncTimer = setInterval(() => {
                    if (!syncEnCurso && syncQueue.length > 0) ejecutarSync();
                }, syncConfig.frecuenciaMin * 60 * 1000);
            }
        }

        // ---- Sync manual ----
        function ejecutarSyncManual() {
            if (!syncConfig.activa || !syncConfig.appsScriptUrl) {
                alert('‚ö†Ô∏è Configura primero la URL del Apps Script.'); return;
            }
            ejecutarSync();
        }

        // ---- Motor principal de sync ----
        async function ejecutarSync() {
            if (syncEnCurso) return;
            syncEnCurso = true;
            actualizarSyncBadge();

            const progressMsg = document.getElementById('sync-progress-msg');
            if (progressMsg) progressMsg.textContent = 'üîÑ Enviando datos‚Ä¶';

            const pendientes = syncQueue.filter(e => e.intentos < 3);
            if (pendientes.length === 0 && syncConfig.modo === 'solo_subir') {
                syncEnCurso = false; actualizarSyncBadge(); return;
            }

            // Agrupar por tabla para env√≠o eficiente
            const payload = {
                usuario:    getCurrentUserId(),
                timestamp:  new Date().toISOString(),
                modo:       syncConfig.modo,
                datos: {}
            };

            const TABLAS = ['ventas','creditos','abonos','inventario','compras','consignaciones','prestamos','gastos','clientes','usuarios','config'];
            TABLAS.forEach(t => {
                const items = pendientes.filter(e => e.tabla === t);
                if (items.length > 0) payload.datos[t] = items.map(e => e.datos);
            });

            // A√±adir estado actual completo para tablas maestras (modo bidireccional)
            if (syncConfig.modo !== 'solo_subir') {
                payload.estadoLocal = {
                    ultimaSync: syncConfig.ultimaSync || null
                };
            }

            let logEntry = {
                timestamp:  new Date().toISOString(),
                usuario:    getCurrentUserId(),
                accion:     'sync',
                enviados:   pendientes.length,
                recibidos:  0,
                errores:    0,
                msg:        ''
            };

            try {
                const resp = await fetch(syncConfig.appsScriptUrl, {
                    method:  'POST',
                    headers: { 'Content-Type': 'text/plain' },   // Apps Script acepta text/plain para evitar CORS preflight
                    body:    JSON.stringify(payload)
                });

                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const result = await resp.json();

                if (result.success) {
                    // Marcar como sincronizados
                    const idsEnviados = new Set(pendientes.map(e => e.id));
                    syncQueue = syncQueue.filter(e => !idsEnviados.has(e.id));
                    saveSyncQueue();

                    // Procesar actualizaciones recibidas
                    let recibidos = 0;
                    if (result.actualizaciones) {
                        recibidos = procesarActualizaciones(result.actualizaciones);
                    }

                    // Procesar conflictos
                    if (result.conflictos && result.conflictos.length > 0) {
                        procesarConflictos(result.conflictos);
                    }

                    syncConfig.ultimaSync = result.ultimaSync || new Date().toISOString();
                    saveSyncConfig();

                    logEntry.recibidos = recibidos;
                    logEntry.msg       = `‚úÖ OK - ${pendientes.length} enviados, ${recibidos} recibidos`;
                    if (progressMsg) progressMsg.textContent = logEntry.msg;
                    actualizarUltimaSync();
                    // B9: notificar sync completada (solo si hubo actividad real)
                    if (pendientes.length > 0 || recibidos > 0) {
                        notifSyncCompletada(pendientes.length, recibidos);
                    }
                    // B9: notificar conflictos si los hay
                    if (result.conflictos && result.conflictos.length > 0) {
                        notifConflictoResuelto(result.conflictos.length);
                    }
                } else {
                    throw new Error(result.error || 'Error desconocido del servidor');
                }

            } catch(err) {
                // Incrementar intentos en los fallidos
                pendientes.forEach(e => {
                    const q = syncQueue.find(x => x.id === e.id);
                    if (q) { q.intentos++; q.error = err.message; }
                });
                saveSyncQueue();

                logEntry.errores = 1;
                logEntry.msg     = `‚ùå Error: ${err.message}`;
                if (progressMsg) progressMsg.textContent = `‚ùå ${err.message}`;
            }

            // Registrar en syncLog (m√°x 200 entradas)
            syncLog.unshift(logEntry);
            if (syncLog.length > 200) syncLog = syncLog.slice(0, 200);
            saveSyncLog();

            syncEnCurso = false;
            actualizarSyncBadge();
            loadSyncQueueDisplay();
            loadSyncLogDisplay();
        }

        // ---- Procesar datos recibidos del servidor ----
        function procesarActualizaciones(updates) {
            let count = 0;
            // Ventas: solo a√±adir las que no existan localmente (append-only)
            if (updates.ventas && syncConfig.modo !== 'solo_subir') {
                updates.ventas.forEach(v => {
                    if (!salesData.find(x => x.id == v.id)) {
                        salesData.unshift(v);
                        count++;
                    }
                });
                if (count > 0) {
                    localStorage.setItem('salesData', JSON.stringify(salesData));
                    loadSalesHistory && loadSalesHistory();
                }
            }
            // Tasas BCV: si m√°s nueva que la local, actualizar
            if (updates.tasaBCV && updates.tasaBCV.tasa) {
                const nuevaTasa = parseFloat(updates.tasaBCV.tasa);
                if (!isNaN(nuevaTasa) && nuevaTasa > 0) {
                    priceExchangeRate = nuevaTasa;
                    appConfig.exchangeRates.bcv = nuevaTasa;
                    localStorage.setItem('appConfig', JSON.stringify(appConfig));
                    count++;
                }
            }
            // Inventario: merge conservador (solo actualizar si timestamp remoto > local)
            if (updates.inventario && syncConfig.modo !== 'solo_subir') {
                updates.inventario.forEach(remoto => {
                    const idx = inventoryData.findIndex(x => x.productoKey === remoto.productoKey);
                    if (idx !== -1) {
                        const local = inventoryData[idx];
                        const tsRemoto = new Date(remoto.modificadoEn || 0).getTime();
                        const tsLocal  = new Date(local.modificadoEn  || 0).getTime();
                        if (tsRemoto > tsLocal) {
                            inventoryData[idx] = { ...local, ...remoto };
                            count++;
                        }
                    }
                });
                if (count > 0) {
                    saveInventory && saveInventory();
                    loadInventoryList && loadInventoryList();
                }
            }
            return count;
        }

        // ---- Procesar conflictos reportados por el servidor ----
        function procesarConflictos(conflictos) {
            if (conflictos.length === 0) return;
            const msgs = conflictos.map(c =>
                `‚Ä¢ ${c.tabla} #${c.id}: ${c.descripcion || 'conflicto detectado'} ‚Üí ${c.resolucion || 'mantenido local'}`
            ).join('\n');
            console.warn('Conflictos de sync:\n' + msgs);
            // A√±adir al log como entrada especial
            syncLog.unshift({
                timestamp: new Date().toISOString(),
                usuario:   getCurrentUserId(),
                accion:    'conflicto',
                enviados:  0, recibidos: 0, errores: conflictos.length,
                msg:       `‚ö†Ô∏è ${conflictos.length} conflicto(s) resuelto(s)`
            });
            saveSyncLog();
        }

        // ---- Actualizar display de √∫ltima sync ----
        function actualizarUltimaSync() {
            const el = document.getElementById('sync-ultima-fecha');
            if (!el) return;
            if (syncConfig.ultimaSync) {
                const d = new Date(syncConfig.ultimaSync);
                el.textContent = d.toLocaleString('es-ES', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
            } else {
                el.textContent = '-';
            }
        }

        // ---- Display cola de sync ----
        function loadSyncQueueDisplay() {
            const container = document.getElementById('sync-cola-container');
            if (!container) return;

            actualizarSyncBadge();

            const hoy = new Date().toISOString().split('T')[0];
            const enviados = syncLog.filter(e => e.timestamp.startsWith(hoy))
                                    .reduce((s,e) => s + (e.enviados||0), 0);
            const errores  = syncLog.filter(e => e.timestamp.startsWith(hoy))
                                    .reduce((s,e) => s + (e.errores||0), 0);
            const elEnv = document.getElementById('sync-enviados-hoy');
            const elErr = document.getElementById('sync-errores-count');
            if (elEnv) elEnv.textContent = enviados;
            if (elErr) elErr.textContent = errores;

            if (syncQueue.length === 0) {
                container.innerHTML = '<div style="color:#999; text-align:center; padding:16px; font-size:13px;">Cola vac√≠a - todo sincronizado ‚úÖ</div>';
                return;
            }

            const tablaIcon = { ventas:'üí∞', creditos:'üìã', inventario:'üì¶', compras:'üõí', consignaciones:'üì§', prestamos:'üè¶', gastos:'üí∏', clientes:'üë•', usuarios:'üë§' };
            container.innerHTML = syncQueue.map(e => {
                const intentosColor = e.intentos >= 3 ? '#f44336' : e.intentos > 0 ? '#ff9800' : '#4caf50';
                return `<div style="display:flex; justify-content:space-between; align-items:center; padding:6px 10px; border-bottom:1px solid #f0f0f0; font-size:12px;">
                    <span>${tablaIcon[e.tabla]||'üìÑ'} <strong>${e.tabla}</strong> ¬∑ ${e.accion} ¬∑ ${new Date(e.timestamp).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</span>
                    <span style="color:${intentosColor};">${e.intentos >= 3 ? '‚ùå Fallido' : e.intentos > 0 ? `‚ö†Ô∏è Intento ${e.intentos}/3` : '‚è≥ Pendiente'}</span>
                </div>`;
            }).join('');
        }

        // ---- Display historial de sync ----
        function loadSyncLogDisplay() {
            const container = document.getElementById('sync-log-container');
            if (!container) return;

            if (syncLog.length === 0) {
                container.innerHTML = '<div style="color:#999; padding:10px;">Sin registros de sincronizaci√≥n.</div>';
                return;
            }

            container.innerHTML = syncLog.slice(0, 50).map(e => {
                const ts    = new Date(e.timestamp).toLocaleString('es-ES', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
                const color = e.errores > 0 ? '#f44336' : '#2e7d32';
                return `<div style="padding:3px 6px; border-bottom:1px solid #f0f0f0; color:${color};">
                    [${ts}] ${e.msg || e.accion}
                </div>`;
            }).join('');
        }

        // ---- Limpiar cola (eliminar entradas fallidas o todas) ----
        function limpiarColaSync() {
            const fallidas = syncQueue.filter(e => e.intentos >= 3).length;
            const msg = fallidas > 0
                ? `Hay ${fallidas} entradas fallidas (3 intentos) y ${syncQueue.length - fallidas} pendientes.\n¬øQu√© deseas hacer?`
                : `Hay ${syncQueue.length} entradas pendientes de sync.\n¬øLimpiar toda la cola?`;
            if (!confirm(msg)) return;
            syncQueue = syncQueue.filter(e => e.intentos < 3 && fallidas > 0);
            if (fallidas === 0) syncQueue = [];
            saveSyncQueue();
            loadSyncQueueDisplay();
            actualizarSyncBadge();
        }

        // ---- Cargar config guardada en el formulario ----
        function loadSyncConfigForm() {
            const urlEl = document.getElementById('sync-apps-script-url');
            const freqEl = document.getElementById('sync-frecuencia');
            const modoEl = document.getElementById('sync-modo');
            if (urlEl)  urlEl.value  = syncConfig.appsScriptUrl || '';
            if (freqEl) freqEl.value = String(syncConfig.frecuenciaMin || 5);
            if (modoEl) modoEl.value = syncConfig.modo || 'bidireccional';

            const btnSync = document.getElementById('btn-sync-manual');
            if (btnSync) btnSync.disabled = !syncConfig.activa;

            const statsPanel = document.getElementById('sync-stats-panel');
            if (statsPanel) statsPanel.style.display = syncConfig.activa ? 'block' : 'none';

            actualizarSyncBadge();
            actualizarUltimaSync();
        }

        // ---- Registro de sync en operaciones existentes ----
        // Helpers para que los m√≥dulos previos encolen sus operaciones
        function syncVenta(venta)             { encolarSync('ventas',         'upsert', venta); }
        function syncCredito(credito)          { encolarSync('creditos',        'upsert', credito); }
        function syncAbono(abono)              { encolarSync('abonos',          'upsert', abono); }
        function syncGasto(gasto)              { encolarSync('gastos',          'upsert', gasto); }
        function syncCompra(compra)            { encolarSync('compras',         'upsert', compra); }
        function syncConsignacion(cons)        { encolarSync('consignaciones',  'upsert', cons); }
        function syncPrestamo(prest)           { encolarSync('prestamos',       'upsert', prest); }
        function syncInventarioItem(item)      { encolarSync('inventario',      'upsert', item); }
        function syncCliente(cliente)          { encolarSync('clientes',        'upsert', cliente); }
        function syncConfigEntry(key, value)   { encolarSync('config',          'upsert', { key, value, timestamp: new Date().toISOString() }); }

        // ========== FIN B8: M√ìDULO SINCRONIZACI√ìN ==========

        // ========== B9: PWA + NOTIFICACIONES PUSH ==========

        let swRegistration   = null;
        let pwaInstallEvent  = null;   // BeforeInstallPrompt guardado
        let notifConfig      = JSON.parse(localStorage.getItem('notifConfig')) || {
            sync: true, conflicto: true, offline: true,
            creditoProx: true, creditoVenc: true,
            stockBajo: true, agotado: true,
            cuota: true, backup: true
        };
        let notifLog = JSON.parse(localStorage.getItem('notifLog')) || [];

        // ---- Guardar config de notificaciones ----
        function guardarNotifConfig() {
            notifConfig = {
                sync:        document.getElementById('notif-sync')?.checked        ?? true,
                conflicto:   document.getElementById('notif-conflicto')?.checked   ?? true,
                offline:     document.getElementById('notif-offline')?.checked      ?? true,
                creditoProx: document.getElementById('notif-credito-prox')?.checked ?? true,
                creditoVenc: document.getElementById('notif-credito-venc')?.checked ?? true,
                stockBajo:   document.getElementById('notif-stock-bajo')?.checked   ?? true,
                agotado:     document.getElementById('notif-agotado')?.checked      ?? true,
                cuota:       document.getElementById('notif-cuota')?.checked        ?? true,
                backup:      document.getElementById('notif-backup')?.checked       ?? true,
            };
            localStorage.setItem('notifConfig', JSON.stringify(notifConfig));
        }

        // ---- Registrar Service Worker ----
        async function registrarServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                console.warn('[B9] Service Worker no soportado en este navegador');
                actualizarEstadoPWA();
                return;
            }
            try {
                swRegistration = await navigator.serviceWorker.register('./service-worker.js', { scope: './' });
                console.log('[B9] SW registrado:', swRegistration.scope);

                // Escuchar mensajes del SW
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data?.type === 'AQUANEV_BACKGROUND_SYNC') {
                        ejecutarSyncManual && ejecutarSyncManual();
                    }
                    if (event.data?.type === 'AQUANEV_NAV') {
                        const tab = event.data.tab;
                        if (tab) showTab && showTab(tab);
                    }
                });

                // Detectar nueva versi√≥n del SW
                swRegistration.addEventListener('updatefound', () => {
                    const newSW = swRegistration.installing;
                    newSW?.addEventListener('statechange', () => {
                        if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                            mostrarBannerActualizacion();
                        }
                    });
                });

            } catch(err) {
                console.warn('[B9] Error registrando SW:', err.message);
            }
            actualizarEstadoPWA();
        }

        // ---- Solicitar permiso de notificaciones ----
        async function solicitarPermisoNotificaciones() {
            if (!('Notification' in window)) {
                alert('‚ö†Ô∏è Tu navegador no soporta notificaciones push.');
                return;
            }
            if (Notification.permission === 'granted') {
                alert('‚úÖ Las notificaciones ya est√°n activadas.');
                actualizarEstadoPWA();
                return;
            }
            const permiso = await Notification.requestPermission();
            actualizarEstadoPWA();
            if (permiso === 'granted') {
                notificar('‚úÖ Notificaciones activadas', 'AQUANEV te avisar√° sobre cr√©ditos, stock y m√°s.', 'notif-test', 'dashboard');
                registrarNotifLog('Notificaciones activadas');
            } else {
                alert('‚ö†Ô∏è Permiso denegado. Puedes activarlo desde la configuraci√≥n del navegador.');
            }
        }

        // ‚îÄ‚îÄ Motor principal de notificaci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function notificar(titulo, cuerpo, tag, tab, requireInteraction) {
            if (!('Notification' in window) || Notification.permission !== 'granted') return;

            // Preferimos enviar al SW para que pueda mostrarlo en background
            if (swRegistration?.active) {
                swRegistration.active.postMessage({
                    type: 'AQUANEV_NOTIFY', title: titulo, body: cuerpo,
                    tag, tab, requireInteraction: requireInteraction || false
                });
            } else {
                // Fallback directo
                new Notification(titulo, {
                    body: cuerpo, icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%23667eea"/><text x="32" y="44" font-size="36" text-anchor="middle" fill="white">üíß</text></svg>',
                    tag, requireInteraction: requireInteraction || false
                });
            }

            registrarNotifLog(titulo + ' - ' + cuerpo);
        }

        function registrarNotifLog(msg) {
            notifLog.unshift({ ts: new Date().toISOString(), msg });
            if (notifLog.length > 50) notifLog = notifLog.slice(0, 50);
            localStorage.setItem('notifLog', JSON.stringify(notifLog));
            renderNotifLog();
        }

        function renderNotifLog() {
            const el = document.getElementById('notif-log-container');
            if (!el) return;
            if (notifLog.length === 0) {
                el.innerHTML = '<span style="color:#aaa;">Sin notificaciones recientes</span>';
                return;
            }
            el.innerHTML = notifLog.slice(0, 20).map(e => {
                const ts = new Date(e.ts).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                return `<div style="padding:2px 0; border-bottom:1px solid #eee; color:#555;">[${ts}] ${e.msg}</div>`;
            }).join('');
        }

        // ‚îÄ‚îÄ 9 TIPOS DE NOTIFICACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // 1. Sync completada
        function notifSyncCompletada(enviados, recibidos) {
            if (!notifConfig.sync) return;
            notificar('‚úÖ Sincronizaci√≥n completada', `${enviados} enviados ¬∑ ${recibidos} recibidos`, 'sync-ok', 'config');
        }

        // 2. Conflicto resuelto
        function notifConflictoResuelto(cantidad) {
            if (!notifConfig.conflicto) return;
            notificar('‚ö†Ô∏è Conflictos resueltos', `${cantidad} conflicto${cantidad > 1 ? 's' : ''} resuelto${cantidad > 1 ? 's' : ''} autom√°ticamente`, 'sync-conflicto', 'config');
        }

        // 3. Sin conexi√≥n con pendientes
        function notifSinConexion(pendientes) {
            if (!notifConfig.offline || pendientes === 0) return;
            notificar('üì¥ Sin conexi√≥n', `${pendientes} operacion${pendientes > 1 ? 'es' : ''} pendiente${pendientes > 1 ? 's' : ''} en cola`, 'offline-pending', 'config', true);
        }

        // 4. Cr√©dito pr√≥ximo a vencer
        function notifCreditoProximo(cliente, diasRestantes, montoUSD) {
            if (!notifConfig.creditoProx) return;
            notificar('üí∞ Cr√©dito pr√≥ximo a vencer',
                `${cliente} - $${montoUSD.toFixed(2)} vence en ${diasRestantes} d√≠a${diasRestantes > 1 ? 's' : ''}`,
                'credito-prox-' + cliente, 'credits');
        }

        // 5. Cr√©dito vencido
        function notifCreditoVencido(cliente, diasVencido, montoUSD) {
            if (!notifConfig.creditoVenc) return;
            notificar('üö® Cr√©dito VENCIDO',
                `${cliente} - $${montoUSD.toFixed(2)} (${diasVencido} d√≠a${diasVencido > 1 ? 's' : ''} vencido)`,
                'credito-venc-' + cliente, 'credits', true);
        }

        // 6. Stock bajo
        function notifStockBajo(productoNombre, stockActual, stockMin) {
            if (!notifConfig.stockBajo) return;
            notificar('üì¶ Stock bajo', `${productoNombre} - ${stockActual} unidades (m√≠n: ${stockMin})`, 'stock-bajo-' + productoNombre, 'inventory');
        }

        // 7. Producto agotado
        function notifAgotado(productoNombre) {
            if (!notifConfig.agotado) return;
            notificar('üö´ Producto AGOTADO', `${productoNombre} - Stock en 0`, 'agotado-' + productoNombre, 'inventory', true);
        }

        // 8. Cuota de pr√©stamo pr√≥xima
        function notifCuotaProxima(prestamista, nroCuota, cuotaUSD, diasRestantes) {
            if (!notifConfig.cuota) return;
            notificar('‚è∞ Cuota pr√≥xima a vencer',
                `${prestamista} - Cuota #${nroCuota} ($${cuotaUSD.toFixed(2)}) en ${diasRestantes} d√≠a${diasRestantes > 1 ? 's' : ''}`,
                'cuota-' + prestamista + '-' + nroCuota, 'prestamos');
        }

        // 9. Backup necesario
        function notifBackupNecesario(diasSinSync) {
            if (!notifConfig.backup) return;
            notificar('üìÖ Backup necesario',
                `Han pasado ${diasSinSync} d√≠as sin sincronizar con Google Sheets`,
                'backup-needed', 'config', true);
        }

        // ‚îÄ‚îÄ Notificaci√≥n de prueba ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function enviarNotifPrueba() {
            if (Notification.permission !== 'granted') {
                alert('Primero activa las notificaciones con el bot√≥n "Activar".');
                return;
            }
            notificar('üîî Prueba AQUANEV', 'Las notificaciones funcionan correctamente üéâ', 'test-' + Date.now(), 'dashboard');
        }

        // ‚îÄ‚îÄ Scanner de alertas diarias ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Se ejecuta al iniciar y peri√≥dicamente para detectar situaciones alertables
        function escanearAlertas() {
            if (Notification.permission !== 'granted') return;
            const hoy = new Date();
            const hoyStr = hoy.toISOString().split('T')[0];

            // ----- Cr√©ditos -----
            const alertasNotifHoy = JSON.parse(sessionStorage.getItem('notifAlertas') || '{}');

            creditsData.forEach(c => {
                if (c.status === 'Pagado' || !c.fechaVencimiento) return;
                const venc      = new Date(c.fechaVencimiento + 'T00:00:00');
                const diasHasta = Math.ceil((venc - hoy) / 86400000);
                const key       = 'c-' + c.id;
                if (alertasNotifHoy[key]) return;  // ya notificado hoy

                const balance = c.balance || c.balanceUSD || 0;
                if (diasHasta < 0) {
                    notifCreditoVencido(c.customer, Math.abs(diasHasta), balance);
                    alertasNotifHoy[key] = hoyStr;
                } else if (diasHasta <= (c.diasAlertaAntes || 3)) {
                    notifCreditoProximo(c.customer, diasHasta, balance);
                    alertasNotifHoy[key] = hoyStr;
                }
            });

            // ----- Inventario -----
            inventoryData.forEach(item => {
                const key = 'i-' + item.productoKey;
                if (alertasNotifHoy[key]) return;
                if (item.stockActual <= 0) {
                    notifAgotado(item.nombre);
                    alertasNotifHoy[key] = hoyStr;
                } else if (item.stockActual <= item.stockMinimo) {
                    notifStockBajo(item.nombre, item.stockActual, item.stockMinimo);
                    alertasNotifHoy[key] = hoyStr;
                }
            });

            // ----- Cuotas de pr√©stamos -----
            prestamosData.forEach(p => {
                if (p.estado !== 'activo') return;
                p.amortizacion.forEach(cuota => {
                    if (cuota.estado === 'pagado') return;
                    const key       = 'p-' + p.id + '-' + cuota.numero;
                    if (alertasNotifHoy[key]) return;
                    const venc      = new Date(cuota.vencimiento + 'T00:00:00');
                    const diasHasta = Math.ceil((venc - hoy) / 86400000);
                    if (diasHasta >= 0 && diasHasta <= 5) {
                        notifCuotaProxima(p.prestamista, cuota.numero, cuota.cuotaUSD, diasHasta);
                        alertasNotifHoy[key] = hoyStr;
                    }
                });
            });

            // ----- Backup necesario -----
            if (syncConfig.ultimaSync) {
                const diasSinSync = Math.floor((hoy - new Date(syncConfig.ultimaSync)) / 86400000);
                const keyBackup   = 'backup';
                if (diasSinSync >= 7 && !alertasNotifHoy[keyBackup]) {
                    notifBackupNecesario(diasSinSync);
                    alertasNotifHoy[keyBackup] = hoyStr;
                }
            }

            sessionStorage.setItem('notifAlertas', JSON.stringify(alertasNotifHoy));
        }

        // ‚îÄ‚îÄ Actualizar panel estado PWA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function actualizarEstadoPWA() {
            // SW
            const swEl = document.getElementById('sw-status-val');
            if (swEl) {
                if (!('serviceWorker' in navigator)) {
                    swEl.textContent = '‚ö´ No soportado'; swEl.style.color = '#9e9e9e';
                } else if (swRegistration) {
                    swEl.textContent = 'üü¢ Activo'; swEl.style.color = '#4caf50';
                } else {
                    swEl.textContent = 'üü° Cargando‚Ä¶'; swEl.style.color = '#ff9800';
                }
            }

            // Notificaciones
            const notifEl  = document.getElementById('notif-perm-val');
            const badgeEl  = document.getElementById('notif-status-badge');
            const btnEl    = document.getElementById('btn-activar-notif');
            if (notifEl) {
                const perm = ('Notification' in window) ? Notification.permission : 'unsupported';
                if (perm === 'granted') {
                    notifEl.textContent = 'üü¢ Activadas'; notifEl.style.color = '#4caf50';
                    if (badgeEl) { badgeEl.textContent = 'üü¢ Activadas'; badgeEl.style.background = '#e8f5e9'; badgeEl.style.color = '#2e7d32'; }
                    if (btnEl)   { btnEl.textContent = '‚úì Activadas'; btnEl.disabled = true; }
                } else if (perm === 'denied') {
                    notifEl.textContent = 'üî¥ Bloqueadas'; notifEl.style.color = '#f44336';
                    if (badgeEl) { badgeEl.textContent = 'üî¥ Bloqueadas'; badgeEl.style.background = '#ffebee'; badgeEl.style.color = '#c62828'; }
                } else {
                    notifEl.textContent = '‚ö´ No activadas'; notifEl.style.color = '#9e9e9e';
                }
            }

            // Cach√©
            const cacheEl = document.getElementById('cache-status-val');
            if (cacheEl) {
                if ('caches' in window) {
                    caches.keys().then(keys => {
                        const aquanevCaches = keys.filter(k => k.startsWith('aquanev-'));
                        cacheEl.textContent  = aquanevCaches.length > 0 ? 'üü¢ ' + aquanevCaches.length + ' cach√©(s)' : 'üü° Sin cach√©';
                        cacheEl.style.color  = aquanevCaches.length > 0 ? '#4caf50' : '#ff9800';
                    });
                } else {
                    cacheEl.textContent = '‚ö´ No soportado'; cacheEl.style.color = '#9e9e9e';
                }
            }

            // Online/Offline
            const onlineEl = document.getElementById('online-status-val');
            if (onlineEl) {
                onlineEl.textContent = navigator.onLine ? 'üü¢ Online' : 'üî¥ Offline';
                onlineEl.style.color = navigator.onLine ? '#4caf50' : '#f44336';
            }

            // Cargar checkboxes de config
            if (document.getElementById('notif-sync')) {
                document.getElementById('notif-sync').checked         = notifConfig.sync;
                document.getElementById('notif-conflicto').checked     = notifConfig.conflicto;
                document.getElementById('notif-offline').checked       = notifConfig.offline;
                document.getElementById('notif-credito-prox').checked  = notifConfig.creditoProx;
                document.getElementById('notif-credito-venc').checked  = notifConfig.creditoVenc;
                document.getElementById('notif-stock-bajo').checked    = notifConfig.stockBajo;
                document.getElementById('notif-agotado').checked       = notifConfig.agotado;
                document.getElementById('notif-cuota').checked         = notifConfig.cuota;
                document.getElementById('notif-backup').checked        = notifConfig.backup;
            }

            renderNotifLog();
        }

        // ‚îÄ‚îÄ Instalar PWA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function instalarPWA() {
            if (!pwaInstallEvent) return;
            pwaInstallEvent.prompt();
            pwaInstallEvent.userChoice.then(result => {
                if (result.outcome === 'accepted') {
                    registrarNotifLog('App instalada en el dispositivo');
                    document.getElementById('pwa-install-banner').style.display = 'none';
                }
                pwaInstallEvent = null;
            });
        }

        // ‚îÄ‚îÄ Limpiar cach√© del SW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function limpiarCacheSW() {
            if (!confirm('¬øLimpiar la cach√© del Service Worker?\nLa app se recargar√° desde la red la pr√≥xima vez.')) return;
            if ('caches' in window) {
                const keys = await caches.keys();
                await Promise.all(keys.filter(k => k.startsWith('aquanev-')).map(k => caches.delete(k)));
                alert('‚úÖ Cach√© limpiada. La app descargar√° recursos frescos al pr√≥ximo acceso.');
                actualizarEstadoPWA();
            }
        }

        // ‚îÄ‚îÄ Banner de actualizaci√≥n disponible ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function mostrarBannerActualizacion() {
            const banner = document.createElement('div');
            banner.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#1565c0;color:white;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;z-index:9999;font-size:14px;';
            banner.innerHTML = `<span>üîÑ Nueva versi√≥n disponible</span>
                <button onclick="this.parentElement.remove(); swRegistration?.waiting?.postMessage({type:'SKIP_WAITING'}); location.reload();"
                    style="background:white;color:#1565c0;border:none;padding:6px 14px;border-radius:4px;cursor:pointer;font-weight:700;">
                    Actualizar
                </button>`;
            document.body.prepend(banner);
        }

        // ‚îÄ‚îÄ Detectar online/offline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.addEventListener('online', () => {
            actualizarEstadoPWA();
            // Intentar sync autom√°tica al recuperar conexi√≥n
            if (syncQueue.length > 0 && syncConfig.activa) {
                setTimeout(() => ejecutarSyncManual && ejecutarSyncManual(), 2000);
            }
        });

        window.addEventListener('offline', () => {
            actualizarEstadoPWA();
            const pendientes = syncQueue.filter(e => e.intentos < 3).length;
            notifSinConexion(pendientes);
        });

        // ‚îÄ‚îÄ Capturar evento de instalaci√≥n PWA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.addEventListener('beforeinstallprompt', event => {
            event.preventDefault();
            pwaInstallEvent = event;
            const banner = document.getElementById('pwa-install-banner');
            if (banner) banner.style.display = 'flex';
        });

        window.addEventListener('appinstalled', () => {
            pwaInstallEvent = null;
            const banner = document.getElementById('pwa-install-banner');
            if (banner) banner.style.display = 'none';
            registrarNotifLog('App instalada correctamente');
        });

        // ‚îÄ‚îÄ Conectar notifSyncCompletada con B8 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Se llama desde ejecutarSync() despu√©s de un sync exitoso
        // (inyectamos la llamada en el flujo de B8 con un hook)
        const _ejecutarSync_original = typeof ejecutarSync === 'function' ? ejecutarSync : null;

        // ========== FIN B9: PWA + NOTIFICACIONES ==========

        // ========== B10: REPORTES AMPLIADOS + OPTIMIZACI√ìN M√ìVIL ==========

        // ‚îÄ‚îÄ‚îÄ Helpers comunes de reportes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function repTablaHTML(headers, rows, emptyMsg) {
            if (rows.length === 0) {
                return `<div style="color:#999; text-align:center; padding:20px; font-size:13px;">${emptyMsg || 'Sin datos para mostrar'}</div>`;
            }
            const ths = headers.map(h => `<th style="padding:8px 10px; background:#f5f5f5; font-size:12px; text-align:left; border-bottom:2px solid #e0e0e0;">${h}</th>`).join('');
            const trs = rows.map(r => {
                const tds = r.map(c => `<td style="padding:7px 10px; font-size:12px; border-bottom:1px solid #f0f0f0;">${c ?? '-'}</td>`).join('');
                return `<tr>${tds}</tr>`;
            }).join('');
            return `<div class="table-responsive" style="margin-top:10px;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead><tr>${ths}</tr></thead>
                    <tbody>${trs}</tbody>
                </table>
            </div>`;
        }

        function repFecha(str) {
            if (!str) return '-';
            const d = new Date(str + 'T00:00:00');
            return d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function diasEntre(desde, hasta) {
            return Math.round((new Date(hasta) - new Date(desde)) / 86400000);
        }

        function repBadge(texto, clase) {
            return `<span class="rep-badge ${clase}">${texto}</span>`;
        }

        function xlsxDescargar(wb, nombre) {
            XLSX.writeFile(wb, nombre + '_' + new Date().toISOString().split('T')[0] + '.xlsx');
        }

        // ‚îÄ‚îÄ‚îÄ Reporte 1: Estado de Inventario ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function generarReporteInventario() {
            const hoy = new Date();
            const rows = inventoryData.map(item => {
                const valor   = (item.stockActual * (item.costoPromedioUSD || 0)).toFixed(2);
                const dias    = item.ultimaVenta
                    ? diasEntre(item.ultimaVenta.split('T')[0], hoy.toISOString().split('T')[0])
                    : '-';
                let estadoBadge;
                if (item.stockActual <= 0)              estadoBadge = repBadge('Agotado', 'rep-crit');
                else if (item.stockActual <= item.stockMinimo) estadoBadge = repBadge('Stock bajo', 'rep-warn');
                else                                     estadoBadge = repBadge('Normal', 'rep-ok');

                return [
                    item.nombre,
                    item.stockActual,
                    `$${(item.costoPromedioUSD || 0).toFixed(2)}`,
                    `$${valor}`,
                    estadoBadge,
                    typeof dias === 'number' ? dias + ' d√≠as' : dias
                ];
            });

            const totalValor = inventoryData.reduce((s, i) => s + (i.stockActual * (i.costoPromedioUSD || 0)), 0);
            const resumen = `<div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:10px; font-size:13px;">
                <span>üì¶ <strong>${inventoryData.length}</strong> productos</span>
                <span>üî¥ Agotados: <strong>${inventoryData.filter(i => i.stockActual <= 0).length}</strong></span>
                <span>üü° Stock bajo: <strong>${inventoryData.filter(i => i.stockActual > 0 && i.stockActual <= i.stockMinimo).length}</strong></span>
                <span>üí∞ Valor total inventario: <strong>$${totalValor.toFixed(2)} USD</strong></span>
            </div>`;

            document.getElementById('rep-inventario-result').innerHTML = resumen +
                repTablaHTML(['Producto','Stock','Costo USD','Valor USD','Estado','D√≠as sin mov.'], rows,
                    'No hay productos en inventario');
        }

        function exportReporteInventarioXLSX() {
            const wb  = XLSX.utils.book_new();
            const data = [['Producto','Stock Actual','Costo USD','Valor USD','Estado','√ölt. Venta','√ölt. Compra','Stock M√≠n']];
            inventoryData.forEach(i => data.push([
                i.nombre, i.stockActual,
                parseFloat((i.costoPromedioUSD || 0).toFixed(2)),
                parseFloat((i.stockActual * (i.costoPromedioUSD || 0)).toFixed(2)),
                i.estado || '',
                i.ultimaVenta   || '',
                i.ultimaCompra  || '',
                i.stockMinimo   || 0
            ]));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'Inventario');
            xlsxDescargar(wb, 'AQUANEV_Inventario');
        }

        // ‚îÄ‚îÄ‚îÄ Reporte 2: Cr√©ditos por Vencimiento ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function generarRepCreditosVencimiento() {
            const filtroEstado = document.getElementById('rep-creditos-estado').value;
            const hoy = new Date();

            let creditos = creditsData.filter(c => (c.balance || c.balanceUSD || 0) > 0);

            const conEstado = creditos.map(c => {
                const venc = c.fechaVencimiento ? new Date(c.fechaVencimiento + 'T00:00:00') : null;
                const diasHasta = venc ? Math.ceil((venc - hoy) / 86400000) : null;
                let estado, badge;
                if (!venc)              { estado = 'sin_fecha'; badge = repBadge('Sin fecha', 'rep-info'); }
                else if (diasHasta < 0) { estado = 'vencido';   badge = repBadge(`Vencido ${Math.abs(diasHasta)}d`, 'rep-crit'); }
                else if (diasHasta <= (c.diasAlertaAntes || 3)) { estado = 'por_vencer'; badge = repBadge(`Vence en ${diasHasta}d`, 'rep-warn'); }
                else                   { estado = 'Pendiente';  badge = repBadge(`${diasHasta} d√≠as`, 'rep-ok'); }
                return { ...c, estado_calc: estado, diasHasta, badge };
            });

            let filtrados = filtroEstado === 'todos' ? conEstado
                : filtroEstado === 'vencido'    ? conEstado.filter(c => c.estado_calc === 'vencido')
                : filtroEstado === 'por_vencer' ? conEstado.filter(c => c.estado_calc === 'por_vencer')
                : conEstado.filter(c => c.estado_calc === filtroEstado);

            // Ordenar: vencidos primero, luego por d√≠as restantes
            filtrados.sort((a, b) => (a.diasHasta ?? 9999) - (b.diasHasta ?? 9999));

            const rows = filtrados.map(c => [
                c.customer,
                `$${(c.amount || c.amountUSD || 0).toFixed(2)}`,
                `$${(c.balance || c.balanceUSD || 0).toFixed(2)}`,
                repFecha(c.fechaVencimiento),
                c.badge,
                c.paymentMethod || c.metodo || '-'
            ]);

            const totalPendiente = filtrados.reduce((s, c) => s + (c.balance || c.balanceUSD || 0), 0);
            const resumen = `<div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:10px; font-size:13px;">
                <span>üìã <strong>${filtrados.length}</strong> cr√©ditos</span>
                <span>üî¥ Vencidos: <strong>${filtrados.filter(c=>c.estado_calc==='vencido').length}</strong></span>
                <span>üü° Por vencer: <strong>${filtrados.filter(c=>c.estado_calc==='por_vencer').length}</strong></span>
                <span>üí∞ Total pendiente: <strong>$${totalPendiente.toFixed(2)} USD</strong></span>
            </div>`;

            document.getElementById('rep-creditos-result').innerHTML = resumen +
                repTablaHTML(['Cliente','Monto','Saldo','Vencimiento','Estado','M√©todo'], rows, 'No hay cr√©ditos pendientes');
        }

        function exportRepCreditosXLSX() {
            const wb  = XLSX.utils.book_new();
            const hoy = new Date();
            const data = [['Cliente','Monto USD','Saldo USD','Fecha Venta','Vencimiento','D√≠as Rest/Venc','Estado','M√©todo']];
            creditsData.filter(c => (c.balance || c.balanceUSD || 0) > 0).forEach(c => {
                const venc = c.fechaVencimiento ? new Date(c.fechaVencimiento + 'T00:00:00') : null;
                const dias = venc ? Math.ceil((venc - hoy) / 86400000) : null;
                data.push([
                    c.customer,
                    parseFloat((c.amount || c.amountUSD || 0).toFixed(2)),
                    parseFloat((c.balance || c.balanceUSD || 0).toFixed(2)),
                    c.date || '', c.fechaVencimiento || '',
                    dias !== null ? dias : '',
                    dias === null ? 'Sin fecha' : dias < 0 ? 'Vencido' : dias <= (c.diasAlertaAntes||3) ? 'Por vencer' : 'Vigente',
                    c.paymentMethod || ''
                ]);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'Creditos');
            xlsxDescargar(wb, 'AQUANEV_Creditos_Vencimiento');
        }

        // ‚îÄ‚îÄ‚îÄ Reporte 3: An√°lisis de Ventas por Producto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function generarRepAnalisisVentas() {
            const desde = document.getElementById('rep-ventas-desde').value;
            const hasta = document.getElementById('rep-ventas-hasta').value;

            let ventas = salesData;
            if (desde) ventas = ventas.filter(v => v.date >= desde);
            if (hasta) ventas = ventas.filter(v => v.date <= hasta);

            // Agrupar por producto
            const mapa = {};
            ventas.forEach(v => {
                const precioBase = v.totalUSD != null
                    ? v.totalUSD / (v.items.reduce((s, i) => s + i.quantity, 0) || 1)
                    : 0;
                v.items.forEach(item => {
                    const key = item.productKey || item.name;
                    if (!mapa[key]) mapa[key] = { nombre: item.name || key, cant: 0, ingresos: 0 };
                    mapa[key].cant     += item.quantity;
                    const precioItem    = item.priceUSD || convertBStoUSD(item.priceBS || 0);
                    mapa[key].ingresos += item.quantity * precioItem;
                });
            });

            const totalIngresos = Object.values(mapa).reduce((s, p) => s + p.ingresos, 0);
            const sorted = Object.values(mapa).sort((a, b) => b.ingresos - a.ingresos);

            const rows = sorted.map(p => {
                const pct    = totalIngresos > 0 ? ((p.ingresos / totalIngresos) * 100).toFixed(1) : '0.0';
                const costo  = inventoryData.find(i => i.nombre === p.nombre)?.costoPromedioUSD;
                const margen = costo
                    ? (((p.ingresos / (p.cant || 1)) - costo) / (p.ingresos / (p.cant || 1)) * 100).toFixed(0) + '%'
                    : '-';
                return [
                    p.nombre,
                    p.cant,
                    `$${p.ingresos.toFixed(2)}`,
                    margen,
                    `${pct}%`
                ];
            });

            const resumen = `<div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:10px; font-size:13px;">
                <span>üõí <strong>${ventas.length}</strong> ventas analizadas</span>
                <span>üì¶ <strong>${sorted.length}</strong> productos distintos</span>
                <span>üí∞ Ingresos totales: <strong>$${totalIngresos.toFixed(2)} USD</strong></span>
            </div>`;

            document.getElementById('rep-ventas-result').innerHTML = resumen +
                repTablaHTML(['Producto','Cant. vendida','Ingresos USD','Margen','% del total'], rows, 'Sin ventas en el per√≠odo');
        }

        function exportRepVentasXLSX() {
            const desde = document.getElementById('rep-ventas-desde').value;
            const hasta = document.getElementById('rep-ventas-hasta').value;
            let ventas = salesData;
            if (desde) ventas = ventas.filter(v => v.date >= desde);
            if (hasta) ventas = ventas.filter(v => v.date <= hasta);

            const wb   = XLSX.utils.book_new();
            const data = [['Producto','Cant. Vendida','Ingresos USD','Costo USD','Margen %','% del Total']];
            const mapa = {};
            ventas.forEach(v => {
                v.items.forEach(item => {
                    const key = item.productKey || item.name;
                    if (!mapa[key]) mapa[key] = { nombre: item.name || key, cant: 0, ingresos: 0 };
                    mapa[key].cant     += item.quantity;
                    mapa[key].ingresos += item.quantity * (item.priceUSD || convertBStoUSD(item.priceBS || 0));
                });
            });
            const total = Object.values(mapa).reduce((s, p) => s + p.ingresos, 0);
            Object.values(mapa).sort((a, b) => b.ingresos - a.ingresos).forEach(p => {
                const costo  = inventoryData.find(i => i.nombre === p.nombre)?.costoPromedioUSD || 0;
                const pUnitio = p.cant > 0 ? p.ingresos / p.cant : 0;
                const margen = costo && pUnitio ? parseFloat((((pUnitio - costo) / pUnitio) * 100).toFixed(1)) : '';
                data.push([p.nombre, p.cant, parseFloat(p.ingresos.toFixed(2)), costo || '', margen,
                    total > 0 ? parseFloat(((p.ingresos / total) * 100).toFixed(1)) : 0]);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'Ventas por Producto');
            xlsxDescargar(wb, 'AQUANEV_Analisis_Ventas');
        }

        // ‚îÄ‚îÄ‚îÄ Reporte 4: Estado de Pr√©stamos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function generarRepPrestamos() {
            const hoy = new Date();
            const rows = prestamosData.map(p => {
                // Pr√≥xima cuota pendiente
                const proxCuota = p.amortizacion.find(c => c.estado === 'pendiente');
                const diasVence = proxCuota
                    ? Math.ceil((new Date(proxCuota.vencimiento + 'T00:00:00') - hoy) / 86400000)
                    : null;
                let estadoBadge;
                if (p.estado === 'cancelado') estadoBadge = repBadge('Cancelado', 'rep-info');
                else if (p.estado === 'finalizado') estadoBadge = repBadge('Finalizado', 'rep-ok');
                else if (diasVence !== null && diasVence < 0) estadoBadge = repBadge('Cuota vencida', 'rep-crit');
                else if (diasVence !== null && diasVence <= 5) estadoBadge = repBadge('Cuota pr√≥xima', 'rep-warn');
                else estadoBadge = repBadge('Al d√≠a', 'rep-ok');

                const iconoTipo = { banco: 'üèõ', persona: 'üë§', empresa: 'üè¢' }[p.tipo] || 'üìÑ';

                return [
                    `${iconoTipo} ${p.prestamista}`,
                    `$${p.montoOriginalUSD.toFixed(2)}`,
                    `$${p.totalPagadoUSD.toFixed(2)}`,
                    `$${p.saldoPendienteUSD.toFixed(2)}`,
                    proxCuota ? `#${proxCuota.numero} ¬∑ $${proxCuota.cuotaUSD.toFixed(2)}` : '-',
                    proxCuota ? repFecha(proxCuota.vencimiento) : '-',
                    estadoBadge
                ];
            });

            const totalDeuda   = prestamosData.filter(p => p.estado === 'activo').reduce((s, p) => s + p.saldoPendienteUSD, 0);
            const totalPagado  = prestamosData.reduce((s, p) => s + p.totalPagadoUSD, 0);
            const activos      = prestamosData.filter(p => p.estado === 'activo').length;
            const resumen = `<div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:10px; font-size:13px;">
                <span>üè¶ Activos: <strong>${activos}</strong></span>
                <span>üí∞ Deuda total: <strong>$${totalDeuda.toFixed(2)} USD</strong></span>
                <span>‚úÖ Total pagado: <strong>$${totalPagado.toFixed(2)} USD</strong></span>
            </div>`;

            document.getElementById('rep-prestamos-result').innerHTML = resumen +
                repTablaHTML(['Prestamista','Monto Orig.','Pagado','Saldo','Pr√≥x. Cuota','Vencimiento','Estado'], rows,
                    'No hay pr√©stamos registrados');
        }

        function exportRepPrestamosXLSX() {
            const wb   = XLSX.utils.book_new();
            const hoy  = new Date();
            const data = [['Prestamista','Tipo','Contrato','Monto USD','Tasa %','Plazo','Cuota USD','Desembolso','Estado',
                           'Cuotas Pagadas','Total Pagado','Saldo Pendiente','Pr√≥x. Cuota N√∫m','Pr√≥x. Vencimiento']];
            prestamosData.forEach(p => {
                const prox = p.amortizacion.find(c => c.estado === 'pendiente');
                data.push([
                    p.prestamista, p.tipo, p.contrato,
                    p.montoOriginalUSD, p.tasaInteres, p.plazoMeses, p.cuotaMensualUSD,
                    p.fechaDesembolso, p.estado, p.cuotasPagadas,
                    parseFloat(p.totalPagadoUSD.toFixed(2)),
                    parseFloat(p.saldoPendienteUSD.toFixed(2)),
                    prox ? prox.numero : '',
                    prox ? prox.vencimiento : ''
                ]);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'Prestamos');
            xlsxDescargar(wb, 'AQUANEV_Prestamos');
        }

        // ‚îÄ‚îÄ‚îÄ Reporte 5: Movimientos de Inventario ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function generarRepMovimientos() {
            const desde = document.getElementById('rep-mov-desde').value;
            const hasta = document.getElementById('rep-mov-hasta').value;
            const tipo  = document.getElementById('rep-mov-tipo').value;

            // inventoryMovements viene del m√≥dulo B2
            const movs = (inventoryMovements || []).filter(m => {
                const fecha = m.fecha || m.timestamp || '';
                if (desde && fecha < desde) return false;
                if (hasta && fecha > hasta + 'T99') return false;
                if (tipo !== 'todos' && m.tipo !== tipo) return false;
                return true;
            });

            const tipoIcon = { venta: 'üîª', compra: 'üî∫', ajuste: 'üîÑ' };
            const rows = movs.slice(0, 200).map(m => {
                const fechaStr = (m.fecha || m.timestamp || '').substring(0, 10);
                const prod = inventoryData.find(i => i.productoKey === m.productoKey);
                return [
                    repFecha(fechaStr),
                    `${tipoIcon[m.tipo] || '‚Ä¢'} ${m.tipo}`,
                    prod?.nombre || m.productoKey || '-',
                    m.cantidad,
                    `${m.stockAntes ?? '-'} ‚Üí ${m.stockDespues ?? '-'}`,
                    m.notas || '-'
                ];
            });

            const resumen = `<div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:10px; font-size:13px;">
                <span>üìã <strong>${movs.length}</strong> movimientos${movs.length > 200 ? ' (mostrando 200)' : ''}</span>
                <span>üîª Salidas (ventas): <strong>${movs.filter(m=>m.tipo==='venta').length}</strong></span>
                <span>üî∫ Entradas (compras/ajustes): <strong>${movs.filter(m=>m.tipo!=='venta').length}</strong></span>
            </div>`;

            document.getElementById('rep-movimientos-result').innerHTML = resumen +
                repTablaHTML(['Fecha','Tipo','Producto','Cant.','Stock','Notas'], rows, 'Sin movimientos en el per√≠odo');
        }

        function exportRepMovimientosXLSX() {
            const desde = document.getElementById('rep-mov-desde').value;
            const hasta = document.getElementById('rep-mov-hasta').value;
            const tipo  = document.getElementById('rep-mov-tipo').value;
            const movs  = (inventoryMovements || []).filter(m => {
                const fecha = m.fecha || m.timestamp || '';
                if (desde && fecha < desde) return false;
                if (hasta && fecha > hasta + 'T99') return false;
                if (tipo !== 'todos' && m.tipo !== tipo) return false;
                return true;
            });
            const wb   = XLSX.utils.book_new();
            const data = [['Fecha','Tipo','Producto Key','Producto Nombre','Cantidad','Stock Antes','Stock Despu√©s','Notas']];
            movs.forEach(m => {
                const prod = inventoryData.find(i => i.productoKey === m.productoKey);
                data.push([
                    (m.fecha || m.timestamp || '').substring(0, 10),
                    m.tipo, m.productoKey, prod?.nombre || '',
                    m.cantidad, m.stockAntes ?? '', m.stockDespues ?? '', m.notas || ''
                ]);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'Movimientos');
            xlsxDescargar(wb, 'AQUANEV_Movimientos_Inventario');
        }

        // ‚îÄ‚îÄ‚îÄ Reporte 6: Consignaciones Pendientes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function generarRepConsignaciones() {
            const hoy    = new Date().toISOString().split('T')[0];
            const abiertas = consignacionesData.filter(c => c.estado === 'entregado' || c.estado === 'mixto');

            const rows = abiertas.map(c => {
                const pendiente = c.cantidadEntregada - c.cantidadDevuelta - c.cantidadCobrada;
                const dias      = diasEntre(c.fechaEntrega, hoy);
                const valorPend = pendiente * c.precioUnitarioUSD;
                let urgencia;
                if (dias > 30)      urgencia = repBadge(`${dias}d - urgente`, 'rep-crit');
                else if (dias > 14) urgencia = repBadge(`${dias}d`, 'rep-warn');
                else                urgencia = repBadge(`${dias}d`, 'rep-ok');

                return [
                    c.cliente,
                    c.productoNombre,
                    c.cantidadEntregada,
                    c.cantidadDevuelta,
                    c.cantidadCobrada,
                    `${pendiente} u ¬∑ $${valorPend.toFixed(2)}`,
                    repFecha(c.fechaEntrega),
                    urgencia
                ];
            });

            const totalPendienteUSD = abiertas.reduce((s, c) => {
                const pend = c.cantidadEntregada - c.cantidadDevuelta - c.cantidadCobrada;
                return s + pend * c.precioUnitarioUSD;
            }, 0);
            const resumen = `<div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:10px; font-size:13px;">
                <span>üì§ Abiertas: <strong>${abiertas.length}</strong></span>
                <span>‚è≥ Con +30 d√≠as: <strong>${abiertas.filter(c=>diasEntre(c.fechaEntrega,hoy)>30).length}</strong></span>
                <span>üí∞ Valor pendiente: <strong>$${totalPendienteUSD.toFixed(2)} USD</strong></span>
            </div>`;

            document.getElementById('rep-consignaciones-result').innerHTML = resumen +
                repTablaHTML(['Cliente','Producto','Entregado','Devuelto','Cobrado','Pendiente','Fecha entrega','Antig√ºedad'], rows,
                    'No hay consignaciones abiertas');
        }

        function exportRepConsignacionesXLSX() {
            const hoy    = new Date().toISOString().split('T')[0];
            const wb     = XLSX.utils.book_new();
            const data   = [['Cliente','Producto','Cant. Entregada','Cant. Devuelta','Cant. Cobrada','Cant. Pendiente',
                             'Valor Pendiente USD','Precio Unit USD','Fecha Entrega','D√≠as Abierto','Estado']];
            consignacionesData.forEach(c => {
                const pend = c.cantidadEntregada - c.cantidadDevuelta - c.cantidadCobrada;
                data.push([
                    c.cliente, c.productoNombre,
                    c.cantidadEntregada, c.cantidadDevuelta, c.cantidadCobrada, pend,
                    parseFloat((pend * c.precioUnitarioUSD).toFixed(2)),
                    c.precioUnitarioUSD,
                    c.fechaEntrega,
                    diasEntre(c.fechaEntrega, hoy),
                    c.estado
                ]);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'Consignaciones');
            xlsxDescargar(wb, 'AQUANEV_Consignaciones');
        }

        // ‚îÄ‚îÄ‚îÄ Exportaci√≥n ampliada: Todo en un XLSX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Extiende la funci√≥n existente exportAllToXLSX agregando hojas de B10
        const _exportAllToXLSX_orig = typeof exportAllToXLSX === 'function' ? exportAllToXLSX : null;

        function exportAllToXLSX() {
            const desde = document.getElementById('export-date-from').value;
            const hasta = document.getElementById('export-date-to').value;
            if (!desde || !hasta) { alert('Selecciona el rango de fechas'); return; }

            // Llamar al original si existe (para Ventas/Gastos/Cr√©ditos)
            if (_exportAllToXLSX_orig) { _exportAllToXLSX_orig(); return; }

            const wb = XLSX.utils.book_new();
            const filtrar = arr => arr.filter(x => (!desde || x.date >= desde) && (!hasta || x.date <= hasta));

            // Hoja Ventas
            const ventasData = [['Fecha','Cliente','Productos','Total USD','M√©todo']];
            filtrar(salesData).forEach(v => ventasData.push([
                v.date, v.customer,
                (v.items||[]).map(i => `${i.quantity}√ó${i.name}`).join(', '),
                parseFloat((v.totalUSD||0).toFixed(2)), v.paymentMethod||''
            ]));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ventasData), 'Ventas');

            // Hoja Gastos
            const gastosData = [['Fecha','Descripci√≥n','Categor√≠a','Monto USD']];
            filtrar(expensesData).forEach(e => gastosData.push([
                e.date, e.description||e.concepto||'', e.category||'',
                parseFloat((e.amountUSD||convertBStoUSD(e.amount||0)).toFixed(2))
            ]));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(gastosData), 'Gastos');

            // Hoja Cr√©ditos
            const creditosData = [['Cliente','Monto USD','Saldo USD','Fecha Venta','Vencimiento','Estado']];
            creditsData.forEach(c => creditosData.push([
                c.customer, parseFloat((c.amount||0).toFixed(2)), parseFloat((c.balance||0).toFixed(2)),
                c.date||'', c.fechaVencimiento||'', c.status||''
            ]));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(creditosData), 'Creditos');

            // Hoja Inventario
            const invData = [['Producto','Stock','Costo USD','Valor USD','Estado']];
            inventoryData.forEach(i => invData.push([
                i.nombre, i.stockActual,
                parseFloat((i.costoPromedioUSD||0).toFixed(2)),
                parseFloat((i.stockActual*(i.costoPromedioUSD||0)).toFixed(2)),
                i.estado||''
            ]));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(invData), 'Inventario');

            xlsxDescargar(wb, 'AQUANEV_Completo_' + desde + '_' + hasta);
        }

        // ‚îÄ‚îÄ‚îÄ Optimizaci√≥n m√≥vil: Pull-to-refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        (function initPullToRefresh() {
            let startY = 0, pulling = false;
            const indicator = document.getElementById('ptr-indicator');

            document.addEventListener('touchstart', e => {
                if (window.scrollY === 0) {
                    startY   = e.touches[0].clientY;
                    pulling  = true;
                }
            }, { passive: true });

            document.addEventListener('touchmove', e => {
                if (!pulling) return;
                const dist = e.touches[0].clientY - startY;
                if (dist > 60 && indicator) {
                    indicator.style.display = 'block';
                }
            }, { passive: true });

            document.addEventListener('touchend', () => {
                if (!pulling) return;
                pulling = false;
                if (indicator && indicator.style.display === 'block') {
                    indicator.textContent = 'üîÑ Sincronizando‚Ä¶';
                    setTimeout(() => {
                        ejecutarSyncManual && ejecutarSyncManual();
                        setTimeout(() => {
                            if (indicator) { indicator.style.display = 'none'; indicator.textContent = '‚Üì Suelta para sincronizar'; }
                        }, 2000);
                    }, 300);
                }
            });
        })();

        // ‚îÄ‚îÄ‚îÄ Optimizaci√≥n m√≥vil: detecci√≥n conexi√≥n lenta ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        (function detectarConexionLenta() {
            const banner = document.getElementById('slow-connection-banner');
            function chequear() {
                if (!banner) return;
                if (navigator.connection) {
                    const tipo = navigator.connection.effectiveType;
                    if (tipo === 'slow-2g' || tipo === '2g') {
                        banner.style.display = 'block';
                        // Desactivar sync autom√°tica - usar background sync del SW
                        if (syncTimer) { clearInterval(syncTimer); syncTimer = null; }
                    } else {
                        banner.style.display = 'none';
                        // Reactivar sync si fue desactivada por conexi√≥n lenta
                        if (!syncTimer && syncConfig.activa && syncConfig.frecuenciaMin > 0) iniciarTimerSync();
                    }
                }
            }
            chequear();
            if (navigator.connection) navigator.connection.addEventListener('change', chequear);
        })();

        // ‚îÄ‚îÄ‚îÄ Inicializar fechas de reportes al hoy y -30 d√≠as ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function initReportDates() {
            const hoy      = new Date().toISOString().split('T')[0];
            const hace30   = new Date(Date.now() - 30 * 86400000).toISOString().split('T')[0];
            const campos   = ['rep-ventas-desde','rep-mov-desde'];
            const camposHoy= ['rep-ventas-hasta','rep-mov-hasta'];
            campos.forEach(id => { const el = document.getElementById(id); if (el) el.value = hace30; });
            camposHoy.forEach(id => { const el = document.getElementById(id); if (el) el.value = hoy; });
        }

        // ========== FIN B10: REPORTES AMPLIADOS + OPTIMIZACI√ìN M√ìVIL ==========

        // ========== SISTEMA DE NAVEGACI√ìN ==========
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remover clase active de todas las pesta√±as
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Agregar clase active a la pesta√±a clickeada
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // Cargar datos espec√≠ficos de la pesta√±a
                    if (tabId === 'sales') {
                        loadProductsList();
                    } else if (tabId === 'ecuador') {
                        loadEcuadorView();
                    } else if (tabId === 'proveedores') {
                        loadProveedoresList();
                        actualizarDatalistProveedores();
                    } else if (tabId === 'expenses') {
                        actualizarDatalistProveedores();
                    } else if (tabId === 'compras') {
                        actualizarDatalistProveedores();
                    }
                });
            });
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'sales') {
                loadProductsList();
            }
        }

        function showPriceManager() {
            showTab('prices');
        }

        // ========== CONFIGURACI√ìN DE CONTACTOS ==========
        function loadContactConfig() {
            document.getElementById('whatsapp-number').value = appConfig.whatsapp.number;
            document.getElementById('whatsapp-message').value = appConfig.whatsapp.message;
            document.getElementById('gmail-address').value = appConfig.gmail.address;
            document.getElementById('gmail-subject').value = appConfig.gmail.subject;
            document.getElementById('gmail-body').value = appConfig.gmail.body;
        }

        function saveWhatsAppConfig() {
            appConfig.whatsapp.number = document.getElementById('whatsapp-number').value;
            appConfig.whatsapp.message = document.getElementById('whatsapp-message').value;
            localStorage.setItem('appConfig', JSON.stringify(appConfig));
            alert('Configuraci√≥n de WhatsApp guardada!');
        }

        function saveGmailConfig() {
            appConfig.gmail.address = document.getElementById('gmail-address').value;
            appConfig.gmail.subject = document.getElementById('gmail-subject').value;
            appConfig.gmail.body = document.getElementById('gmail-body').value;
            localStorage.setItem('appConfig', JSON.stringify(appConfig));
            alert('Configuraci√≥n de Gmail guardada!');
        }

        function openWhatsApp() {
            const number = appConfig.whatsapp.number;
            const message = encodeURIComponent(appConfig.whatsapp.message);
            window.open(`https://wa.me/${number}?text=${message}`, '_blank');
        }

        function openGmail() {
            const address = appConfig.gmail.address;
            const subject = encodeURIComponent(appConfig.gmail.subject);
            const body = encodeURIComponent(appConfig.gmail.body);
            window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${address}&su=${subject}&body=${body}`, '_blank');
        }

        // ========== GESTI√ìN DE TASAS MANUALES ==========
        // ‚îÄ‚îÄ Sincronizar tasa BCV desde bcvRateHistory (fuente √∫nica) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function syncRateFromBCV() {
            const today = new Date().toISOString().split('T')[0];
            const tasaHoy = getBCVRateForDate(today);
            if (tasaHoy && tasaHoy > 0) {
                appConfig.exchangeRates.bcv      = tasaHoy;
                appConfig.exchangeRates.priceRate = tasaHoy;
                priceExchangeRate                 = tasaHoy;
                localStorage.setItem('appConfig', JSON.stringify(appConfig));
            }
            return tasaHoy || appConfig.exchangeRates.bcv;
        }

        function loadManualRates() {
            const tasa = syncRateFromBCV();
            document.getElementById('manual-bcv-rate').value    = tasa.toFixed(2);
            document.getElementById('price-exchange-rate').value = tasa.toFixed(2);
            document.getElementById('manual-binance-rate').value = appConfig.exchangeRates.binance;
            document.getElementById('iva-percentage').value      = ivaPercentage;
        }

        function saveManualRates() {
            // Solo Binance e IVA son editables; BCV viene de bcvRateHistory
            appConfig.exchangeRates.binance = parseFloat(document.getElementById('manual-binance-rate').value);
            ivaPercentage = parseFloat(document.getElementById('iva-percentage').value);
            syncRateFromBCV();
            
            localStorage.setItem('appConfig', JSON.stringify(appConfig));
            localStorage.setItem('ivaPercentage', ivaPercentage.toString());
            
            loadManualExchangeRates();
            loadCurrentPrices();
            loadProductsList();
            loadCurrentPricesTable();
            
            alert('Configuraci√≥n guardada correctamente!');
        }

        function loadManualExchangeRates() {
            document.getElementById('bcv-rate').textContent = appConfig.exchangeRates.bcv.toFixed(2) + ' BS';
            document.getElementById('binance-rate').textContent = appConfig.exchangeRates.binance.toFixed(2) + ' BS';
            
            const now = new Date();
            const horaLegible = now.toLocaleTimeString('es-VE', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('bcv-last-update').textContent = horaLegible;
            document.getElementById('binance-last-update').textContent = horaLegible;
        }

        function updateExchangeRates() {
            showTab('config');
            alert('Para actualizar las tasas, modifica los valores en la pesta√±a Configuraci√≥n y guarda los cambios.');
        }

        // ========== SISTEMA DE PRECIOS EN D√ìLARES ==========
        function updateCalculatedPrice() {
            const priceUSD = parseFloat(document.getElementById('new-price-usd').value) || 0;
            const exchangeRate = parseFloat(document.getElementById('price-exchange-rate').value) || priceExchangeRate;
            const priceBS = priceUSD * exchangeRate;
            
            document.getElementById('calculated-price-bs').textContent = 
                `$${priceUSD.toFixed(2)} USD = ${priceBS.toFixed(2)} BS (Tasa: ${exchangeRate} BS/USD)`;
        }

        function getCurrentPriceBS(productKey) {
            const priceUSD = waterPrices[productKey]?.priceUSD || 0;
            return priceUSD * priceExchangeRate;
        }

        function convertUSDtoBS(amountUSD) {
            return amountUSD * priceExchangeRate;
        }

        function convertBStoUSD(amountBS) {
            return amountBS / priceExchangeRate;
        }

        function setCurrencyDisplay(currency) {
            currentCurrencyDisplay = currency;
            document.querySelectorAll('.currency-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadCurrentPrices();
        }

        // ========== GESTI√ìN DE PRECIOS ==========
        function updateWaterPrice() {
            const productKey = document.getElementById('price-product').value;
            const newPriceUSD = parseFloat(document.getElementById('new-price-usd').value);
            const notes = document.getElementById('price-notes').value;
            
            if (!newPriceUSD || isNaN(newPriceUSD) || newPriceUSD < 0) {
                alert('Ingresa un precio v√°lido en d√≥lares');
                return;
            }
            
            const productNames = {
                recarga_local: 'Recarga en Local',
                recarga_domicilio: 'Recarga a Domicilio',
                recarga_lejana: 'Recarga a Domicilio Lejana',
                empresas_mayor: 'Empresas Mayor de 12 unidades',
                botellon_nuevo: 'Botell√≥n Nuevo',
                hielo: 'Hielo'
            };
            
            const oldPriceUSD = waterPrices[productKey]?.priceUSD || 0;
            
            // Guardar en historial
            priceHistory.unshift({
                date: new Date().toISOString(),
                productKey: productKey,
                productName: productNames[productKey],
                oldPriceUSD: oldPriceUSD,
                newPriceUSD: newPriceUSD,
                exchangeRate: priceExchangeRate,
                notes: notes
            });
            
            // Actualizar precio
            waterPrices[productKey] = {
                priceUSD: newPriceUSD,
                lastUpdate: new Date().toISOString(),
                hasIva: productKey === 'hielo'
            };
            
            localStorage.setItem('waterPrices', JSON.stringify(waterPrices));
            localStorage.setItem('priceHistory', JSON.stringify(priceHistory));
            
            // Actualizar vistas
            loadCurrentPrices();
            loadProductsList();
            loadCurrentPricesTable();
            loadPriceHistory();
            
            // Limpiar formulario
            document.getElementById('new-price-usd').value = '';
            document.getElementById('price-notes').value = '';
            updateCalculatedPrice();
            
            alert(`Precio de ${productNames[productKey]} actualizado a $${newPriceUSD.toFixed(2)} USD`);
        }

        function loadCurrentPrices() {
            const container = document.getElementById('current-prices');
            container.innerHTML = '';
            
            const products = {
                recarga_local: { name: 'Recarga Local', icon: 'fa-refresh' },
                recarga_domicilio: { name: 'Recarga Domicilio', icon: 'fa-truck' },
                recarga_lejana: { name: 'Recarga Lejana', icon: 'fa-road' },
                empresas_mayor: { name: 'Empresas Mayor', icon: 'fa-building' },
                botellon_nuevo: { name: 'Botell√≥n Nuevo', icon: 'fa-box' },
                hielo: { name: 'Hielo', icon: 'fa-snowflake' }
            };
            
            for (const [key, product] of Object.entries(products)) {
                const priceUSD = waterPrices[key]?.priceUSD || 0;
                const priceBS = priceUSD * priceExchangeRate;
                const hasIva = waterPrices[key]?.hasIva || false;
                
                const displayPrice = currentCurrencyDisplay === 'usd' ? 
                    `$${priceUSD.toFixed(2)} USD` : 
                    `${priceBS.toFixed(2)} BS`;
                
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <div class="stat-title">
                        <i class="fas ${product.icon}"></i> ${product.name}
                        ${hasIva ? '<span class="iva-badge">IVA</span>' : ''}
                    </div>
                    <div class="stat-value">${displayPrice}</div>
                    ${currentCurrencyDisplay === 'usd' ? 
                        `<div class="stat-desc">${priceBS.toFixed(2)} BS</div>` : 
                        `<div class="stat-desc">$${priceUSD.toFixed(2)} USD</div>`
                    }
                `;
                container.appendChild(statCard);
            }
        }

        function loadCurrentPricesTable() {
            const tbody = document.getElementById('current-prices-table');
            tbody.innerHTML = '';
            
            // Nombres amigables para productos
            const productNames = {
                recarga_local: 'Recarga en Local',
                recarga_domicilio: 'Recarga a Domicilio',
                recarga_lejana: 'Recarga a Domicilio Lejana',
                empresas_mayor: 'Empresas Mayor de 12 unidades',
                botellon_nuevo: 'Botell√≥n Nuevo',
                hielo: 'Hielo',
                recarga_local_empresa: 'Recarga Local Empresa',
                dispensador: 'Dispensador de Agua'
            };
            
            // Iterar sobre TODOS los productos en waterPrices
            for (const [key, data] of Object.entries(waterPrices)) {
                const priceUSD = data?.priceUSD || 0;
                const priceBS = priceUSD * priceExchangeRate;
                const hasIva = data?.hasIva || false;
                const lastUpdate = data?.lastUpdate;
                const displayName = productNames[key] || key; // Usar nombre amigable o key si no existe
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${displayName}</td>
                    <td>$${priceUSD.toFixed(2)}</td>
                    <td>${priceBS.toFixed(2)} BS</td>
                    <td>${hasIva ? 'S√≠' : 'No'}</td>
                    <td>${formatDate(lastUpdate)}</td>
                    <td>
                        <button class="btn btn-warning btn-small" onclick="quickEditPrice('${key}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        function quickEditPrice(productKey) {
            const productNames = {
                recarga_local: 'Recarga en Local',
                recarga_domicilio: 'Recarga a Domicilio',
                recarga_lejana: 'Recarga a Domicilio Lejana',
                empresas_mayor: 'Empresas Mayor de 12 unidades',
                botellon_nuevo: 'Botell√≥n Nuevo',
                hielo: 'Hielo',
                recarga_local_empresa: 'Recarga Local Empresa',
                dispensador: 'Dispensador de Agua'
            };
            
            const displayName = productNames[productKey] || productKey;
            const currentPriceUSD = waterPrices[productKey]?.priceUSD || 0;
            const currentHasIva = waterPrices[productKey]?.hasIva || false;
            
            const newPriceUSD = parseFloat(prompt(`Nuevo precio en USD para ${displayName}:`, currentPriceUSD));
            
            if (newPriceUSD && !isNaN(newPriceUSD)) {
                const ivaResponse = confirm(`¬øEste producto tiene IVA?\n\nActual: ${currentHasIva ? 'S√ç' : 'NO'}\n\nClick OK para S√ç, Cancelar para NO`);
                const newHasIva = ivaResponse;
                
                const notes = prompt('Notas del cambio (opcional):');
                
                priceHistory.unshift({
                    date: new Date().toISOString(),
                    productKey: productKey,
                    productName: displayName,
                    oldPriceUSD: currentPriceUSD,
                    newPriceUSD: newPriceUSD,
                    oldHasIva: currentHasIva,
                    newHasIva: newHasIva,
                    exchangeRate: priceExchangeRate,
                    notes: notes || 'Cambio r√°pido'
                });
                
                waterPrices[productKey] = {
                    priceUSD: newPriceUSD,
                    lastUpdate: new Date().toISOString(),
                    hasIva: newHasIva
                };
                
                localStorage.setItem('waterPrices', JSON.stringify(waterPrices));
                localStorage.setItem('priceHistory', JSON.stringify(priceHistory));
                
                loadCurrentPrices();
                loadProductsList();
                loadCurrentPricesTable();
                loadPriceHistory();
                loadDashboard();
                refreshOrderProductSelects();
                poblarConsProductoSelect();
                
                alert(`‚úÖ Precio actualizado:\n$${newPriceUSD.toFixed(2)} USD\nIVA: ${newHasIva ? 'S√ç' : 'NO'}`);
            }
        }

        function loadPriceHistory() {
            const tbody = document.getElementById('price-history');
            tbody.innerHTML = '';
            
            const recentHistory = priceHistory.slice(0, 20);
            
            if (recentHistory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #6c757d;">
                            No hay historial de cambios de precios
                        </td>
                    </tr>
                `;
                return;
            }
            
            recentHistory.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(record.date)}</td>
                    <td>${record.productName}</td>
                    <td>$${record.oldPriceUSD.toFixed(2)}</td>
                    <td>$${record.newPriceUSD.toFixed(2)}</td>
                    <td>${record.exchangeRate} BS/USD</td>
                    <td>${record.notes || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ========== SISTEMA DE VENTAS ==========
        function loadProductsList() {
            const container = document.getElementById('products-list');
            container.innerHTML = '';
            
            const products = {
                recarga_local: { name: 'Recarga en Local', icon: 'fa-refresh' },
                recarga_domicilio: { name: 'Recarga a Domicilio', icon: 'fa-truck' },
                recarga_lejana: { name: 'Recarga a Domicilio Lejana', icon: 'fa-road' },
                empresas_mayor: { name: 'Empresas Mayor de 12 unidades', icon: 'fa-building' },
                botellon_nuevo: { name: 'Botell√≥n Nuevo', icon: 'fa-box' },
                hielo: { name: 'Hielo', icon: 'fa-snowflake' },
                recarga_local_empresa: { name: 'Recarga Local Empresa', icon: 'fa-building' },
                dispensador: { name: 'Dispensador de Agua', icon: 'fa-faucet' }
            };
            
            for (const [key, product] of Object.entries(products)) {
                const priceUSD = waterPrices[key]?.priceUSD || 0;
                const priceBS = priceUSD * priceExchangeRate;
                const hasIva = waterPrices[key]?.hasIva || false;
                
                const productDiv = document.createElement('div');
                productDiv.className = 'product-item';
                productDiv.innerHTML = `
                    <div class="product-header">
                        <div>
                            <span class="product-name">
                                <i class="fas ${product.icon}"></i> ${product.name}
                            </span>
                            ${hasIva ? '<span class="iva-badge">+IVA</span>' : ''}
                        </div>
                        <div class="product-price">
                            $${priceUSD.toFixed(2)} USD<br>
                            <span class="price-detail">${priceBS.toFixed(2)} BS</span>
                        </div>
                    </div>
                    <div class="price-input-group">
                        <input type="number" id="qty-${key}" min="0" value="0" placeholder="Cantidad" inputmode="decimal">
                        <button class="btn btn-primary btn-small" onclick="addToSale('${key}')">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                    </div>
                `;
                container.appendChild(productDiv);
            }

            // B5: Agregar kits activos
            const kitsActivos = (productosCompuestos || []).filter(k => k.activo !== false);
            if (kitsActivos.length > 0) {
                const kitHeader = document.createElement('div');
                kitHeader.style.cssText = 'font-size:12px; font-weight:700; color:#5c6bc0; text-transform:uppercase; letter-spacing:1px; padding:10px 0 4px; border-top:2px dashed #e8eaf6; margin-top:8px;';
                kitHeader.textContent = 'üß© Kits / Productos Compuestos';
                container.appendChild(kitHeader);

                kitsActivos.forEach(kit => {
                    const stockDisp   = calcularStockKit(kit);
                    const priceBS     = convertUSDtoBS(kit.precioVentaUSD);
                    const stockColor  = stockDisp === 0 ? '#f44336' : stockDisp < 5 ? '#ff9800' : '#2e7d32';
                    const kitDiv      = document.createElement('div');
                    kitDiv.className  = 'product-item';
                    kitDiv.style.cssText = 'border-left:3px solid #5c6bc0; opacity:' + (stockDisp === 0 ? '0.5' : '1');
                    kitDiv.innerHTML  = `
                        <div class="product-header">
                            <div>
                                <span class="product-name">
                                    <i class="fas fa-cubes"></i> ${kit.nombre}
                                </span>
                                ${kit.hasIva ? '<span class="iva-badge">+IVA</span>' : ''}
                                <div style="font-size:11px; color:${stockColor}; margin-top:2px;">Stock: ${stockDisp} kits disponibles</div>
                                <div style="font-size:11px; color:#888; margin-top:2px;">${kit.componentes.map(c => `${c.cantidad}√ó ${c.nombre}`).join(' + ')}</div>
                            </div>
                            <div class="product-price">
                                $${kit.precioVentaUSD.toFixed(2)} USD<br>
                                <span class="price-detail">${priceBS.toFixed(2)} BS</span>
                            </div>
                        </div>
                        <div class="price-input-group">
                            <input type="number" id="qty-kit-${kit.key}" min="1" value="1" placeholder="Cantidad" ${stockDisp === 0 ? 'disabled' : ''} inputmode="decimal">
                            <button class="btn btn-primary btn-small" onclick="addKitToSale('${kit.key}')" ${stockDisp === 0 ? 'disabled title="Sin stock"' : ''}>
                                <i class="fas fa-plus"></i> ${stockDisp === 0 ? 'Sin stock' : 'Agregar'}
                            </button>
                        </div>
                    `;
                    container.appendChild(kitDiv);
                });
            }
            
            // Cargar lista de clientes en el select
            loadCustomerSelect();
        }

        function loadCustomerSelect() {
            // Poblar datalist para b√∫squeda r√°pida en m√≥vil
            const datalist = document.getElementById('customer-datalist');
            if (datalist) {
                datalist.innerHTML = '';
                const sortedClients = [...clientsData].sort((a, b) => a.name.localeCompare(b.name, 'es'));
                sortedClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.name;
                    datalist.appendChild(option);
                });
            }
        }

        function addToSale(productKey) {
            const quantityInput = document.getElementById(`qty-${productKey}`);
            let quantity = parseInt(quantityInput.value) || 0;
            
            // Si el campo est√° en 0 y se presiona el bot√≥n, sumar 1
            if (quantity === 0) {
                quantity = 1;
            }
            
            if (quantity < 1) {
                alert('La cantidad debe ser al menos 1');
                return;
            }
            
            const productInfo = getProductInfo(productKey);
            
            if (!productInfo) {
                alert('Error: Producto no encontrado');
                return;
            }
            
            if (!productInfo.name || productInfo.name === 'undefined') {
                alert('Error: El producto no est√° configurado correctamente');
                return;
            }
            
            const existingItem = currentSaleItems.find(item => item.productKey === productKey);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                currentSaleItems.push({
                    productKey: productKey,
                    name: productInfo.name,
                    priceUSD: productInfo.priceUSD,
                    priceBS: productInfo.priceBS,
                    quantity: quantity,
                    hasIva: productInfo.hasIva
                });
            }
            
            updateSaleDisplay();
            quantityInput.value = 0; // Reset to 0 after adding
        }

        function removeFromSale(index) {
            currentSaleItems.splice(index, 1);
            updateSaleDisplay();
        }

        function getProductInfo(productKey) {
            const productNames = {
                recarga_local: 'Recarga en Local',
                recarga_domicilio: 'Recarga a Domicilio',
                recarga_lejana: 'Recarga a Domicilio Lejana',
                empresas_mayor: 'Empresas Mayor de 12 unidades',
                botellon_nuevo: 'Botell√≥n Nuevo',
                hielo: 'Hielo',
                recarga_local_empresa: 'Recarga Local Empresa',
                dispensador: 'Dispensador de Agua'
            };
            
            const priceUSD = waterPrices[productKey]?.priceUSD || 0;
            const priceBS = priceUSD * priceExchangeRate;
            const hasIva = waterPrices[productKey]?.hasIva || false;
            
            return {
                name: productNames[productKey] || productKey,
                priceUSD: priceUSD,
                priceBS: priceBS,
                hasIva: hasIva
            };
        }

        // Alternar desglose fiscal
        function toggleFiscalBreakdown() {
            const documentType = document.getElementById('document-type').value;
            const fiscalDiv = document.getElementById('fiscal-breakdown');
            
            if (documentType === 'Factura') {
                fiscalDiv.style.display = 'block';
                calculateFiscalBreakdown();
            } else {
                fiscalDiv.style.display = 'none';
            }
        }
        
        // Calcular desglose fiscal
        function calculateFiscalBreakdown() {
            const documentType = document.getElementById('document-type').value;
            if (documentType !== 'Factura') return;

            const customerName = document.getElementById('customer-name').value;
            const client = clientsData.find(c => c.name === customerName);

            // IVA solo aplica en Factura
            let subtotalSinIva = 0;
            let ivaTotalBS    = 0;
            currentSaleItems.forEach(item => {
                const itemTotal = item.priceBS * item.quantity;
                const itemIva   = item.hasIva ? itemTotal * (ivaPercentage / 100) : 0;
                subtotalSinIva += itemTotal;
                ivaTotalBS     += itemIva;
            });
            const totalConIva = subtotalSinIva + ivaTotalBS;   // lo que el cliente debe antes de retenciones

            // ---- Retenciones (se calculan sobre la base sin IVA) ----
            let retencionIva  = 0;
            let retencionIslr = 0;
            if (client) {
                if (client.retieneIva)  retencionIva  = ivaTotalBS * 0.75;
                if (client.retieneIslr) retencionIslr = subtotalSinIva * 0.02;
            }
            const totalNeto = totalConIva - retencionIva - retencionIslr;

            // ---- Mostrar l√≠neas base ----
            document.getElementById('fiscal-subtotal').textContent   = subtotalSinIva.toFixed(2) + ' BS';
            document.getElementById('fiscal-iva').textContent        = ivaTotalBS.toFixed(2)     + ' BS';
            document.getElementById('fiscal-total-iva').textContent  = totalConIva.toFixed(2)    + ' BS';

            // ---- Secci√≥n retenciones ----
            const retencionesDiv = document.getElementById('fiscal-retenciones');
            if (retencionIva > 0 || retencionIslr > 0) {
                retencionesDiv.style.display = 'block';
                const rowIva  = document.getElementById('retencion-iva-label').parentElement;
                const rowIslr = document.getElementById('retencion-isr-label').parentElement;
                if (retencionIva > 0) {
                    document.getElementById('retencion-iva-label').textContent  = '- Retenci√≥n IVA (75%):';
                    document.getElementById('retencion-iva-amount').textContent = '-' + retencionIva.toFixed(2) + ' BS';
                    rowIva.style.display = 'flex';
                } else { rowIva.style.display = 'none'; }
                if (retencionIslr > 0) {
                    document.getElementById('retencion-isr-label').textContent  = '- Retenci√≥n ISLR (2%):';
                    document.getElementById('retencion-isr-amount').textContent = '-' + retencionIslr.toFixed(2) + ' BS';
                    rowIslr.style.display = 'flex';
                } else { rowIslr.style.display = 'none'; }
                document.getElementById('fiscal-neto').textContent = totalNeto.toFixed(2) + ' BS';
            } else {
                retencionesDiv.style.display = 'none';
            }

            // ---- Secci√≥n adelanto (visible con o sin retenciones) ----
            const useAdelanto   = document.getElementById('usar-adelanto').checked;
            const adelantoSection = document.getElementById('fiscal-adelanto-section');

            // Asegurar que fiscal-adelanto-section est√© fuera de fiscal-retenciones en el DOM
            // (se mueve una sola vez si es necesario)
            const fiscalGrid = document.querySelector('#fiscal-breakdown > div');
            if (adelantoSection.parentElement !== fiscalGrid) {
                fiscalGrid.appendChild(adelantoSection);
            }

            if (useAdelanto && customerName) {
                const totalDisponible = adelantosClientes
                    .filter(a => a.cliente === customerName && a.status === 'Activo' && a.saldo > 0)
                    .reduce((sum, a) => sum + a.saldo, 0);

                if (totalDisponible > 0) {
                    const montoAUsar  = Math.min(totalDisponible, totalNeto);
                    const totalFinal  = totalNeto - montoAUsar;
                    adelantoSection.style.display = 'block';
                    document.getElementById('fiscal-adelanto-usado').textContent  = '-' + montoAUsar.toFixed(2) + ' BS';
                    document.getElementById('fiscal-total-final').textContent     = totalFinal.toFixed(2) + ' BS';
                } else {
                    adelantoSection.style.display = 'none';
                }
            } else {
                adelantoSection.style.display = 'none';
            }
        }
        // ========== ADELANTOS EN VENTAS ==========
        
        // Verificar y mostrar adelanto del cliente
        function checkCustomerAdelanto() {
            const customerName = document.getElementById('customer-name').value;
            const adelantoPanel = document.getElementById('customer-adelanto-panel');
            
            if (!customerName) {
                adelantoPanel.style.display = 'none';
                return;
            }
            
            const adelantosDisponibles = adelantosClientes.filter(a => 
                a.cliente === customerName && 
                a.status === 'Activo' && 
                a.saldo > 0
            );
            
            const totalDisponible = adelantosDisponibles.reduce((sum, a) => sum + a.saldo, 0);
            
            if (totalDisponible > 0) {
                adelantoPanel.style.display = 'block';
                const totalDispUSD = adelantosDisponibles.reduce((sum, a) => sum + getAdelantoSaldoUSD(a), 0);
                document.getElementById('adelanto-saldo-disponible').textContent = fmtUSD(totalDispUSD) + ' USD';
                updateAdelantoUsage();
            } else {
                adelantoPanel.style.display = 'none';
            }
        }
        
        // Toggle uso de adelanto
        function toggleUseAdelanto() {
            const useAdelanto = document.getElementById('usar-adelanto').checked;
            const detailDiv = document.getElementById('adelanto-usage-detail');
            
            if (useAdelanto) {
                detailDiv.style.display = 'block';
                updateAdelantoUsage();
            } else {
                detailDiv.style.display = 'none';
            }
            
            calculateFiscalBreakdown();
        }
        
        // Actualizar c√°lculo de uso de adelanto
        function updateAdelantoUsage() {
            const customerName = document.getElementById('customer-name').value;
            const useAdelanto = document.getElementById('usar-adelanto').checked;
            
            if (!useAdelanto || !customerName) return;
            
            const totalDisponible = adelantosClientes
                .filter(a => a.cliente === customerName && a.status === 'Activo' && a.saldo > 0)
                .reduce((sum, a) => sum + a.saldo, 0);
            
            // documentType declarado ANTES de usarlo
            const documentType = document.getElementById('document-type').value;
            const aplicaIvaAdel = (documentType === 'Factura');

            let subtotalSinIva = 0;
            let ivaTotalBS = 0;
            currentSaleItems.forEach(item => {
                const itemTotal = item.priceBS * item.quantity;
                const itemIva   = (aplicaIvaAdel && item.hasIva) ? itemTotal * (ivaPercentage / 100) : 0;
                subtotalSinIva += itemTotal;
                ivaTotalBS     += itemIva;
            });
            const totalConIva = subtotalSinIva + ivaTotalBS;

            // Retenciones solo si es Factura
            const client = clientsData.find(c => c.name === customerName);
            let totalNeto = totalConIva;
            if (documentType === 'Factura' && client) {
                let retencionIva  = client.retieneIva  ? ivaTotalBS * 0.75       : 0;
                let retencionIslr = client.retieneIslr ? subtotalSinIva * 0.02   : 0;
                totalNeto = totalConIva - retencionIva - retencionIslr;
            }
            
            const montoAUsar = Math.min(totalDisponible, totalNeto);
            const saldoRestante = totalDisponible - montoAUsar;
            
            // Mostrar en USD
            const totalDispUSD = adelantosClientes
                .filter(a => a.cliente === customerName && a.status === 'Activo' && a.saldo > 0)
                .reduce((sum, a) => sum + getAdelantoSaldoUSD(a), 0);
            const proportion    = totalDisponible > 0 ? montoAUsar / totalDisponible : 0;
            const usadoUSD      = totalDispUSD * proportion;
            const restanteUSD   = totalDispUSD - usadoUSD;
            
            document.getElementById('adelanto-monto-usado').textContent    = fmtUSD(usadoUSD)    + ' USD';
            document.getElementById('adelanto-saldo-restante').textContent = fmtUSD(restanteUSD) + ' USD';
        }
        
        // ========== B2+: COMPRAS DESDE GASTOS (actualiza inventario) ==========

        let comprasItems = []; // √≠tems de la compra en curso

        function onExpenseCategoryChange() {
            const cat = document.getElementById('expense-category').value;
            
            // Panel Compras
            const panelCompras = document.getElementById('compras-inventario-panel');
            panelCompras.style.display = cat === 'Compras' ? 'block' : 'none';
            if (cat === 'Compras') {
                comprasItems = [];
                renderComprasItems();
                poblarCompraProductoSelect();
            }
            
            // Panel Cr√©dito
            const panelCredito = document.getElementById('credito-pago-panel');
            const camposNormales = document.getElementById('expense-campos-normales');
            const metodoPagoGroup = document.getElementById('expense-metodo-pago-group');
            
            if (cat === 'Cr√©dito') {
                panelCredito.style.display = 'block';
                camposNormales.style.display = 'none';
                metodoPagoGroup.style.display = 'none';
                poblarCreditoPrestamosSelect();
            } else {
                panelCredito.style.display = 'none';
                camposNormales.style.display = 'block';
                metodoPagoGroup.style.display = 'block';
            }
            
            // IVA: centralizado en actualizarIvaGastos()
            actualizarIvaGastos();
            
            // Panel Hielo
            checkHieloAdelanto();
        }

        // ‚îÄ‚îÄ Controla visibilidad del IVA en gastos seg√∫n categor√≠a Y tipo de documento ‚îÄ‚îÄ
        function actualizarIvaGastos() {
            const cat  = document.getElementById('expense-category')?.value || '';
            const doc  = document.getElementById('expense-document-type')?.value || '';
            const ivaGroup   = document.getElementById('expense-iva-group');
            const ivaDisplay = document.getElementById('expense-iva-display-group');
            const baseRow    = document.getElementById('expense-base-row');
            const hint       = document.getElementById('expense-iva-hint');
            const ivaInput   = document.getElementById('expense-iva');

            // IVA solo aplica si: categor√≠a no es Personal/Cr√©dito Y el documento es Factura
            const noIva = (cat === 'Personal' || cat === 'Cr√©dito' || doc !== 'Factura');

            if (noIva) {
                if (ivaGroup)   ivaGroup.style.display   = 'none';
                if (ivaDisplay) ivaDisplay.style.display = 'none';
                if (baseRow)    baseRow.style.display    = 'none';
                if (ivaInput)   ivaInput.value = 0;
                if (hint) {
                    if (cat === 'Personal')         hint.textContent = 'Salarios/sueldos no llevan IVA';
                    else if (cat === 'Cr√©dito')     hint.textContent = 'Pagos de cr√©dito no llevan IVA';
                    else if (doc !== 'Factura')     hint.textContent = 'Solo las facturas llevan IVA';
                }
            } else {
                if (ivaGroup)   ivaGroup.style.display   = 'block';
                if (ivaDisplay) ivaDisplay.style.display = 'block';
                if (baseRow)    baseRow.style.display    = 'block';
                if (ivaInput && parseFloat(ivaInput.value) === 0) ivaInput.value = 16;
                if (hint) hint.textContent = 'Rango: 12% - 16%';
            }
            calculateExpenseAmounts();
        }

        // Llamada cuando cambia el tipo de documento en gastos
        function onExpenseDocTypeChange() {
            actualizarIvaGastos();
        }
        function poblarCreditoPrestamosSelect() {
            const sel = document.getElementById('credito-prestamo-sel');
            if (!sel) return;
            const activos = prestamosData.filter(p => p.estado === 'activo');
            sel.innerHTML = '<option value="">- Seleccionar pr√©stamo activo -</option>';
            activos.forEach(p => {
                const pendiente = (p.saldoPendienteUSD || 0).toFixed(2);
                sel.innerHTML += `<option value="${p.id}">${p.prestamista} - $${pendiente} pendiente</option>`;
            });
            document.getElementById('credito-cuotas-panel').style.display = 'none';
            document.getElementById('credito-cuota-info').style.display = 'none';
            document.getElementById('credito-resumen').style.display = 'none';
        }

        function onCreditoPrestSelChange() {
            const prestId = document.getElementById('credito-prestamo-sel').value;
            const cuotasPanel = document.getElementById('credito-cuotas-panel');
            if (!prestId) { cuotasPanel.style.display = 'none'; return; }
            
            const p = prestamosData.find(x => x.id === prestId);
            if (!p) return;
            
            const cuotasSel = document.getElementById('credito-cuota-sel');
            cuotasSel.innerHTML = '<option value="">- Seleccionar cuota pendiente -</option>';
            
            const pendientes = (p.amortizacion || []).filter(c => c.estado !== 'pagado');
            pendientes.forEach(c => {
                const vencida    = c.vencimiento < new Date().toISOString().split('T')[0];
                const tag        = vencida ? ' ‚ö†Ô∏è VENCIDA' : '';
                const esParcial  = c.estado === 'parcial';
                const saldoReal  = esParcial && c.saldoPendienteUSD != null ? c.saldoPendienteUSD : c.cuotaUSD;
                const labelMonto = esParcial
                    ? `$${saldoReal.toFixed(2)} pendiente (de $${c.cuotaUSD.toFixed(2)}) ‚ö°`
                    : `$${c.cuotaUSD.toFixed(2)} USD`;
                cuotasSel.innerHTML += `<option value="${c.numero}">Cuota #${c.numero} - ${labelMonto} ¬∑ vence ${c.vencimiento}${tag}</option>`;
            });
            
            cuotasPanel.style.display = 'block';
            document.getElementById('credito-cuota-info').style.display = 'none';
            document.getElementById('credito-resumen').style.display = 'none';
            // Limpiar radios
            document.querySelectorAll('input[name="credito-tipo-pago"]').forEach(r => r.checked = false);
            document.getElementById('credito-monto-parcial-panel').style.display = 'none';
        }

        function onCreditoCuotaSelChange() {
            const prestId  = document.getElementById('credito-prestamo-sel').value;
            const nroCuota = parseInt(document.getElementById('credito-cuota-sel').value);
            const infoDiv  = document.getElementById('credito-cuota-info');
            if (!prestId || !nroCuota) { infoDiv.style.display = 'none'; return; }
            
            const p     = prestamosData.find(x => x.id === prestId);
            const cuota = p?.amortizacion?.find(c => c.numero === nroCuota);
            if (!cuota) return;
            
            const hoy    = new Date().toISOString().split('T')[0];
            const vencida = cuota.vencimiento < hoy;
            const diasDiff = Math.round((new Date(cuota.vencimiento) - new Date(hoy)) / 86400000);
            
            const esParcial   = cuota.estado === 'parcial';
            const saldoReal   = esParcial
                ? (cuota.saldoPendienteUSD != null ? cuota.saldoPendienteUSD : cuota.cuotaUSD)
                : cuota.cuotaUSD;
            const abonado     = cuota.montoPagadoUSD || 0;

            infoDiv.style.display = 'block';
            infoDiv.innerHTML = `
                <div style="font-weight:700; margin-bottom:8px; color:#283593;">üìã Cuota #${cuota.numero} de ${p.plazoMeses}</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:14px;">
                    <div>üí∞ Capital: <strong>$${cuota.capitalUSD.toFixed(2)}</strong></div>
                    <div>üìà Inter√©s: <strong>$${cuota.interesUSD.toFixed(2)}</strong></div>
                    <div>üìÖ Vencimiento: <strong>${cuota.vencimiento}</strong></div>
                    <div>${vencida
                        ? `<span style="color:#f44336;">‚ö†Ô∏è Vencida hace ${Math.abs(diasDiff)} d√≠as</span>`
                        : `<span style="color:#4caf50;">‚úÖ Vence en ${diasDiff} d√≠as</span>`}</div>
                </div>
                ${esParcial ? `
                <div style="margin-top:8px; padding:8px; background:#fff3e0; border-radius:6px; font-size:13px;">
                    <div>‚ö° Abono anterior: <strong style="color:#388e3c;">$${abonado.toFixed(2)} USD</strong></div>
                    <div>üìã Cuota original: $${cuota.cuotaUSD.toFixed(2)} USD</div>
                </div>` : ''}
                <div style="margin-top:10px; font-size:18px; font-weight:700; color:${esParcial ? '#c62828' : '#1565c0'}; border-top:1px solid #c5cae9; padding-top:8px;">
                    ${esParcial ? 'üî¥ Saldo pendiente' : 'Total cuota'}: $${saldoReal.toFixed(2)} USD
                </div>
            `;
            // Guardar saldo real para validaciones
            infoDiv.dataset.saldoReal   = saldoReal;
            infoDiv.dataset.esParcial   = esParcial ? '1' : '0';
            
            // Reset tipo pago
            document.querySelectorAll('input[name="credito-tipo-pago"]').forEach(r => r.checked = false);
            document.getElementById('credito-monto-parcial-panel').style.display = 'none';
            document.getElementById('credito-resumen').style.display = 'none';
        }

        function onCreditoTipoPagoChange() {
            const tipo = document.querySelector('input[name="credito-tipo-pago"]:checked')?.value;
            const parcialPanel = document.getElementById('credito-monto-parcial-panel');
            const resumen = document.getElementById('credito-resumen');
            
            if (tipo === 'parcial') {
                parcialPanel.style.display = 'block';
                resumen.style.display = 'none';
                document.getElementById('credito-monto-parcial').value = '';
                document.getElementById('credito-parcial-hint').textContent = '';
            } else if (tipo === 'completo') {
                parcialPanel.style.display = 'none';
                actualizarResumenCredito();
            }
        }

        function onCreditoMontoParcialInput() {
            actualizarResumenCredito();
        }

        function actualizarResumenCredito() {
            const tipo    = document.querySelector('input[name="credito-tipo-pago"]:checked')?.value;
            if (!tipo) return;
            
            const prestId  = document.getElementById('credito-prestamo-sel').value;
            const nroCuota = parseInt(document.getElementById('credito-cuota-sel').value);
            if (!prestId || !nroCuota) return;
            
            const p     = prestamosData.find(x => x.id === prestId);
            const cuota = p?.amortizacion?.find(c => c.numero === nroCuota);
            if (!cuota) return;

            // Usar saldo pendiente real (si ya tuvo abonos parciales)
            const esParcial  = cuota.estado === 'parcial';
            const saldoReal  = esParcial
                ? (cuota.saldoPendienteUSD != null ? cuota.saldoPendienteUSD : cuota.cuotaUSD)
                : cuota.cuotaUSD;
            const abonado    = cuota.montoPagadoUSD || 0;

            const resumen = document.getElementById('credito-resumen');
            
            if (tipo === 'completo') {
                resumen.style.display = 'block';
                resumen.innerHTML = `
                    <div style="font-weight:700; color:#2e7d32; margin-bottom:6px;">‚úÖ Pago ${esParcial ? 'del Saldo Pendiente' : 'Completo'}</div>
                    ${esParcial ? `<div style="font-size:12px; color:#888;">Abono anterior: $${abonado.toFixed(2)} USD</div>` : ''}
                    <div>Monto a pagar: <strong>$${saldoReal.toFixed(2)} USD</strong></div>
                    <div style="font-size:12px; color:#555; margin-top:4px;">La cuota #${cuota.numero} quedar√° marcada como <strong>PAGADA</strong>.</div>
                `;
            } else {
                const montoPagado = parseFloat(document.getElementById('credito-monto-parcial').value) || 0;
                const hint = document.getElementById('credito-parcial-hint');
                
                if (montoPagado <= 0) {
                    resumen.style.display = 'none';
                    hint.textContent = 'Ingresa el monto pagado';
                    return;
                }
                // Validar contra saldo real, no contra cuotaUSD completa
                if (montoPagado >= saldoReal) {
                    hint.textContent = `‚ö†Ô∏è El monto ($${montoPagado.toFixed(2)}) iguala o supera el saldo pendiente ($${saldoReal.toFixed(2)}). Usa "Pago Completo del Saldo".`;
                    resumen.style.display = 'none';
                    return;
                }
                hint.textContent = '';
                const saldoNuevo = saldoReal - montoPagado;
                resumen.style.display = 'block';
                resumen.innerHTML = `
                    <div style="font-weight:700; color:#e65100; margin-bottom:6px;">‚ö° Pago Parcial</div>
                    <div>Pagado ahora: <strong>$${montoPagado.toFixed(2)} USD</strong></div>
                    <div>Saldo pendiente cuota: <strong style="color:#f44336;">$${saldoNuevo.toFixed(2)} USD</strong></div>
                    <div style="font-size:12px; color:#555; margin-top:4px;">Podr√°s abonar el resto en un nuevo gasto.</div>
                `;
            }
        }

        function poblarCompraProductoSelect() {
            const sel = document.getElementById('compra-producto-sel');
            if (!sel) return;
            // Productos del inventario existentes + opci√≥n de crear nuevo
            const options = inventoryData.map(item =>
                `<option value="${item.productoKey}" data-costo="${item.costoPromedioUSD || 0}">${item.nombre}</option>`
            ).join('');
            sel.innerHTML = '<option value="">Seleccionar producto de inventario‚Ä¶</option>' + options +
                '<option value="__nuevo__">‚ûï Nuevo producto (agregar al inventario)</option>';
        }

        function onCompraProductoChange() {
            const sel = document.getElementById('compra-producto-sel');
            const val = sel.value;
            if (val === '__nuevo__') {
                // Abre modal de nuevo producto de inventario y al cerrar recarga el select
                showInvProductModal();
                // Escuchar cuando se cierre el modal para repoblar select
                const observer = new MutationObserver(() => {
                    if (document.getElementById('inv-product-modal').style.display === 'none') {
                        poblarCompraProductoSelect();
                        observer.disconnect();
                    }
                });
                observer.observe(document.getElementById('inv-product-modal'), { attributes: true, attributeFilter: ['style'] });
                sel.value = '';
                return;
            }
            // Pre-llenar costo con el costo promedio actual del producto
            const item = inventoryData.find(i => i.productoKey === val);
            if (item && item.costoPromedioUSD > 0) {
                document.getElementById('compra-costo-unit').value = item.costoPromedioUSD.toFixed(2);
            }
            updateCompraSubtotal();
        }

        function updateCompraSubtotal() {
            const cant  = parseFloat(document.getElementById('compra-cantidad').value) || 0;
            const costo = parseFloat(document.getElementById('compra-costo-unit').value) || 0;
            const sub   = cant * costo;
            document.getElementById('compra-subtotal-preview').textContent = 'Subtotal: $' + sub.toFixed(2) + ' USD';
        }

        function agregarItemCompra() {
            const sel   = document.getElementById('compra-producto-sel');
            const key   = sel.value;
            const cant  = parseInt(document.getElementById('compra-cantidad').value) || 0;
            const costo = parseFloat(document.getElementById('compra-costo-unit').value) || 0;

            if (!key || key === '__nuevo__') { alert('Selecciona un producto de inventario'); return; }
            if (cant <= 0)  { alert('La cantidad debe ser mayor a 0'); return; }
            if (costo <= 0) { alert('El costo unitario debe ser mayor a 0'); return; }

            const item = inventoryData.find(i => i.productoKey === key);
            if (!item) { alert('Producto no encontrado en inventario'); return; }

            // Si ya est√° en la lista, actualizar con costo promedio ponderado
            const existing = comprasItems.find(i => i.productoKey === key);
            if (existing) {
                const costoPromPonderado = ((existing.cantidad * existing.costoUnitarioUSD) + (cant * costo)) / (existing.cantidad + cant);
                existing.cantidad        += cant;
                existing.costoUnitarioUSD = parseFloat(costoPromPonderado.toFixed(4));
                existing.subtotalUSD      = existing.cantidad * existing.costoUnitarioUSD;
            } else {
                comprasItems.push({
                    productoKey:    key,
                    nombre:         item.nombre,
                    cantidad:       cant,
                    costoUnitarioUSD: costo,
                    subtotalUSD:    cant * costo
                });
            }

            renderComprasItems();
            // Limpiar campos
            sel.value = '';
            document.getElementById('compra-cantidad').value = '1';
            document.getElementById('compra-costo-unit').value = '0';
            document.getElementById('compra-subtotal-preview').textContent = 'Subtotal: $0.00 USD';
        }

        function eliminarItemCompra(idx) {
            comprasItems.splice(idx, 1);
            renderComprasItems();
        }

        function renderComprasItems() {
            const container = document.getElementById('compras-items-container');
            const listDiv   = document.getElementById('compras-items-list');
            const totalEl   = document.getElementById('compras-total-usd');

            if (comprasItems.length === 0) {
                listDiv.style.display = 'none';
                totalEl.textContent   = '$0.00 USD';
                return;
            }
            listDiv.style.display = 'block';
            const total = comprasItems.reduce((s, i) => s + i.subtotalUSD, 0);
            totalEl.textContent = '$' + total.toFixed(2) + ' USD';

            container.innerHTML = comprasItems.map((item, idx) => `
                <div style="display:flex; justify-content:space-between; align-items:center; background:white; border-radius:6px; padding:8px 12px; margin-bottom:6px; font-size:13px;">
                    <div>
                        <strong>${item.nombre}</strong>
                        <span style="color:#666;"> - ${item.cantidad} u √ó $${item.costoUnitarioUSD.toFixed(2)}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <strong style="color:#2e7d32;">$${item.subtotalUSD.toFixed(2)}</strong>
                        <span onclick="eliminarItemCompra(${idx})" style="cursor:pointer; color:#f44336; font-size:16px;">‚úï</span>
                    </div>
                </div>`).join('');
        }

        // Actualizar inventario cuando se guarda un gasto de categor√≠a Compras
        function procesarComprasEnInventario(expenseId, expenseDate) {
            if (comprasItems.length === 0) return;
            comprasItems.forEach(item => {
                const idx = inventoryData.findIndex(i => i.productoKey === item.productoKey);
                if (idx === -1) return;
                const inv        = inventoryData[idx];
                const stockAnt   = inv.stockActual;

                // Costo promedio ponderado (PEPS)
                const costoTotalAnt   = (inv.costoPromedioUSD || 0) * stockAnt;
                const costoTotalNuevo = item.costoUnitarioUSD * item.cantidad;
                const nuevoStock      = stockAnt + item.cantidad;
                inv.costoPromedioUSD  = nuevoStock > 0 ? (costoTotalAnt + costoTotalNuevo) / nuevoStock : item.costoUnitarioUSD;

                inv.stockActual    = nuevoStock;
                inv.totalCompras   = (inv.totalCompras || 0) + item.cantidad;
                inv.ultimaCompra   = expenseDate;
                inv.diasSinMovimiento = 0;
                const est          = calcularEstadoInventario(inv);
                inv.estado         = est.estado;
                inv.requiereAlerta = est.estado !== 'normal';
                inv.modificadoEn   = new Date().toISOString();

                registrarMovimiento(
                    item.productoKey, 'compra', item.cantidad,
                    stockAnt, nuevoStock,
                    `Gasto #${expenseId} - $${item.costoUnitarioUSD.toFixed(2)}/u`
                );
            });
            saveInventory();
            loadInventoryList();
            loadMovimientosHistorial();
        }

        // ========== ADELANTOS EN GASTOS (HIELO) ==========
        
        // Verificar y mostrar adelanto de hielo
        function checkHieloAdelanto() {
            const category = document.getElementById('expense-category').value;
            const adelantoPanel = document.getElementById('hielo-adelanto-panel');
            
            if (category !== 'Hielo') {
                adelantoPanel.style.display = 'none';
                document.getElementById('usar-adelanto-hielo').checked = false;
                document.getElementById('hielo-usage-detail').style.display = 'none';
                return;
            }
            
            const adelantosDisponibles = adelantosHielo.filter(a =>
                a.status === 'Activo' && getHieloSaldoUSD(a) > 0.001
            );
            
            const totalDispUSD = adelantosDisponibles.reduce((sum, a) => sum + getHieloSaldoUSD(a), 0);
            
            if (totalDispUSD > 0) {
                adelantoPanel.style.display = 'block';
                document.getElementById('hielo-saldo-disponible').textContent = fmtUSD(totalDispUSD) + ' USD';
                updateHieloAdelantoUsage();
            } else {
                adelantoPanel.style.display = 'none';
            }
        }
        
        // Toggle uso de adelanto de hielo
        function toggleUseAdelantoHielo() {
            const useAdelanto = document.getElementById('usar-adelanto-hielo').checked;
            const detailDiv = document.getElementById('hielo-usage-detail');
            
            if (useAdelanto) {
                detailDiv.style.display = 'block';
                updateHieloAdelantoUsage();
            } else {
                detailDiv.style.display = 'none';
            }
        }
        
        // Actualizar c√°lculo de uso de adelanto de hielo
        function updateHieloAdelantoUsage() {
            const useAdelanto = document.getElementById('usar-adelanto-hielo').checked;
            const amountUSD   = parseFloat(document.getElementById('expense-amount').value) || 0;

            if (!useAdelanto || amountUSD <= 0) return;

            // Todo en USD - saldoDisponibleUSD es la unidad correcta
            const adelantosDisponibles = adelantosHielo.filter(a =>
                a.status === 'Activo' && getHieloSaldoUSD(a) > 0.001
            );

            const totalDispUSD  = adelantosDisponibles.reduce((sum, a) => sum + getHieloSaldoUSD(a), 0);
            const montoAUsarUSD = Math.min(totalDispUSD, amountUSD);
            const restanteUSD   = totalDispUSD - montoAUsarUSD;
            // Diferencia: lo que el usuario debe pagar en efectivo despu√©s de aplicar el adelanto
            const diferenciaUSD = Math.max(0, amountUSD - totalDispUSD);

            document.getElementById('hielo-monto-usado').textContent    = fmtUSD(montoAUsarUSD) + ' USD';
            document.getElementById('hielo-saldo-restante').textContent = fmtUSD(restanteUSD)   + ' USD';

            // Mostrar fila de diferencia solo si hay monto pendiente a pagar
            const difRow = document.getElementById('hielo-diferencia-row');
            if (difRow) {
                if (diferenciaUSD > 0.005) {
                    difRow.style.display = 'flex';
                    document.getElementById('hielo-diferencia').textContent = fmtUSD(diferenciaUSD) + ' USD';
                } else {
                    difRow.style.display = 'none';
                }
            }
        }
        
        function updateSaleDisplay() {
            const container = document.getElementById('sale-items');
            const totalContainer = document.getElementById('sale-total');
            
            if (currentSaleItems.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">No hay productos agregados</div>';
                totalContainer.style.display = 'none';
                return;
            }
            
            // IVA solo aplica si el tipo de documento es Factura
            const documentType = document.getElementById('document-type').value;
            const aplicaIva = (documentType === 'Factura');

            container.innerHTML = '';
            let subtotalBS = 0;
            let ivaTotalBS = 0;
            
            currentSaleItems.forEach((item, index) => {
                if (!item.name || item.priceBS === undefined || item.quantity === undefined) {
                    console.error('Item inv√°lido:', item);
                    return;
                }
                
                const itemTotalBS = item.priceBS * item.quantity;
                // IVA solo si es Factura Y el producto tiene IVA
                const itemIvaBS = (aplicaIva && item.hasIva) ? itemTotalBS * (ivaPercentage / 100) : 0;
                
                subtotalBS += itemTotalBS;
                ivaTotalBS += itemIvaBS;
                
                // Badge IVA solo se muestra cuando aplica
                const ivaBadge = (item.hasIva && aplicaIva)
                    ? '<span class="iva-badge">+IVA</span>'
                    : (item.hasIva && !aplicaIva)
                        ? '<span class="iva-badge" style="background:#9e9e9e;" title="Sin IVA en Nota de Entrega">sin IVA</span>'
                        : '';

                const itemDiv = document.createElement('div');
                itemDiv.className = 'sale-item';
                itemDiv.innerHTML = `
                    <div>
                        <strong>${item.name}</strong> ${ivaBadge}<br>
                        <small>${item.quantity} x ${item.priceBS.toFixed(2)} BS = ${itemTotalBS.toFixed(2)} BS</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <strong>${(itemTotalBS + itemIvaBS).toFixed(2)} BS</strong>
                        <span class="remove-item" onclick="removeFromSale(${index})">
                            <i class="fas fa-times"></i>
                        </span>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
            
            const totalBS = subtotalBS + ivaTotalBS;
            const totalUSD = convertBStoUSD(totalBS);
            
            document.getElementById('subtotal-amount').textContent = subtotalBS.toFixed(2) + ' BS';
            document.getElementById('iva-amount').textContent = ivaTotalBS.toFixed(2) + ' BS';
            document.getElementById('total-amount').textContent = totalBS.toFixed(2) + ' BS';
            document.getElementById('total-usd').textContent = totalUSD.toFixed(2) + ' USD';
            document.getElementById('iva-percentage-display').textContent = aplicaIva ? ivaPercentage : '0 (N/A)';
            
            totalContainer.style.display = 'block';
            
            // Actualizar desglose fiscal si est√° visible
            calculateFiscalBreakdown();
            
            // Verificar adelantos del cliente
            checkCustomerAdelanto();
        }

        function saveSale() {
            if (currentSaleItems.length === 0) {
                alert('Agrega al menos un producto a la venta');
                return;
            }
            
            const customer = document.getElementById('customer-name').value;
            const paymentMethod = document.getElementById('payment-method').value;
            const documentType = document.getElementById('document-type').value;
            const notes = document.getElementById('sale-notes').value;
            
            if (!customer || !paymentMethod || !documentType) {
                alert('Completa todos los campos obligatorios');
                return;
            }
            
            const client = clientsData.find(c => c.name === customer);
            
            // B1: Validar cr√©dito si el m√©todo de pago es Cr√©dito
            if (paymentMethod === 'Cr√©dito') {
                if (client && !client.permiteCredito) {
                    alert(`‚ö†Ô∏è El cliente "${customer}" no tiene cr√©dito habilitado.\n\nPuedes habilitarlo en la secci√≥n Clientes ‚Üí Editar ‚Üí Condiciones de Cr√©dito.`);
                    return;
                }
                // Verificar cr√©ditos vencidos del cliente
                const creditosVencidos = creditsData.filter(c => {
                    if (c.customer !== customer || c.status === 'Pagado') return false;
                    const estado = calcularEstadoCredito(c);
                    return estado.estado === 'vencido';
                });
                if (creditosVencidos.length > 0) {
                    const totalVencido = creditosVencidos.reduce((sum, c) => sum + c.balance, 0);
                    const confirmar = confirm(`‚ö†Ô∏è El cliente "${customer}" tiene ${creditosVencidos.length} cr√©dito(s) VENCIDO(S) por un total de ${totalVencido.toFixed(2)} BS.\n\n¬øDeseas continuar con la venta a cr√©dito de todas formas?`);
                    if (!confirmar) return;
                }
            }
            let subtotalBS = 0;
            let ivaTotalBS = 0;
            
            // IVA solo aplica si el tipo de documento es Factura
            const aplicaIva = (documentType === 'Factura');

            currentSaleItems.forEach(item => {
                const itemTotalBS = item.priceBS * item.quantity;
                const itemIvaBS = (aplicaIva && item.hasIva) ? itemTotalBS * (ivaPercentage / 100) : 0;
                subtotalBS += itemTotalBS;
                ivaTotalBS += itemIvaBS;
            });
            
            const totalBS = subtotalBS + ivaTotalBS;
            
            // Calcular retenciones si es Factura
            let retencionIva = 0;
            let retencionIslr = 0;
            let totalNeto = totalBS;
            
            if (documentType === 'Factura' && client) {
                // Usar los valores reales calculados √≠tem por √≠tem (no dividir por 1.16)
                if (client.retieneIva) {
                    retencionIva  = ivaTotalBS * 0.75;        // 75% del IVA real
                }
                if (client.retieneIslr) {
                    retencionIslr = subtotalBS * 0.02;        // 2% sobre la base sin IVA
                }
                totalNeto = totalBS - retencionIva - retencionIslr;
            }
            
            const sale = {
                id: Date.now(),
                date: document.getElementById('sale-date').value,
                customer: customer,
                customerRif: client ? client.rif : '',
                items: JSON.parse(JSON.stringify(currentSaleItems)),
                subtotal: subtotalBS,
                iva: ivaTotalBS,
                total: totalBS,
                totalUSD: convertBStoUSD(totalBS),
                paymentMethod: paymentMethod,
                documentType: documentType,
                retencionIva: retencionIva,
                retencionIslr: retencionIslr,
                totalNeto: totalNeto,
                notes: notes
            };
            
            salesData.unshift(sale);
            localStorage.setItem('salesData', JSON.stringify(salesData));
            
            // Descontar de adelanto si est√° marcado
            const useAdelanto = document.getElementById('usar-adelanto').checked;
            if (useAdelanto) {
                const montoADescontar = Math.min(
                    adelantosClientes.filter(a => a.cliente === customer && a.status === 'Activo' && a.saldo > 0)
                        .reduce((sum, a) => sum + a.saldo, 0),
                    totalNeto
                );
                
                if (montoADescontar > 0) {
                    let restante = montoADescontar;
                    
                    for (const adelanto of adelantosClientes) {
                        if (adelanto.cliente === customer && adelanto.status === 'Activo' && adelanto.saldo > 0 && restante > 0) {
                            const aUsar = Math.min(adelanto.saldo, restante);
                            
                            adelanto.saldo -= aUsar;
                            adelanto.usado += aUsar;
                            
                            if (adelanto.saldo <= 0) {
                                adelanto.status = 'Agotado';
                            }
                            
                            if (!adelanto.usos) adelanto.usos = [];
                            adelanto.usos.push({
                                fecha: sale.date,
                                monto: aUsar,
                                concepto: `Venta #${sale.id}`,
                                saldoRestante: adelanto.saldo
                            });
                            
                            restante -= aUsar;
                        }
                    }
                    
                    sale.adelantoUsado = montoADescontar;
                    sale.adelantoSaldoAntes = montoADescontar + adelantosClientes
                        .filter(a => a.cliente === customer && a.status === 'Activo')
                        .reduce((sum, a) => sum + a.saldo, 0);
                    
                    localStorage.setItem('adelantosClientes', JSON.stringify(adelantosClientes));
                    loadAdelantosClientesList();
                }
            }
            
            if (paymentMethod === 'Cr√©dito') {
                // Redondear totalNeto a 2 decimales para evitar problemas
                const creditAmount = parseFloat(totalNeto.toFixed(2));
                // Base fija en USD: usar totalUSD de la venta (ya calculado con tasa del d√≠a de venta)
                // Si la venta tiene retenciones, la base USD es proporcional al totalNeto/totalBS
                const _totalUSDBase = parseFloat(convertBStoUSD(totalBS).toFixed(2));
                const _netoRatio    = totalBS > 0 ? totalNeto / totalBS : 1;
                const creditAmountUSD = parseFloat((_totalUSDBase * _netoRatio).toFixed(2));
                
                // B1: Calcular fecha de vencimiento seg√∫n cliente
                const clienteData = clientsData.find(c => c.name === customer);
                let fechaVencimiento = null;
                let diasAlertaAntes = 3;
                let diasCredito = null;
                
                if (clienteData && clienteData.permiteCredito) {
                    diasCredito = clienteData.diasCredito || 30;
                    diasAlertaAntes = clienteData.diasAlertaAntes || 3;
                    const fechaBase = new Date(sale.date + 'T00:00:00');
                    fechaBase.setDate(fechaBase.getDate() + diasCredito);
                    fechaVencimiento = fechaBase.toISOString().split('T')[0];
                }
                
                const credit = {
                    id: sale.id,
                    customer: sale.customer,
                    date: sale.date,
                    amount: creditAmount,       // legacy BS
                    amountUSD: creditAmountUSD, // base fija en USD - nunca cambia
                    paid: 0,
                    paidUSD: 0,                 // total abonado en USD
                    balance: creditAmount,
                    balanceUSD: creditAmountUSD, // saldo pendiente en USD
                    status: 'Pendiente',
                    payments: [],
                    // B1: Vencimiento y alertas
                    fechaVencimiento: fechaVencimiento,
                    diasCredito: diasCredito,
                    diasAlertaAntes: diasAlertaAntes
                };
                creditsData.unshift(credit);
                localStorage.setItem('creditsData', JSON.stringify(creditsData));
                loadPendingCredits();
                loadCreditReportClients();
                loadSalesReportClients();
            }
            
            // B2: Descontar stock del inventario vinculado
            integrarInventarioConVenta(sale.items, sale.id, sale.date);
            
            alert('‚úÖ Venta registrada exitosamente!');
            
            // Limpiar formulario completo
            currentSaleItems = [];
            document.getElementById('customer-name').value = '';
            document.getElementById('payment-method').value = '';
            document.getElementById('document-type').value = '';
            document.getElementById('sale-notes').value = '';
            document.getElementById('fiscal-breakdown').style.display = 'none';
            document.getElementById('customer-adelanto-panel').style.display = 'none';
            document.getElementById('usar-adelanto').checked = false;
            document.getElementById('adelanto-usage-detail').style.display = 'none';
            updateSaleDisplay();
            
            loadDashboard();
            loadEcuadorView();
            loadSalesHistory();
            loadRecentSales();
            loadInventoryList();  // B2: refrescar inventario
        }

        // ========== DASHBOARD Y REPORTES ==========
        function loadDashboard() {
            const today = new Date().toISOString().split('T')[0];

            const todaySales      = salesData.filter(sale => sale.date === today);
            const todaySalesCount = todaySales.reduce((sum, sale) =>
                sum + sale.items.reduce((s, item) => s + item.quantity, 0), 0);

            // Ingresos en USD - usar totalUSD si existe, sino convertir desde BS
            const todayIncomeUSD = todaySales.reduce((sum, sale) => {
                if (sale.totalUSD != null) return sum + (parseFloat(sale.totalUSD) || 0);
                return sum + convertBStoUSD(sale.total || 0);
            }, 0);

            // Gastos en USD
            const todayExpensesUSD = expensesData
                .filter(e => e.date === today)
                .reduce((sum, e) => {
                    if (e.amountUSD != null) return sum + (parseFloat(e.amountUSD) || 0);
                    return sum + convertBStoUSD(e.amount || 0);
                }, 0);

            const dailyBalanceUSD = todayIncomeUSD - todayExpensesUSD;

            document.getElementById('today-sales').textContent    = todaySalesCount;
            document.getElementById('today-income').textContent   = '$' + todayIncomeUSD.toFixed(2);
            document.getElementById('today-expenses').textContent = '$' + todayExpensesUSD.toFixed(2);

            const balEl = document.getElementById('daily-balance');
            balEl.textContent = '$' + dailyBalanceUSD.toFixed(2);
            balEl.style.color = dailyBalanceUSD >= 0 ? '#2e7d32' : '#f44336';

            // ---- META DE VENTA DIARIA ----
            const META_USD = 30;
            actualizarMetaDiaria(todayIncomeUSD, META_USD);

            // ---- Alertas de inventario ----
            const invAlertas = getInventarioAlertas();
            const agotados   = invAlertas.filter(a => a.tipo === 'agotado');
            const stockBajo  = invAlertas.filter(a => a.tipo === 'stock_bajo');
            let dashInvAlert = document.getElementById('dashboard-inv-alert');
            if (!dashInvAlert) {
                dashInvAlert = document.createElement('div');
                dashInvAlert.id = 'dashboard-inv-alert';
                dashInvAlert.style.cssText = 'margin-top:10px; padding:10px 15px; border-radius:8px; font-size:13px; cursor:pointer;';
                dashInvAlert.onclick = () => { showTab('inventory'); };
                const statsContainer = document.querySelector('#dashboard .stats-container');
                if (statsContainer) statsContainer.after(dashInvAlert);
            }
            if (invAlertas.length > 0) {
                const msgs = [];
                if (agotados.length)  msgs.push(`üî¥ ${agotados.length} agotado${agotados.length>1?'s':''}`);
                if (stockBajo.length) msgs.push(`üü° ${stockBajo.length} stock bajo`);
                dashInvAlert.style.display    = 'block';
                dashInvAlert.style.background = agotados.length ? 'rgba(244,67,54,0.1)' : 'rgba(255,152,0,0.1)';
                dashInvAlert.style.border     = `1px solid ${agotados.length ? '#f44336' : '#ff9800'}`;
                dashInvAlert.innerHTML = `‚ö†Ô∏è Inventario: ${msgs.join(' | ')} - <u>Ver inventario</u>`;
            } else {
                dashInvAlert.style.display = 'none';
            }
        }

        // ---- Meta de venta diaria ----
        function actualizarMetaDiaria(incomeUSD, metaUSD) {
            const card    = document.getElementById('meta-diaria-card');
            const barra   = document.getElementById('meta-barra');
            const pctEl   = document.getElementById('meta-pct-label');
            const usdEl   = document.getElementById('meta-progreso-usd');
            const descEl  = document.getElementById('meta-desc-texto');
            const badgeEl = document.getElementById('meta-badge');
            const lbl1    = document.getElementById('meta-objetivo-label');
            const lbl2    = document.getElementById('meta-objetivo-label2');
            if (!card) return;

            const pct = Math.min((incomeUSD / metaUSD) * 100, 100);
            const raw = (incomeUSD / metaUSD) * 100;  // sin l√≠mite para mostrar superaci√≥n

            // Labels fijos
            if (lbl1) lbl1.textContent = '$' + metaUSD.toFixed(2);
            if (lbl2) lbl2.textContent = '$' + metaUSD;

            usdEl.textContent  = '$' + incomeUSD.toFixed(2);
            pctEl.textContent  = Math.round(raw) + '%';
            barra.style.width  = pct + '%';

            // ---- Escala de color y badge seg√∫n % alcanzado ----
            let color, borderColor, bgCard, badge, desc;

            if (raw === 0) {
                color = '#9e9e9e'; borderColor = '#9e9e9e'; bgCard = 'white';
                badge = 'üí§'; desc = 'Sin ventas por el momento';
            } else if (raw < 25) {
                color = '#ef9a9a'; borderColor = '#ef5350'; bgCard = 'white';
                badge = 'üå±'; desc = `Faltan $${(metaUSD - incomeUSD).toFixed(2)} para la meta`;
            } else if (raw < 50) {
                color = '#ffb74d'; borderColor = '#ff9800'; bgCard = 'white';
                badge = 'üî•'; desc = `Buen comienzo - faltan $${(metaUSD - incomeUSD).toFixed(2)}`;
            } else if (raw < 75) {
                color = '#ffd54f'; borderColor = '#ffc107'; bgCard = '#fffde7';
                badge = '‚ö°'; desc = `M√°s de la mitad - ¬°sigue as√≠!`;
            } else if (raw < 100) {
                color = '#81c784'; borderColor = '#4caf50'; bgCard = '#f1f8e9';
                badge = 'üöÄ'; desc = `¬°Casi! Faltan $${(metaUSD - incomeUSD).toFixed(2)}`;
            } else if (raw < 150) {
                color = '#4caf50'; borderColor = '#2e7d32'; bgCard = '#e8f5e9';
                badge = 'üèÜ'; desc = `¬°Meta alcanzada! +$${(incomeUSD - metaUSD).toFixed(2)} extra`;
            } else {
                color = '#7b1fa2'; borderColor = '#9c27b0'; bgCard = '#f3e5f5';
                badge = 'üåü'; desc = `¬°Excepcional! ${Math.round(raw)}% de la meta`;
            }

            barra.style.background    = color;
            usdEl.style.color         = color;
            pctEl.style.color         = borderColor;
            card.style.borderLeftColor = borderColor;
            card.style.background     = bgCard;
            badgeEl.textContent       = badge;
            descEl.textContent        = desc;
        }

        function loadRecentSales() {
            const tbody = document.getElementById('recent-sales');
            tbody.innerHTML = '';
            
            const recentSales = salesData.slice(0, 5);
            
            if (recentSales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #6c757d;">
                            No hay ventas registradas
                        </td>
                    </tr>
                `;
                return;
            }
            
            recentSales.forEach(sale => {
                const productsSummary = sale.items.map(item => 
                    `${item.quantity} ${item.name}`
                ).join(', ');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(sale.date)}</td>
                    <td>${sale.customer}</td>
                    <td>${productsSummary}</td>
                    <td>$${(sale.totalUSD != null ? parseFloat(sale.totalUSD) : convertBStoUSD(sale.total || 0)).toFixed(2)} USD</td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadSalesHistory() {
            const tbody = document.getElementById('sales-history');
            const filterSelect = document.getElementById('filter-sales-client');
            tbody.innerHTML = '';
            
            // Cargar clientes en el filtro
            if (filterSelect && filterSelect.options.length === 1) {
                const uniqueClients = [...new Set(salesData.map(s => s.customer))].sort();
                uniqueClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client;
                    option.textContent = client;
                    filterSelect.appendChild(option);
                });
            }
            
            if (salesData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #6c757d;">
                            No hay ventas registradas
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Obtener filtro
            const selectedClient = filterSelect ? filterSelect.value : '';
            
            // Filtrar ventas
            const filteredSales = selectedClient 
                ? salesData.filter(s => s.customer === selectedClient)
                : salesData;
            
            if (filteredSales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #6c757d;">
                            No hay ventas para este cliente
                        </td>
                    </tr>
                `;
                return;
            }
            
            const mostrarTodas = tbody.dataset.showAll === '1';
            const ventasVis = mostrarTodas ? filteredSales : filteredSales.slice(0, 10);
            ventasVis.forEach(sale => {
                const productsSummary = sale.items.map(item => 
                    `${item.quantity} ${item.name}`
                ).join(', ');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(sale.date)}</td>
                    <td>${sale.customer}</td>
                    <td>${productsSummary}</td>
                    <td>${sale.total.toFixed(2)} BS</td>
                    <td>$${sale.totalUSD.toFixed(2)} USD</td>
                    <td>${sale.paymentMethod}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editSale('${sale.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteSale('${sale.id}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            // Bot√≥n "Ver todos / Ver menos"
            if (filteredSales.length > 10) {
                const trBtn = document.createElement('tr');
                const tdBtn = document.createElement('td');
                tdBtn.colSpan = 7;
                tdBtn.style.textAlign = 'center';
                tdBtn.style.padding = '10px';
                const btnVer = document.createElement('button');
                btnVer.className = 'btn btn-secondary btn-small';
                btnVer.style.width = '100%';
                btnVer.textContent = mostrarTodas
                    ? `‚ñ≤ Ver menos (mostrar √∫ltimas 10 de ${filteredSales.length})`
                    : `‚ñº Ver todos (${filteredSales.length} ventas)`;
                btnVer.onclick = () => {
                    tbody.dataset.showAll = mostrarTodas ? '0' : '1';
                    loadSalesHistory();
                };
                tdBtn.appendChild(btnVer);
                trBtn.appendChild(tdBtn);
                tbody.appendChild(trBtn);
            }
        }
        
        function filterSalesHistory() {
            loadSalesHistory();
        }
        
        function editSale(saleId) {
            const sale = salesData.find(s => s.id == saleId);
            if (!sale) {
                alert('Venta no encontrada');
                return;
            }
            
            // Crear modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;';
            modal.id = 'edit-sale-modal';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;';
            
            // T√≠tulo
            const title = document.createElement('h2');
            title.textContent = '‚úèÔ∏è Editar Venta';
            title.style.marginTop = '0';
            modalContent.appendChild(title);
            
            // Fecha
            const fechaGroup = document.createElement('div');
            fechaGroup.className = 'form-group';
            const fechaLabel = document.createElement('label');
            fechaLabel.textContent = 'Fecha';
            const fechaInput = document.createElement('input');
            fechaInput.type = 'date';
            fechaInput.id = 'edit-sale-date';
            fechaInput.value = sale.date;
            fechaInput.style.cssText = 'width: 100%; padding: 10px;';
            fechaGroup.appendChild(fechaLabel);
            fechaGroup.appendChild(fechaInput);
            modalContent.appendChild(fechaGroup);
            
            // Cliente
            const clienteGroup = document.createElement('div');
            clienteGroup.className = 'form-group';
            const clienteLabel = document.createElement('label');
            clienteLabel.textContent = 'Cliente';
            const clienteInput = document.createElement('input');
            clienteInput.type = 'text';
            clienteInput.value = sale.customer;
            clienteInput.disabled = true;
            clienteInput.style.cssText = 'width: 100%; padding: 10px; background: #f5f5f5;';
            clienteGroup.appendChild(clienteLabel);
            clienteGroup.appendChild(clienteInput);
            modalContent.appendChild(clienteGroup);
            
            // Productos
            const productosGroup = document.createElement('div');
            productosGroup.className = 'form-group';
            const productosLabel = document.createElement('label');
            productosLabel.textContent = 'Productos y Cantidades';
            productosGroup.appendChild(productosLabel);
            
            sale.items.forEach(function(item, idx) {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                
                const qtyInput = document.createElement('input');
                qtyInput.type = 'number';
                qtyInput.id = 'edit-qty-' + idx;
                qtyInput.value = item.quantity;
                qtyInput.min = '1';
                qtyInput.style.cssText = 'width: 80px; padding: 8px;';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = item.name;
                nameSpan.style.flex = '1';
                
                const priceSpan = document.createElement('span');
                priceSpan.textContent = '$' + item.priceUSD.toFixed(2);
                
                itemDiv.appendChild(qtyInput);
                itemDiv.appendChild(nameSpan);
                itemDiv.appendChild(priceSpan);
                productosGroup.appendChild(itemDiv);
            });
            
            modalContent.appendChild(productosGroup);
            
            // Botones
            const buttonDiv = document.createElement('div');
            buttonDiv.style.cssText = 'display: flex; gap: 10px; margin-top: 25px;';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.style.flex = '1';
            cancelBtn.onclick = function() {
                document.body.removeChild(modal);
            };
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-primary';
            saveBtn.textContent = 'Guardar Cambios';
            saveBtn.style.flex = '1';
            saveBtn.onclick = function() {
                guardarVentaEditada(saleId);
            };
            
            buttonDiv.appendChild(cancelBtn);
            buttonDiv.appendChild(saveBtn);
            modalContent.appendChild(buttonDiv);
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }
        
        function guardarVentaEditada(saleId) {
            const sale = salesData.find(s => s.id == saleId);
            if (!sale) return;
            
            // Obtener nueva fecha
            const newDate = document.getElementById('edit-sale-date').value;
            
            // Obtener nuevas cantidades
            sale.items.forEach(function(item, idx) {
                const qtyInput = document.getElementById('edit-qty-' + idx);
                if (qtyInput) {
                    item.quantity = parseInt(qtyInput.value) || 1;
                }
            });
            
            // Recalcular totales
            let subtotalSinIva = 0;
            let ivaTotal = 0;
            sale.items.forEach(function(item) {
                const lineTotal = (item.priceUSD || item.priceBS / priceExchangeRate) * item.quantity * priceExchangeRate;
                const lineIva   = item.hasIva ? lineTotal * (ivaPercentage / 100) : 0;
                subtotalSinIva += lineTotal;
                ivaTotal       += lineIva;
            });
            const total = subtotalSinIva + ivaTotal;

            sale.date     = newDate;
            sale.subtotal = subtotalSinIva;
            sale.iva      = ivaTotal;
            sale.total    = total;
            sale.totalUSD = subtotalSinIva / priceExchangeRate;

            // Si tiene retenciones, recalcular con valores correctos
            if (sale.retencionIva || sale.retencionIslr) {
                const retencionIva  = sale.retencionIva  ? ivaTotal       * 0.75 : 0;
                const retencionIslr = sale.retencionIslr ? subtotalSinIva * 0.02 : 0;
                sale.retencionIva   = retencionIva;
                sale.retencionIslr  = retencionIslr;
                sale.totalNeto      = total - retencionIva - retencionIslr;
            }
            
            // Guardar
            localStorage.setItem('salesData', JSON.stringify(salesData));
            
            // Si era cr√©dito, actualizar el cr√©dito
            const credit = creditsData.find(c => c.id == saleId);
            if (credit) {
                const newAmount = sale.totalNeto || sale.total;
                const creditAmount = parseFloat(newAmount.toFixed(2));
                credit.amount = creditAmount;
                credit.balance = parseFloat((creditAmount - (credit.paid || 0)).toFixed(2));
                localStorage.setItem('creditsData', JSON.stringify(creditsData));
            }
            
            // Cerrar modal
            const modal = document.getElementById('edit-sale-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // Recargar
            loadSalesHistory();
            loadDashboard();
            loadPendingCredits();
            
            alert('‚úÖ Venta actualizada correctamente');
        }
        
        function deleteSale(saleId) {
            const sale = salesData.find(s => s.id == saleId);
            if (!sale) return;
            
            const productsSummary = sale.items.map(i => `${i.quantity}x ${i.name}`).join(', ');
            
            if (!confirm(`¬øEliminar esta venta?\n\nCliente: ${sale.customer}\nFecha: ${formatDate(sale.date)}\nProductos: ${productsSummary}\nTotal: ${sale.total.toFixed(2)} BS\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            // Eliminar venta
            const index = salesData.findIndex(s => s.id == saleId);
            if (index > -1) {
                salesData.splice(index, 1);
                localStorage.setItem('salesData', JSON.stringify(salesData));
                
                // Si era cr√©dito, eliminar el cr√©dito tambi√©n
                const creditIndex = creditsData.findIndex(c => c.id == saleId);
                if (creditIndex > -1) {
                    if (creditsData[creditIndex].paid > 0) {
                        alert('‚ö†Ô∏è Este cr√©dito tiene abonos registrados. Solo se eliminar√° la venta, el cr√©dito permanecer√°.');
                    } else {
                        creditsData.splice(creditIndex, 1);
                        localStorage.setItem('creditsData', JSON.stringify(creditsData));
                    }
                }
                
                loadSalesHistory();
                loadDashboard();
                loadPendingCredits();
                loadEcuadorView();
                alert('‚úÖ Venta eliminada correctamente');
            }
        }

        // ========== SISTEMA DE FORMULARIOS ==========
        function setupForms() {
            // Formulario de adelantos de clientes
            const adelantoClienteForm = document.getElementById('adelanto-cliente-form');
            if (adelantoClienteForm) {
                adelantoClienteForm.addEventListener('submit', registrarAdelantoCliente);
            }
            
            // Formulario de adelantos de hielo
            const adelantoHieloForm = document.getElementById('adelanto-hielo-form');
            if (adelantoHieloForm) {
                adelantoHieloForm.addEventListener('submit', registrarAdelantoHielo);
            }
            
            // Formulario de gastos
            document.getElementById('expense-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const category = document.getElementById('expense-category').value;
                const fecha    = document.getElementById('expense-date').value;
                
                if (!category) { alert('Selecciona una categor√≠a'); return; }
                if (!fecha)    { alert('Ingresa la fecha'); return; }

                // ============================================================
                // FLUJO ESPECIAL: CR√âDITO ‚Üí Pago de cuota de pr√©stamo
                // ============================================================
                if (category === 'Cr√©dito') {
                    const prestId  = document.getElementById('credito-prestamo-sel').value;
                    const nroCuota = parseInt(document.getElementById('credito-cuota-sel').value);
                    const tipoPago = document.querySelector('input[name="credito-tipo-pago"]:checked')?.value;
                    
                    if (!prestId)  { alert('Selecciona el pr√©stamo'); return; }
                    if (!nroCuota) { alert('Selecciona la cuota'); return; }
                    if (!tipoPago) { alert('Selecciona el tipo de pago (Completo o Parcial)'); return; }
                    
                    const p     = prestamosData.find(x => x.id === prestId);
                    const cuota = p?.amortizacion?.find(c => c.numero === nroCuota);
                    if (!cuota) { alert('Cuota no encontrada'); return; }
                    
                    // Saldo real de la cuota (considera abonos previos)
                    const saldoRealCuota = (cuota.estado === 'parcial' && cuota.saldoPendienteUSD != null)
                        ? cuota.saldoPendienteUSD
                        : cuota.cuotaUSD;

                    let montoPagadoUSD = saldoRealCuota; // default: pago completo del saldo
                    let esParcial      = false;
                    let excedente      = 0;

                    if (tipoPago === 'parcial') {
                        montoPagadoUSD = parseFloat(document.getElementById('credito-monto-parcial').value) || 0;
                        if (montoPagadoUSD <= 0) { alert('Ingresa el monto pagado'); return; }
                        // Permitir pago mayor al saldo de la cuota - el excedente va a la siguiente
                        if (montoPagadoUSD < saldoRealCuota) {
                            esParcial = true;
                        } else {
                            // Pago cubre esta cuota y puede exceder
                            excedente = parseFloat((montoPagadoUSD - saldoRealCuota).toFixed(2));
                            montoPagadoUSD = saldoRealCuota; // lo que se aplica a esta cuota
                        }
                    }

                    // Registrar historial de pagos
                    if (!cuota.pagos) cuota.pagos = [];

                    if (esParcial) {
                        cuota.estado            = 'parcial';
                        cuota.montoPagadoUSD    = parseFloat(((cuota.montoPagadoUSD || 0) + montoPagadoUSD).toFixed(2));
                        cuota.saldoPendienteUSD = parseFloat((cuota.cuotaUSD - cuota.montoPagadoUSD).toFixed(2));
                        // Asegurar no queda negativo
                        if (cuota.saldoPendienteUSD <= 0.005) {
                            cuota.saldoPendienteUSD = 0;
                            cuota.estado    = 'pagado';
                            cuota.fechaPago = fecha;
                        }
                        cuota.pagos.push({ fecha, monto: montoPagadoUSD, tipo: 'parcial' });
                    } else {
                        // Pago completo del saldo pendiente
                        cuota.montoPagadoUSD    = cuota.cuotaUSD;
                        cuota.saldoPendienteUSD = 0;
                        cuota.estado            = 'pagado';
                        cuota.fechaPago         = fecha;
                        cuota.metodoPago        = 'Efectivo';
                        cuota.pagos.push({ fecha, monto: montoPagadoUSD, tipo: 'completo' });
                    }

                    // Aplicar excedente a la siguiente cuota pendiente
                    let mensajeExcedente = '';
                    if (excedente > 0) {
                        const siguienteCuota = p.amortizacion.find(c => c.numero > nroCuota && c.estado !== 'pagado');
                        if (siguienteCuota) {
                            if (!siguienteCuota.pagos) siguienteCuota.pagos = [];
                            const abonoSig = Math.min(excedente, siguienteCuota.cuotaUSD);
                            siguienteCuota.montoPagadoUSD    = parseFloat(((siguienteCuota.montoPagadoUSD || 0) + abonoSig).toFixed(2));
                            siguienteCuota.saldoPendienteUSD = parseFloat((siguienteCuota.cuotaUSD - siguienteCuota.montoPagadoUSD).toFixed(2));
                            if (siguienteCuota.saldoPendienteUSD <= 0.005) {
                                siguienteCuota.saldoPendienteUSD = 0;
                                siguienteCuota.estado   = 'pagado';
                                siguienteCuota.fechaPago = fecha;
                            } else {
                                siguienteCuota.estado = 'parcial';
                            }
                            siguienteCuota.pagos.push({ fecha, monto: abonoSig, tipo: 'excedente_cuota_anterior' });
                            mensajeExcedente = `
üí° Excedente $${abonoSig.toFixed(2)} aplicado a Cuota #${siguienteCuota.numero}.`;
                        }
                    }

                    recalcularEstadoPrestamo(p);
                    savePrestamos();

                    const montoTotal   = montoPagadoUSD + excedente;
                    const descCredito  = esParcial
                        ? `Abono parcial cuota #${nroCuota} - ${p.prestamista} ($${montoPagadoUSD.toFixed(2)} USD, saldo $${cuota.saldoPendienteUSD.toFixed(2)})`
                        : `Pago cuota #${nroCuota} - ${p.prestamista}${excedente > 0 ? ' + excedente $'+excedente.toFixed(2) : ''}`;

                    const expCred = {
                        id: Date.now(), date: fecha, description: descCredito,
                        invoiceNumber: '', documentType: 'Recibo',
                        amount: montoTotal, amountUSD: montoTotal, iva: 0,
                        category: 'Cr√©dito',
                        creditoRef: {
                            prestId, nroCuota, tipoPago: esParcial ? 'parcial' : 'completo',
                            montoPagadoUSD: montoTotal,
                            saldoCuota: cuota.cuotaUSD,
                            saldoPendiente: cuota.saldoPendienteUSD
                        }
                    };
                    expensesData.unshift(expCred);
                    localStorage.setItem('expensesData', JSON.stringify(expensesData));

                    const msgCred = esParcial
                        ? `‚úÖ Abono registrado.
Cuota #${nroCuota}: $${montoPagadoUSD.toFixed(2)} abonados, saldo pendiente $${cuota.saldoPendienteUSD.toFixed(2)} USD.`
                        : `‚úÖ Cuota #${nroCuota} pagada completamente.
Saldo pr√©stamo: $${p.saldoPendienteUSD.toFixed(2)} USD${mensajeExcedente}`;
                    alert(msgCred);
                    
                    document.getElementById('credito-prestamo-sel').value = '';
                    document.getElementById('credito-cuotas-panel').style.display = 'none';
                    document.getElementById('credito-cuota-info').style.display = 'none';
                    document.getElementById('credito-resumen').style.display = 'none';
                    document.querySelectorAll('input[name="credito-tipo-pago"]').forEach(r => r.checked = false);
                    document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
                    document.getElementById('expense-category').value = '';
                    if(document.getElementById('expense-supplier')) document.getElementById('expense-supplier').value = '';
                    onExpenseCategoryChange();
                    loadPrestamosDashboard(); loadPrestamosList();
                    loadEcuadorView(); loadExpensesHistory(); loadDashboard();
                    return;
                }

                // ============================================================
                // FLUJO NORMAL (incluyendo Personal sin IVA)
                // ============================================================
                const amount       = parseFloat(document.getElementById('expense-amount').value);
                const documentType = document.getElementById('expense-document-type').value;
                // IVA solo aplica si la categor√≠a no es Personal/Cr√©dito Y el documento es Factura
                const noIva        = (category === 'Personal' || category === 'Cr√©dito' || documentType !== 'Factura');
                const iva          = noIva ? 0 : (parseFloat(document.getElementById('expense-iva').value) || 0);
                
                if (!amount || amount <= 0) { alert('Ingresa un monto v√°lido'); return; }
                if (!documentType)          { alert('Selecciona el tipo de documento'); return; }
                if (!noIva && iva > 0 && (iva < 12 || iva > 16)) {
                    alert('El IVA debe estar entre 12% y 16%'); return;
                }
                if (category === 'Compras' && comprasItems.length === 0) {
                    alert('‚ö†Ô∏è Agrega al menos un √≠tem de compra antes de guardar.'); return;
                }
                
                const expense = {
                    id: Date.now(), date: fecha,
                    supplier:      (document.getElementById('expense-supplier')?.value || '').trim(),
                    description:   document.getElementById('expense-description').value,
                    invoiceNumber: document.getElementById('expense-invoice-number').value,
                    documentType,  amount, amountUSD: amount, iva, category,
                    paymentMethod: document.getElementById('expense-payment-method')?.value || '',
                    comprasItems: category === 'Compras' ? JSON.parse(JSON.stringify(comprasItems)) : undefined
                };
                
                expensesData.unshift(expense);
                localStorage.setItem('expensesData', JSON.stringify(expensesData));

                if (category === 'Compras') {
                    procesarComprasEnInventario(expense.id, expense.date);
                    comprasItems = [];
                    renderComprasItems();
                    document.getElementById('compras-inventario-panel').style.display = 'none';
                }
                
                const useAdelanto = document.getElementById('usar-adelanto-hielo').checked;
                if (useAdelanto && category === 'Hielo') {
                    // Fuente de verdad: getHieloSaldoUSD (maneja campos antiguos sin saldoDisponibleUSD)
                    const totalDispUSD = adelantosHielo
                        .filter(a => a.status === 'Activo' && getHieloSaldoUSD(a) > 0.001)
                        .reduce((sum, a) => sum + getHieloSaldoUSD(a), 0);

                    const montoADescontarUSD = Math.min(totalDispUSD, amount);

                    if (montoADescontarUSD > 0) {
                        let restanteUSD = montoADescontarUSD;
                        for (const adelanto of adelantosHielo) {
                            const saldoActualUSD = getHieloSaldoUSD(adelanto);  // leer saldo real ANTES de modificar
                            if (adelanto.status === 'Activo' && saldoActualUSD > 0.001 && restanteUSD > 0.001) {
                                const aUsarUSD    = Math.min(saldoActualUSD, restanteUSD);
                                const nuevoSaldoUSD = Math.max(0, saldoActualUSD - aUsarUSD);
                                // Actualizar campo USD (fuente de verdad)
                                adelanto.saldoDisponibleUSD = nuevoSaldoUSD;
                                adelanto.gastadoUSD         = (adelanto.gastadoUSD || 0) + aUsarUSD;
                                // Mantener campo BS sincronizado (compatibilidad)
                                adelanto.saldoDisponible = Math.max(0, convertUSDtoBS(nuevoSaldoUSD));
                                adelanto.gastado         = (adelanto.gastado || 0) + convertUSDtoBS(aUsarUSD);
                                // Marcar agotado si el saldo USD lleg√≥ a 0
                                if (nuevoSaldoUSD <= 0.001) adelanto.status = 'Agotado';
                                if (!adelanto.usos) adelanto.usos = [];
                                adelanto.usos.push({
                                    fecha,
                                    montoUSD: aUsarUSD,
                                    monto: convertUSDtoBS(aUsarUSD),
                                    concepto: `Gasto: ${expense.description}`,
                                    saldoRestanteUSD: nuevoSaldoUSD
                                });
                                restanteUSD -= aUsarUSD;
                            }
                        }
                        expense.adelantoUsadoUSD = montoADescontarUSD;
                        expense.adelantoUsado    = convertUSDtoBS(montoADescontarUSD); // legacy
                        localStorage.setItem('adelantosHielo', JSON.stringify(adelantosHielo));
                        loadAdelantosHieloList();
                    }
                }
                
                const msg = category === 'Compras'
                    ? `‚úÖ Compra registrada. Inventario actualizado (${expense.comprasItems.length} producto${expense.comprasItems.length !== 1 ? 's' : ''}).`
                    : category === 'Personal'
                        ? `‚úÖ Pago de personal registrado: $${amount.toFixed(2)} USD (sin IVA)`
                        : '‚úÖ Gasto registrado exitosamente!';
                alert(msg);
                this.reset();
                document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('expense-iva').value = 16;
                document.getElementById('hielo-adelanto-panel').style.display = 'none';
                document.getElementById('compras-inventario-panel').style.display = 'none';
                document.getElementById('usar-adelanto-hielo').checked = false;
                onExpenseCategoryChange();
                calculateExpenseAmounts();
                loadDashboard(); loadEcuadorView(); loadExpensesHistory();
            });
            
            // Formulario de pedidos
            document.getElementById('order-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const customer = document.getElementById('order-customer').value;
                const products = collectOrderProducts();
                
                if (!customer) {
                    alert('Selecciona un cliente');
                    return;
                }
                
                if (products.length === 0) {
                    alert('Agrega al menos un producto al pedido');
                    return;
                }
                
                const order = {
                    id: Date.now(),
                    date: document.getElementById('order-date').value,
                    customer: customer,
                    products: products,
                    notes: document.getElementById('order-notes').value,
                    status: document.getElementById('order-status').value
                };
                
                ordersData.unshift(order);
                localStorage.setItem('ordersData', JSON.stringify(ordersData));
                
                alert('‚úÖ Pedido registrado exitosamente!');
                this.reset();
                document.getElementById('order-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('order-status').value = 'Pendiente';
                document.getElementById('order-products-list').innerHTML = '';
                currentOrderProducts = [];
                
                loadOrdersHistory();
            });
            
            // Formulario de reportes
            document.getElementById('report-form').addEventListener('submit', function(e) {
                e.preventDefault();
                generateReport();
            });
        }

        function toggleCustomDateRange() {
            const customRange = document.getElementById('custom-date-range');
            if (this.value === 'custom') {
                customRange.style.display = 'block';
            } else {
                customRange.style.display = 'none';
            }
        }

        // ========== FUNCIONES DE CARGA DE DATOS ==========
        function loadExpensesHistory() {
            const tbody = document.getElementById('expenses-history');
            tbody.innerHTML = '';
            
            if (expensesData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #6c757d;">
                            No hay gastos registrados
                        </td>
                    </tr>
                `;
                return;
            }
            
            const mostrarTodosG = tbody.dataset.showAll === '1';
            const expVis = mostrarTodosG ? expensesData : expensesData.slice(0, 10);
            expVis.forEach(expense => {
                const totalUSD    = expense.amountUSD ?? convertBStoUSD(expense.amount ?? 0);
                const invoiceInfo = expense.invoiceNumber ? `<br><small>Fact. ${expense.invoiceNumber}</small>` : '';
                const ivaInfo     = (expense.iva && expense.iva > 0) ? ` | IVA: ${expense.iva}%` : ' | Sin IVA';

                // Detalle especial seg√∫n categor√≠a
                let extraDetail = '';
                if (expense.category === 'Compras' && expense.comprasItems?.length) {
                    const itemsList = expense.comprasItems.map(it =>
                        `<div style="font-size:11px;color:#2e7d32;">‚Ä¢ ${it.cantidad} √ó ${it.nombre} @ $${it.costoUnitarioUSD.toFixed(2)} = $${it.subtotalUSD.toFixed(2)}</div>`
                    ).join('');
                    extraDetail = `<div style="margin-top:4px;background:#f1f8e9;border-radius:4px;padding:4px 6px;">${itemsList}</div>`;
                } else if (expense.category === 'Cr√©dito' && expense.creditoRef) {
                    const ref = expense.creditoRef;
                    const tipoBadge = ref.tipoPago === 'parcial'
                        ? `<span style="background:#ff9800;color:white;border-radius:4px;padding:1px 6px;font-size:10px;">PARCIAL</span>`
                        : `<span style="background:#4caf50;color:white;border-radius:4px;padding:1px 6px;font-size:10px;">COMPLETO</span>`;
                    const saldoInfo = ref.tipoPago === 'parcial'
                        ? ` ¬∑ saldo cuota: $${(ref.saldoCuota - ref.montoPagadoUSD).toFixed(2)}`
                        : '';
                    extraDetail = `<div style="font-size:11px;color:#3f51b5;margin-top:3px;">Cuota #${ref.nroCuota} ${tipoBadge}${saldoInfo}</div>`;
                } else if (expense.category === 'Personal') {
                    extraDetail = `<div style="font-size:11px;color:#7b1fa2;margin-top:3px;">üë§ Salario/Sueldo - sin IVA</div>`;
                }

                // Badge de categor√≠a con colores por tipo
                const badgeColors = {
                    'Compras':     '#4caf50', 'Transporte': '#2196f3',
                    'Suministros': '#00bcd4', 'Mantenimiento': '#ff9800',
                    'Personal':    '#9c27b0', 'Hielo': '#03a9f4',
                    'Cr√©dito':     '#3f51b5', 'Otros': '#607d8b'
                };
                const badgeColor = badgeColors[expense.category] || '#607d8b';
                const categoryBadge = `<span class="badge" style="background:${badgeColor};color:white;">${expense.category}</span>`;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(expense.date)}</td>
                    <td><strong>${expense.description}</strong>${expense.supplier ? '<br><small style="color:#888;">üè≠ '+expense.supplier+'</small>' : ''}${invoiceInfo}${extraDetail}</td>
                    <td>${categoryBadge}</td>
                    <td><strong>$${totalUSD.toFixed(2)} USD</strong>${(expense.iva > 0) ? `<br><small>IVA ${expense.iva}%</small>` : '<br><small style="color:#9e9e9e;">Sin IVA</small>'}</td>
                    <td><small>${expense.documentType || 'N/A'}</small></td>
                    <td>
                        <button class="btn btn-small btn-danger" onclick="deleteExpense(${expense.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            // Bot√≥n "Ver todos / Ver menos" gastos
            if (expensesData.length > 10) {
                const trBtn = document.createElement('tr');
                const tdBtn = document.createElement('td');
                tdBtn.colSpan = 6;
                tdBtn.style.textAlign = 'center';
                tdBtn.style.padding = '10px';
                const btnVer = document.createElement('button');
                btnVer.className = 'btn btn-secondary btn-small';
                btnVer.style.width = '100%';
                btnVer.textContent = mostrarTodosG
                    ? `‚ñ≤ Ver menos (mostrar √∫ltimos 10 de ${expensesData.length})`
                    : `‚ñº Ver todos (${expensesData.length} gastos)`;
                btnVer.onclick = () => {
                    tbody.dataset.showAll = mostrarTodosG ? '0' : '1';
                    loadExpensesHistory();
                };
                tdBtn.appendChild(btnVer);
                trBtn.appendChild(tdBtn);
                tbody.appendChild(trBtn);
            }
        }
        
        function filterExpenses() {
            const searchTerm = document.getElementById('expense-search').value.toLowerCase();
            if (!searchTerm) { loadExpensesHistory(); return; }

            const tbody = document.getElementById('expenses-history');
            tbody.innerHTML = '';
            
            const filtered = expensesData.filter(e =>
                (e.description || '').toLowerCase().includes(searchTerm) ||
                (e.category   || '').toLowerCase().includes(searchTerm) ||
                (e.invoiceNumber || '').toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#6c757d;">No se encontraron gastos</td></tr>`;
                return;
            }
            
            // Reusar la misma l√≥gica de renderizado - temporalmente swap de expensesData
            const backup = expensesData;
            expensesData = filtered;
            loadExpensesHistory();
            expensesData = backup;
        }
        
        function loadOrdersHistory() {
            const tbody = document.getElementById('orders-history');
            tbody.innerHTML = '';
            
            if (ordersData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #6c757d;">
                            No hay pedidos registrados
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Filtrar cancelados (auto-eliminar)
            const nonCanceled = ordersData.filter(o => o.status !== 'Cancelado');
            
            // Ordenar: Pendiente/En Ruta primero, Entregado al final
            const sortedOrders = nonCanceled.sort((a, b) => {
                const orderA = a.status === 'Entregado' ? 1 : 0;
                const orderB = b.status === 'Entregado' ? 1 : 0;
                return orderA - orderB;
            });
            
            if (sortedOrders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #6c757d;">
                            No hay pedidos activos
                        </td>
                    </tr>
                `;
                return;
            }
            
            sortedOrders.forEach(order => {
                const statusClass = getStatusClass(order.status);
                
                // Resumir productos
                let productsText = '';
                if (order.products && Array.isArray(order.products)) {
                    productsText = order.products.map(p => `${p.quantity}x ${p.productName}`).join(', ');
                } else if (order.quantity) {
                    // Pedidos viejos
                    productsText = `${order.quantity} botellones`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(order.date)}</td>
                    <td><strong>${order.customer}</strong></td>
                    <td><small>${productsText}</small></td>
                    <td>
                        ${order.status === 'Entregado' ? 
                            `<span class="badge badge-success" style="padding: 8px 12px; font-size: 14px;">Entregado</span>` :
                            `<select class="form-control" onchange="changeOrderStatus(${order.id}, this.value)" 
                                    style="width: auto; padding: 5px;">
                                <option value="Pendiente" ${order.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="En Ruta" ${order.status === 'En Ruta' ? 'selected' : ''}>En Ruta</option>
                                <option value="Entregado" ${order.status === 'Entregado' ? 'selected' : ''}>Entregado</option>
                                <option value="Cancelado" ${order.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                            </select>`
                        }
                    </td>
                    <td>
                        ${order.status === 'Entregado' ? 
                            `<button class="btn btn-small btn-success" onclick="convertOrderToSale(${order.id})" title="Convertir a venta">
                                <i class="fas fa-cash-register"></i> Venta
                            </button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="deleteOrder(${order.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // ========== B1: Funciones de Estado de Cr√©dito ==========
        function calcularEstadoCredito(credit) {
            // Cr√©dito pagado: vencimiento cerrado - no mostrar alerta de d√≠as
            const statusReal = credit.status ||
                ((credit.balanceUSD != null ? credit.balanceUSD : credit.balance) <= 0.005 ? 'Pagado' : 'Pendiente');
            if (statusReal === 'Pagado') {
                return { estado: 'pagado', color: '#4caf50', icono: '‚úÖ', label: 'Pagado', diasRestantes: null };
            }
            if (!credit.fechaVencimiento) {
                return { estado: 'sin_vencimiento', color: '#607d8b', icono: '‚ö™', label: credit.status || 'Pendiente', diasRestantes: null };
            }
            const hoy = new Date(); hoy.setHours(0,0,0,0);
            const venc = new Date(credit.fechaVencimiento + 'T00:00:00');
            const diasHasta = Math.ceil((venc - hoy) / (1000*60*60*24));
            const diasAlerta = credit.diasAlertaAntes || 3;
            if (diasHasta < 0) {
                return { estado: 'vencido', color: '#f44336', icono: 'üî¥', label: `Vencido ${Math.abs(diasHasta)}d`, diasVencido: Math.abs(diasHasta) };
            } else if (diasHasta <= diasAlerta) {
                return { estado: 'por_vencer', color: '#ff9800', icono: 'üü°', label: `Vence en ${diasHasta}d`, diasRestantes: diasHasta };
            } else {
                return { estado: 'vigente', color: '#4caf50', icono: 'üü¢', label: `${diasHasta}d restantes`, diasRestantes: diasHasta };
            }
        }
        
        function toggleCreditFields() {
            const permite = document.getElementById('new-client-permite-credito').checked;
            document.getElementById('credit-fields-group').style.display = permite ? 'block' : 'none';
        }

        // ‚îÄ‚îÄ Helpers USD para cr√©ditos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Resuelve el monto USD de un cr√©dito: primero busca la venta original,
        // luego usa totalUSD guardado, sino convierte desde BS con tasa actual.
        function getCreditAmountUSD(credit) {
            // Prioridad: amountUSD guardado en el cr√©dito (base fija)
            if (credit.amountUSD != null) return parseFloat(credit.amountUSD);
            // Fallback: totalUSD de la venta asociada
            const sale = salesData.find(s => s.id == credit.id);
            if (sale?.totalUSD) return parseFloat(sale.totalUSD);
            // √öltimo recurso: campo legado
            return convertBStoUSD(credit.amount || 0);
        }

        function getCreditPaidUSD(credit) {
            // Si tiene el campo directo paidUSD, usarlo
            if (credit.paidUSD != null) return parseFloat(credit.paidUSD);
            // Fallback proporcional sobre base BS (cr√©ditos antiguos sin paidUSD)
            const paid   = credit.paid   || 0;
            const amount = credit.amount || 1;
            if (amount === 0) return 0;
            return getCreditAmountUSD(credit) * (paid / amount);
        }

        function getCreditBalanceUSD(credit) {
            // Si tiene el campo directo balanceUSD, usarlo
            if (credit.balanceUSD != null) return Math.max(0, parseFloat(credit.balanceUSD));
            // Fallback: amountUSD - paidUSD
            return Math.max(0, getCreditAmountUSD(credit) - getCreditPaidUSD(credit));
        }

        function fmtUSD(n) { return '$' + parseFloat(n || 0).toFixed(2); }

        function loadPendingCredits() {
            const tbody = document.getElementById('pending-credits');
            tbody.innerHTML = '';
            
            if (creditsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #6c757d;">
                            No hay cr√©ditos registrados
                        </td>
                    </tr>
                `;
                return;
            }
            
            // B1: Filtrar por estado
            const filtroEstado = document.getElementById('credit-filter-estado')?.value || 'todos';
            
            // Ordenar: Vencidos primero, luego por vencer, luego vigentes, luego pagados
            const estadoOrder = { vencido: 0, por_vencer: 1, vigente: 2, sin_vencimiento: 3 };
            const sortedCredits = [...creditsData].sort((a, b) => {
                if (a.status === 'Pagado' && b.status !== 'Pagado') return 1;
                if (b.status === 'Pagado' && a.status !== 'Pagado') return -1;
                const ea = calcularEstadoCredito(a);
                const eb = calcularEstadoCredito(b);
                return (estadoOrder[ea.estado] ?? 4) - (estadoOrder[eb.estado] ?? 4);
            });
            
            // Contar alertas
            let vencidos = 0, porVencer = 0;
            
            let rendered = 0;
            const mostrarTodosCr = tbody.dataset.showAll === '1';
            const limCr = mostrarTodosCr ? sortedCredits.length : 10;
            sortedCredits.forEach(credit => {
                // Asegurar propiedades
                if (!credit.paid) credit.paid = 0;
                if (!credit.balance) credit.balance = credit.amount;
                if (!credit.payments) credit.payments = [];
                
                credit.amount = parseFloat(credit.amount?.toFixed(2) || 0);
                credit.balance = parseFloat((credit.amount - credit.paid).toFixed(2));
                if (credit.balance < 0.01) credit.balance = 0;
                
                if (credit.balance <= 0 || credit.paid >= credit.amount) {
                    credit.status = 'Pagado'; credit.balance = 0;
                } else if (credit.paid > 0) {
                    credit.status = 'Parcial';
                } else {
                    credit.status = 'Pendiente';
                }
                
                // B1: estado de vencimiento
                const estadoVenc = calcularEstadoCredito(credit);
                if (credit.status !== 'Pagado') {
                    if (estadoVenc.estado === 'vencido') vencidos++;
                    if (estadoVenc.estado === 'por_vencer') porVencer++;
                }
                
                // Aplicar filtro
                if (filtroEstado !== 'todos') {
                    if (filtroEstado === 'vencido'    && estadoVenc.estado !== 'vencido')    return;
                    if (filtroEstado === 'por_vencer' && estadoVenc.estado !== 'por_vencer') return;
                    if (filtroEstado === 'vigente'    && estadoVenc.estado !== 'vigente')    return;
                    if (filtroEstado === 'Pendiente'  && estadoVenc.estado !== 'sin_vencimiento') return;
                }
                
                const statusClass = credit.status === 'Pendiente' ? 'badge-warning' : 
                                   credit.status === 'Parcial' ? 'badge-info' : 'badge-success';
                
                // Color de fila seg√∫n estado de vencimiento
                let rowBg = '';
                if (credit.status !== 'Pagado') {
                    if (estadoVenc.estado === 'vencido')   rowBg = 'background: rgba(244,67,54,0.06);';
                    else if (estadoVenc.estado === 'por_vencer') rowBg = 'background: rgba(255,152,0,0.06);';
                }
                
                // Vencimiento: cr√©dito pagado ‚Üí ‚úÖ Cancelado, otros ‚Üí fecha + estado
                let vencLabel;
                if (credit.status === 'Pagado') {
                    vencLabel = `<div style="font-weight:600; color:#4caf50;">‚úÖ Cancelado</div>
                     <small style="color:#4caf50;">${credit.fechaVencimiento ? credit.fechaVencimiento : ''}</small>`;
                } else if (credit.fechaVencimiento) {
                    vencLabel = `<div style="font-weight:600; color:${estadoVenc.color}">${estadoVenc.icono} ${credit.fechaVencimiento}</div>
                     <small style="color:${estadoVenc.color}">${estadoVenc.label}</small>`;
                } else {
                    vencLabel = '<small style="color:#999">Sin fecha</small>';
                }
                
                const row = document.createElement('tr');
                row.style.cssText = rowBg;
                row.innerHTML = `
                    <td><strong>${credit.customer}</strong></td>
                    <td>${formatDate(credit.date)}</td>
                    <td>${vencLabel}</td>
                    <td>${fmtUSD(getCreditAmountUSD(credit))}</td>
                    <td>${fmtUSD(getCreditPaidUSD(credit))}</td>
                    <td><strong>${fmtUSD(getCreditBalanceUSD(credit))}</strong></td>
                    <td><span class="badge ${statusClass}">${credit.status}</span></td>
                    <td>
                        ${credit.status !== 'Pagado' ? 
                            `<button class="btn btn-primary btn-small" onclick="showPaymentModal(${credit.id})">
                                <i class="fas fa-plus"></i> Abonar
                            </button>` : 
                            `<span style="color: #4caf50;">‚úì Pagado</span>`
                        }
                    </td>
                `;
                if (rendered >= limCr) return;
                tbody.appendChild(row);
                rendered++;
            });
            
            if (rendered === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:#999; padding:20px;">No hay cr√©ditos que coincidan con el filtro</td></tr>`;
            }
            // Bot√≥n Ver todos cr√©ditos
            const totalCr = sortedCredits.length;
            if (totalCr > 10) {
                const trBtn = document.createElement('tr');
                const tdBtn = document.createElement('td');
                tdBtn.colSpan = 8;
                tdBtn.style.textAlign = 'center';
                tdBtn.style.padding = '8px';
                const btnVer = document.createElement('button');
                btnVer.className = 'btn btn-secondary btn-small';
                btnVer.style.width = '100%';
                btnVer.textContent = mostrarTodosCr
                    ? '‚ñ≤ Ver menos (√∫ltimos 10)'
                    : '‚ñº Ver todos (' + totalCr + ' cr√©ditos)';
                btnVer.onclick = () => {
                    tbody.dataset.showAll = mostrarTodosCr ? '0' : '1';
                    loadPendingCredits && loadPendingCredits();
                };
                tdBtn.appendChild(btnVer);
                trBtn.appendChild(tdBtn);
                tbody.appendChild(trBtn);
            }
            
            // B1: Barra de alertas
            const alertBar = document.getElementById('credits-alerts-bar');
            if (alertBar) {
                const msgs = [];
                if (vencidos > 0) msgs.push(`üî¥ <strong>${vencidos}</strong> cr√©dito${vencidos>1?'s':''} vencido${vencidos>1?'s':''}`);
                if (porVencer > 0) msgs.push(`üü° <strong>${porVencer}</strong> cr√©dito${porVencer>1?'s':''} por vencer`);
                if (msgs.length > 0) {
                    alertBar.style.display = 'block';
                    alertBar.style.background = vencidos > 0 ? 'rgba(244,67,54,0.1)' : 'rgba(255,152,0,0.1)';
                    alertBar.style.border = `1px solid ${vencidos > 0 ? '#f44336' : '#ff9800'}`;
                    alertBar.innerHTML = '‚ö†Ô∏è ' + msgs.join(' &nbsp;|&nbsp; ') + ' - Revisa los detalles';
                } else {
                    alertBar.style.display = 'none';
                }
            }
            
            // Guardar estados corregidos
            localStorage.setItem('creditsData', JSON.stringify(creditsData));
        }

        // ========== GESTI√ìN DE CLIENTES ==========
        // Setup del buscador de clientes en el formulario de ventas
        function setupClientSearch() {
            const searchInput = document.getElementById('customer-name');
            const dropdown = document.getElementById('client-dropdown');
            
            if (!searchInput || !dropdown) return;
            
            // Evento de input para buscar mientras se escribe
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                if (searchTerm.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                filterAndShowClients(searchTerm);
            });
            
            // Mostrar dropdown al hacer focus si hay texto
            searchInput.addEventListener('focus', function() {
                if (this.value.trim().length > 0) {
                    filterAndShowClients(this.value.toLowerCase().trim());
                }
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
            
            // Prevenir que se cierre al hacer clic en el dropdown
            dropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        function filterAndShowClients(searchTerm) {
            const dropdown = document.getElementById('client-dropdown');
            
            // Ordenar clientes alfab√©ticamente
            const sortedClients = [...clientsData].sort((a, b) => 
                a.name.localeCompare(b.name, 'es', { sensitivity: 'base' })
            );
            
            // Filtrar clientes por nombre completo o iniciales
            const filteredClients = sortedClients.filter(client => {
                const nameLower = client.name.toLowerCase();
                
                // B√∫squeda por nombre completo
                if (nameLower.includes(searchTerm)) {
                    return true;
                }
                
                // B√∫squeda por iniciales
                const words = client.name.split(' ');
                const initials = words.map(word => word.charAt(0)).join('').toLowerCase();
                
                if (initials.includes(searchTerm)) {
                    return true;
                }
                
                // B√∫squeda por iniciales con espacios (ej: "j g" para "Juan Garc√≠a")
                const searchWords = searchTerm.split(' ').filter(w => w.length > 0);
                if (searchWords.length > 1) {
                    let match = true;
                    for (let i = 0; i < searchWords.length && i < words.length; i++) {
                        if (!words[i].toLowerCase().startsWith(searchWords[i])) {
                            match = false;
                            break;
                        }
                    }
                    if (match) return true;
                }
                
                return false;
            });
            
            // Mostrar resultados
            if (filteredClients.length === 0) {
                dropdown.innerHTML = '<div class="no-results">No se encontraron clientes. Escribe el nombre completo para registrar uno nuevo.</div>';
                dropdown.classList.add('show');
                return;
            }
            
            dropdown.innerHTML = '';
            filteredClients.forEach(client => {
                const option = document.createElement('div');
                option.className = 'client-option';
                option.innerHTML = `
                    <div>
                        <div class="client-name">${client.name}</div>
                        ${client.contact ? `<div class="client-contact">${client.contact}</div>` : ''}
                    </div>
                `;
                
                option.addEventListener('click', function() {
                    selectClient(client);
                });
                
                dropdown.appendChild(option);
            });
            
            dropdown.classList.add('show');
        }
        
        function selectClient(client) {
            const searchInput = document.getElementById('customer-name');
            const dropdown = document.getElementById('client-dropdown');
            const hiddenInput = document.getElementById('selected-customer-id');
            
            searchInput.value = client.name;
            if (hiddenInput) {
                hiddenInput.value = client.id;
            }
            dropdown.classList.remove('show');
        }
        
        function loadClientsList() {
            const tbody = document.getElementById('clients-list');
            tbody.innerHTML = '';
            
            // Ordenar alfab√©ticamente
            const sortedClients = [...clientsData].sort((a, b) => a.name.localeCompare(b.name, 'es'));
            
            if (sortedClients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #6c757d;">
                            No hay clientes registrados
                        </td>
                    </tr>
                `;
                return;
            }
            
            sortedClients.forEach(client => {
                const clientSales = salesData.filter(sale => sale.customer === client.name);
                const totalPurchasesUSD = clientSales.reduce((sum, sale) =>
                    sum + (sale.totalUSD ?? convertBStoUSD(sale.total ?? 0)), 0);
                const lastPurchase = clientSales.length > 0 ? clientSales[0].date : 'Nunca';
                
                const retenciones = [];
                if (client.retieneIva) retenciones.push('IVA 75%');
                if (client.retieneIslr) retenciones.push('ISLR 2%');
                const retencionesText = retenciones.length > 0 ? retenciones.join(', ') : 'Ninguna';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${client.name}</strong><br><small>${client.rif || 'Sin RIF'}</small></td>
                    <td>${client.contact || 'N/A'}</td>
                    <td>${client.permiteCredito ? `<span style="color:#4caf50; font-weight:600;">‚úÖ ${client.diasCredito || 30} d√≠as</span>` : '<span style="color:#999;">‚ùå No</span>'}</td>
                    <td><small>${retencionesText}</small></td>
                    <td>${formatDate(lastPurchase)}</td>
                    <td><strong>${fmtUSD(totalPurchasesUSD)}</strong></td>
                    <td>
                        <button class="btn btn-small btn-primary" onclick="editClient('${client.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteClient('${client.id}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function filterClients() {
            const searchTerm = document.getElementById('client-search').value.toLowerCase();
            const tbody = document.getElementById('clients-list');
            tbody.innerHTML = '';
            
            const filteredClients = clientsData.filter(client => 
                client.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredClients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #6c757d;">
                            No se encontraron clientes
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredClients.forEach(client => {
                const clientSales = salesData.filter(sale => sale.customer === client.name);
                const totalPurchasesUSD = clientSales.reduce((sum, sale) =>
                    sum + (sale.totalUSD ?? convertBStoUSD(sale.total ?? 0)), 0);
                
                // Obtener √∫ltima compra
                const lastPurchase = clientSales.length > 0 ? 
                    clientSales[0].date : 'Nunca';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.name}</td>
                    <td>${client.contact || 'N/A'}</td>
                    <td>${formatDate(lastPurchase)}</td>
                    <td>${fmtUSD(totalPurchasesUSD)}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteClient('${client.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Variable global para tipo de cliente
        let currentClientType = null;
        
        function showAddClientModal() {
            // Mostrar modal de selecci√≥n de tipo
            document.getElementById('client-type-modal').style.display = 'flex';
        }
        
        function closeClientTypeModal() {
            document.getElementById('client-type-modal').style.display = 'none';
        }
        
        function selectClientType(type) {
            currentClientType = type;
            
            // Cerrar modal de tipo
            closeClientTypeModal();
            
            // Configurar modal seg√∫n tipo
            const rifLabel = document.getElementById('rif-label');
            const rifInput = document.getElementById('new-client-rif');
            const rifHint = document.getElementById('rif-hint');
            const modalTitle = document.getElementById('client-modal-title');
            
            if (type === 'natural') {
                // Persona Natural: RIF opcional
                modalTitle.innerHTML = 'üë§ Agregar Persona Natural';
                rifLabel.innerHTML = 'RIF (Opcional)';
                rifInput.placeholder = 'V-12345678-9 (opcional)';
                rifInput.removeAttribute('required');
                rifHint.textContent = 'Formato: V-12345678-9 (opcional)';
            } else {
                // Persona Jur√≠dica: RIF obligatorio
                modalTitle.innerHTML = 'üè¢ Agregar Persona Jur√≠dica';
                rifLabel.innerHTML = 'RIF *';
                rifInput.placeholder = 'J-12345678-9';
                rifInput.setAttribute('required', 'required');
                rifHint.textContent = 'Formato: J-12345678-9 (obligatorio)';
            }
            
            // Mostrar modal de cliente
            document.getElementById('client-modal').style.display = 'flex';
        }
        
        function closeClientModal() {
            document.getElementById('client-modal').style.display = 'none';
            document.getElementById('new-client-name').value = '';
            document.getElementById('new-client-rif').value = '';
            document.getElementById('new-client-contact').value = '';
            document.getElementById('new-client-address').value = '';
            document.getElementById('new-client-retiene-iva').checked = false;
            document.getElementById('new-client-retiene-isr').checked = false;
            currentClientType = null;
        }
        
        function saveNewClient() {
            const name = document.getElementById('new-client-name').value.trim();
            const rif = document.getElementById('new-client-rif').value.trim();
            const contact = document.getElementById('new-client-contact').value.trim();
            const address = document.getElementById('new-client-address').value.trim();
            const retieneIva = document.getElementById('new-client-retiene-iva').checked;
            const retieneIslr = document.getElementById('new-client-retiene-isr').checked;
            
            if (!name) {
                alert('El nombre del cliente es obligatorio');
                return;
            }
            
            // Validar RIF seg√∫n tipo de cliente
            if (currentClientType === 'juridica') {
                // Persona Jur√≠dica: RIF obligatorio
                if (!rif) {
                    alert('El RIF es obligatorio para Persona Jur√≠dica');
                    return;
                }
                
                // Validar formato RIF
                if (!/^[VJEGP]-\d{8,9}-\d$/.test(rif)) {
                    alert('Formato de RIF inv√°lido. Use: J-12345678-9');
                    return;
                }
            } else if (currentClientType === 'natural') {
                // Persona Natural: RIF opcional, pero si se ingresa debe ser v√°lido
                if (rif && !/^[VJEGP]-\d{8,9}-\d$/.test(rif)) {
                    alert('Formato de RIF inv√°lido. Use: V-12345678-9');
                    return;
                }
            }
            
            // Verificar si el cliente ya existe
            if (clientsData.some(client => client.name.toLowerCase() === name.toLowerCase())) {
                alert('Ya existe un cliente con ese nombre');
                return;
            }
            
            const client = {
                id: Date.now().toString(),
                name: name,
                rif: rif || 'N/A',
                contact: contact,
                address: address,
                retieneIva: retieneIva,
                retieneIslr: retieneIslr,
                tipoCliente: currentClientType || 'natural',
                // B1: Condiciones de cr√©dito
                permiteCredito: document.getElementById('new-client-permite-credito').checked,
                diasCredito: parseInt(document.getElementById('new-client-dias-credito').value) || 30,
                diasAlertaAntes: parseInt(document.getElementById('new-client-dias-alerta').value) || 3,
                createdAt: new Date().toISOString()
            };
            
            clientsData.push(client);
            
            // Ordenar alfab√©ticamente
            clientsData.sort((a, b) => a.name.localeCompare(b.name, 'es'));
            
            localStorage.setItem('clientsData', JSON.stringify(clientsData));
            
            closeClientModal();
            loadClientsList();
            loadCustomerSelect();
            loadSalesReportClients();
            loadCreditReportClients();
            loadAdelantosClientes();
            
            // Limpiar formulario
            document.getElementById('new-client-name').value = '';
            document.getElementById('new-client-rif').value = '';
            document.getElementById('new-client-contact').value = '';
            document.getElementById('new-client-address').value = '';
            document.getElementById('new-client-retiene-iva').checked = false;
            document.getElementById('new-client-retiene-isr').checked = false;
            document.getElementById('new-client-permite-credito').checked = false;
            document.getElementById('new-client-dias-credito').value = '30';
            document.getElementById('new-client-dias-alerta').value = '3';
            document.getElementById('credit-fields-group').style.display = 'none';
            
            alert('‚úÖ Cliente agregado exitosamente!');
        }
        
        function editClient(clientId) {
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            
            document.getElementById('new-client-name').value = client.name;
            document.getElementById('new-client-rif').value = client.rif || '';
            document.getElementById('new-client-contact').value = client.contact || '';
            document.getElementById('new-client-address').value = client.address || '';
            document.getElementById('new-client-retiene-iva').checked = client.retieneIva || false;
            document.getElementById('new-client-retiene-isr').checked = client.retieneIslr || false;
            // B1: cargar campos de cr√©dito
            document.getElementById('new-client-permite-credito').checked = client.permiteCredito || false;
            document.getElementById('new-client-dias-credito').value = client.diasCredito || 30;
            document.getElementById('new-client-dias-alerta').value = client.diasAlertaAntes || 3;
            document.getElementById('credit-fields-group').style.display = client.permiteCredito ? 'block' : 'none';
            
            // Cambiar t√≠tulo y bot√≥n
            document.querySelector('#client-modal h3').textContent = 'Editar Cliente';
            
            // Cambiar funci√≥n del bot√≥n guardar
            const saveBtn = document.querySelector('#client-modal .btn-primary');
            saveBtn.onclick = function() { updateClient(clientId); };
            
            showAddClientModal();
        }
        
        function updateClient(clientId) {
            const name = document.getElementById('new-client-name').value.trim();
            const rif = document.getElementById('new-client-rif').value.trim();
            const contact = document.getElementById('new-client-contact').value.trim();
            const address = document.getElementById('new-client-address').value.trim();
            const retieneIva = document.getElementById('new-client-retiene-iva').checked;
            const retieneIslr = document.getElementById('new-client-retiene-isr').checked;
            
            if (!name || !rif) {
                alert('Nombre y RIF son obligatorios');
                return;
            }
            
            if (!/^[VJEGP]-\d{8,9}-\d$/.test(rif)) {
                alert('Formato de RIF inv√°lido. Use: J-12345678-9');
                return;
            }
            
            const clientIndex = clientsData.findIndex(c => c.id === clientId);
            if (clientIndex === -1) return;
            
            const oldName = clientsData[clientIndex].name;
            
            clientsData[clientIndex] = {
                ...clientsData[clientIndex],
                name: name,
                rif: rif,
                contact: contact,
                address: address,
                retieneIva: retieneIva,
                retieneIslr: retieneIslr,
                // B1: Condiciones de cr√©dito
                permiteCredito: document.getElementById('new-client-permite-credito').checked,
                diasCredito: parseInt(document.getElementById('new-client-dias-credito').value) || 30,
                diasAlertaAntes: parseInt(document.getElementById('new-client-dias-alerta').value) || 3
            };
            
            const clienteActualizado = clientsData[clientIndex];
            
            // B1: Recalcular fechaVencimiento en cr√©ditos activos de este cliente
            // (se actualizan cuando cambian los d√≠as de cr√©dito del cliente)
            let creditosActualizados = 0;
            creditsData.forEach(credit => {
                const nombreBuscar = oldName !== name ? oldName : name;
                if (credit.customer === nombreBuscar && credit.status !== 'Pagado') {
                    if (clienteActualizado.permiteCredito && clienteActualizado.diasCredito && credit.date) {
                        const fechaBase = new Date(credit.date + 'T00:00:00');
                        fechaBase.setDate(fechaBase.getDate() + clienteActualizado.diasCredito);
                        credit.fechaVencimiento = fechaBase.toISOString().split('T')[0];
                        credit.diasCredito = clienteActualizado.diasCredito;
                        credit.diasAlertaAntes = clienteActualizado.diasAlertaAntes || 3;
                        creditosActualizados++;
                    } else if (!clienteActualizado.permiteCredito) {
                        // Si se deshabilit√≥ el cr√©dito, limpiar fechas
                        credit.fechaVencimiento = null;
                        credit.diasCredito = null;
                    }
                }
            });
            
            // Si cambi√≥ el nombre, actualizar ventas y cr√©ditos
            if (oldName !== name) {
                salesData.forEach(sale => {
                    if (sale.customer === oldName) sale.customer = name;
                });
                creditsData.forEach(credit => {
                    if (credit.customer === oldName) credit.customer = name;
                });
                localStorage.setItem('salesData', JSON.stringify(salesData));
            }
            
            localStorage.setItem('creditsData', JSON.stringify(creditsData));
            
            // Ordenar alfab√©ticamente
            clientsData.sort((a, b) => a.name.localeCompare(b.name, 'es'));
            
            localStorage.setItem('clientsData', JSON.stringify(clientsData));
            
            closeClientModal();
            loadClientsList();
            loadCustomerSelect();
            loadPendingCredits();   // B1: refrescar cr√©ditos con nuevo estado de vencimiento
            
            const msg = creditosActualizados > 0 
                ? `‚úÖ Cliente actualizado.\nüìã ${creditosActualizados} cr√©dito(s) recalculados con los nuevos d√≠as.`
                : '‚úÖ Cliente actualizado exitosamente!';
            alert(msg);
        }
        
        function deleteClient(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este cliente?')) {
                clientsData = clientsData.filter(client => client.id !== id);
                localStorage.setItem('clientsData', JSON.stringify(clientsData));
                loadClientsList();
                loadCustomerSelect();
            }
        }

        // ========== FUNCIONES DE ELIMINACI√ìN ==========
        function deleteSale(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar esta venta?')) {
                salesData = salesData.filter(sale => sale.id !== id);
                localStorage.setItem('salesData', JSON.stringify(salesData));
                loadSalesHistory();
                loadDashboard();
            loadEcuadorView();
                loadRecentSales();
            }
        }
        
        function deleteExpense(id) {
            const expense = expensesData.find(e => e.id === id);
            if (!expense) return;

            let confirmMsg = '¬øEliminar este gasto?';

            // Mensaje especial para gastos vinculados
            if (expense.category === 'Compras' && expense.comprasItems?.length > 0) {
                confirmMsg = '‚ö†Ô∏è Este gasto es una Compra vinculada al inventario.\n\n¬øEliminar el gasto y REVERTIR el stock?';
            } else if (expense.category === 'Cr√©dito' && expense.creditoRef) {
                const ref = expense.creditoRef;
                confirmMsg = `‚ö†Ô∏è Este gasto es un pago de cuota de pr√©stamo.\n\nCuota #${ref.nroCuota} - $${ref.montoPagadoUSD?.toFixed(2)} USD\n\n¬øEliminar el gasto y REVERTIR el abono en la tabla de amortizaci√≥n?`;
            }

            if (!confirm(confirmMsg)) return;

            // Revertir inventario si era Compra
            if (expense.category === 'Compras' && expense.comprasItems?.length > 0) {
                expense.comprasItems.forEach(item => {
                    const idx = inventoryData.findIndex(i => i.productoKey === item.productoKey);
                    if (idx === -1) return;
                    const inv        = inventoryData[idx];
                    const stockAnt   = inv.stockActual;
                    const nuevoStock = Math.max(0, stockAnt - item.cantidad);
                    inv.stockActual       = nuevoStock;
                    inv.totalCompras      = Math.max(0, (inv.totalCompras || 0) - item.cantidad);
                    inv.diasSinMovimiento = 0;
                    const est             = calcularEstadoInventario(inv);
                    inv.estado            = est.estado;
                    inv.requiereAlerta    = est.estado !== 'normal';
                    inv.modificadoEn      = new Date().toISOString();
                    registrarMovimiento(item.productoKey, 'ajuste', item.cantidad, stockAnt, nuevoStock, `Eliminaci√≥n Gasto #${expense.id}`);
                });
                saveInventory();
                loadInventoryList();
                loadMovimientosHistorial();
            }

            // Revertir pago de cuota si era Cr√©dito
            if (expense.category === 'Cr√©dito' && expense.creditoRef) {
                const ref   = expense.creditoRef;
                const prest = prestamosData.find(p => p.id === ref.prestId);
                if (prest) {
                    const cuota = prest.amortizacion.find(c => c.numero === ref.nroCuota);
                    if (cuota) {
                        const montoRevertir = parseFloat(ref.montoPagadoUSD || 0);
                        // Restar el monto pagado
                        cuota.montoPagadoUSD    = parseFloat(Math.max(0, (cuota.montoPagadoUSD || 0) - montoRevertir).toFixed(2));
                        cuota.saldoPendienteUSD = parseFloat((cuota.cuotaUSD - cuota.montoPagadoUSD).toFixed(2));
                        // Restaurar estado correcto
                        if (cuota.montoPagadoUSD <= 0) {
                            cuota.estado            = 'pendiente';
                            cuota.montoPagadoUSD    = 0;
                            cuota.saldoPendienteUSD = cuota.cuotaUSD;
                            cuota.fechaPago         = null;
                            cuota.pagos             = (cuota.pagos || []).filter(p => p.fecha !== expense.date || Math.abs(p.monto - montoRevertir) > 0.01);
                        } else {
                            cuota.estado = 'parcial';
                            cuota.pagos  = (cuota.pagos || []).filter(p => p.fecha !== expense.date || Math.abs(p.monto - montoRevertir) > 0.01);
                        }
                        recalcularEstadoPrestamo(prest);
                        savePrestamos();
                        loadPrestamosDashboard && loadPrestamosDashboard();
                        loadPrestamosList && loadPrestamosList();
                    }
                }
            }

            expensesData = expensesData.filter(e => e.id !== id);
            localStorage.setItem('expensesData', JSON.stringify(expensesData));
            loadExpensesHistory();
            loadDashboard();
            loadEcuadorView();
        }
        
        function deleteOrder(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este pedido?')) {
                ordersData = ordersData.filter(order => order.id !== id);
                localStorage.setItem('ordersData', JSON.stringify(ordersData));
                loadOrdersHistory();
            }
        }
        
        let currentCreditId = null;
        
        function showPaymentModal(creditId) {
            console.log('=== ABRIENDO MODAL DE ABONO ===');
            console.log('Credit ID:', creditId);
            
            currentCreditId = creditId;
            const credit = creditsData.find(c => c.id === creditId);
            
            if (!credit) {
                console.error('Cr√©dito no encontrado');
                return;
            }
            
            console.log('Cr√©dito encontrado:', credit);
            
            // Asegurar que tiene las propiedades necesarias
            if (!credit.paid) credit.paid = 0;
            if (!credit.balance) credit.balance = credit.amount;
            if (!credit.payments) credit.payments = [];
            
            // Fecha inicial
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            console.log('Fecha inicial establecida:', today);
            
            // Cliente
            document.getElementById('payment-customer-name').textContent = credit.customer;
            console.log('Cliente:', credit.customer);
            
            // Total abonado (siempre en USD)
            const paidDisplay = credit.paidUSD != null ? credit.paidUSD : getCreditPaidUSD(credit);
            document.getElementById('payment-total-paid').textContent = fmtUSD(paidDisplay);
            console.log('Total abonado:', credit.paid);
            
            // Limpiar campos
            document.getElementById('payment-amount').value = '';
            // No establecer max porque el monto var√≠a con la tasa del d√≠a
            document.getElementById('payment-method-abono').value = '';
            document.getElementById('payment-notes').value = '';
            
            // Actualizar todos los valores con la tasa del d√≠a
            console.log('Llamando a actualizarValoresConTasaBCV...');
            actualizarValoresConTasaBCV();
            
            console.log('Mostrando modal...');
            document.getElementById('payment-modal').style.display = 'flex';
            console.log('=== MODAL ABIERTO ===');
        }
        
        function actualizarValoresConTasaBCV() {
            const paymentDate = document.getElementById('payment-date').value;
            if (!paymentDate || !currentCreditId) return;

            const credit  = creditsData.find(c => c.id === currentCreditId);
            if (!credit) return;

            const sale    = salesData.find(s => s.id == currentCreditId);
            const bcvRate = getBCVRateForDate(paymentDate);

            // Mostrar tasa del d√≠a seleccionado
            const rateDisplay = document.getElementById('payment-bcv-rate-display');
            if (rateDisplay) {
                rateDisplay.textContent = 'Tasa BCV ' + formatDate(paymentDate) + ': ' + bcvRate.toFixed(2) + ' BS/USD';
            }

            // ‚îÄ‚îÄ Saldo pendiente en USD (base fija, nunca cambia con la tasa) ‚îÄ‚îÄ
            // Asegurar que el cr√©dito tiene balanceUSD
            if (credit.amountUSD == null) credit.amountUSD = getCreditAmountUSD(credit);
            if (credit.paidUSD == null) {
                const prop = credit.amount > 0 ? (credit.paid || 0) / credit.amount : 0;
                credit.paidUSD = parseFloat((credit.amountUSD * prop).toFixed(2));
            }
            if (credit.balanceUSD == null) {
                credit.balanceUSD = parseFloat(Math.max(0, credit.amountUSD - credit.paidUSD).toFixed(2));
            }

            const debtUSD = credit.balanceUSD;
            // BS es solo informativo: cu√°ntos bol√≠vares equivale el saldo USD con la tasa del d√≠a elegido
            const debtBS  = debtUSD * bcvRate;

            document.getElementById('payment-debt-usd').textContent = fmtUSD(debtUSD) + ' USD';
            document.getElementById('payment-debt-bs').textContent  = debtBS.toFixed(2) + ' BS (ref. tasa ' + formatDate(paymentDate) + ')';

            // ‚îÄ‚îÄ Detalle de la venta ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            let saleDetailsHTML = '';

            if (sale) {
                const productsList = (sale.items || []).map(function(item) {
                    return '<div style="padding:6px 0; border-bottom:1px solid #ddd;"><strong>' + item.quantity + 'x</strong> ' + item.name + '</div>';
                }).join('');

                // Mostrar valores de la venta en BS referencial (solo informativo)
                const saleBS     = (sale.totalUSD || 0) * bcvRate;
                const saleNetoBS = sale.totalNeto ? sale.totalNeto / (sale.total || 1) * saleBS : saleBS;

                saleDetailsHTML =
                    '<div style="margin-bottom:10px;"><strong>Fecha venta:</strong> ' + formatDate(sale.date) + '</div>' +
                    '<div style="margin-bottom:15px;"><strong>Productos:</strong>' + productsList + '</div>' +
                    '<div style="background:#f0f8ff; padding:15px; border-radius:8px; margin-top:10px;">' +
                    '<div style="font-size:11px; color:#666; margin-bottom:10px;">üìå Base USD fija al d√≠a de la venta ¬∑ BS calculado con tasa del ' + formatDate(paymentDate) + '</div>' +
                    '<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">' +
                    '<div><strong>Base cr√©dito:</strong> ' + fmtUSD(credit.amountUSD) + ' USD</div>' +
                    '<div><strong>Total abonado:</strong> ' + fmtUSD(credit.paidUSD) + ' USD</div>' +
                    '<div><strong>Saldo USD (fijo):</strong> <span style="color:#dc3545; font-weight:700;">' + fmtUSD(debtUSD) + ' USD</span></div>' +
                    '<div><strong>Saldo BS (ref.):</strong> ' + debtBS.toFixed(2) + ' BS</div>' +
                    '</div>';

                if (sale.retencionIva > 0 || sale.retencionIslr > 0) {
                    saleDetailsHTML += '<div style="margin-top:8px; font-size:12px; color:#888;">Venta con retenciones aplicadas al momento de la venta.</div>';
                }
                saleDetailsHTML += '</div>';
            } else {
                saleDetailsHTML =
                    '<div style="color:#666; padding:15px; background:#f5f5f5; border-radius:8px;">' +
                    '<strong>Base del cr√©dito:</strong> ' + fmtUSD(credit.amountUSD) + ' USD<br>' +
                    '<strong>Total abonado:</strong> '    + fmtUSD(credit.paidUSD)   + ' USD<br>' +
                    '<strong>Saldo pendiente:</strong> '  + fmtUSD(debtUSD)          + ' USD' +
                    ' (' + debtBS.toFixed(2) + ' BS ref. tasa ' + formatDate(paymentDate) + ')' +
                    '</div>';
            }

            document.getElementById('payment-sale-details').innerHTML = saleDetailsHTML;
        }
        
        function updatePaymentBCVRate() {
            actualizarValoresConTasaBCV();
        }
        
        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
            
            // Limpiar completamente el formulario
            document.getElementById('payment-amount').value = '';
            document.getElementById('payment-method-abono').value = '';
            document.getElementById('payment-notes').value = '';
            document.getElementById('payment-date').value = '';
            
            // Limpiar variable global
            currentCreditId = null;
        }
        
        function savePayment() {
            if (!currentCreditId) return;

            const amountUSD     = parseFloat(document.getElementById('payment-amount').value);
            const date          = document.getElementById('payment-date').value;
            const paymentMethod = document.getElementById('payment-method-abono').value;
            const notes         = document.getElementById('payment-notes').value;

            if (!amountUSD || amountUSD <= 0) { alert('Ingresa un monto v√°lido'); return; }
            if (!paymentMethod) { alert('Selecciona una forma de pago'); return; }

            const creditIndex = creditsData.findIndex(c => c.id === currentCreditId);
            if (creditIndex === -1) return;

            const credit = creditsData[creditIndex];

            // Migrar cr√©ditos legacy sin campos USD
            if (credit.amountUSD == null) credit.amountUSD = getCreditAmountUSD(credit);
            if (credit.paidUSD == null) {
                const prop = credit.amount > 0 ? (credit.paid || 0) / credit.amount : 0;
                credit.paidUSD = parseFloat((credit.amountUSD * prop).toFixed(2));
            }
            if (credit.balanceUSD == null) {
                credit.balanceUSD = parseFloat(Math.max(0, credit.amountUSD - credit.paidUSD).toFixed(2));
            }

            // El abono no puede superar el saldo pendiente en USD
            const saldoPendienteUSD = credit.balanceUSD;
            const abonoEfectivoUSD  = parseFloat(Math.min(amountUSD, saldoPendienteUSD).toFixed(2));

            if (amountUSD > saldoPendienteUSD + 0.005) {
                const ok = confirm(
                    `‚ö†Ô∏è El monto ($${amountUSD.toFixed(2)} USD) supera el saldo pendiente ($${saldoPendienteUSD.toFixed(2)} USD).\n\n` +
                    `Se registrar√° el abono exacto al saldo: $${saldoPendienteUSD.toFixed(2)} USD.\n\n¬øConfirmar?`
                );
                if (!ok) return;
            }

            if (!credit.payments) credit.payments = [];

            // Tasa BCV del d√≠a del pago (referencia BS, no afecta el c√°lculo USD)
            const bcvRate = getBCVRateForDate(date);
            const abonoBS = parseFloat((abonoEfectivoUSD * bcvRate).toFixed(2));

            // Registrar el abono con unidades expl√≠citas
            credit.payments.push({
                date:          date,
                amount:        abonoEfectivoUSD,
                amountUSD:     abonoEfectivoUSD,
                amountBS:      abonoBS,
                bcvRate:       bcvRate,
                paymentMethod: paymentMethod,
                notes:         notes
            });

            // Actualizar acumuladores USD (campo primario)
            credit.paidUSD    = parseFloat((credit.paidUSD + abonoEfectivoUSD).toFixed(2));
            credit.balanceUSD = parseFloat(Math.max(0, credit.amountUSD - credit.paidUSD).toFixed(2));

            // Mantener campos BS legacy sincronizados
            credit.paid    = parseFloat(((credit.paid || 0) + abonoBS).toFixed(2));
            credit.balance = parseFloat(Math.max(0, (credit.amount || 0) - credit.paid).toFixed(2));

            // Estado basado en saldo USD
            if (credit.balanceUSD <= 0.005) {
                credit.status     = 'Pagado';
                credit.balanceUSD = 0;
                credit.balance    = 0;
            } else if (credit.paidUSD > 0) {
                credit.status = 'Parcial';
            } else {
                credit.status = 'Pendiente';
            }

            // Guardar
            localStorage.setItem('creditsData', JSON.stringify(creditsData));

            syncAbono({
                id:            Date.now(),
                creditId:      credit.id,
                date:          date,
                amount:        abonoEfectivoUSD,
                amountUSD:     abonoEfectivoUSD,
                amountBS:      abonoBS,
                bcvRate:       bcvRate,
                exchangeRate:  bcvRate,
                paymentMethod: paymentMethod,
                notes:         notes,
                creadoPor:     getCurrentUserId()
            });

            closePaymentModal();
            loadPendingCredits();
            loadEcuadorView();

            alert(
                `‚úÖ Abono registrado exitosamente\n\n` +
                `Monto abonado:    ${fmtUSD(abonoEfectivoUSD)} USD\n` +
                `Tasa BCV (${date}): ${bcvRate.toFixed(2)} BS/USD\n` +
                `Equiv. en BS:     ${abonoBS.toFixed(2)} BS\n` +
                `\n` +
                `Base del cr√©dito: ${fmtUSD(credit.amountUSD)} USD\n` +
                `Total abonado:    ${fmtUSD(credit.paidUSD)} USD\n` +
                `Saldo pendiente:  ${fmtUSD(credit.balanceUSD)} USD\n` +
                `\nEstado: ${credit.status}`
            );
        }

        function markCreditAsPaid(id) {
            if (confirm('¬øMarcar este cr√©dito como pagado?')) {
                const credit = creditsData.find(credit => credit.id === id);
                if (credit) {
                    credit.status = 'Pagado';
                    if (!credit.paid) credit.paid = credit.amount;
                    if (!credit.balance) credit.balance = 0;
                    localStorage.setItem('creditsData', JSON.stringify(creditsData));
                    loadPendingCredits();
                    loadEcuadorView();
                }
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'Pendiente': return 'badge-warning';
                case 'En proceso': return 'badge-warning';
                case 'Entregado': return 'badge-success';
                case 'Cancelado': return 'badge-danger';
                default: return 'badge-warning';
            }
        }

        // ========== CARGA DE DATOS PREDEFINIDOS ==========
        function loadPredefinedClients() {
            // Lista de clientes optimizada (sin duplicados)
            const uniqueClients = [
                "GAS ANZOATEGUI", "COLCHORIENTE", "PLASTICOS BICENTENARIO", "PRECA", 
                "DIMAX", "GALPON VERDE", "COPESCA", "FERREAGRO", "IRAIDA BARRETO", 
                "SRA TANIA", "FEMANCA", "TALLER LA SOLUCION", "JENNIFER", "LILIANA", 
                "PLASTICOS INTERNACIONAL", "LOCAL", "SRA MARIELA", "MARIA", "MAQUI", 
                "CALINSA", "ISRAEL", "CAUCHERA", "DANIEL BARBERO", "WILLIAMS GANDOLAS", 
                "CUADRILLA ZONA IND", "JOHELYS ZACARIAS", "SRA LILIANA", "MARIA SUPER S", 
                "JESUS MARTINEZ", "ERIKA", "CITO", "RIBERA COUNTRY", "FERRETERIA", 
                "SRA EGLYS", "SRA IRAIDA", "LEONERYS MOLINA", "EMPRESA DE CAL", 
                "VILLAS DE MESONES", "BLU FOODS", "SR GIOVANY CARPINTERO", "EL MURO", 
                "ERIKSON SUPER S", "KARIANNYS", "JOSUE GUILLEN", "JUAN BARROSO", 
                "FERTI", "CAUCHERA ALTERNA", "SR WILLIAMS", "KIOSKO 3 UDO", "DIANA", 
                "MURO", "ANNA", "CLARA", "JAR TECNOLOGY", "SOLVICOM", "ORIANA", 
                "PERFUMERIA", "TRIPLE 8", "ERIKA SUPER S", "RIVERA COUNTRY", "SUPER S", 
                "TORTAS ALOA", "DALIA", "ACRILUM", "MARIO PERICO", "ANDRY", 
                "CRUZ SUPER S", "CUADRILLA", "ADRIEL", "SRA JOSEFA MACCO", "RESISTENCIA I", 
                "EMISORA", "SR ISRAEL", "LUCHI", "COLINAS DEL RINCON", "LUISA CALZADILLA", 
                "SR LUIS", "ORIANA", "MAYORKIN", "AREPERA", "KEYLA ALFONZO", 
                "POST GRADO CITO", "MERCADO", "NUEVO", "EFRAIN", "PELUQUERIA", 
                "YANET GUAMACHITO", "BOTELLON", "VECINA", "MERIZARETH", "CUADRILLA OJO DE AGUA", 
                "PALACIO DE JUSTICIA", "CIUDAD BAHIA", "VENTA", "FRENTE A HIPERLIDER", 
                "CAPITAN", "CAUVICA", "JEFFREY", "JOHANA VECINA", "PROMOPAPA", "JORDY", 
                "EMPANADAS", "NELSON", "EDGAR RAMIREZ", "BOTELLON NUEVO", "BAHIA BLANCA", 
                "YORVY VECINA", "JOSE BURIEL", "AURILUZ", "UNES", "CONSTRUGANGA VALENCIA", 
                "PROF LUISA CALZADILLA", "LUIS", "DARWIN", "MARY CRUZ", "ALIMENTOS EL CASTILLO", 
                "BRYAN", "SUPER S ORIANA", "JUDITH", "YRAIDA MAMA DE DANIEL", "GOYA", 
                "LA PICA", "SRA DALIA", "SRA ANDRY", "YRAIDA", "BAHIA REDONDA", "JOSEFA", 
                "BOTELLON VACIO", "LAS CASITAS", "JESUS HURTADO", "YENNY", "ELIDA", 
                "MERCEDES BARROSO", "SABINO", "PUERTO", "UDO", "NUEVA", "PEDRO PE√ëA", 
                "TATIANA", "MOLORCA", "VILLAS DE MESONES VECINA 2", "INES PEREZ", "MESONES", 
                "GIOVANNY CARPINTERO", "YOLANDA", "CLIENTE COCA COLA", "PLC", "GALPON SUPER S", 
                "CRISTY", "SRA CRUZ", "DANIELA ALBUJAS", "MAMA", "HIERRO CASA", "TRONCONAL 2", 
                "CLIENTE", "DO√ëA"
            ];
            
            uniqueClients.forEach(clientName => {
                clientsData.push({
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                    name: clientName,
                    createdAt: new Date().toISOString()
                });
            });
            
            localStorage.setItem('clientsData', JSON.stringify(clientsData));
        }
        
        function loadPredefinedExpenses() {
            // Lista de gastos optimizada (sin duplicados)
            const uniqueExpenses = [
                { description: "ACEITE PARA LA MOTO", category: "Mantenimiento", amount: 1 },
                { description: "HIELOS", category: "Suministros", amount: 10 },
                { description: "SACOS DE HIELO SR RUBEN", category: "Suministros", amount: 10 },
                { description: "PRECINTOS", category: "Suministros", amount: 1000 },
                { description: "TAPAS", category: "Suministros", amount: 1000 },
                { description: "TAPAS Y EMBUDO BS 3382", category: "Suministros", amount: 1000 },
                { description: "ACEITES MOTO", category: "Mantenimiento", amount: 2 },
                { description: "25 L GASOLINA", category: "Transporte", amount: 25 },
                { description: "25 SACOS DE HIELO", category: "Suministros", amount: 25 },
                { description: "25$ PARA MERI", category: "Personal", amount: 25 },
                { description: "26 HIELOS", category: "Suministros", amount: 26 },
                { description: "500 TAPAS Y 500 PRECINTOS", category: "Suministros", amount: 500 },
                { description: "ABONO CAUCHO JEFFREY", category: "Mantenimiento", amount: 1 },
                { description: "ABONO DEUDA DE MOTO A JEFFREY, RESTO 40$", category: "Mantenimiento", amount: 40 },
                { description: "ACEITE MOTO", category: "Mantenimiento", amount: 1 },
                { description: "ACEITE MOTO 2 POTES", category: "Mantenimiento", amount: 2 },
                { description: "ACEITE MOTO 900 BS", category: "Mantenimiento", amount: 900 },
                { description: "AGARRA BOTELLON", category: "Suministros", amount: 1 },
                { description: "AGUA", category: "Suministros", amount: 1 },
                { description: "AGUA MINERAL BS 67", category: "Suministros", amount: 67 },
                { description: "AJUSTE DE CAMBIOS A LA MOTO", category: "Mantenimiento", amount: 1 },
                { description: "ALIMENTO PARA POLLOS", category: "Otros", amount: 1 },
                { description: "ALMUERZO POLLO", category: "Personal", amount: 1 },
                { description: "ALQUILER ENERO Y FEBRERO", category: "Otros", amount: 1 },
                { description: "ALQUILER LOCAL", category: "Otros", amount: 1 },
                { description: "ALQUILER LOCAL MAYO, JUNIO, JULIO", category: "Otros", amount: 1 },
                { description: "ANIME PARA LA CAVA", category: "Suministros", amount: 1 },
                { description: "APORTE ABUELA ADELA MTTO CASA", category: "Personal", amount: 1 },
                { description: "ARREGLO MAQUINA DE COSER", category: "Mantenimiento", amount: 1 },
                { description: "BELTRAN", category: "Otros", amount: 1 },
                { description: "BELTRAN MADERA", category: "Suministros", amount: 1 },
                { description: "BELTRAN MADERA CAVA", category: "Suministros", amount: 1 },
                { description: "BENNY", category: "Personal", amount: 1 },
                { description: "BENNY  ENERO 210$", category: "Personal", amount: 210 },
                { description: "BENNY 10$", category: "Personal", amount: 10 },
                { description: "BENNY 100$", category: "Personal", amount: 100 },
                { description: "BENNY 20$", category: "Personal", amount: 20 },
                { description: "BENNY 25$", category: "Personal", amount: 25 },
                { description: "BENNY 30$", category: "Personal", amount: 30 },
                { description: "BENNY 300$", category: "Personal", amount: 300 },
                { description: "BENNY 300USDT", category: "Personal", amount: 300 },
                { description: "BENNY 40$", category: "Personal", amount: 40 },
                { description: "BENNY 85$", category: "Personal", amount: 85 },
                { description: "BENNY FEBRERO", category: "Personal", amount: 1 },
                { description: "BENNY PAGO DE AGOSTO", category: "Personal", amount: 1 },
                { description: "BENNY PAGO DE DICIEMBRE 260$", category: "Personal", amount: 260 },
                { description: "BENNY PAGO DE SEPT", category: "Personal", amount: 1 },
                { description: "BENNY, PAGO DEL MES DE JULIO", category: "Personal", amount: 1 },
                { description: "BIOPAGO", category: "Otros", amount: 1 },
                { description: "BOMBA", category: "Mantenimiento", amount: 1 },
                { description: "BROCHA, RAMPLUS, BASES DE RODILLO", category: "Suministros", amount: 1 },
                { description: "BUJIA", category: "Mantenimiento", amount: 1 },
                { description: "BUJIA MOTO", category: "Mantenimiento", amount: 1 },
                { description: "CAMBIO DE ACEITE A MOTO Y COMPRA DE GUAYA DE VELOCIDAD", category: "Mantenimiento", amount: 1 },
                { description: "CAMBIO DE ACEITE MOTO", category: "Mantenimiento", amount: 1 },
                { description: "CARDAN", category: "Mantenimiento", amount: 1 },
                { description: "CASCO", category: "Suministros", amount: 1 },
                { description: "CAUCHERA", category: "Mantenimiento", amount: 1 },
                { description: "CAUCHO", category: "Mantenimiento", amount: 1 },
                { description: "CAUCHO DELANTERO ESPICHADO", category: "Mantenimiento", amount: 1 },
                { description: "CAUCHO MOTO REPARACION", category: "Mantenimiento", amount: 1 },
                { description: "CAUCHO NUEVO", category: "Mantenimiento", amount: 1 },
                { description: "CEPILLO LAVA BOTELLONES", category: "Suministros", amount: 1 },
                { description: "CEPILLOS LAVA BOTELLONES", category: "Suministros", amount: 1 },
                { description: "CHICHAS 60BS CADA UNA", category: "Personal", amount: 60 },
                { description: "CODO, JUNTA, TEFLON, PEGA PVC", category: "Suministros", amount: 1 },
                { description: "COLABORACION LEYDY BENNY", category: "Personal", amount: 1 },
                { description: "COMISION COMPRA DE 100$ ‚Ä¶BS 300", category: "Otros", amount: 300 },
                { description: "COMISION COMPRA DE 20$ ‚Ä¶BS 60", category: "Otros", amount: 60 },
                { description: "COMISION PAGO MOVIL", category: "Otros", amount: 1 },
                { description: "COMISION POR RETIRO DE DIVISAS BCO MERCANTIL", category: "Otros", amount: 1 },
                { description: "COMPLEMENTO CAJAS DE AGUA", category: "Suministros", amount: 1 },
                { description: "COMPLEMENTO INSTALAC DE CAUCHO NUEV", category: "Mantenimiento", amount: 1 },
                { description: "COMPLETAR LOS 100$ DE MIGUEL", category: "Personal", amount: 100 },
                { description: "COMPRA DE 100$ PARA BENNY TASA 125", category: "Personal", amount: 100 },
                { description: "COMPRA DE 20$ BS 2000", category: "Otros", amount: 2000 },
                { description: "COMPRA DE 20$ BS 2200", category: "Otros", amount: 2200 },
                { description: "COMPRA DE 50$ BENNY TASA 130BS", category: "Personal", amount: 50 },
                { description: "COMPRA DE 80$", category: "Otros", amount: 80 },
                { description: "COMPRA DE FERRETERIA", category: "Suministros", amount: 1 },
                { description: "COMPRA DE HIELO", category: "Suministros", amount: 1 },
                { description: "COMPRA DE MATERIALES PARA CIERRE ESCOLAR DE ELIEZER", category: "Suministros", amount: 1 },
                { description: "COMPRA FILTROS", category: "Suministros", amount: 1 },
                { description: "COPIA DE LLAVES", category: "Suministros", amount: 1 },
                { description: "COPIAS E IMPRESIONES", category: "Suministros", amount: 1 },
                { description: "CREMALLERA MOTO", category: "Mantenimiento", amount: 1 },
                { description: "CRUCETA PARA LA MOTO", category: "Mantenimiento", amount: 1 },
                { description: "DANNY CAVA", category: "Suministros", amount: 1 },
                { description: "DETERGENTE LIQUIDO", category: "Suministros", amount: 1 },
                { description: "EFECTIVO EN EL MES", category: "Otros", amount: 1 },
                { description: "EMILIANO 10$", category: "Personal", amount: 10 },
                { description: "ENTREGAS", category: "Transporte", amount: 1 },
                { description: "ENVIO DE TAPAS", category: "Transporte", amount: 1 },
                { description: "ESCOBA Y MATERIALES DE LIMPIEZA", category: "Suministros", amount: 1 },
                { description: "ESCOBA, 250ML DE LAVAPLATOS, DETERGENTE LIQUIDO Y DESINFECT", category: "Suministros", amount: 1 },
                { description: "ESCOBILLON Y MATERIAL DE LIMPIEZA", category: "Suministros", amount: 1 },
                { description: "ESPONJAS", category: "Suministros", amount: 1 },
                { description: "ESTOPERA MOTO", category: "Mantenimiento", amount: 1 },
                { description: "EXCEDENTE FERRETERIA LOCAL", category: "Suministros", amount: 1 },
                { description: "EXTRA REP MOTO", category: "Mantenimiento", amount: 1 },
                { description: "FABRICIO", category: "Personal", amount: 1 },
                { description: "FILTROS", category: "Suministros", amount: 1 },
                { description: "FLETE", category: "Transporte", amount: 1 },
                { description: "FLETE 14$", category: "Transporte", amount: 14 },
                { description: "FLETE 6$", category: "Transporte", amount: 6 },
                { description: "FLETE COLCHORIENTE", category: "Transporte", amount: 1 },
                { description: "FLETE DE TAPAS", category: "Transporte", amount: 1 },
                { description: "FLETE DIMAX", category: "Transporte", amount: 1 },
                { description: "FLETE ENTREGA COLCHORIENTE", category: "Transporte", amount: 1 },
                { description: "FLETE LUIS 12$", category: "Transporte", amount: 12 },
                { description: "FLETE SR OSCAR SE LE DEBE UNO DE ABRIL", category: "Transporte", amount: 1 },
                { description: "FOTOCOPIAS DOCUMENTOS DEL SENIAT", category: "Suministros", amount: 1 },
                { description: "GASOLINA", category: "Transporte", amount: 1 },
                { description: "GASOLINA 25 LITROS", category: "Transporte", amount: 25 },
                { description: "GASOLINA 25L", category: "Transporte", amount: 25 },
                { description: "GASOLINA PARA LA MOTO", category: "Transporte", amount: 1 },
                { description: "HIELO", category: "Suministros", amount: 1 },
                { description: "HIPOCLORITO", category: "Suministros", amount: 1 },
                { description: "IMPRESI√ìN", category: "Suministros", amount: 1 },
                { description: "IMPRESI√ìN DE FLYERS", category: "Suministros", amount: 1 },
                { description: "IMPRESI√ìN NOTAS DE ENTREGA Y COPIA", category: "Suministros", amount: 1 },
                { description: "IMPRESIONES", category: "Suministros", amount: 1 },
                { description: "IMPRESIONES NOTAS DE ENTREGA", category: "Suministros", amount: 1 },
                { description: "INSTALACION DE CAUCHO", category: "Mantenimiento", amount: 1 },
                { description: "IVA DE  OCTUBRE", category: "Otros", amount: 1 },
                { description: "IVA DE ABRIL", category: "Otros", amount: 1 },
                { description: "IVA DE JUNIO", category: "Otros", amount: 1 },
                { description: "IVA DE MAYO", category: "Otros", amount: 1 },
                { description: "IVA DE NOVIEMBRE", category: "Otros", amount: 1 },
                { description: "IVA ENERO", category: "Otros", amount: 1 },
                { description: "IVA FEBRERO", category: "Otros", amount: 1 },
                { description: "IVA JUNIO", category: "Otros", amount: 1 },
                { description: "JEFFREY", category: "Personal", amount: 1 },
                { description: "JEFFREY 1 BOTELLON PALACIO DE JUSTICIA", category: "Personal", amount: 1 },
                { description: "JEFFREY 1 PROMO PAPA", category: "Personal", amount: 1 },
                { description: "JEFFREY ABONO POR COMPRA DE CAUCHO", category: "Personal", amount: 1 },
                { description: "JEFFREY BS 100", category: "Personal", amount: 100 },
                { description: "JEFFREY BS 500", category: "Personal", amount: 500 },
                { description: "JEFFREY CONSUMO EN EFECTIVO", category: "Personal", amount: 1 },
                { description: "JEFFREY DIONIS", category: "Personal", amount: 1 },
                { description: "JEFFREY EN EFECTIVO PERDIO SU TLF", category: "Personal", amount: 1 },
                { description: "JEFFREY JULIO", category: "Personal", amount: 1 },
                { description: "JEFFREY PAGO", category: "Personal", amount: 1 },
                { description: "JEFFREY PAGO PALACIO DE JUSTICIA", category: "Personal", amount: 1 },
                { description: "JEFFREY PAGO POR SU INVERSION EN EL HIELO DEL 23,24 Y 25 DE MAYO", category: "Personal", amount: 1 },
                { description: "JEFFREY PAGO SRA IRAIDA", category: "Personal", amount: 1 },
                { description: "JEFFREY PROMO PAPA", category: "Personal", amount: 1 },
                { description: "JEFFREY RECARGA PALACIO DE JUSTICIA", category: "Personal", amount: 1 },
                { description: "JEFFREY SEPTIEMBRE", category: "Personal", amount: 1 },
                { description: "JEFFREY SRA IRAIDA", category: "Personal", amount: 1 },
                { description: "JEFFREY, COMPENSACION POR SU APORTE EN LA ADQUISICION DE LA MOTO", category: "Personal", amount: 1 },
                { description: "JEFFREY, FONDO DE BOTELLONES", category: "Personal", amount: 1 },
                { description: "JEFFREY, REPARACION PARA LA MOTO", category: "Personal", amount: 1 },
                { description: "JUAN CARLOS, REGISTRO DE AQUANEV", category: "Otros", amount: 1 },
                { description: "LAVAPLATOS", category: "Suministros", amount: 1 },
                { description: "LILIANA", category: "Personal", amount: 1 },
                { description: "LLAVES DE AGUA", category: "Suministros", amount: 1 },
                { description: "LLAVES DE PASO", category: "Suministros", amount: 1 },
                { description: "LLAVES REPUESTOS", category: "Suministros", amount: 1 },
                { description: "MAMA", category: "Personal", amount: 1 },
                { description: "MAMA GASTO POR RICHARD 1200 BS", category: "Personal", amount: 1200 },
                { description: "MAMA PAGO POR BENNY", category: "Personal", amount: 1 },
                { description: "MAMA VIAJE A BOLIVAR", category: "Personal", amount: 1 },
                { description: "MANO DE OBRA MOTO", category: "Mantenimiento", amount: 1 },
                { description: "MANO DE OBRA MOTO 40$ NACHO", category: "Mantenimiento", amount: 40 },
                { description: "MARCADORES", category: "Suministros", amount: 1 },
                { description: "MATERIAL PARA LA CAVA", category: "Suministros", amount: 1 },
                { description: "MATERIALES TUBERIAS", category: "Suministros", amount: 1 },
                { description: "MAURO CABEZA", category: "Personal", amount: 1 },
                { description: "MAURO ODONTOLOGO", category: "Personal", amount: 1 },
                { description: "MECANICO", category: "Mantenimiento", amount: 1 },
                { description: "MECANICO AJUSTE", category: "Mantenimiento", amount: 1 },
                { description: "MECANICO AJUSTE CROCHE", category: "Mantenimiento", amount: 1 },
                { description: "MEDIDOR DE PH Y CLORO", category: "Suministros", amount: 1 },
                { description: "MENSUALIDAD MERCADO DICIEMBRE", category: "Personal", amount: 1 },
                { description: "MENSUALIDAD MERCADO NOVIEMBRE", category: "Personal", amount: 1 },
                { description: "MENSUALIDAD MERCADO SEPTIEMBRE Y OCTUBRE", category: "Personal", amount: 1 },
                { description: "MERI", category: "Personal", amount: 1 },
                { description: "MERI ADELANTO OCTUBRE", category: "Personal", amount: 1 },
                { description: "MERI MEDICAMENTOS", category: "Personal", amount: 1 },
                { description: "MERI PAGO", category: "Personal", amount: 1 },
                { description: "MERI PAGO DE JULIO", category: "Personal", amount: 1 },
                { description: "MERI PASAJE", category: "Personal", amount: 1 },
                { description: "MERI SEPTIEMBRE", category: "Personal", amount: 1 },
                { description: "MERI VIAJE A BOLIVAR PAGO DE COMIDA Y PASAJE DE RETORNO", category: "Personal", amount: 1 },
                { description: "MERIZARETH", category: "Personal", amount: 1 },
                { description: "MES DE ALQUILER ABRIL", category: "Otros", amount: 1 },
                { description: "MICROFILTROS", category: "Suministros", amount: 1 },
                { description: "MICROFILTROS 1 Y 5 MICRAS", category: "Suministros", amount: 1 },
                { description: "MOTO MANTENIMIENTO TRANSPORTE BS 10.000", category: "Mantenimiento", amount: 10000 },
                { description: "MOTO REVISION NACHO", category: "Mantenimiento", amount: 1 },
                { description: "MRW JEFFREY", category: "Transporte", amount: 1 },
                { description: "OTROS", category: "Otros", amount: 1 },
                { description: "PAGO A BENNY", category: "Personal", amount: 1 },
                { description: "PAGO A FABRICIO", category: "Personal", amount: 1 },
                { description: "PAGO A MECANICO DE MOTO 70$", category: "Mantenimiento", amount: 70 },
                { description: "PAGO A MIGUEL 280$", category: "Personal", amount: 280 },
                { description: "PAGO DE 20 HIELOS", category: "Suministros", amount: 20 },
                { description: "PAGO DE JEFFREY POR INVERSION (BS. 7260)", category: "Personal", amount: 7260 },
                { description: "PAGO DE JEFFREY POR INVERSION (BS. 8324)", category: "Personal", amount: 8324 },
                { description: "PAGO DEL IVA MES DE ABRIL BS. 1198,25", category: "Otros", amount: 1198.25 },
                { description: "PAGO JEFFREY POR 1845BS (ABONO DE GAS ANZ DE 66,54% DE SEMANA 4)", category: "Personal", amount: 1845 },
                { description: "PAGO MECANICO", category: "Mantenimiento", amount: 1 },
                { description: "PAGO MENSUALIDAD DEL LOCAL", category: "Otros", amount: 1 },
                { description: "PAGO MRW POR RECEPCION DE CEPILLOS LAVABOTELLONES", category: "Transporte", amount: 1 },
                { description: "PAGO SEMANA 4 JEFFREY BS 982,13 TASA 36,4311", category: "Personal", amount: 982.13 },
                { description: "PAGO SEMANA 5 JEFFREY BS 630,64 TASA 36,4311", category: "Personal", amount: 630.64 },
                { description: "PAGO SR FRANCISCO", category: "Personal", amount: 1 },
                { description: "PAGO SR OSCAR BS 500", category: "Personal", amount: 500 },
                { description: "PAGO WIFI", category: "Otros", amount: 1 },
                { description: "PAPAS DE CARNE", category: "Personal", amount: 1 },
                { description: "PASAJE", category: "Transporte", amount: 1 },
                { description: "PASAJE EMILIANO", category: "Transporte", amount: 1 },
                { description: "PASAJE JEFFREY", category: "Transporte", amount: 1 },
                { description: "PASAJES MAMA CASA ABUELA", category: "Transporte", amount: 1 },
                { description: "PASAJES Y TAXI VISITA DE JESSEY", category: "Transporte", amount: 1 },
                { description: "PATA DE CAMBIO MOTO", category: "Mantenimiento", amount: 1 },
                { description: "PISTOLA DE CALOR", category: "Suministros", amount: 1 },
                { description: "PISTOLA DE CALOR 35$ EFECTIVO", category: "Suministros", amount: 35 },
                { description: "PODA DE MONTE", category: "Otros", amount: 1 },
                { description: "POTES DE ACEITE PARA LA MOTO", category: "Mantenimiento", amount: 1 },
                { description: "PUBLICACI√ìN AQUANEV", category: "Otros", amount: 1 },
                { description: "RASTRILLO Y PALA", category: "Suministros", amount: 1 },
                { description: "RECARGAS", category: "Suministros", amount: 1 },
                { description: "RELE DE BOMBA", category: "Mantenimiento", amount: 1 },
                { description: "REMACHES Y REPARACION MOTO", category: "Mantenimiento", amount: 1 },
                { description: "RENTA BIOPAGO", category: "Otros", amount: 1 },
                { description: "RENTA TLF", category: "Otros", amount: 1 },
                { description: "RENTA TLF MERI", category: "Otros", amount: 1 },
                { description: "REPARACION DE CAUCHO", category: "Mantenimiento", amount: 1 },
                { description: "REPARACION DE MOTO FILTRO", category: "Mantenimiento", amount: 1 },
                { description: "REPARACION DE MOTO TOTAL 130$", category: "Mantenimiento", amount: 130 },
                { description: "REPARACION SENSOR DE LA BOMBA", category: "Mantenimiento", amount: 1 },
                { description: "RETIRO EN ZOOM", category: "Otros", amount: 1 },
                { description: "REVISION MOTO", category: "Mantenimiento", amount: 1 },
                { description: "ROLINERAS MOTO", category: "Mantenimiento", amount: 1 },
                { description: "SELLO", category: "Suministros", amount: 1 },
                { description: "SENIAT IVA", category: "Otros", amount: 1 },
                { description: "SOL", category: "Personal", amount: 1 },
                { description: "SOL MES DE JULIO", category: "Personal", amount: 1 },
                { description: "SOL PAGO", category: "Personal", amount: 1 },
                { description: "SOL SEGUNDA QUINCENA DE JUNIO", category: "Personal", amount: 1 },
                { description: "SOLDADURA MOTO", category: "Mantenimiento", amount: 1 },
                { description: "SOPA", category: "Personal", amount: 1 },
                { description: "SRA IRAIDA DOS VECES 6$+5$", category: "Personal", amount: 11 },
                { description: "TALONARIOS DE FACTURA AQUANEV", category: "Suministros", amount: 1 },
                { description: "TANQUE AGUA MOTO", category: "Mantenimiento", amount: 1 },
                { description: "TAPAS", category: "Suministros", amount: 1 },
                { description: "TAPAS Y 8 BOTELLONES AZULES (BS 3650,21)", category: "Suministros", amount: 3650.21 },
                { description: "TAPAS Y PRECINTOS", category: "Suministros", amount: 1 },
                { description: "TRASLADO JEFFREY", category: "Transporte", amount: 1 },
                { description: "TRIPAS PARA LA MOTO CON INSTALACION", category: "Mantenimiento", amount: 1 },
                { description: "VARIACION POR COMPRA DE 50$ TASA MONITOR 39,20 BS BCV 36,3265", category: "Otros", amount: 50 },
                { description: "VENTA DE TRONCONAL", category: "Otros", amount: 1 },
                { description: "ZOOM RECEPCION DE TAPAS", category: "Transporte", amount: 1 }
            ];
            
            uniqueExpenses.forEach(expense => {
                expensesData.push({
                    id: Date.now() + Math.random().toString(36).substr(2, 5),
                    date: new Date().toISOString().split('T')[0],
                    description: expense.description,
                    amount: expense.amount,
                    category: expense.category
                });
            });
            
            localStorage.setItem('expensesData', JSON.stringify(expensesData));
        }

        // ========== VISTA ECUADOR ==========
        function loadEcuadorView() {
            const today    = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay  = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            const monthlySales    = salesData.filter(sale => {
                const d = new Date(sale.date + 'T00:00:00');
                return d >= firstDay && d <= lastDay;
            });
            const monthlyExpenses = expensesData.filter(expense => {
                const d = new Date(expense.date + 'T00:00:00');
                return d >= firstDay && d <= lastDay;
            });
            
            // ‚îÄ‚îÄ Calcular en USD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const totalSalesUSD    = monthlySales.reduce((s, sale) =>
                s + (sale.totalUSD ?? convertBStoUSD(sale.total ?? 0)), 0);
            const totalExpensesUSD = monthlyExpenses.reduce((s, exp) =>
                s + (exp.amountUSD ?? convertBStoUSD(exp.amount ?? 0)), 0);
            const netBalanceUSD    = totalSalesUSD - totalExpensesUSD;
            
            const pendingCreditsUSD = creditsData
                .filter(c => c.status !== 'Pagado')
                .reduce((s, c) => s + getCreditBalanceUSD(c), 0);
            
            // ‚îÄ‚îÄ Stat cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const ecSales    = document.getElementById('ecuador-monthly-sales');
            const ecExp      = document.getElementById('ecuador-monthly-expenses');
            const ecBalance  = document.getElementById('ecuador-net-balance');
            const ecCredits  = document.getElementById('ecuador-pending-credits');
            
            if (ecSales)   ecSales.textContent   = fmtUSD(totalSalesUSD)    + ' USD';
            if (ecExp)     ecExp.textContent      = fmtUSD(totalExpensesUSD) + ' USD';
            if (ecBalance) {
                ecBalance.textContent = fmtUSD(netBalanceUSD) + ' USD';
                ecBalance.style.color = netBalanceUSD >= 0 ? '#4caf50' : '#f44336';
            }
            if (ecCredits) ecCredits.textContent = fmtUSD(pendingCreditsUSD) + ' USD';
            
            // ‚îÄ‚îÄ Resumen mensual (una sola columna USD) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const summaryTbody = document.getElementById('ecuador-summary');
            if (summaryTbody) {
                const totalProducts = monthlySales.reduce((s, sale) =>
                    s + sale.items.reduce((is, item) => is + item.quantity, 0), 0);
                
                summaryTbody.innerHTML = `
                    <tr>
                        <td>Ventas Totales</td>
                        <td>${monthlySales.length}</td>
                        <td>${fmtUSD(totalSalesUSD)} USD</td>
                    </tr>
                    <tr>
                        <td>Productos Vendidos</td>
                        <td>${totalProducts}</td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>Gastos Totales</td>
                        <td>${monthlyExpenses.length}</td>
                        <td>${fmtUSD(totalExpensesUSD)} USD</td>
                    </tr>
                    <tr style="font-weight:700; background:#f8f9fa;">
                        <td>Balance Neto</td>
                        <td>-</td>
                        <td style="color:${netBalanceUSD >= 0 ? '#4caf50' : '#f44336'};">${fmtUSD(netBalanceUSD)} USD</td>
                    </tr>
                    <tr>
                        <td>Cr√©ditos Pendientes</td>
                        <td>${creditsData.filter(c => c.status !== 'Pagado').length}</td>
                        <td style="color:#e74c3c;">${fmtUSD(pendingCreditsUSD)} USD</td>
                    </tr>
                `;
            }
            
            // ‚îÄ‚îÄ Top 10 clientes en USD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const clientTotals = {};
            monthlySales.forEach(sale => {
                const usd = sale.totalUSD ?? convertBStoUSD(sale.total ?? 0);
                if (!clientTotals[sale.customer]) clientTotals[sale.customer] = { totalUSD: 0, count: 0 };
                clientTotals[sale.customer].totalUSD += usd;
                clientTotals[sale.customer].count    += 1;
            });
            
            const topClients = Object.entries(clientTotals)
                .sort((a, b) => b[1].totalUSD - a[1].totalUSD)
                .slice(0, 10);
            
            const topClientsTbody = document.getElementById('top-clients');
            if (topClientsTbody) {
                topClientsTbody.innerHTML = '';
                if (topClients.length === 0) {
                    topClientsTbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#6c757d;">No hay ventas este mes</td></tr>`;
                } else {
                    topClients.forEach(([client, data], i) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${i + 1}</td>
                            <td>${client}</td>
                            <td>${data.count}</td>
                            <td>${fmtUSD(data.totalUSD)} USD</td>
                        `;
                        topClientsTbody.appendChild(row);
                    });
                }
            }
        }
        
        // ========== REPORTES ==========
        function generateReport() {
            const reportType = document.getElementById('report-type').value;
            let startDate, endDate;
            
            const today = new Date();
            
            switch(reportType) {
                case 'daily':
                    startDate = today.toISOString().split('T')[0];
                    endDate = startDate;
                    break;
                case 'weekly':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    startDate = weekAgo.toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'monthly':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'custom':
                    startDate = document.getElementById('start-date').value;
                    endDate = document.getElementById('end-date').value;
                    if (!startDate || !endDate) {
                        alert('Selecciona ambas fechas para el reporte personalizado');
                        return;
                    }
                    break;
            }
            
            const filteredSales = salesData.filter(sale => 
                sale.date >= startDate && sale.date <= endDate
            );
            
            const filteredExpenses = expensesData.filter(expense => 
                expense.date >= startDate && expense.date <= endDate
            );
            
            const totalSalesUSD    = filteredSales.reduce((sum, sale) =>
                sum + (sale.totalUSD ?? convertBStoUSD(sale.total ?? 0)), 0);
            const totalExpensesUSD = filteredExpenses.reduce((sum, expense) =>
                sum + (expense.amountUSD ?? convertBStoUSD(expense.amount ?? 0)), 0);
            const netProfitUSD = totalSalesUSD - totalExpensesUSD;
            const totalProducts = filteredSales.reduce((sum, sale) => {
                return sum + sale.items.reduce((itemSum, item) => itemSum + item.quantity, 0);
            }, 0);
            
            const summary = document.getElementById('report-summary');
            summary.innerHTML = `
                <h3>Resumen del Per√≠odo: ${formatDate(startDate)} - ${formatDate(endDate)}</h3>
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-title">Ventas Totales</div>
                        <div class="stat-value">${fmtUSD(totalSalesUSD)} USD</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Gastos Totales</div>
                        <div class="stat-value">${fmtUSD(totalExpensesUSD)} USD</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Ganancia Neta</div>
                        <div class="stat-value" style="color:${netProfitUSD >= 0 ? '#4caf50' : '#f44336'}">${fmtUSD(netProfitUSD)} USD</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Total Productos</div>
                        <div class="stat-value">${totalProducts}</div>
                    </div>
                </div>
                
                <h4>Ventas por M√©todo de Pago</h4>
                <div class="table-scroll-wrap"><table>
                    <thead>
                        <tr>
                            <th>M√©todo de Pago</th>
                            <th>Total Ventas (USD)</th>
                            <th>Porcentaje</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generatePaymentMethodSummary(filteredSales)}
                    </tbody>
                </table></div>
                
                <h4>Gastos por Categor√≠a</h4>
                <div class="table-scroll-wrap"><table>
                    <thead>
                        <tr>
                            <th>Categor√≠a</th>
                            <th>Total Gastos (USD)</th>
                            <th>Porcentaje</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generateExpenseCategorySummary(filteredExpenses)}
                    </tbody>
                </table></div>
            `;
        }
        
        function generatePaymentMethodSummary(sales) {
            const methodTotals = {};
            let totalUSD = 0;
            
            sales.forEach(sale => {
                const usd = sale.totalUSD ?? convertBStoUSD(sale.total ?? 0);
                if (!methodTotals[sale.paymentMethod]) methodTotals[sale.paymentMethod] = 0;
                methodTotals[sale.paymentMethod] += usd;
                totalUSD += usd;
            });
            
            let html = '';
            for (const method in methodTotals) {
                const percentage = totalUSD > 0 ? ((methodTotals[method] / totalUSD) * 100).toFixed(1) : '0.0';
                html += `
                    <tr>
                        <td>${method}</td>
                        <td>${fmtUSD(methodTotals[method])} USD</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }
            
            return html || '<tr><td colspan="3" style="text-align: center;">No hay datos</td></tr>';
        }
        
        function generateExpenseCategorySummary(expenses) {
            const categoryTotals = {};
            let totalUSD = 0;
            
            expenses.forEach(expense => {
                const usd = expense.amountUSD ?? convertBStoUSD(expense.amount ?? 0);
                if (!categoryTotals[expense.category]) categoryTotals[expense.category] = 0;
                categoryTotals[expense.category] += usd;
                totalUSD += usd;
            });
            
            let html = '';
            for (const category in categoryTotals) {
                const percentage = totalUSD > 0 ?
                    ((categoryTotals[category] / totalUSD) * 100).toFixed(1) : '0.0';
                html += `
                    <tr>
                        <td>${category}</td>
                        <td>${fmtUSD(categoryTotals[category])} USD</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }
            
            return html || '<tr><td colspan="3" style="text-align: center;">No hay datos</td></tr>';
        }
        
        // ========== SISTEMA DE PEDIDOS MEJORADO ==========
        
        // Calcular montos de gastos
        function calculateExpenseAmounts() {
            const amount  = parseFloat(document.getElementById('expense-amount').value) || 0;
            const cat     = document.getElementById('expense-category')?.value || '';
            const doc     = document.getElementById('expense-document-type')?.value || '';

            // IVA no aplica: Personal, Cr√©dito, o cualquier doc que no sea Factura
            const noIva = (cat === 'Personal' || cat === 'Cr√©dito' || doc !== 'Factura');
            const ivaPercent = noIva ? 0 : (parseFloat(document.getElementById('expense-iva')?.value) || 0);

            const base = (noIva || ivaPercent === 0) ? amount : amount / (1 + ivaPercent / 100);
            const iva  = amount - base;

            const elTotalUSD  = document.getElementById('expense-total-usd');
            const elTotalBS   = document.getElementById('expense-total-bs');
            const elBaseBS    = document.getElementById('expense-base-bs');
            const elIvaBS     = document.getElementById('expense-iva-bs');

            if (elTotalUSD)  elTotalUSD.textContent = `$${amount.toFixed(2)} USD`;
            if (elTotalBS)   elTotalBS.textContent  = noIva ? '(sin IVA)' : `IVA: $${iva.toFixed(2)} USD`;
            if (elBaseBS)    elBaseBS.textContent   = base.toFixed(2);
            if (elIvaBS)     elIvaBS.textContent    = iva.toFixed(2);
        }
        
        // Filtrar gastos por fechas
        function filterExpensesByDate() {
            const dateFrom = document.getElementById('expense-filter-from').value;
            const dateTo = document.getElementById('expense-filter-to').value;
            
            if (!dateFrom && !dateTo) {
                loadExpensesHistory();
                return;
            }
            
            const tbody = document.getElementById('expenses-history');
            tbody.innerHTML = '';
            
            let filteredExpenses = expensesData;
            if (dateFrom) filteredExpenses = filteredExpenses.filter(e => e.date >= dateFrom);
            if (dateTo)   filteredExpenses = filteredExpenses.filter(e => e.date <= dateTo);
            
            if (filteredExpenses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #6c757d;">
                            No hay gastos en el per√≠odo seleccionado
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredExpenses.forEach(expense => {
                const totalUSD    = expense.amountUSD ?? convertBStoUSD(expense.amount ?? 0);
                const invoiceInfo = expense.invoiceNumber ? `<br><small>Fact. ${expense.invoiceNumber}</small>` : '';

                let extraDetail = '';
                if (expense.category === 'Compras' && expense.comprasItems?.length) {
                    const itemsList = expense.comprasItems.map(it =>
                        `<div style="font-size:11px;color:#2e7d32;">‚Ä¢ ${it.cantidad} √ó ${it.nombre} @ $${it.costoUnitarioUSD.toFixed(2)} = $${it.subtotalUSD.toFixed(2)}</div>`
                    ).join('');
                    extraDetail = `<div style="margin-top:4px;background:#f1f8e9;border-radius:4px;padding:4px 6px;">${itemsList}</div>`;
                } else if (expense.category === 'Cr√©dito' && expense.creditoRef) {
                    const ref = expense.creditoRef;
                    const tipoBadge = ref.tipoPago === 'parcial'
                        ? `<span style="background:#ff9800;color:white;border-radius:4px;padding:1px 6px;font-size:10px;">PARCIAL</span>`
                        : `<span style="background:#4caf50;color:white;border-radius:4px;padding:1px 6px;font-size:10px;">COMPLETO</span>`;
                    const saldoInfo = ref.tipoPago === 'parcial'
                        ? ` ¬∑ saldo cuota: $${(ref.saldoCuota - ref.montoPagadoUSD).toFixed(2)}` : '';
                    extraDetail = `<div style="font-size:11px;color:#3f51b5;margin-top:3px;">Cuota #${ref.nroCuota} ${tipoBadge}${saldoInfo}</div>`;
                } else if (expense.category === 'Personal') {
                    extraDetail = `<div style="font-size:11px;color:#7b1fa2;margin-top:3px;">üë§ Salario/Sueldo - sin IVA</div>`;
                }

                const badgeColors = { 'Compras':'#4caf50','Transporte':'#2196f3','Suministros':'#00bcd4','Mantenimiento':'#ff9800','Personal':'#9c27b0','Hielo':'#03a9f4','Cr√©dito':'#3f51b5','Otros':'#607d8b' };
                const badgeColor = badgeColors[expense.category] || '#607d8b';
                const categoryBadge = `<span class="badge" style="background:${badgeColor};color:white;">${expense.category}</span>`;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(expense.date)}</td>
                    <td><strong>${expense.description}</strong>${invoiceInfo}${extraDetail}</td>
                    <td>${categoryBadge}</td>
                    <td><strong>$${totalUSD.toFixed(2)} USD</strong>${(expense.iva > 0) ? `<br><small>IVA ${expense.iva}%</small>` : '<br><small style="color:#9e9e9e;">Sin IVA</small>'}</td>
                    <td><small>${expense.documentType || 'N/A'}</small></td>
                    <td>
                        <button class="btn btn-small btn-danger" onclick="deleteExpense(${expense.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Cargar selector de clientes en pedidos
        function loadOrderCustomerSelect() {
            const select = document.getElementById('order-customer');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleccionar cliente</option>';
            
            const sortedClients = [...clientsData].sort((a, b) => a.name.localeCompare(b.name, 'es'));
            
            sortedClients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.name;
                option.textContent = client.name;
                select.appendChild(option);
            });
        }
        
        // Agregar producto al pedido
        function addProductToOrder() {
            const productDiv = document.createElement('div');
            productDiv.className = 'order-product-item';
            productDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';

            const productIndex = currentOrderProducts.length;

            productDiv.innerHTML = `
                <select class="order-product-select" data-index="${productIndex}" style="flex: 2;">
                    ${getProductOptionsHTML()}
                </select>
                <input type="number" class="order-product-quantity" data-index="${productIndex}"
                       min="1" value="1" placeholder="Cant." style="flex: 1;" inputmode="decimal">
                <button type="button" class="btn btn-danger btn-small" onclick="removeProductFromOrder(${productIndex})">
                    <i class="fas fa-times"></i>
                </button>
            `;

            document.getElementById('order-products-list').appendChild(productDiv);
            currentOrderProducts.push({ product: '', quantity: 1 });
        }
        
        // Obtener nombre de producto para mostrar - din√°mico (waterPrices + inventario + kits)
        function getProductDisplayName(productKey) {
            // 1. waterPrices (productos base)
            if (waterPrices[productKey]) {
                const info = getProductInfo(productKey);
                if (info && info.name) return info.name;
            }
            // 2. inventoryData (productos sin vincular a waterPrices)
            const invItem = inventoryData.find(i => i.productoKey === productKey);
            if (invItem) return invItem.nombre;
            // 3. Kits
            const kit = productosCompuestos.find(k => k.key === productKey);
            if (kit) return 'üß© ' + kit.nombre;
            // Fallback
            return productKey;
        }

        // Construir <option> HTML para TODOS los productos disponibles
        // Usado en Pedidos y cualquier selector que necesite lista completa
        function getProductOptionsHTML(selected) {
            const sel = selected || '';
            let opts = '<option value="">Seleccionar producto‚Ä¶</option>';

            // Secci√≥n: productos base waterPrices
            const wpKeys = Object.keys(waterPrices);
            if (wpKeys.length > 0) {
                opts += '<optgroup label="üíß Productos Base">';
                wpKeys.forEach(k => {
                    const name = getProductDisplayName(k);
                    const price = waterPrices[k].priceUSD || 0;
                    opts += `<option value="${k}" ${sel===k?'selected':''}>${name} - $${price.toFixed(2)}</option>`;
                });
                opts += '</optgroup>';
            }

            // Secci√≥n: inventario no vinculado a waterPrices
            const invSueltos = inventoryData.filter(i => !i.vinculadoA || !waterPrices[i.vinculadoA]);
            if (invSueltos.length > 0) {
                opts += '<optgroup label="üì¶ Inventario">';
                invSueltos.forEach(i => {
                    const precio = getPrecioVentaInventario ? getPrecioVentaInventario(i) : (i.costoPromedioUSD || 0);
                    opts += `<option value="${i.productoKey}" ${sel===i.productoKey?'selected':''}>${i.nombre} (stock: ${i.stockActual}) - $${precio.toFixed(2)}</option>`;
                });
                opts += '</optgroup>';
            }

            // Secci√≥n: kits activos
            const kitsActivos = productosCompuestos.filter(k => k.activo !== false);
            if (kitsActivos.length > 0) {
                opts += '<optgroup label="üß© Kits / Compuestos">';
                kitsActivos.forEach(k => {
                    const stock = calcularStockKit(k);
                    opts += `<option value="${k.key}" ${sel===k.key?'selected':''}>${k.nombre} (stock: ${stock}) - $${(k.precioVentaUSD||0).toFixed(2)}</option>`;
                });
                opts += '</optgroup>';
            }

            return opts;
        }

        // Refrescar todos los selectores de productos en m√≥dulo Pedidos
        function refreshOrderProductSelects() {
            document.querySelectorAll('.order-product-select').forEach(sel => {
                const current = sel.value;
                sel.innerHTML = getProductOptionsHTML(current);
            });
        }
        
        // Remover producto del pedido
        function removeProductFromOrder(index) {
            const items = document.querySelectorAll('.order-product-item');
            if (items[index]) {
                items[index].remove();
            }
            currentOrderProducts.splice(index, 1);
            updateOrderProductsIndexes();
        }
        
        // Actualizar √≠ndices despu√©s de remover
        function updateOrderProductsIndexes() {
            const items = document.querySelectorAll('.order-product-item');
            items.forEach((item, newIndex) => {
                const select = item.querySelector('.order-product-select');
                const input = item.querySelector('.order-product-quantity');
                const button = item.querySelector('button');
                
                select.dataset.index = newIndex;
                input.dataset.index = newIndex;
                button.onclick = () => removeProductFromOrder(newIndex);
            });
        }
        
        // Recopilar productos del pedido
        function collectOrderProducts() {
            const products = [];
            const selects = document.querySelectorAll('.order-product-select');
            const quantities = document.querySelectorAll('.order-product-quantity');
            
            selects.forEach((select, index) => {
                const productKey = select.value;
                const quantity = parseInt(quantities[index].value) || 0;
                
                if (productKey && quantity > 0) {
                    products.push({
                        product: productKey,
                        productName: getProductDisplayName(productKey),
                        quantity: quantity
                    });
                }
            });
            
            return products;
        }
        
        // Convertir pedido a venta
        function convertOrderToSale(orderId) {
            const order = ordersData.find(o => o.id === orderId);
            if (!order) return;
            
            if (order.status !== 'Entregado') {
                if (!confirm('Este pedido no est√° marcado como Entregado. ¬øContinuar de todos modos?')) {
                    return;
                }
            }
            
            // Precargar datos en formulario de ventas
            currentSaleItems = [];
            
            order.products.forEach(item => {
                const productInfo = getProductInfo(item.product);
                if (productInfo && productInfo.name) {
                    currentSaleItems.push({
                        productKey: item.product,
                        name: productInfo.name,
                        priceUSD: productInfo.priceUSD,
                        priceBS: productInfo.priceBS,
                        quantity: item.quantity,
                        hasIva: productInfo.hasIva
                    });
                }
            });
            
            // Cambiar a pesta√±a ventas
            showTab('sales');
            
            // Precargar cliente
            document.getElementById('customer-name').value = order.customer;
            document.getElementById('sale-notes').value = `Pedido #${order.id} - ${order.notes || ''}`;
            
            updateSaleDisplay();
            
            alert('‚úÖ Pedido cargado en ventas. Completa los datos y guarda.');
        }
        
        // Cambiar estado de pedido
        function changeOrderStatus(orderId, newStatus) {
            const orderIndex = ordersData.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return;
            
            // Si cambia a Cancelado, eliminar permanentemente
            if (newStatus === 'Cancelado') {
                if (confirm('¬øEst√°s seguro de cancelar este pedido? Se eliminar√° permanentemente.')) {
                    ordersData.splice(orderIndex, 1);
                    localStorage.setItem('ordersData', JSON.stringify(ordersData));
                    loadOrdersHistory();
                    alert('‚úÖ Pedido cancelado y eliminado');
                }
                return;
            }
            
            ordersData[orderIndex].status = newStatus;
            localStorage.setItem('ordersData', JSON.stringify(ordersData));
            
            loadOrdersHistory();
            
            if (newStatus === 'Entregado') {
                if (confirm('¬øDeseas convertir este pedido en una venta ahora?')) {
                    convertOrderToSale(orderId);
                }
            }
        }
        
        // ========== SISTEMA DE ADELANTOS ==========
        
        // Cargar clientes en selector de adelantos
        function loadAdelantosClientes() {
            const select = document.getElementById('adelanto-cliente');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleccionar cliente</option>';
            
            clientsData.forEach(client => {
                const option = document.createElement('option');
                option.value = client.name;
                option.textContent = client.name;
                select.appendChild(option);
            });
        }
        
        // Registrar adelanto de cliente
        function registrarAdelantoCliente(e) {
            e.preventDefault();
            
            const cliente    = document.getElementById('adelanto-cliente').value;
            const montoUSD   = parseFloat(document.getElementById('adelanto-monto').value);
            const fecha      = document.getElementById('adelanto-fecha').value;
            const formaPago  = document.getElementById('adelanto-forma-pago').value;
            const concepto   = document.getElementById('adelanto-concepto').value;
            
            if (!cliente || !montoUSD || !fecha || !formaPago) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            if (montoUSD <= 0) { alert('El monto debe ser mayor a 0'); return; }
            
            // Compatibilidad: guardar monto en BS (sistema interno) y USD
            const montoBS = convertUSDtoBS(montoUSD);
            
            const adelanto = {
                id:        Date.now(),
                cliente:   cliente,
                monto:     montoBS,      // legacy BS - usado por calculateFiscalBreakdown
                montoUSD:  montoUSD,
                saldo:     montoBS,
                saldoUSD:  montoUSD,
                usado:     0,
                usadoUSD:  0,
                fecha:     fecha,
                formaPago: formaPago,
                concepto:  concepto,
                status:    'Activo',
                usos:      []
            };
            
            adelantosClientes.unshift(adelanto);
            localStorage.setItem('adelantosClientes', JSON.stringify(adelantosClientes));
            
            loadAdelantosClientesList();
            document.getElementById('adelanto-cliente-form').reset();
            alert(`‚úÖ Adelanto registrado: ${fmtUSD(montoUSD)} USD`);
        }
        
        // ‚îÄ‚îÄ Helpers USD para adelantos (nuevos y legado sin montoUSD) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function getAdelantoMontoUSD(a)  { return a.montoUSD  ?? convertBStoUSD(a.monto  || 0); }
        function getAdelantoSaldoUSD(a)  { return a.saldoUSD  ?? convertBStoUSD(a.saldo  || 0); }
        function getAdelantoUsadoUSD(a)  { return a.usadoUSD  ?? convertBStoUSD(a.usado  || 0); }
        // Hielo
        function getHieloMontoUSD(a)    { return a.montoUSD        ?? convertBStoUSD(a.monto           || 0); }
        function getHieloSaldoUSD(a) {
            // Usa saldoDisponibleUSD si existe y es un n√∫mero positivo v√°lido
            const usd = a.saldoDisponibleUSD;
            if (typeof usd === 'number' && !isNaN(usd) && usd >= 0) return usd;
            // Fallback: convertir campo BS (compatibilidad con adelantos antiguos)
            return Math.max(0, convertBStoUSD(a.saldoDisponible || 0));
        }
        function getHieloGastadoUSD(a)  { return a.gastadoUSD      ?? convertBStoUSD(a.gastado         || 0); }

        // Cargar lista de adelantos de clientes
        function loadAdelantosClientesList() {
            const tbody = document.getElementById('adelantos-clientes-list');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const activos = adelantosClientes.filter(a => a.status === 'Activo' && a.saldo > 0);
            
            if (activos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #6c757d;">
                            No hay adelantos activos
                        </td>
                    </tr>
                `;
                return;
            }
            
            activos.forEach(adelanto => {
                const row = document.createElement('tr');
                const statusClass = adelanto.saldo > 0 ? 'badge-success' : 'badge-warning';
                
                row.innerHTML = `
                    <td>${adelanto.cliente}</td>
                    <td>${formatDate(adelanto.fecha)}</td>
                    <td>${fmtUSD(getAdelantoMontoUSD(adelanto))}</td>
                    <td>${fmtUSD(getAdelantoUsadoUSD(adelanto))}</td>
                    <td><strong>${fmtUSD(getAdelantoSaldoUSD(adelanto))}</strong></td>
                    <td>${adelanto.formaPago}</td>
                    <td><span class="badge ${statusClass}">${adelanto.status}</span></td>
                    <td>
                        <button class="btn btn-small btn-primary" onclick="verHistorialAdelanto(${adelanto.id})">
                            <i class="fas fa-history"></i> Historial
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Verificar si cliente tiene adelanto disponible
        function verificarAdelantoCliente(cliente) {
            const adelantos = adelantosClientes.filter(a => 
                a.cliente === cliente && 
                a.status === 'Activo' && 
                a.saldo > 0
            );
            
            if (adelantos.length > 0) {
                const totalDisponible = adelantos.reduce((sum, a) => sum + a.saldo, 0);
                return {
                    tiene: true,
                    saldo: totalDisponible,
                    adelantos: adelantos
                };
            }
            
            return { tiene: false, saldo: 0 };
        }
        
        // Usar adelanto en una venta
        function usarAdelantoEnVenta(cliente, montoVenta) {
            const adelantosDisp = adelantosClientes.filter(a => 
                a.cliente === cliente && 
                a.status === 'Activo' && 
                a.saldo > 0
            );
            
            if (adelantosDisp.length === 0) {
                return false;
            }
            
            let montoRestante = montoVenta;
            const usos = [];
            
            for (const adelanto of adelantosDisp) {
                if (montoRestante <= 0) break;
                
                const montoAUsar = Math.min(adelanto.saldo, montoRestante);
                
                adelanto.saldo -= montoAUsar;
                adelanto.usado += montoAUsar;
                
                if (adelanto.saldo <= 0) {
                    adelanto.status = 'Agotado';
                }
                
                if (!adelanto.usos) {
                    adelanto.usos = [];
                }
                
                adelanto.usos.push({
                    fecha: new Date().toISOString().split('T')[0],
                    monto: montoAUsar,
                    concepto: 'Pago de venta'
                });
                
                usos.push({
                    adelantoId: adelanto.id,
                    monto: montoAUsar
                });
                
                montoRestante -= montoAUsar;
            }
            
            localStorage.setItem('adelantosClientes', JSON.stringify(adelantosClientes));
            loadAdelantosClientesList();
            
            return {
                usado: montoVenta - montoRestante,
                restante: montoRestante,
                usos: usos
            };
        }
        
        // Registrar adelanto de hielo
        function registrarAdelantoHielo(e) {
            e.preventDefault();
            
            const montoUSD   = parseFloat(document.getElementById('adelanto-hielo-monto').value);
            const fecha      = document.getElementById('adelanto-hielo-fecha').value;
            const proveedor  = document.getElementById('adelanto-hielo-proveedor').value;
            const concepto   = document.getElementById('adelanto-hielo-concepto').value;
            
            if (!montoUSD || !fecha) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            if (montoUSD <= 0) { alert('El monto debe ser mayor a 0'); return; }
            
            const montoBS = convertUSDtoBS(montoUSD);
            
            const adelanto = {
                id:                  Date.now(),
                monto:               montoBS,       // legacy BS
                montoUSD:            montoUSD,
                saldoDisponible:     montoBS,
                saldoDisponibleUSD:  montoUSD,
                gastado:             0,
                gastadoUSD:          0,
                fecha:               fecha,
                proveedor:           proveedor || 'No especificado',
                concepto:            concepto,
                status:              'Activo',
                usos:                []
            };
            
            adelantosHielo.unshift(adelanto);
            localStorage.setItem('adelantosHielo', JSON.stringify(adelantosHielo));
            
            loadAdelantosHieloList();
            document.getElementById('adelanto-hielo-form').reset();
            alert(`‚úÖ Adelanto de hielo registrado: ${fmtUSD(montoUSD)} USD`);
        }
        
        // Cargar lista de adelantos de hielo
        function loadAdelantosHieloList() {
            const tbody = document.getElementById('adelantos-hielo-list');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const activos = adelantosHielo.filter(a => a.status === 'Activo' && getHieloSaldoUSD(a) > 0);
            
            if (activos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #6c757d;">
                            No hay adelantos de hielo activos
                        </td>
                    </tr>
                `;
                return;
            }
            
            activos.forEach(adelanto => {
                const row = document.createElement('tr');
                const statusClass = adelanto.saldoDisponible > 0 ? 'badge-success' : 'badge-warning';
                
                row.innerHTML = `
                    <td>${formatDate(adelanto.fecha)}</td>
                    <td>${adelanto.proveedor}</td>
                    <td>${fmtUSD(getHieloMontoUSD(adelanto))}</td>
                    <td>${fmtUSD(getHieloGastadoUSD(adelanto))}</td>
                    <td><strong>${fmtUSD(getHieloSaldoUSD(adelanto))}</strong></td>
                    <td><span class="badge ${statusClass}">${adelanto.status}</span></td>
                    <td>
                        <button class="btn btn-small btn-primary" onclick="verHistorialAdelantoHielo(${adelanto.id})">
                            <i class="fas fa-history"></i> Historial
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Ver historial de adelanto
        function verHistorialAdelanto(id) {
            const adelanto = adelantosClientes.find(a => a.id === id);
            if (!adelanto) return;
            
            let mensaje = `HISTORIAL DE ADELANTO\n            \nCliente: ${adelanto.cliente}\nMonto Total: ${fmtUSD(getAdelantoMontoUSD(adelanto))} USD\nUsado: ${fmtUSD(getAdelantoUsadoUSD(adelanto))} USD\nSaldo: ${fmtUSD(getAdelantoSaldoUSD(adelanto))} USD\nForma de Pago: ${adelanto.formaPago}\n\n`;
            
            if (adelanto.usos && adelanto.usos.length > 0) {
                mensaje += 'USOS DEL ADELANTO:\n\n';
                adelanto.usos.forEach(uso => {
                    const usoUSD = uso.montoUSD ?? convertBStoUSD(uso.monto || 0);
                    mensaje += `${formatDate(uso.fecha)}: ${fmtUSD(usoUSD)} USD - ${uso.concepto}\n`;
                });
            } else {
                mensaje += 'No se ha usado este adelanto a√∫n.';
            }
            
            alert(mensaje);
        }
        
        // Ver historial de adelanto de hielo
        function verHistorialAdelantoHielo(id) {
            const adelanto = adelantosHielo.find(a => a.id === id);
            if (!adelanto) return;
            
            let mensaje = `HISTORIAL DE ADELANTO DE HIELO\n            \nProveedor: ${adelanto.proveedor}\nMonto Total: ${fmtUSD(getHieloMontoUSD(adelanto))} USD\nGastado: ${fmtUSD(getHieloGastadoUSD(adelanto))} USD\nSaldo: ${fmtUSD(getHieloSaldoUSD(adelanto))} USD\n\n`;
            
            if (adelanto.usos && adelanto.usos.length > 0) {
                mensaje += 'USOS DEL ADELANTO:\n\n';
                adelanto.usos.forEach(uso => {
                    const usoUSD = uso.montoUSD ?? convertBStoUSD(uso.monto || 0);
                    mensaje += `${formatDate(uso.fecha)}: ${fmtUSD(usoUSD)} USD - ${uso.concepto}\n`;
                });
            } else {
                mensaje += 'No se ha usado este adelanto a√∫n.';
            }
            
            alert(mensaje);
        }
        
        // ========== EXPORTACI√ìN CSV ==========
        
        // Convertir a CSV
        function arrayToCSV(data, headers) {
            if (data.length === 0) return '';
            
            const csvRows = [];
            
            // Agregar encabezados
            csvRows.push(headers.join(','));
            
            // Agregar datos
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    // Escapar comillas y envolver en comillas si contiene coma
                    const escaped = String(value).replace(/"/g, '""');
                    return escaped.includes(',') ? `"${escaped}"` : escaped;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }
        
        // Descargar CSV
        function downloadCSV(filename, csvContent) {
            const BOM = '\uFEFF'; // Para que Excel abra correctamente con UTF-8
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // Exportar Ventas
        function exportSalesToCSV() {
            const dateFrom = document.getElementById('export-date-from').value;
            const dateTo = document.getElementById('export-date-to').value;
            
            if (!dateFrom || !dateTo) {
                alert('Selecciona el rango de fechas');
                return;
            }
            
            let filteredSales = salesData.filter(s => s.date >= dateFrom && s.date <= dateTo);
            
            if (filteredSales.length === 0) {
                alert('No hay ventas en el per√≠odo seleccionado');
                return;
            }
            
            const exportData = [];
            
            filteredSales.forEach(sale => {
                const totalUSD  = sale.totalUSD ?? convertBStoUSD(sale.total ?? 0);
                const baseUSD   = totalUSD / 1.16;
                const ivaUSD    = totalUSD - baseUSD;
                const retIvaUSD = sale.retencionIva  ? ivaUSD  * 0.75 : 0;
                const retIsUSD  = sale.retencionIslr ? baseUSD * 0.02 : 0;
                const netoUSD   = totalUSD - retIvaUSD - retIsUSD;
                const products  = sale.items.map(item => `${item.quantity}x ${item.name}`).join('; ');
                
                exportData.push({
                    'Fecha':              sale.date,
                    'Cliente':            sale.customer,
                    'RIF':                sale.customerRif || 'N/A',
                    'Tipo Documento':     sale.documentType || 'N/A',
                    'Productos':          products,
                    'Base Imponible USD': baseUSD.toFixed(2),
                    'IVA USD':            ivaUSD.toFixed(2),
                    'Total con IVA USD':  totalUSD.toFixed(2),
                    'Retenci√≥n IVA USD':  retIvaUSD.toFixed(2),
                    'Retenci√≥n ISLR USD': retIsUSD.toFixed(2),
                    'Total Neto USD':     netoUSD.toFixed(2),
                    'M√©todo de Pago':     sale.paymentMethod,
                    'Notas':              sale.notes || ''
                });
            });
            
            const headers = Object.keys(exportData[0]);
            const csv = arrayToCSV(exportData, headers);
            const filename = `ventas_${dateFrom}_${dateTo}.csv`;
            
            downloadCSV(filename, csv);
            alert(`‚úÖ Exportadas ${filteredSales.length} ventas`);
        }
        
        // Exportar Gastos
        function exportExpensesToCSV() {
            const dateFrom = document.getElementById('export-date-from').value;
            const dateTo = document.getElementById('export-date-to').value;
            
            if (!dateFrom || !dateTo) {
                alert('Selecciona el rango de fechas');
                return;
            }
            
            let filteredExpenses = expensesData.filter(e => e.date >= dateFrom && e.date <= dateTo);
            
            if (filteredExpenses.length === 0) {
                alert('No hay gastos en el per√≠odo seleccionado');
                return;
            }
            
            const exportData = [];
            
            filteredExpenses.forEach(expense => {
                const ivaPercent = expense.iva || 16;
                const totalUSD   = expense.amountUSD ?? convertBStoUSD(expense.amount ?? 0);
                const baseUSD    = totalUSD / (1 + ivaPercent / 100);
                const ivaUSD     = totalUSD - baseUSD;
                
                exportData.push({
                    'Fecha':          expense.date,
                    'Descripci√≥n':    expense.description,
                    'N¬∫ Factura':     expense.invoiceNumber || 'N/A',
                    'Tipo Documento': expense.documentType || 'N/A',
                    'Categor√≠a':      expense.category,
                    'Base USD':       baseUSD.toFixed(2),
                    'IVA %':          ivaPercent,
                    'IVA USD':        ivaUSD.toFixed(2),
                    'Total USD':      totalUSD.toFixed(2)
                });
            });
            
            const headers = Object.keys(exportData[0]);
            const csv = arrayToCSV(exportData, headers);
            const filename = `gastos_${dateFrom}_${dateTo}.csv`;
            
            downloadCSV(filename, csv);
            alert(`‚úÖ Exportados ${filteredExpenses.length} gastos`);
        }
        
        // Exportar Cr√©ditos
        function exportCreditsToCSV() {
            const dateFrom = document.getElementById('export-date-from').value;
            const dateTo = document.getElementById('export-date-to').value;
            
            if (!dateFrom || !dateTo) {
                alert('Selecciona el rango de fechas');
                return;
            }
            
            let filteredCredits = creditsData.filter(c => c.date >= dateFrom && c.date <= dateTo);
            
            if (filteredCredits.length === 0) {
                alert('No hay cr√©ditos en el per√≠odo seleccionado');
                return;
            }
            
            const exportData = [];
            
            filteredCredits.forEach(credit => {
                const amtUSD   = getCreditAmountUSD(credit);
                const paidUSD  = getCreditPaidUSD(credit);
                const balUSD   = getCreditBalanceUSD(credit);
                const payments = credit.payments || [];
                
                if (payments.length === 0) {
                    exportData.push({
                        'Fecha Cr√©dito': credit.date,
                        'Cliente':        credit.customer,
                        'Monto USD':      amtUSD.toFixed(2),
                        'Abonado USD':    paidUSD.toFixed(2),
                        'Saldo USD':      balUSD.toFixed(2),
                        'Estado':         credit.status,
                        'Fecha Abono':    '',
                        'Monto Abono USD': '',
                        'Forma Pago Abono': '',
                        'Notas Abono':    ''
                    });
                } else {
                    payments.forEach(payment => {
                        const pUSD = credit.amount > 0
                            ? (payment.amount / credit.amount) * amtUSD
                            : convertBStoUSD(payment.amount);
                        exportData.push({
                            'Fecha Cr√©dito': credit.date,
                            'Cliente':        credit.customer,
                            'Monto USD':      amtUSD.toFixed(2),
                            'Abonado USD':    paidUSD.toFixed(2),
                            'Saldo USD':      balUSD.toFixed(2),
                            'Estado':         credit.status,
                            'Fecha Abono':    payment.date,
                            'Monto Abono USD': pUSD.toFixed(2),
                            'Forma Pago Abono': payment.paymentMethod || 'N/A',
                            'Notas Abono':    payment.notes || ''
                        });
                    });
                }
            });
            
            const headers = Object.keys(exportData[0]);
            const csv = arrayToCSV(exportData, headers);
            const filename = `creditos_${dateFrom}_${dateTo}.csv`;
            
            downloadCSV(filename, csv);
            alert(`‚úÖ Exportados ${filteredCredits.length} cr√©ditos`);
        }
        
        // Exportar Todo (simula ZIP con m√∫ltiples descargas)
        function exportAllToCSV() {
            const dateFrom = document.getElementById('export-date-from').value;
            const dateTo = document.getElementById('export-date-to').value;
            
            if (!dateFrom || !dateTo) {
                alert('Selecciona el rango de fechas');
                return;
            }
            
            if (!confirm('Se descargar√°n 3 archivos CSV. ¬øContinuar?')) {
                return;
            }
            
            // Descargar cada archivo con un peque√±o delay
            exportSalesToCSV();
            
            setTimeout(() => {
                exportExpensesToCSV();
            }, 500);
            
            setTimeout(() => {
                exportCreditsToCSV();
            }, 1000);
        }
        
        // ========== EXPORTACI√ìN XLSX ==========
        
        function exportSalesToXLSX() {
            const dateFrom = document.getElementById('export-date-from').value;
            const dateTo = document.getElementById('export-date-to').value;
            
            if (!dateFrom || !dateTo) {
                alert('Selecciona el rango de fechas');
                return;
            }
            
            const filteredSales = salesData.filter(s => s.date >= dateFrom && s.date <= dateTo);
            
            if (filteredSales.length === 0) {
                alert('No hay ventas en el per√≠odo seleccionado');
                return;
            }
            
            const exportData = filteredSales.map(sale => {
                const totalUSD   = sale.totalUSD ?? convertBStoUSD(sale.total ?? 0);
                const ivaFactor  = 1.16;
                const baseUSD    = parseFloat((totalUSD / ivaFactor).toFixed(2));
                const ivaUSD     = parseFloat((totalUSD - baseUSD).toFixed(2));
                const retIvaUSD  = sale.retencionIva   ? parseFloat((ivaUSD  * 0.75).toFixed(2)) : 0;
                const retIslrUSD = sale.retencionIslr  ? parseFloat((baseUSD * 0.02).toFixed(2)) : 0;
                const netoUSD    = parseFloat((totalUSD - retIvaUSD - retIslrUSD).toFixed(2));
                const adelUSD    = sale.adelantoUsado
                    ? parseFloat(convertBStoUSD(sale.adelantoUsado).toFixed(2)) : 0;
                const products   = sale.items.map(item => `${item.quantity}x ${item.name}`).join('; ');
                
                return {
                    'Fecha':         sale.date,
                    'Cliente':       sale.customer,
                    'RIF':           sale.customerRif || 'N/A',
                    'Tipo Documento': sale.documentType || 'N/A',
                    'Productos':     products,
                    'Base USD':      baseUSD,
                    'IVA USD':       ivaUSD,
                    'Total USD':     parseFloat(totalUSD.toFixed(2)),
                    'Ret IVA USD':   retIvaUSD,
                    'Ret ISLR USD':  retIslrUSD,
                    'Neto USD':      netoUSD,
                    'M√©todo Pago':   sale.paymentMethod,
                    'Adelanto USD':  adelUSD,
                    'Notas':         sale.notes || ''
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            ws['!cols'] = [{wch:12},{wch:25},{wch:15},{wch:18},{wch:40},{wch:12},{wch:12},{wch:12},{wch:12},{wch:12},{wch:12},{wch:10},{wch:15},{wch:12},{wch:30}];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ventas");
            
            XLSX.writeFile(wb, `ventas_${dateFrom}_${dateTo}.xlsx`);
            alert(`‚úÖ Exportadas ${filteredSales.length} ventas a Excel`);
        }
        
        function exportExpensesToXLSX() {
            const dateFrom = document.getElementById('export-date-from').value;
            const dateTo = document.getElementById('export-date-to').value;
            
            if (!dateFrom || !dateTo) {
                alert('Selecciona el rango de fechas');
                return;
            }
            
            const filteredExpenses = expensesData.filter(e => e.date >= dateFrom && e.date <= dateTo);
            
            if (filteredExpenses.length === 0) {
                alert('No hay gastos en el per√≠odo seleccionado');
                return;
            }
            
            const exportData = filteredExpenses.map(expense => {
                const ivaPercent = expense.iva || 16;
                const totalUSD   = expense.amountUSD ?? convertBStoUSD(expense.amount ?? 0);
                const baseUSD    = parseFloat((totalUSD / (1 + ivaPercent / 100)).toFixed(2));
                const ivaUSD     = parseFloat((totalUSD - baseUSD).toFixed(2));
                const adelUSD    = expense.adelantoUsado
                    ? parseFloat(convertBStoUSD(expense.adelantoUsado).toFixed(2)) : 0;
                
                return {
                    'Fecha':       expense.date,
                    'Descripci√≥n': expense.description,
                    'Factura':     expense.invoiceNumber || 'N/A',
                    'Tipo Doc':    expense.documentType || 'N/A',
                    'Categor√≠a':   expense.category,
                    'Base USD':    baseUSD,
                    'IVA %':       ivaPercent,
                    'IVA USD':     ivaUSD,
                    'Total USD':   parseFloat(totalUSD.toFixed(2)),
                    'Adelanto USD': adelUSD
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            ws['!cols'] = [{wch:12},{wch:35},{wch:15},{wch:18},{wch:15},{wch:12},{wch:8},{wch:12},{wch:12},{wch:10},{wch:12}];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Gastos");
            
            XLSX.writeFile(wb, `gastos_${dateFrom}_${dateTo}.xlsx`);
            alert(`‚úÖ Exportados ${filteredExpenses.length} gastos a Excel`);
        }
        
        function exportCreditsToXLSX() {
            const dateFrom = document.getElementById('export-date-from').value;
            const dateTo = document.getElementById('export-date-to').value;
            
            if (!dateFrom || !dateTo) {
                alert('Selecciona el rango de fechas');
                return;
            }
            
            const filteredCredits = creditsData.filter(c => c.date >= dateFrom && c.date <= dateTo);
            
            if (filteredCredits.length === 0) {
                alert('No hay cr√©ditos en el per√≠odo seleccionado');
                return;
            }
            
            const exportData = [];
            filteredCredits.forEach(credit => {
                const amtUSD  = getCreditAmountUSD(credit);
                const payments = credit.payments || [];
                if (payments.length === 0) {
                    exportData.push({
                        'Fecha': credit.date,
                        'Cliente': credit.customer,
                        'Monto USD': parseFloat(amtUSD.toFixed(2)),
                        'Abonado USD': parseFloat(getCreditPaidUSD(credit).toFixed(2)),
                        'Saldo USD': parseFloat(getCreditBalanceUSD(credit).toFixed(2)),
                        'Estado': credit.status
                    });
                } else {
                    payments.forEach(payment => {
                        const pUSD = credit.amount > 0
                            ? (payment.amount / credit.amount) * amtUSD
                            : convertBStoUSD(payment.amount);
                        exportData.push({
                            'Fecha Cr√©dito': credit.date,
                            'Cliente': credit.customer,
                            'Monto Total USD': parseFloat(amtUSD.toFixed(2)),
                            'Fecha Abono': payment.date,
                            'Abono USD': parseFloat(pUSD.toFixed(2)),
                            'Forma Pago': payment.paymentMethod || 'N/A',
                            'Saldo USD': parseFloat(getCreditBalanceUSD(credit).toFixed(2))
                        });
                    });
                }
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            ws['!cols'] = [{wch:14},{wch:25},{wch:12},{wch:14},{wch:12},{wch:15},{wch:12}];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Cr√©ditos");
            
            XLSX.writeFile(wb, `creditos_${dateFrom}_${dateTo}.xlsx`);
            alert(`‚úÖ Exportados ${filteredCredits.length} cr√©ditos a Excel`);
        }
        
        function exportAllToXLSX() {
            const dateFrom = document.getElementById('export-date-from').value;
            const dateTo = document.getElementById('export-date-to').value;
            
            if (!dateFrom || !dateTo) {
                alert('Selecciona el rango de fechas');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            let hasData = false;
            
            // VENTAS
            const filteredSales = salesData.filter(s => s.date >= dateFrom && s.date <= dateTo);
            if (filteredSales.length > 0) {
                hasData = true;
                const salesExport = filteredSales.map(sale => {
                    const totalUSD  = sale.totalUSD ?? convertBStoUSD(sale.total ?? 0);
                    const baseUSD   = parseFloat((totalUSD / 1.16).toFixed(2));
                    const ivaUSD    = parseFloat((totalUSD - baseUSD).toFixed(2));
                    const retIvaUSD = sale.retencionIva  ? parseFloat((ivaUSD  * 0.75).toFixed(2)) : 0;
                    const retIsUSD  = sale.retencionIslr ? parseFloat((baseUSD * 0.02).toFixed(2)) : 0;
                    const netoUSD   = parseFloat((totalUSD - retIvaUSD - retIsUSD).toFixed(2));
                    return {
                        'Fecha':      sale.date,
                        'Cliente':    sale.customer,
                        'RIF':        sale.customerRif || 'N/A',
                        'Productos':  sale.items.map(i => `${i.quantity}x ${i.name}`).join('; '),
                        'Base USD':   baseUSD,
                        'IVA USD':    ivaUSD,
                        'Total USD':  parseFloat(totalUSD.toFixed(2)),
                        'Ret IVA USD': retIvaUSD,
                        'Ret ISLR USD': retIsUSD,
                        'Neto USD':   netoUSD,
                        'Pago':       sale.paymentMethod,
                        'Adelanto USD': sale.adelantoUsado
                            ? parseFloat(convertBStoUSD(sale.adelantoUsado).toFixed(2)) : 0
                    };
                });
                const ws = XLSX.utils.json_to_sheet(salesExport);
                ws['!cols'] = [{wch:12},{wch:25},{wch:15},{wch:40},{wch:12},{wch:12},{wch:12},{wch:12},{wch:12},{wch:12},{wch:15},{wch:12}];
                XLSX.utils.book_append_sheet(wb, ws, "Ventas");
            }
            
            // GASTOS
            const filteredExpenses = expensesData.filter(e => e.date >= dateFrom && e.date <= dateTo);
            if (filteredExpenses.length > 0) {
                hasData = true;
                const expensesExport = filteredExpenses.map(expense => {
                    const ivaPercent = expense.iva || 16;
                    const totalUSD   = expense.amountUSD ?? convertBStoUSD(expense.amount ?? 0);
                    const baseUSD    = parseFloat((totalUSD / (1 + ivaPercent / 100)).toFixed(2));
                    return {
                        'Fecha':       expense.date,
                        'Descripci√≥n': expense.description,
                        'Factura':     expense.invoiceNumber || 'N/A',
                        'Categor√≠a':   expense.category,
                        'Base USD':    baseUSD,
                        'IVA %':       ivaPercent,
                        'Total USD':   parseFloat(totalUSD.toFixed(2)),
                        'Adelanto USD': expense.adelantoUsado
                            ? parseFloat(convertBStoUSD(expense.adelantoUsado).toFixed(2)) : 0
                    };
                });
                const ws = XLSX.utils.json_to_sheet(expensesExport);
                ws['!cols'] = [{wch:12},{wch:35},{wch:15},{wch:15},{wch:12},{wch:8},{wch:12},{wch:12}];
                XLSX.utils.book_append_sheet(wb, ws, "Gastos");
            }
            
            // CR√âDITOS
            const filteredCredits = creditsData.filter(c => c.date >= dateFrom && c.date <= dateTo);
            if (filteredCredits.length > 0) {
                hasData = true;
                const creditsExport = [];
                filteredCredits.forEach(credit => {
                    const amtUSD   = getCreditAmountUSD(credit);
                    const payments = credit.payments || [];
                    if (payments.length === 0) {
                        creditsExport.push({
                            'Fecha':      credit.date,
                            'Cliente':    credit.customer,
                            'Monto USD':  parseFloat(amtUSD.toFixed(2)),
                            'Saldo USD':  parseFloat(getCreditBalanceUSD(credit).toFixed(2)),
                            'Estado':     credit.status
                        });
                    } else {
                        payments.forEach(payment => {
                            const pUSD = credit.amount > 0
                                ? (payment.amount / credit.amount) * amtUSD
                                : convertBStoUSD(payment.amount);
                            creditsExport.push({
                                'Fecha':       credit.date,
                                'Cliente':     credit.customer,
                                'Monto USD':   parseFloat(amtUSD.toFixed(2)),
                                'Fecha Abono': payment.date,
                                'Abono USD':   parseFloat(pUSD.toFixed(2)),
                                'Forma Pago':  payment.paymentMethod || 'N/A',
                                'Saldo USD':   parseFloat(getCreditBalanceUSD(credit).toFixed(2))
                            });
                        });
                    }
                });
                const ws = XLSX.utils.json_to_sheet(creditsExport);
                ws['!cols'] = [{wch:12},{wch:25},{wch:12},{wch:14},{wch:12},{wch:15},{wch:12}];
                XLSX.utils.book_append_sheet(wb, ws, "Cr√©ditos");
            }
            
            if (!hasData) {
                alert('No hay datos en el per√≠odo seleccionado');
                return;
            }
            
            XLSX.writeFile(wb, `AQUANEV_Completo_${dateFrom}_${dateTo}.xlsx`);
            alert('‚úÖ Exportaci√≥n completa a Excel');
        }
        
        // ========== REPORTE DE VENTAS POR CLIENTE ==========
        function loadSalesReportClients() {
            const select = document.getElementById('sales-report-client');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Todos los clientes --</option>';
            
            // Obtener clientes √∫nicos de las ventas
            const clientsWithSales = [...new Set(salesData.map(s => s.customer))];
            clientsWithSales.sort();
            
            clientsWithSales.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                select.appendChild(option);
            });
        }
        
        function generateSalesReport() {
            const selectedClient = document.getElementById('sales-report-client').value;
            const dateFrom = document.getElementById('sales-date-from').value;
            const dateTo = document.getElementById('sales-date-to').value;
            const container = document.getElementById('sales-report-summary');
            
            let filteredSales = salesData;
            
            // Filtrar por cliente
            if (selectedClient) {
                filteredSales = filteredSales.filter(s => s.customer === selectedClient);
            }
            
            // Filtrar por fechas
            if (dateFrom) {
                filteredSales = filteredSales.filter(s => s.date >= dateFrom);
            }
            if (dateTo) {
                filteredSales = filteredSales.filter(s => s.date <= dateTo);
            }
            
            if (filteredSales.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No hay ventas registradas en el per√≠odo seleccionado</p>';
                return;
            }
            
            // Calcular totales en USD
            const totalSales   = filteredSales.length;
            const totalAmountUSD = filteredSales.reduce((sum, s) =>
                sum + (s.totalUSD ?? convertBStoUSD(s.total ?? 0)), 0);
            const totalProducts = filteredSales.reduce((sum, s) =>
                sum + s.items.reduce((is, item) => is + item.quantity, 0), 0);
            
            const paidSales    = filteredSales.filter(s => s.paymentMethod !== 'Cr√©dito');
            const creditSales  = filteredSales.filter(s => s.paymentMethod === 'Cr√©dito');
            const totalPaidUSD = paidSales.reduce((sum, s) =>
                sum + (s.totalUSD ?? convertBStoUSD(s.total ?? 0)), 0);
            const totalPendingUSD = creditSales.reduce((sum, s) =>
                sum + (s.totalUSD ?? convertBStoUSD(s.total ?? 0)), 0);
            
            // Agrupar por forma de pago en USD
            const paymentMethods = {};
            filteredSales.forEach(sale => {
                const method = sale.paymentMethod || 'No especificado';
                if (!paymentMethods[method]) paymentMethods[method] = 0;
                paymentMethods[method] += sale.totalUSD ?? convertBStoUSD(sale.total ?? 0);
            });
            
            const periodText = dateFrom || dateTo ? 
                `Per√≠odo: ${dateFrom ? formatDate(dateFrom) : 'Inicio'} - ${dateTo ? formatDate(dateTo) : 'Hoy'}` : 
                'Todos los per√≠odos';
            
            let html = `
                <div class="payment-summary" style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="margin-bottom: 15px;">üìà Resumen de Ventas${selectedClient ? ' - ' + selectedClient : ''}</h3>
                    <p style="margin-bottom: 10px; font-size: 14px; color: #666;">${periodText}</p>
                    <div class="payment-row" style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span><strong>Total de Ventas:</strong></span>
                        <span>${totalSales}</span>
                    </div>
                    <div class="payment-row" style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span><strong>Productos Totales:</strong></span>
                        <span>${totalProducts} unidades</span>
                    </div>
                    <div class="payment-row" style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span><strong>Monto Total:</strong></span>
                        <span>${fmtUSD(totalAmountUSD)} USD</span>
                    </div>
                    <div class="payment-row" style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span><strong>Total Pagado:</strong></span>
                        <span style="color: #2ecc71;">${fmtUSD(totalPaidUSD)} USD</span>
                    </div>
                    <div class="payment-row" style="display: flex; justify-content: space-between; margin: 8px 0; padding-top: 10px; border-top: 2px solid #999;">
                        <span><strong>Saldo Pendiente:</strong></span>
                        <span style="color: #e74c3c; font-size: 18px;"><strong>${fmtUSD(totalPendingUSD)} USD</strong></span>
                    </div>
            `;
            
            // Desglose por forma de pago
            if (Object.keys(paymentMethods).length > 0) {
                html += `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #999;">
                        <strong>üí≥ Ventas por Forma de Pago:</strong><br>
                `;
                for (const [method, total] of Object.entries(paymentMethods)) {
                    html += `
                        <div class="payment-row" style="display: flex; justify-content: space-between; margin: 5px 0; padding-left: 20px;">
                            <span>${method}:</span>
                            <span>${fmtUSD(total)} USD</span>
                        </div>
                    `;
                }
                html += `</div>`;
            }
            
            html += `</div>`;
            
            // Tabla de ventas
            html += `
                <div class="table-scroll-wrap"><table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Fecha</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Cliente</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Productos</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Total USD</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Forma de Pago</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Estado</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredSales.forEach(sale => {
                const productsSummary = sale.items.map(item => `${item.quantity} ${item.name}`).join(', ');
                const status = sale.paymentMethod === 'Cr√©dito' ? '‚ö†Ô∏è Pendiente' : '‚úÖ Pagado';
                const statusClass = sale.paymentMethod === 'Cr√©dito' ? 'badge-warning' : 'badge-success';
                
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px;">${formatDate(sale.date)}</td>
                        <td style="padding: 12px;">${sale.customer}</td>
                        <td style="padding: 12px;">${productsSummary}</td>
                        <td style="padding: 12px;"><strong>${fmtUSD(sale.totalUSD ?? convertBStoUSD(sale.total ?? 0))}</strong></td>
                        <td style="padding: 12px;">${sale.paymentMethod}</td>
                        <td style="padding: 12px;"><span class="badge ${statusClass}">${status}</span></td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table></div>
            `;
            
            container.innerHTML = html;
        }
        
        function downloadSalesReportTXT() {
            const selectedClient = document.getElementById('sales-report-client').value;
            const dateFrom = document.getElementById('sales-date-from').value;
            const dateTo = document.getElementById('sales-date-to').value;
            
            let filteredSales = salesData;
            
            if (selectedClient) {
                filteredSales = filteredSales.filter(s => s.customer === selectedClient);
            }
            if (dateFrom) {
                filteredSales = filteredSales.filter(s => s.date >= dateFrom);
            }
            if (dateTo) {
                filteredSales = filteredSales.filter(s => s.date <= dateTo);
            }
            
            if (filteredSales.length === 0) {
                alert('No hay ventas para generar el reporte');
                return;
            }
            
            const periodText = dateFrom || dateTo ? 
                `${dateFrom ? formatDate(dateFrom) : 'Inicio'} - ${dateTo ? formatDate(dateTo) : 'Hoy'}` : 
                'Todos los per√≠odos';
            
            let report = `REPORTE DE VENTAS POR CLIENTE${selectedClient ? ' - ' + selectedClient : ''}
Per√≠odo: ${periodText}
Fecha: ${new Date().toLocaleDateString('es-ES')}
${'='.repeat(60)}

`;
            
            filteredSales.forEach(sale => {
                const productsSummary = sale.items.map(item => `${item.quantity} ${item.name}`).join(', ');
                const status  = sale.paymentMethod === 'Cr√©dito' ? 'PENDIENTE' : 'PAGADO';
                const saleUSD = sale.totalUSD ?? convertBStoUSD(sale.total ?? 0);
                
                report += `Fecha: ${formatDate(sale.date)}
Cliente: ${sale.customer}
Productos: ${productsSummary}
Total: ${fmtUSD(saleUSD)} USD
Forma de Pago: ${sale.paymentMethod}
Estado: ${status}

${'-'.repeat(60)}

`;
            });
            
            const totalAmountUSD  = filteredSales.reduce((sum, s) =>
                sum + (s.totalUSD ?? convertBStoUSD(s.total ?? 0)), 0);
            const paidSales       = filteredSales.filter(s => s.paymentMethod !== 'Cr√©dito');
            const totalPaidUSD    = paidSales.reduce((sum, s) =>
                sum + (s.totalUSD ?? convertBStoUSD(s.total ?? 0)), 0);
            const totalPendingUSD = totalAmountUSD - totalPaidUSD;
            
            report += `
RESUMEN TOTAL:
Total de Ventas: ${filteredSales.length}
Monto Total: ${fmtUSD(totalAmountUSD)} USD
Total Pagado: ${fmtUSD(totalPaidUSD)} USD
Saldo Pendiente: ${fmtUSD(totalPendingUSD)} USD
`;
            
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `reporte_ventas_${selectedClient || 'todos'}_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Reporte descargado correctamente');
        }
        
        // ========== REPORTE DE CR√âDITOS ==========
        function loadCreditReportClients() {
            const select = document.getElementById('credit-report-client');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Todos los clientes --</option>';
            
            // Obtener clientes √∫nicos que tienen cr√©ditos
            const clientsWithCredits = [...new Set(creditsData.map(c => c.customer))];
            clientsWithCredits.sort();
            
            clientsWithCredits.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                select.appendChild(option);
            });
        }
        
        function generateCreditReport() {
            const selectedClient = document.getElementById('credit-report-client').value;
            const dateFrom = document.getElementById('credit-date-from').value;
            const dateTo = document.getElementById('credit-date-to').value;
            const container = document.getElementById('credit-report-summary');
            
            let filteredCredits = creditsData;
            
            // Filtrar por cliente
            if (selectedClient) {
                filteredCredits = filteredCredits.filter(c => c.customer === selectedClient);
            }
            
            // Filtrar por fechas
            if (dateFrom) {
                filteredCredits = filteredCredits.filter(c => c.date >= dateFrom);
            }
            if (dateTo) {
                filteredCredits = filteredCredits.filter(c => c.date <= dateTo);
            }
            
            if (filteredCredits.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No hay cr√©ditos registrados en el per√≠odo seleccionado</p>';
                return;
            }
            
            // Calcular totales en USD
            const totalAmount  = filteredCredits.reduce((sum, c) => sum + getCreditAmountUSD(c), 0);
            const totalPaid    = filteredCredits.reduce((sum, c) => sum + getCreditPaidUSD(c), 0);
            const totalBalance = filteredCredits.reduce((sum, c) => sum + getCreditBalanceUSD(c), 0);
            
            // Calcular totales por forma de pago (en USD)
            const paymentMethodTotals = {};
            filteredCredits.forEach(credit => {
                if (credit.payments) {
                    const amtUSD = getCreditAmountUSD(credit);
                    const amtBS  = credit.amount || 1;
                    credit.payments.forEach(payment => {
                        const method = payment.paymentMethod || 'No especificado';
                        if (!paymentMethodTotals[method]) paymentMethodTotals[method] = 0;
                        // Convertir cada abono BS ‚Üí USD usando proporci√≥n del cr√©dito
                        const pUSD = amtBS > 0 ? (payment.amount / amtBS) * amtUSD : convertBStoUSD(payment.amount);
                        paymentMethodTotals[method] += pUSD;
                    });
                }
            });
            
            const periodText = dateFrom || dateTo ? 
                `Per√≠odo: ${dateFrom ? formatDate(dateFrom) : 'Inicio'} - ${dateTo ? formatDate(dateTo) : 'Hoy'}` : 
                'Todos los per√≠odos';
            
            let html = `
                <div class="payment-summary" style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="margin-bottom: 15px;">üìä Resumen de Cr√©ditos${selectedClient ? ' - ' + selectedClient : ''}</h3>
                    <p style="margin-bottom: 10px; font-size: 14px; color: #666;">${periodText}</p>
                    <div class="payment-row" style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span><strong>Total Cr√©ditos:</strong></span>
                        <span>${filteredCredits.length}</span>
                    </div>
                    <div class="payment-row" style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span><strong>Monto Total:</strong></span>
                        <span>${fmtUSD(totalAmount)} USD</span>
                    </div>
                    <div class="payment-row" style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span><strong>Total Abonado:</strong></span>
                        <span style="color: #2ecc71;">${fmtUSD(totalPaid)} USD</span>
                    </div>
                    <div class="payment-row" style="display: flex; justify-content: space-between; margin: 8px 0; padding-top: 10px; border-top: 2px solid #999;">
                        <span><strong>Saldo Pendiente:</strong></span>
                        <span style="color: #e74c3c; font-size: 20px;"><strong>${fmtUSD(totalBalance)} USD</strong></span>
                    </div>
            `;
            
            // Mostrar resumen por forma de pago
            if (Object.keys(paymentMethodTotals).length > 0) {
                html += `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #999;">
                        <strong>üí≥ Abonos por Forma de Pago:</strong><br>
                `;
                for (const [method, total] of Object.entries(paymentMethodTotals)) {
                    html += `
                        <div class="payment-row" style="display: flex; justify-content: space-between; margin: 5px 0; padding-left: 20px;">
                            <span>${method}:</span>
                            <span>${fmtUSD(total)} USD</span>
                        </div>
                    `;
                }
                html += `</div>`;
            }
            
            html += `
                </div>
                
                <div class="table-scroll-wrap"><table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Cliente</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Fecha</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Monto USD</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Abonado USD</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Saldo USD</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Estado</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Abonos</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredCredits.forEach(credit => {
                const paid = credit.paid || 0;
                const balance = credit.balance || (credit.amount - paid);
                const payments = credit.payments || [];
                
                const statusClass = credit.status === 'Pagado' ? 'badge-success' : 
                                   credit.status === 'Parcial' ? 'badge-info' : 'badge-warning';
                
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px;">${credit.customer}</td>
                        <td style="padding: 12px;">${formatDate(credit.date)}</td>
                        <td style="padding: 12px;">${fmtUSD(getCreditAmountUSD(credit))}</td>
                        <td style="padding: 12px; color: #2ecc71;">${fmtUSD(getCreditPaidUSD(credit))}</td>
                        <td style="padding: 12px; color: #e74c3c;"><strong>${fmtUSD(getCreditBalanceUSD(credit))}</strong></td>
                        <td style="padding: 12px;"><span class="badge ${statusClass}">${credit.status}</span></td>
                        <td style="padding: 12px;">${payments.length}</td>
                    </tr>
                `;
                
                // Mostrar detalle de abonos si existen
                if (payments.length > 0) {
                    html += `
                        <tr style="background: #f8f9fa;">
                            <td colspan="7" style="padding: 10px;">
                                <strong>Historial de Abonos:</strong><br>
                    `;
                    payments.forEach(payment => {
                        const payMethod  = payment.paymentMethod ? ` [${payment.paymentMethod}]` : '';
                        const amtUSD     = credit.amount > 0
                            ? (payment.amount / credit.amount) * getCreditAmountUSD(credit)
                            : convertBStoUSD(payment.amount);
                        html += `
                            <div style="margin: 5px 0; padding-left: 20px;">
                                ‚Ä¢ ${formatDate(payment.date)}: ${fmtUSD(amtUSD)} USD${payMethod} ${payment.notes ? '- ' + payment.notes : ''}
                            </div>
                        `;
                    });
                    html += `
                            </td>
                        </tr>
                    `;
                }
            });
            
            html += `
                    </tbody>
                </table></div>
            `;
            
            container.innerHTML = html;
        }
        
        function downloadCreditReportPDF() {
            const selectedClient = document.getElementById('credit-report-client').value;
            let filteredCredits = creditsData;
            if (selectedClient) {
                filteredCredits = creditsData.filter(c => c.customer === selectedClient);
            }
            
            if (filteredCredits.length === 0) {
                alert('No hay cr√©ditos para generar el reporte');
                return;
            }
            
            // Generar contenido de texto simple para copiar
            let report = `REPORTE DE CR√âDITOS${selectedClient ? ' - ' + selectedClient : ''}
Fecha: ${new Date().toLocaleDateString('es-ES')}
${'='.repeat(60)}

`;
            
            
            filteredCredits.forEach(credit => {
                const amtUSD  = getCreditAmountUSD(credit);
                const paid    = getCreditPaidUSD(credit);
                const balance = getCreditBalanceUSD(credit);
                const payments = credit.payments || [];
                
                report += `Cliente: ${credit.customer}
Fecha Cr√©dito: ${formatDate(credit.date)}
Monto Total: ${fmtUSD(amtUSD)} USD
Abonado: ${fmtUSD(paid)} USD
Saldo Pendiente: ${fmtUSD(balance)} USD
Estado: ${credit.status}

`;
                
                if (payments.length > 0) {
                    report += `Historial de Abonos:
`;
                    payments.forEach(payment => {
                        const pUSD = credit.amount > 0
                            ? (payment.amount / credit.amount) * amtUSD
                            : convertBStoUSD(payment.amount);
                        report += `  - ${formatDate(payment.date)}: ${fmtUSD(pUSD)} USD ${payment.notes ? '(' + payment.notes + ')' : ''}
`;
                    });
                    report += `
`;
                }
                
                report += `${'-'.repeat(60)}

`;
            });
            
            const totalAmount  = filteredCredits.reduce((sum, c) => sum + getCreditAmountUSD(c), 0);
            const totalPaid    = filteredCredits.reduce((sum, c) => sum + getCreditPaidUSD(c), 0);
            const totalBalance = filteredCredits.reduce((sum, c) => sum + getCreditBalanceUSD(c), 0);
            
            report += `
RESUMEN TOTAL:
Total Cr√©ditos: ${filteredCredits.length}
Monto Total: ${fmtUSD(totalAmount)} USD
Total Abonado: ${fmtUSD(totalPaid)} USD
Saldo Pendiente Total: ${fmtUSD(totalBalance)} USD
`;
            // Descargar como archivo de texto
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `reporte_creditos_${selectedClient || 'todos'}_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Reporte descargado correctamente');
        }

        // ========== FUNCIONES AUXILIARES ==========
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            // Separar la fecha para evitar problemas de zona horaria
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const year = parts[0];
                const month = parts[1];
                const day = parts[2];
                return day + '/' + month + '/' + year;
            }
            return dateString;
        }
        
        function formatShortDate(dateString) {
            if (!dateString) return 'N/A';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const month = parts[1];
                const day = parts[2];
                return day + '/' + month;
            }
            return dateString;
        }

        // ========== CREAR NUEVO PRODUCTO ==========
        function createNewProduct() {
            const key = document.getElementById('new-product-key').value.trim().toLowerCase();
            const name = document.getElementById('new-product-name').value.trim();
            const price = parseFloat(document.getElementById('new-product-price').value);
            const icon = document.getElementById('new-product-icon').value;
            const hasIva = document.getElementById('new-product-iva').checked;
            
            // Validaciones
            if (!key || !name || !price || price <= 0) {
                alert('Por favor completa todos los campos correctamente');
                return;
            }
            
            // Validar formato de clave (solo letras min√∫sculas y gui√≥n bajo)
            if (!/^[a-z_]+$/.test(key)) {
                alert('La clave solo puede contener letras min√∫sculas y gui√≥n bajo (_)');
                return;
            }
            
            // Verificar si ya existe
            if (waterPrices[key]) {
                alert('Ya existe un producto con esa clave. Usa otra clave diferente.');
                return;
            }
            
            // Crear el producto
            waterPrices[key] = {
                priceUSD: price,
                lastUpdate: new Date().toISOString(),
                hasIva: hasIva
            };
            
            // Guardar en localStorage
            localStorage.setItem('waterPrices', JSON.stringify(waterPrices));
            
            // Agregar al select de precios
            const priceSelect = document.getElementById('price-product');
            const option = document.createElement('option');
            option.value = key;
            option.textContent = name;
            priceSelect.appendChild(option);
            
            // Recargar vistas - incluyendo Pedidos y Consignaciones
            loadProductsList();
            loadCurrentPricesTable();
            loadCurrentPrices();
            poblarConsProductoSelect();
            poblarCItemProductoSelect();
            poblarCompraProductoSelect();
            refreshOrderProductSelects();

            // Limpiar formulario
            document.getElementById('new-product-key').value = '';
            document.getElementById('new-product-name').value = '';
            document.getElementById('new-product-price').value = '';
            document.getElementById('new-product-iva').checked = true;

            alert(`‚úÖ Producto "${name}" creado exitosamente y disponible en todos los m√≥dulos.`);
        }
        
        function saveSettings() {
            const newIva = parseFloat(document.getElementById('iva-percentage').value);
            const newExchangeRate = parseFloat(document.getElementById('price-exchange-rate').value);
            
            if (!isNaN(newIva) && newIva >= 0 && newIva <= 100) {
                ivaPercentage = newIva;
                localStorage.setItem('ivaPercentage', newIva.toString());
                document.getElementById('iva-percentage-display').textContent = newIva;
            }
            
            if (!isNaN(newExchangeRate) && newExchangeRate > 0) {
                // Usar funci√≥n de historial BCV
                updateBCVRate(newExchangeRate);
                appConfig.exchangeRates.priceRate = newExchangeRate;
                localStorage.setItem('appConfig', JSON.stringify(appConfig));
            }
            
            loadCurrentPrices();
            loadProductsList();
            loadCurrentPricesTable();
            updateSaleDisplay();
            updateCalculatedPrice();
        }
        
        // ========== GESTI√ìN DE TASAS BCV HIST√ìRICAS ==========
        
        // ========== GESTI√ìN DE TASAS BCV HIST√ìRICAS ==========
        function registrarTasaBCV() {
            const fechaInput = document.getElementById('bcv-rate-date');
            const tasaInput = document.getElementById('bcv-rate-value');
            
            if (!fechaInput || !tasaInput) {
                alert('Error: No se encontraron los campos');
                return;
            }
            
            const fecha = fechaInput.value;
            const tasa = parseFloat(tasaInput.value);
            
            if (!fecha) {
                alert('‚ö†Ô∏è Debes seleccionar una fecha');
                return;
            }
            
            if (!tasa || tasa <= 0) {
                alert('‚ö†Ô∏è Debes ingresar una tasa v√°lida mayor a 0');
                return;
            }
            
            // Log para debugging
            console.log('Registrando tasa BCV:');
            console.log('Fecha seleccionada:', fecha);
            console.log('Tasa:', tasa);
            
            // Verificar si ya existe
            const existingIndex = bcvRateHistory.findIndex(function(r) {
                return r.date === fecha;
            });
            
            if (existingIndex > -1) {
                const oldRate = bcvRateHistory[existingIndex].rate;
                if (confirm('Ya existe una tasa para ' + formatDate(fecha) + '\n\nTasa actual: ' + oldRate.toFixed(2) + ' BS/USD\nNueva tasa: ' + tasa.toFixed(2) + ' BS/USD\n\n¬øDeseas actualizarla?')) {
                    bcvRateHistory[existingIndex].rate = tasa;
                    console.log('Tasa actualizada en √≠ndice:', existingIndex);
                } else {
                    return;
                }
            } else {
                bcvRateHistory.push({ date: fecha, rate: tasa });
                console.log('Nueva tasa agregada. Total tasas:', bcvRateHistory.length);
            }
            
            // Ordenar por fecha descendente
            bcvRateHistory.sort(function(a, b) {
                return b.date.localeCompare(a.date);
            });
            
            console.log('Tasas ordenadas:', bcvRateHistory);
            
            // Guardar
            localStorage.setItem('bcvRateHistory', JSON.stringify(bcvRateHistory));
            console.log('Guardado en localStorage');
            
            // Limpiar formulario
            fechaInput.value = '';
            tasaInput.value = '';
            
            // Recargar tabla
            cargarHistorialTasasBCV();

            // Si la tasa registrada es de HOY, sincronizar todos los campos autom√°ticamente
            const today = new Date().toISOString().split('T')[0];
            if (fecha === today) {
                syncRateFromBCV();         // actualiza appConfig + priceExchangeRate
                loadManualRates();         // actualiza campos en Configuraci√≥n y Precios
                loadManualExchangeRates(); // actualiza el header (bcv-rate visual)
                loadCurrentPrices();       // recalcula precios con la nueva tasa
                loadCurrentPricesTable && loadCurrentPricesTable();
            }

            const eraHoy = fecha === today ? '\n\n‚úÖ Tasa aplicada en toda la aplicaci√≥n.' : '\n\n(Tasa hist√≥rica - no afecta la tasa actual)';
            alert('Tasa BCV registrada\n\nFecha: ' + formatDate(fecha) + '\nTasa: ' + tasa.toFixed(2) + ' BS/USD' + eraHoy);
        }
        
        function cargarHistorialTasasBCV() {
            const tbody = document.getElementById('bcv-rates-history');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (bcvRateHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999; padding: 20px;">No hay tasas registradas</td></tr>';
                return;
            }
            
            const mostrarTodasBCV = tbody.dataset.showAll === '1';
            const bcvVis = mostrarTodasBCV ? bcvRateHistory : bcvRateHistory.slice(0, 10);
            bcvVis.forEach(function(entry) {
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + formatDate(entry.date) + '</td>' +
                    '<td><strong style="color: #1976d2;">' + entry.rate.toFixed(2) + ' BS/USD</strong></td>' +
                    '<td><button class="btn btn-danger btn-small" onclick="eliminarTasaBCV(\'' + entry.date + '\')" title="Eliminar"><i class="fas fa-trash"></i> Eliminar</button></td>';
                tbody.appendChild(row);
            });
            // Bot√≥n Ver todos tasas BCV
            if (bcvRateHistory.length > 10) {
                const trBtn = document.createElement('tr');
                const tdBtn = document.createElement('td');
                tdBtn.colSpan = 3;
                tdBtn.style.textAlign = 'center';
                tdBtn.style.padding = '8px';
                const btnVer = document.createElement('button');
                btnVer.className = 'btn btn-secondary btn-small';
                btnVer.style.width = '100%';
                btnVer.textContent = mostrarTodasBCV
                    ? '‚ñ≤ Ver menos (√∫ltimas 10)'
                    : '‚ñº Ver todas (' + bcvRateHistory.length + ' tasas)';
                btnVer.onclick = function() {
                    tbody.dataset.showAll = mostrarTodasBCV ? '0' : '1';
                    cargarHistorialTasasBCV();
                };
                tdBtn.appendChild(btnVer);
                trBtn.appendChild(tdBtn);
                tbody.appendChild(trBtn);
            }
        }
        
        function eliminarTasaBCV(fecha) {
            const entry = bcvRateHistory.find(r => r.date === fecha);
            if (!entry) return;
            
            if (confirm('¬øEliminar la tasa BCV del ' + formatDate(fecha) + '?\n\nTasa: ' + entry.rate.toFixed(2) + ' BS/USD\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.')) {
                const index = bcvRateHistory.findIndex(r => r.date === fecha);
                bcvRateHistory.splice(index, 1);
                localStorage.setItem('bcvRateHistory', JSON.stringify(bcvRateHistory));
                cargarHistorialTasasBCV();
                alert('‚úÖ Tasa eliminada correctamente');
            }
        }
        
        // ========== SISTEMA DE AUTENTICACI√ìN (reemplazado por B7) ==========
        // isAuthenticated y logout() ya definidos en B7. appPassword se mantiene
        // para compatibilidad con respaldos que lo incluyan.
        let appPassword = localStorage.getItem('appPassword') || null;
        let isAuthenticated = false;

        // Legacy stub - el flujo real lo maneja attemptLoginB7()
        function attemptLogin() { attemptLoginB7(); }

        function login() {
            // Solo se llama si appPassword legacy est√° activo y no hay sistema B7
            loginB7();
        }
        
        // ========== SISTEMA DE RESPALDO ==========
        function downloadBackup() {
            const backup = {
                version: '2.0',
                date: new Date().toISOString(),
                data: {
                    salesData: salesData,
                    clientsData: clientsData,
                    expensesData: expensesData,
                    ordersData: ordersData,
                    creditsData: creditsData,
                    adelantosClientes: adelantosClientes,
                    adelantosHielo: adelantosHielo,
                    waterPrices: waterPrices,
                    priceHistory: priceHistory,
                    appConfig: appConfig,
                    ivaPercentage: ivaPercentage
                }
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `AQUANEV_respaldo_v3.0_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('Respaldo descargado correctamente');
        }

        // ========== M√ìDULO PROVEEDORES ==========

        let editProvId = null;

        function abrirProvModal(provId = null) {
            editProvId = provId;
            const fields = ['prov-nombre','prov-rif','prov-telefono','prov-email',
                            'prov-direccion','prov-contacto','prov-notas'];

            if (provId) {
                const p = proveedoresData.find(x => x.id === provId);
                if (!p) return;
                document.getElementById('prov-modal-title').textContent = 'Editar Proveedor';
                document.getElementById('prov-nombre').value    = p.nombre    || '';
                document.getElementById('prov-rif').value       = p.rif       || '';
                document.getElementById('prov-telefono').value  = p.telefono  || '';
                document.getElementById('prov-email').value     = p.email     || '';
                document.getElementById('prov-direccion').value = p.direccion || '';
                document.getElementById('prov-contacto').value  = p.contacto  || '';
                document.getElementById('prov-notas').value     = p.notas     || '';
                document.getElementById('prov-dias-credito').value = p.diasCredito || 0;
                document.getElementById('prov-moneda').value    = p.moneda    || 'USD';
                document.getElementById('prov-tipo-gastos').checked        = p.tipos?.includes('gastos')         || false;
                document.getElementById('prov-tipo-compras').checked       = p.tipos?.includes('compras')        || false;
                document.getElementById('prov-doc-factura').checked        = p.docs?.includes('Factura')         || false;
                document.getElementById('prov-doc-nota-entrega').checked   = p.docs?.includes('Nota de Entrega') || false;
                document.getElementById('prov-doc-recibo').checked         = p.docs?.includes('Recibo')          || false;
                document.getElementById('prov-doc-orden').checked          = p.docs?.includes('Orden de Compra') || false;
                document.getElementById('prov-doc-sin-doc').checked        = p.docs?.includes('Sin Documento')   || false;
            } else {
                document.getElementById('prov-modal-title').textContent = 'Nuevo Proveedor';
                ['prov-nombre','prov-rif','prov-telefono','prov-email','prov-direccion','prov-contacto','prov-notas'].forEach(id => document.getElementById(id).value = '');
                ['prov-tipo-gastos','prov-tipo-compras','prov-doc-factura','prov-doc-nota-entrega','prov-doc-recibo','prov-doc-orden','prov-doc-sin-doc'].forEach(id => document.getElementById(id).checked = false);
                document.getElementById('prov-dias-credito').value = 0;
                document.getElementById('prov-moneda').value = 'USD';
            }
            document.getElementById('prov-modal').style.display = 'flex';
        }

        function cerrarProvModal() {
            document.getElementById('prov-modal').style.display = 'none';
            editProvId = null;
        }

        function guardarProveedor() {
            const nombre = document.getElementById('prov-nombre').value.trim();
            if (!nombre) { alert('Ingresa el nombre del proveedor'); return; }

            const tipos = [];
            if (document.getElementById('prov-tipo-gastos').checked)  tipos.push('gastos');
            if (document.getElementById('prov-tipo-compras').checked) tipos.push('compras');
            if (tipos.length === 0) { alert('Selecciona al menos un tipo: Gastos o Compras'); return; }

            const docs = [];
            if (document.getElementById('prov-doc-factura').checked)        docs.push('Factura');
            if (document.getElementById('prov-doc-nota-entrega').checked)   docs.push('Nota de Entrega');
            if (document.getElementById('prov-doc-recibo').checked)         docs.push('Recibo');
            if (document.getElementById('prov-doc-orden').checked)          docs.push('Orden de Compra');
            if (document.getElementById('prov-doc-sin-doc').checked)        docs.push('Sin Documento');

            const data = {
                nombre,
                rif:         document.getElementById('prov-rif').value.trim(),
                telefono:    document.getElementById('prov-telefono').value.trim(),
                email:       document.getElementById('prov-email').value.trim(),
                direccion:   document.getElementById('prov-direccion').value.trim(),
                contacto:    document.getElementById('prov-contacto').value.trim(),
                notas:       document.getElementById('prov-notas').value.trim(),
                diasCredito: parseInt(document.getElementById('prov-dias-credito').value) || 0,
                moneda:      document.getElementById('prov-moneda').value,
                tipos, docs,
                activo: true
            };

            if (editProvId) {
                const idx = proveedoresData.findIndex(x => x.id === editProvId);
                if (idx !== -1) proveedoresData[idx] = { ...proveedoresData[idx], ...data, modificadoEn: new Date().toISOString() };
            } else {
                proveedoresData.unshift({ id: 'prov-' + Date.now(), ...data, creadoEn: new Date().toISOString() });
            }
            saveProveedores();
            cerrarProvModal();
            loadProveedoresList();
            actualizarDatalistProveedores();
            alert('Proveedor guardado correctamente.');
        }

        function eliminarProveedor(id) {
            const p = proveedoresData.find(x => x.id === id);
            if (!p) return;
            if (!confirm('Eliminar el proveedor "' + p.nombre + '"?')) return;
            proveedoresData = proveedoresData.filter(x => x.id !== id);
            saveProveedores();
            loadProveedoresList();
            actualizarDatalistProveedores();
        }

        function toggleProvActivo(id) {
            const p = proveedoresData.find(x => x.id === id);
            if (!p) return;
            p.activo = !p.activo;
            saveProveedores();
            loadProveedoresList();
        }

        function filtrarProveedores() { loadProveedoresList(); }

        function loadProveedoresList() {
            const container = document.getElementById('prov-lista-container');
            if (!container) return;

            const busq = (document.getElementById('prov-search')?.value || '').toLowerCase();
            const tipo = document.getElementById('prov-filtro-tipo')?.value || 'todos';

            let lista = [...proveedoresData];
            if (busq) lista = lista.filter(p => (p.nombre + ' ' + (p.rif||'') + ' ' + (p.contacto||'')).toLowerCase().includes(busq));
            if (tipo !== 'todos') lista = lista.filter(p => tipo === 'ambos' ? (p.tipos?.length >= 2) : p.tipos?.includes(tipo));

            // Dashboard stats
            const dash = document.getElementById('prov-dashboard');
            if (dash) {
                const stats = [
                    ['Total', proveedoresData.length, '#1565c0', '#e3f2fd'],
                    ['Activos', proveedoresData.filter(p => p.activo).length, '#2e7d32', '#e8f5e9'],
                    ['Gastos', proveedoresData.filter(p => p.tipos?.includes('gastos')).length, '#7b1fa2', '#f3e5f5'],
                    ['Compras', proveedoresData.filter(p => p.tipos?.includes('compras')).length, '#e65100', '#fff3e0'],
                ];
                dash.innerHTML = stats.map(([label, val, color, bg]) =>
                    `<div style="background:${bg}; border-radius:10px; padding:12px; text-align:center;">
                        <div style="font-size:11px; color:#666; margin-bottom:4px;">${label.toUpperCase()}</div>
                        <div style="font-size:22px; font-weight:700; color:${color};">${val}</div>
                    </div>`
                ).join('');
            }

            if (lista.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">
                    <div style="font-size:40px; margin-bottom:10px;">&#127981;</div>
                    <p>No hay proveedores. Agrega el primero.</p>
                    <button class="btn btn-primary" onclick="abrirProvModal()"><i class="fas fa-plus"></i> Agregar Proveedor</button></div>`;
                return;
            }

            const tipoColors = { gastos:'#7b1fa2', compras:'#4caf50' };
            const docIcons   = { 'Factura':'&#129534;', 'Nota de Entrega':'&#128230;', 'Recibo':'&#128394;', 'Orden de Compra':'&#128203;', 'Sin Documento':'&#10060;' };

            container.innerHTML = lista.map(p => {
                const tipoLabels = (p.tipos || []).map(t =>
                    `<span style="background:${tipoColors[t]||'#999'}20; color:${tipoColors[t]||'#999'}; border-radius:12px; padding:2px 9px; font-size:11px; font-weight:600;">${t === 'gastos' ? 'Gastos' : 'Compras'}</span>`
                ).join(' ');
                const docLabels = (p.docs || []).map(d =>
                    `<span style="background:#f5f5f5; border-radius:12px; padding:2px 8px; font-size:11px; color:#555;">${d}</span>`
                ).join(' ');
                return `<div style="border:1px solid #e0e0e0; border-left:4px solid ${p.activo ? '#1565c0' : '#bdbdbd'}; border-radius:10px; padding:14px 16px; margin-bottom:10px; background:${p.activo ? 'white' : '#fafafa'}; opacity:${p.activo ? 1 : 0.7};">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:8px;">
                        <div style="flex:1; min-width:0;">
                            <div style="font-weight:700; font-size:15px; margin-bottom:4px;">${p.nombre}</div>
                            <div style="font-size:12px; color:#888; margin-bottom:6px;">
                                ${p.rif ? '<strong>' + p.rif + '</strong>' : ''}
                                ${p.telefono ? ' &middot; ' + p.telefono : ''}
                                ${p.email ? ' &middot; ' + p.email : ''}
                                ${p.contacto ? ' &middot; ' + p.contacto : ''}
                            </div>
                            <div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:6px;">${tipoLabels}</div>
                            <div style="display:flex; flex-wrap:wrap; gap:4px;">${docLabels}</div>
                            ${p.diasCredito > 0 ? `<div style="font-size:11px; color:#555; margin-top:4px;">Credito: ${p.diasCredito} dias - ${p.moneda || 'USD'}</div>` : ''}
                            ${p.notas ? `<div style="font-size:11px; color:#888; margin-top:4px; font-style:italic;">${p.notas}</div>` : ''}
                        </div>
                        <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
                            <span style="background:${p.activo ? '#e8f5e9' : '#fce4ec'}; color:${p.activo ? '#2e7d32' : '#c62828'}; border-radius:20px; padding:2px 10px; font-size:11px;">${p.activo ? 'Activo' : 'Inactivo'}</span>
                            <div style="display:flex; gap:6px;">
                                <button class="btn btn-small" style="background:#e3f2fd; color:#1565c0;" onclick="abrirProvModal('${p.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-small" style="background:${p.activo ? '#fff3e0' : '#e8f5e9'}; color:${p.activo ? '#e65100' : '#2e7d32'};" onclick="toggleProvActivo('${p.id}')">${p.activo ? 'Pausar' : 'Activar'}</button>
                                <button class="btn btn-small btn-danger" onclick="eliminarProveedor('${p.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function actualizarDatalistProveedores() {
            const activos = proveedoresData.filter(p => p.activo);
            // Datalist para Compras (ya existe en HTML)
            const dlCompras = document.getElementById('compras-proveedores-list');
            if (dlCompras) {
                dlCompras.innerHTML = activos
                    .filter(p => p.tipos?.includes('compras'))
                    .map(p => `<option value="${p.nombre}">`)
                    .join('');
                // Tambien incluir los que no estan en proveedoresData (historial antiguo)
                const antiguo = [...new Set(comprasData.map(c => c.proveedor).filter(Boolean))];
                antiguo.forEach(nombre => {
                    if (!activos.find(p => p.nombre === nombre)) {
                        dlCompras.innerHTML += `<option value="${nombre}">`;
                    }
                });
            }
            // Datalist para Gastos - agregar si tiene campo proveedor
            let dlGastos = document.getElementById('gastos-proveedores-list');
            if (dlGastos) {
                dlGastos.innerHTML = activos
                    .filter(p => p.tipos?.includes('gastos'))
                    .map(p => `<option value="${p.nombre}">`)
                    .join('');
            }
        }



        function onComprasProveedorSelChange() {
            const nombre = document.getElementById('c-proveedor')?.value?.trim();
            if (!nombre) return;
            const prov = proveedoresData.find(p => p.nombre === nombre && p.activo);
            if (!prov) return;
            const facEl = document.getElementById('c-factura');
            if (facEl && !facEl.value && prov.docs?.length === 1) {
                facEl.placeholder = prov.docs[0] === 'Factura' ? 'F-001-0001 (Factura)' :
                                    prov.docs[0] === 'Nota de Entrega' ? 'N/E-001' : 'Ref...';
            }
        }
    </script>
</body>
</html>